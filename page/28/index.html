<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Breeze.Temple">
<meta property="og:type" content="website">
<meta property="og:title" content="IT日记">
<meta property="og:url" content="http://yoursite.com/page/28/index.html">
<meta property="og:site_name" content="IT日记">
<meta property="og:description" content="Breeze.Temple">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Breeze.Temple">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/28/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>IT日记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Life is Now.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-OOM-Killer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-OOM-Killer/" class="post-title-link" itemprop="url">Linux下malloc函数和OOM Killer</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="Malloc函数和OOM-Killer"><a href="#Malloc函数和OOM-Killer" class="headerlink" title="Malloc函数和OOM Killer"></a><strong>Malloc函数和OOM Killer</strong></h3><p>Linux下malloc函数主要用来在用户空间从heap申请内存，申请成功返回指向所分配内存的指针，申请失败返回NULL。<br><strong>默认情况下，Linux内核使用“乐观的”分配内存策略</strong>，首先粗略估计系统可使用的内存数，然后分配内存，<br>但是在使用的时候才真正把这块分配的内存给你。<br>这样一来，即使用malloc申请内存没有返回NULL，你也不一定能完全使用这块内存，<br>特别是在一次或连续多次申请很多内存的时候。</p>
<p>如果一直连续用malloc申请内存，而不真正使用，所申请的内存总数可以超过真正可以使用的内存数。<br>但是当真正使用这块内存，比如用memset或bzero函数一次性把所申请到的大块内存“使用掉”，<br>Linux系统就会Out Of Memory，这个时候OOM Killer就会kill掉用户空间的其他进程来腾出更多可使用内存。</p>
<p>OOM Killer根据OOM score来决定kill哪个进程，OOM score可以看/proc/<PID>/oom_score，<br>score由badness函数计算得出，根据进程运行时间长短，进程优先级，进程所使用的内存数等等。<br>可以通过/proc/<PID>/oom_adj来干预计算socre，这个值的取值范围是-17～15，<br>如果是-17该进程就永远不会被kill（这个可能也和内核版本有关，不见得所有内核版本都支持，得实际试试）。</p>
<p>“默认情况”Linux是这种做的，“默认情况”是指/proc/sys/vm/overcommit_memory为0的时候。<br>这个参数也可以调整，如果为1表示“来着不拒”，只要你malloc过来申请，我啥都不做，立马给你分配内存，<br>这样的话性能就会有大幅度的提高；<br>如果为2表示Linux会精确计算所有可使用的内存和所申请的内存，如果所申请的超过的可使用的内存数就返回NULL。<br>可使用的内存值计算方法，虚拟内存（swap）+ /proc/sys/vm/overcommit_memory（百分比） × 物理内存。<br>/proc/sys/vm/overcommit_memory默认值为50,计算起来就是50%的物理内存数。</p>
<p>Linux自身内核会占一部分内存，还有buffer/cache所占用的内存，<br>所以实际上能被malloc申请后使用的内存并非物理内存大小，<br>demsg的输出里面包含了相关信息（如果看不到，可能是被别的信息冲掉了，重启系统，在系统起来后马上看）：</p>
<pre><code>Memory: 2071220k/2097152k available (2122k kernel code, 24584k reserved, 884k data, 228k init, 1179584k highmem)</code></pre><h3 id="关于OOM-Killer的proc文件系统"><a href="#关于OOM-Killer的proc文件系统" class="headerlink" title="关于OOM Killer的proc文件系统"></a><strong>关于OOM Killer的proc文件系统</strong></h3><p>下面开始介绍与OOM Killer相关的proc文件系统。</p>
<h4 id="proc-PID-oom-adj"><a href="#proc-PID-oom-adj" class="headerlink" title="/proc/PID/oom_adj"></a><strong>/proc/PID/oom_adj</strong></h4><p>为/proc/PID/oom_adj设置值就可以调整得分。<br>调整值的范围为–16~15。正的值容易被OOM Killer选定。负值可能性较低。<br>例如，当指定3时，得分就变为23倍；当指定–5时，得分就变为1/25。</p>
<p>“–17”是一个特殊的值。如果设置为–17，就会禁止OOM Killer发出的信号（从Linux 2.6.12开始支持设置–17）。</p>
<p>在OOM Killer运行的情况下，为了实现远程登录而想要将sshd排除在对象外时，可以执行下列命令。</p>
<pre><code># cat /proc/&#39;cat /var/run/sshd.pid&#39;/oom_score
15
# echo -17 &gt;  /proc/&#39;cat /var/run/sshd.pid&#39;/oom_adj
# tail /proc/&#39;cat /var/run/sshd.pid&#39;/oom_*
==&gt; /proc/2278/oom_adj &lt;==
-17
==&gt; /proc/2278/oom_score &lt;==
0                               /*得分变成0*/</code></pre><p>从Linux 2.6.18开始可以使用/proc/PID/oom_adj。内容记载在Documentation /filesystems/proc.txt中。</p>
<h4 id="proc-sys-vm-panic-on-oom"><a href="#proc-sys-vm-panic-on-oom" class="headerlink" title="/proc/sys/vm/panic_on_oom"></a><strong>/proc/sys/vm/panic_on_oom</strong></h4><p>将/proc/sys/vm/panic_on_oom设置为1时，在OOM Killer运行时可以不发送进程信号，而是使内核产生重大故障。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/panic_on_oom</code></pre><h4 id="proc-sys-vm-oom-kill-allocating-task"><a href="#proc-sys-vm-oom-kill-allocating-task" class="headerlink" title="/proc/sys/vm/oom_kill_allocating_task"></a><strong>/proc/sys/vm/oom_kill_allocating_task</strong></h4><p>从Linux 2.6.24开始proc文件系统就有oom_kill_allocating_task。<br>如果对此设置除0以外的值，则促使OOM Killer运行的进程自身将接收信号。此处省略对所有进程的得分计算过程。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_kill_allocating_task</code></pre><p>这样就不需要参照所有进程，但是也不会考虑进程的优先级和root权限等，只发送信号。</p>
<h4 id="proc-sys-vm-oom-dump-tasks"><a href="#proc-sys-vm-oom-dump-tasks" class="headerlink" title="/proc/sys/vm/oom_dump_tasks"></a><strong>/proc/sys/vm/oom_dump_tasks</strong></h4><p>从Linux 2.6.25开始，将oom_dump_tasks设置为除0以外的值时，在OOM Killer运行时的输出中会增加进程的列表信息。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_dump_tasks</code></pre><p>列表信息显示如下，可以使用dmesg或syslog来确认。</p>
<pre><code>[ pid ]   uid  tgid total_vm      rss cpu oom_adj name
[    1]     0     1     2580        1   0       0 init
[  500]     0   500     3231        0   1     -17 udevd
[ 2736]     0  2736     1470        1   0       0 syslogd
[ 2741]     0  2741      944        0   0       0 klogd
[ 2765]    81  2765     5307        0   0       0 dbus-daemon
[ 2861]     0  2861      944        0   0       0 acpid
...
[ 3320]     0  3320   525842   241215   1       0 stress</code></pre><h4 id="proc-PID-oom-score-adj"><a href="#proc-PID-oom-score-adj" class="headerlink" title="/proc/PID/oom_score_adj"></a><strong>/proc/PID/oom_score_adj</strong></h4><p>从Linux 2.6.36开始都安装了/proc/<PID>/oom_score_adj，<br>此后将替换为/proc/PID/oom_adj。<br>即使当前是对/proc/PID/oom_adj进行的设置，在内核内部进行变换后的值也是针对/proc/PID/oom_score_adj设置的。</p>
<p>可以设置–1000~1000之间的值。设置为–1000时，该进程就被排除在OOM Killer强制终止的对象外。</p>
<p>在内核2.6.36以后的版本中写入oom_adj，只会输出一次如下的信息。</p>
<pre><code># dmesg
.....
udevd (60): /proc/60/oom_adj is deprecated, please use /proc/60/oom_score_adj instead.</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-malloc/" class="post-title-link" itemprop="url">linux内存分配原理（brk和mmap）（转载）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="如何查看进程发生缺页中断的次数？"><a href="#如何查看进程发生缺页中断的次数？" class="headerlink" title="如何查看进程发生缺页中断的次数？"></a><strong>如何查看进程发生缺页中断的次数？</strong></h3><pre><code>ps -o majflt,minflt -C program</code></pre><p>majflt代表major fault，中文名叫大错误，minflt代表minor fault，中文名叫小错误。<br>这两个数值表示一个进程自启动以来所发生的缺页中断的次数。</p>
<h3 id="发成缺页中断后，执行了那些操作？"><a href="#发成缺页中断后，执行了那些操作？" class="headerlink" title="发成缺页中断后，执行了那些操作？"></a><strong>发成缺页中断后，执行了那些操作？</strong></h3><p>当一个进程发生缺页中断的时候，进程会陷入内核态，执行以下操作： </p>
<ol>
<li>检查要访问的虚拟地址是否合法 </li>
<li>查找/分配一个物理页 </li>
<li>填充物理页内容（读取磁盘，或者直接置0，或者啥也不干） </li>
<li>建立映射关系（虚拟地址到物理地址） </li>
<li>重新执行发生缺页中断的那条指令 </li>
</ol>
<p>如果第3步，需要读取磁盘，那么这次缺页中断就是majflt，否则就是minflt。 </p>
<h3 id="内存分配的原理"><a href="#内存分配的原理" class="headerlink" title="内存分配的原理"></a><strong>内存分配的原理</strong></h3><p>从操作系统角度来看，进程分配内存有两种方式，分别由两个系统调用完成：brk和mmap（不考虑共享内存）。</p>
<ol>
<li>brk是将数据段(.data)的最高地址指针_edata往高地址推；</li>
<li>mmap是在进程的虚拟地址空间中（堆和栈中间，称为文件映射区域的地方）找一块空闲的虚拟内存。</li>
</ol>
<p><strong>这两种方式分配的都是虚拟内存，没有分配物理内存。<br>在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立虚拟内存和物理内存之间的映射关系。</strong><br>在标准C库中，提供了malloc/free函数分配释放内存，这两个函数底层是由brk，mmap，munmap这些系统调用实现的。</p>
<h3 id="以例子来说明内存分配的原理"><a href="#以例子来说明内存分配的原理" class="headerlink" title="以例子来说明内存分配的原理"></a><strong>以例子来说明内存分配的原理</strong></h3><h4 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a><strong>情况一</strong></h4><p>malloc小于128k的内存，使用brk分配内存，<br>将_edata往高地址推(只分配虚拟空间，不对应物理内存(因此没有初始化)，<br>第一次读/写数据时，引起内核缺页中断，内核才分配对应的物理内存，然后虚拟地址空间建立映射关系)，如下图：</p>
<p><img src="/images/malloc/1.jpg" alt="brk" title="wizard"></p>
<ul>
<li><p>进程启动的时候，其（虚拟）内存空间的初始布局如图1所示。<br>其中，mmap内存映射文件是在堆和栈的中间（例如libc-2.2.93.so，其它数据文件等），为了简单起见，省略了内存映射文件。<br>_edata指针（glibc里面定义）指向数据段的最高地址。 </p>
</li>
<li><p>进程调用A=malloc(30K)以后，内存空间如图2：<br>malloc函数会调用brk系统调用，将_edata指针往高地址推30K，就完成虚拟内存分配。<br>你可能会问：只要把_edata+30K就完成内存分配了？<br>事实是这样的，_edata+30K只是完成虚拟地址的分配，A这块内存现在还是没有物理页与之对应的，<br>等到进程第一次读写A这块内存的时候，发生缺页中断，这个时候，内核才分配A这块内存对应的物理页。<br>也就是说，如果用malloc分配了A这块内容，然后从来不访问它，那么，A对应的物理页是不会被分配的。 </p>
</li>
<li><p>进程调用B=malloc(40K)以后，内存空间如图3。</p>
</li>
</ul>
<h4 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a><strong>情况二</strong></h4><p>malloc大于128k的内存，使用mmap分配内存，在堆和栈之间找一块空闲内存分配(对应独立内存，而且初始化为0)，如下图：</p>
<p><img src="/images/malloc/2.jpg" alt="mmap" title="build"></p>
<ul>
<li><p>进程调用C=malloc(200K)以后，内存空间如图4：<br>默认情况下，malloc函数分配内存，如果请求内存大于128K（可由M_MMAP_THRESHOLD选项调节），<br>那就不是去推_edata指针了，而是利用mmap系统调用，从堆和栈的中间分配一块虚拟内存。<br>  <strong>这样子做主要是因为:<br>  brk分配的内存需要等到高地址内存释放以后才能释放<br>  （例如，在B释放之前，A是不可能释放的，这就是内存碎片产生的原因，什么时候紧缩看下面），<br>  而mmap分配的内存可以单独释放。</strong><br>  当然，还有其它的好处，也有坏处，再具体下去，有兴趣的同学可以去看glibc里面malloc的代码了。 </p>
</li>
<li><p>进程调用D=malloc(100K)以后，内存空间如图5；</p>
</li>
<li><p>进程调用free(C)以后，C对应的虚拟内存和物理内存一起释放。</p>
</li>
</ul>
<p><img src="/images/malloc/3.jpg" alt="free" title="dot"></p>
<ul>
<li><p>进程调用free(B)以后，如图7所示：<br>B对应的虚拟内存和物理内存都没有释放，因为只有一个_edata指针，如果往回推，那么D这块内存怎么办呢？<br>当然，B这块内存，是可以重用的，如果这个时候再来一个40K的请求，那么malloc很可能就把B这块内存返回回去了。 </p>
</li>
<li><p>进程调用free(D)以后，如图8所示：<br>B和D连接起来，变成一块140K的空闲内存。</p>
</li>
<li><p>默认情况下：<br>当最高地址空间的空闲内存超过128K（可由M_TRIM_THRESHOLD选项调节）时，执行内存紧缩操作（trim）。<br>在上一个步骤free的时候，发现最高地址空闲内存超过128K，于是内存紧缩，变成图9所示。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/grep-special/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/grep-special/" class="post-title-link" itemprop="url">Grep搜索特定文件</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>120</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a><strong>Script</strong></h3><pre><code>grep XXYYZZ * -Rn --include=&#39;*.c&#39;
grep XXYYZZ * -Rn --include=&#39;*.h&#39;
grep XXYYZZ * -Rn --include=&#39;*.[ch]&#39;</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/doxygen-graphviz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/doxygen-graphviz/" class="post-title-link" itemprop="url">Ubuntu下使用Doxygen和graphviz来产生源代码函数调用图</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Doxygen/" itemprop="url" rel="index">
                    <span itemprop="name">Doxygen</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>721</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><pre><code>sudo apt-get install doxygen doxygen-doc doxygen-gui graphviz
doxywizard
doxygen -g</code></pre><h3 id="生成函数调用图"><a href="#生成函数调用图" class="headerlink" title="生成函数调用图"></a><strong>生成函数调用图</strong></h3><h4 id="DoxyWizard"><a href="#DoxyWizard" class="headerlink" title="DoxyWizard"></a><strong>DoxyWizard</strong></h4><p>打开DoxyWizard，弹出Doxygen配置界面。如下图，标出了主要需要设置的选项:</p>
<p><img src="/images/doxygen/1.png" alt="wizard" title="wizard"></p>
<ol>
<li>Step1：设置doxygen的工作目录，这里主要是生成doxygen运行的目录</li>
<li>Step2：选项设置，wizard和expert选项可以同时设置。</li>
</ol>
<p>wizard选项卡中，选择Project Name作为工程名称，将来会显示在文档的标题中；<br>选择Source code directory，设置源代码所在目录，Destination directory设置文档的生成目录；<br>选择Scan recursively则递归分析源代码目录中的子目录内的源代码。</p>
<h4 id="build"><a href="#build" class="headerlink" title="build"></a><strong>build</strong></h4><p>需要从没有任何标记的源代码中分析出函数调用关系，所以还需要设置expert选项卡:</p>
<p><img src="/images/doxygen/2.png" alt="build" title="build"></p>
<p>勾选Build选项中的与函数有关的选项，EXTRACT_ALL必须勾选；<br>sourcebrowser: 需要查看代码，勾选Inline sources和souce Browser。</p>
<h4 id="dot"><a href="#dot" class="headerlink" title="dot"></a><strong>dot</strong></h4><p>由于使用到了Graphviz，所以要设置Dot选项，勾选HAVE_DOT，并设置DOT_PATH为Graphviz的bin目录。</p>
<p><img src="/images/doxygen/3.png" alt="dot1" title="dot"></p>
<p>Dot: 这里可以勾选CLASS_DIAGRAMS/HAVE_DOT/CALL_GRAPH/CALLER_GRAPH/DOT_PATH</p>
<p><img src="/images/doxygen/4.png" alt="dot2" title="dot2"></p>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a><strong>run</strong></h4><p>然后就可以点RUN标签，运行后，会生成HTML，查看INDEX.HTML既可以看到结果</p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_7a1c18a80102vd2p.html" target="_blank" rel="noopener">Ubuntu 下使用 Doxygen</a></li>
<li><a href="http://www.07net01.com/program/229677.html" target="_blank" rel="noopener">使用Doxygen+graphviz+Sublime2来看代码，查看函数调用关系</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/vim-multifile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/vim-multifile/" class="post-title-link" itemprop="url">VIM多文件查找与替换</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>708</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a><strong>Script</strong></h3><pre><code>find . -name &quot;*.c&quot; | xargs sed -i &quot;s/$1/$2/g&quot;</code></pre><h3 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a><strong>VIM</strong></h3><h4 id="多文件查找"><a href="#多文件查找" class="headerlink" title="多文件查找"></a><strong>多文件查找</strong></h4><h5 id="grep"><a href="#grep" class="headerlink" title="grep"></a><strong>grep</strong></h5><p>直接在vim中输入</p>
<pre><code>:grep abc * </code></pre><p>这是直接调用unix下的grep命令 </p>
<h5 id="vimgrep"><a href="#vimgrep" class="headerlink" title="vimgrep"></a><strong>vimgrep</strong></h5><p>基本用法就是</p>
<pre><code>:vimgrep /匹配模式/[g][j] 要搜索的文件/范围 
:vim[grep][!] /{pattern}/[g][j] {file} ...</code></pre><p>g 和 j 是两个可选的标志位，g表示是否把每一行的多个匹配结果都加入。j表示是否搜索完后定位到第一个匹配位置。<br>要搜索的文件可以是具体的文件路径，也可以是带通配符的路径比如 <em>.as **/</em>.as ，**表示递归所有子目录。<br>要搜索的文件和或搜索范围都可以写多个，用空格分开。 例子：</p>
<pre><code>:vimgrep /\/ **/*.as 搜索当前目录以及所有子目录内as文件中的 &quot;flash&quot;
:vimgrep /an error/ *.c 就是在所有的.c文件中搜索an error。
:vimgrep/an error/* 意思是查找当前目录下的文件中的an error，不包括子目录</code></pre><h5 id="定位"><a href="#定位" class="headerlink" title="定位"></a><strong>定位</strong></h5><p>输入上述的命令后，可以像输入:make命令，那样定位匹配到的文件位置 </p>
<pre><code>:cnext (:cn)           下一个匹配位置
:cprevious (:cp)     上一个匹配位置
:cwindow (:cw)     quickfix窗口，可以选择匹配的文件位置
:cl(:clist)                查看所有匹配的位置</code></pre><h4 id="多文件替换-arg"><a href="#多文件替换-arg" class="headerlink" title="多文件替换(arg)"></a><strong>多文件替换(arg)</strong></h4><ol>
<li>加入要处理的文件  :args *.txt</li>
<li>输入对上述文件的动作  :argdo %s/hate/love/gc | update  （这里将hate替换成love，update表示要写入到文件中，否则只作替换而不写入）</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/05/07/lib32-for-ubuntu64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/05/07/lib32-for-ubuntu64/" class="post-title-link" itemprop="url">ubuntu64位系统32位兼容包</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-05-08 00:00:00" itemprop="dateCreated datePublished" datetime="2015-05-08T00:00:00+08:00">2015-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">ubuntu</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>612</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ubuntu 14.04 64位无法安装ia32-libs，此包已被移除</p>
<pre><code>sudo apt-get install ia32-libs</code></pre><p>替换为</p>
<pre><code>sudo apt-get install libc6:i386
sudo apt-get install lib32z1 lib32ncurses5 lib32bz2-1.0</code></pre><p>上面这些包基本上都是基本必备库，另外编译中需要到的各个库可以搜索相应的版本，进行安装，例如：</p>
<pre><code>➜  /home/yanwzh  &gt; sudo apt-cache search libelf

libelf-dev - libelf1 development libraries and header files
libelf1 - library to read and write ELF files
libelfg0 - an ELF object file access library
libelfg0-dev - an ELF object file access library: development files
libelf-freebsd-1 - library to read and write ELF files
libelf-freebsd-dev - Development files for libelf (FreeBSD version)

➜  /home/yanwzh  &gt; sudo apt-get install libelf-dev:i386</code></pre><p>使用sudo apt-get install somepkg:i386 来强制安装32位版本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/05/nm-symbols/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/05/nm-symbols/" class="post-title-link" itemprop="url">nm symbols 类型及程序组成</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-06 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-06T00:00:00+08:00">2015-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/Linker/" itemprop="url" rel="index">
                    <span itemprop="name">Linker</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>nm symbols</code> 类型列表</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2015/04/05/nm-symbols/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-mem-info/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-mem-info/" class="post-title-link" itemprop="url">eCos Mem Info[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eCos/" itemprop="url" rel="index">
                    <span itemprop="name">eCos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>嵌入式系统的内存资源是非常有限的，<br>如果配置不当可导致eCos应用程序因为存储空间不足而链接失败。<br>解决这个问题的办法可以是增加更多的内存或者是减少软件对内存资源的使用，通常是后一种办法。<br>既然要减少内存使用量，那么首先要找出都是哪些变量吃光了内存，<br>就是说要对映像符号进行分析，找出最占内存的变量，<br>看看能否避免使用该变量或减少该变量的占用容量。<br>GNU工具链中的nm就是做这个事情用的，按照用户手册的说法，<br>nm是用来解析映像符号的，包括符号使用容量和所在的文件。</p>
<h2 id="查找最占内存变量"><a href="#查找最占内存变量" class="headerlink" title="查找最占内存变量"></a><strong>查找最占内存变量</strong></h2><pre><code>$ nm --print-size --line-numbers --size-sort app.elf | grep &quot; [dDbB] &quot;  
......  
10004154 00000800 b var_data    /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/ecos/sys_arch.c:84  
10002fb0 00000b00 b timer_table  
10001f98 00001000 b main_stack  
10004994 00001800 b stack_data  /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/ecos/sys_arch.c:95  
2007c000 000018b8 b emac_ahb_ram        /cygdrive/f/ecos/hg/packages/devs/eth/arm/lpc2xxx/current/src/if_lpc2xxx.c:357  
20080388 0000283b b memp_memory /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/core/memp.c:146  </code></pre><ul>
<li>–print-size：打印符号符号占用内存量</li>
<li>–line-numbers：打印符号所在的源文件名及行号</li>
<li>–size-sort：以符号占用内存量来排序</li>
<li>app.elf：eCos应用映像文件名</li>
<li>输出内容按列分别为：符号地址、符号占用内存量、符号类型、所在文件及行号</li>
<li>grep的作用是过滤不需要的符号，我们这里仅需要存储在RAM中的变量，将常量和函数等过滤掉，<br>注意grep参数的引号和方括号之间有空格。<br>输出结果按照变量内容占用量排序输出，最后输出的是占用量最大的变量。<br>从上面的输出可以看出memp_memory占用的内存最多，通过文件名可以判断这是lwIP内存池，<br>修改lwIP配置减少连接数和缓存数目等可以减少该变量的内存占用量。</li>
</ul>
<h2 id="链接失败时的办法"><a href="#链接失败时的办法" class="headerlink" title="链接失败时的办法"></a><strong>链接失败时的办法</strong></h2><p>如果容量超限，压根就不能编译完成，也就谈不上映像文件了，<br>这时候可以修改target.ld文件，修改内存容量，内存容量可以修改成比目标机实际容量更大的值，<br>修改target.ld的目的是可以正确地生成映像文件然后使用nm来分析内存使用情况并进行调整，<br>而不是下载到目标机运行，如果target.ld设定的内存容量比目标机实际内存容量大，<br>即使下载到目标机也不能正常运行。根据nm输出结果及应用需求调整内存使用量，<br>当映像使用的内存容量小于目标机实际内存容量后，恢复target.ld的内存容量设置。</p>
<h2 id="使用size查看总内存量"><a href="#使用size查看总内存量" class="headerlink" title="使用size查看总内存量"></a><strong>使用size查看总内存量</strong></h2><p>nm打印出每个符号占用的内存量，而size打印映像的总内存量，<br>可以使用size输出快速判断容量是否超限的问题，size还可以显示srec和ihex格式的映像容量。</p>
<pre><code>$ size app.elf  
text    data     bss     dec     hex filename  
158712    1852   43503  204067   31d23 app.elf  </code></pre><h2 id="使用哪个nm？"><a href="#使用哪个nm？" class="headerlink" title="使用哪个nm？"></a><strong>使用哪个nm？</strong></h2><p>nm和size只是对ELF格式的映像文件符号和加载段进行分析，<br>因此跟硬件架构没多大关系，<br>使用nm或arm-eabi-nm的效果是一样的，如果不放心，那就用arm-eabi-nm吧，size同理。</p>
<h2 id="nm常用参数"><a href="#nm常用参数" class="headerlink" title="nm常用参数"></a><strong>nm常用参数</strong></h2><h3 id="C-–demangle"><a href="#C-–demangle" class="headerlink" title="-C, –demangle"></a><strong>-C, –demangle</strong></h3><p>逆向解析C++符号转换，编译C++源代码时，<br>会将C++符号转换成符号汇编器要求的符号，<br>如果不对C++符号进行逆向解析，那么看到的是汇编符号而不是C++源文件中的符号名。</p>
<p>使用该参数前，输出汇编符号，晦涩难懂</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
00006adc T _ZN10Cyg_Thread5delayEy  
......  </code></pre><p>使用该参数后，输出C++符号，与源文件符号一致</p>
<pre><code>$ arm-eabi-nm -C app.elf  
    ......  
00006adc T Cyg_Thread::delay(unsigned long long)  
    ......  </code></pre><h3 id="l-–line-numbers"><a href="#l-–line-numbers" class="headerlink" title="-l, –line-numbers"></a><strong>-l, –line-numbers</strong></h3><p>输出符号所在的文件名和行号。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
0001a0c4 T write  </code></pre><p>使用该参数后，行尾追加文件名和行号</p>
<pre><code>$ arm-eabi-nm -l app.elf  
......  
0001a0c4 T write        /cygdrive/f/ecos/hg/packages/io/fileio/current/src/io.cxx:169  </code></pre><h3 id="S-–print-size"><a href="#S-–print-size" class="headerlink" title="-S, –print-size"></a><strong>-S, –print-size</strong></h3><p>输出符号占用内存量。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
0001a0c4 T write  </code></pre><p>使用该参数后，第2列数字为符号占用内存量</p>
<pre><code>$ arm-eabi-nm -S app.elf  
......  
0001a0c4 00000034 T write  </code></pre><h3 id="n-–numeric-sort"><a href="#n-–numeric-sort" class="headerlink" title="-n, –numeric-sort"></a><strong>-n, –numeric-sort</strong></h3><p>输出结果按照符号地址排序。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
000202c8 T udp_sendto_if  
00018ec0 t update_arp_entry  
10004154 b var_data  
1000497c b var_handle  
10004954 b var_mempool  
00009a60 T vfnprintf  
0001a0c4 T write  </code></pre><p>使用该参数后，根据第1列数值排序</p>
<pre><code>$ arm-eabi-nm -n app.elf  
......  
100070b0 A __heap1  
10007fe0 A hal_startup_stack  
2007c000 A __ahb_sram0_start  
2007c000 b emac_ahb_ram  
2007d8b8 A __ahb_sram0_end  
20080000 A __ahb_sram1_start  
20080000 b ram_heap  
20080388 b memp_memory  
20082bc3 A __ahb_sram1_end  </code></pre><h3 id="–size-sort"><a href="#–size-sort" class="headerlink" title="–size-sort"></a><strong>–size-sort</strong></h3><p>按照内存使用量排序。使用该参数前</p>
<pre><code>$ arm-eabi-nm -S app.elf  
......  
10004154 00000800 b var_data  
1000497c 00000004 b var_handle  
10004954 00000028 b var_mempool  
00009a60 000015f4 T vfnprintf  
0001a0c4 00000034 T write  </code></pre><p>使用该参数后，根据第2列数值进行排序</p>
<pre><code>$ arm-eabi-nm -S --size-sort app.elf  
......  
10001f98 00001000 b _ZL10main_stack  
0001cf38 000011dc t tcp_receive  
00009a60 000015f4 T vfnprintf  
10004994 00001800 b stack_data  
2007c000 000018b8 b emac_ahb_ram  
20080388 0000283b b memp_memory </code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-cpu-load/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-cpu-load/" class="post-title-link" itemprop="url">eCos Cpu Load[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eCos/" itemprop="url" rel="index">
                    <span itemprop="name">eCos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>cpuload组件包提供了一种估算CPU负载的方式。它可以估算最近0.1秒、1秒和10秒内的CPU负载百分比。</p>
<h3 id="负载测量API"><a href="#负载测量API" class="headerlink" title="负载测量API"></a><strong>负载测量API</strong></h3><p>首先，必须在被测目标机上对测量算法进行校准，一旦校准完成后就可以开始测量。<br>测量是一个连续过程，因此总是提供最近的测量数据，测量过程可以根据需要随时停止。<br>一旦开始测量过程，就可以获取测量结果。</p>
<p>需要注意的是：如果目标机或CPU执行任何节能措施，例如降低时钟频率或者挂起CPU等，<br>这些节能措施将干扰CPU负载测量，在这种情况下，测量结果是未定义的。<br>Synthetic Target就是这样的情况之一。阅读本文后续实现细节章节可以了解更多。</p>
<p>『译注』Cortex-M架构的默认实现会在执行空闲任务时挂起CPU，<br>因此默认情况下，测量结果并非是实际的CPU负载，<br>需要重定义HAL_IDLE_THREAD_ACTION宏取消空闲时挂起，<br>HAL_IDLE_THREAD_ACTION宏的默认实现位于hal/cortexm/arch/<version>/include/hal_arch.h:336。</p>
<p>负载测量不支持SMP系统，仅支持单CPU系统。</p>
<p>负载测量API可以在cyg/cpuload/cpuload.h中找到。</p>
<p>『译注』源代码位于services/cpuload</p>
<h4 id="cyg-cpuload-calibrate"><a href="#cyg-cpuload-calibrate" class="headerlink" title="cyg_cpuload_calibrate"></a><strong>cyg_cpuload_calibrate</strong></h4><p>这个函数用来校准CPU负载测量算法。它执行一次特别的测量过程确定空闲时的CPU性能。</p>
<pre><code>void cyg_cpuload_calibrate(cyg_uint32* calibration);  </code></pre><p>该函数通过calibration指针返回校准值。<br>这个函数是非常特别的，为了获得正确的校准结果需要满足若干条件。<br>该函数使用了2个最高线程优先级，当该函数被使用时，其它线程不能使用这两个优先级。<br>调用该函数时，内核调度器必须已经启动而且调度器未加锁。<br>该函数将花费0.1秒的时间完成校准操作，在这0.1秒校准期间不能有任何其它线程执行。</p>
<p>『译注』这个函数使用了线程优先级1和2，为了获得正确的测量结果，<br>其它线程不能使用优先级1和2。eCos的最高线程优先级是0，如果有优先级为0的线程，<br>必须保证在校准过程该线程处于挂起状态，<br>否则校准过程可能被优先级为0的线程抢占而导致错误的校准结果。</p>
<p>『译注』该函数将会创建一个线程，线程堆栈大小为CYGNUM_HAL_STACK_SIZE_MINIMUM，<br>在Cortex-M架构下约1.5KB，该线程仅在校准过程执行一次，<br>随后被删除永远都不会再执行，如果目标机内存非常有限，<br>应当知晓CPU负载测量校准时使用了1.5KB的堆栈空间。</p>
<h4 id="cyg-cpuload-create"><a href="#cyg-cpuload-create" class="headerlink" title="cyg_cpuload_create"></a><strong>cyg_cpuload_create</strong></h4><p>这个函数启动CPU负载测量。</p>
<pre><code>void cyg_cpuload_create(cyg_cpuload_t* cpuload,  
        cyg_uint32 calibrate,  
        cyg_handle_t* handle);  </code></pre><p>调用该函数启动测量过程，handle返回操作句柄，通过该句柄可以读取测量结果以及停止测量过程。</p>
<h4 id="cyg-cpuload-delete"><a href="#cyg-cpuload-delete" class="headerlink" title="cyg_cpuload_delete"></a><strong>cyg_cpuload_delete</strong></h4><p>这个函数停止CPU负载测量。</p>
<pre><code>void cyg_cpuload_delete(cyg_handle_t handle);  </code></pre><p>handle必须是cyg_cpuload_create函数返回的操作句柄。</p>
<h4 id="cyg-cpuload-get"><a href="#cyg-cpuload-get" class="headerlink" title="cyg_cpuload_get"></a><strong>cyg_cpuload_get</strong></h4><p>这个函数返回最近的测量结果。</p>
<pre><code>void cyg_cpuload_get(cyg_handle_t handle,  
        cyg_uint32* average_point1s,  
        cyg_uint32* average_1s,  
        cyg_uint32* average_10s);  </code></pre><p>handle必须是cyg_cpuload_create函数返回的操作句柄。<br>最近0.1秒、1秒和10秒的负载测量结果通过average_point1s、average_1s和average_10s返回。</p>
<h3 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a><strong>实现细节</strong></h3><p>这一节给出一些测量过程的实现细节，这些细节可以帮助我们理解测量结果的意义。<br>当没有其它线程可以执行时，eCos将执行空闲线程，空闲线程总是可执行的而且使用最低线程优先级。<br>空闲线程只做一点点事情，它有一个永远都不会退出的循环，每次循环将idle_thread_loops变量加1，<br>然后调用HAL_IDLE_THREAD_ACTION宏。<br>CPU负载测量算法就是使用了idle_thread_loops变量，<br>测量算法周期性地检查idle_thread_loops变量，并记录前后两次检查的差值，<br>系统越空这个差值就越大，通过这个简单的手段就可以确定系统的负载。</p>
<p>cyg_cpuload_calibrate函数执行空闲任务0.1秒，<br>从而确定系统空闲0.1秒的时间内idle_thread_loops会被累加多少次。<br>cyg_cpuload_create函数启动一个闹钟，这个闹钟每隔0.1秒调用回调函数，<br>回调函数计算idle_thread_loops从上次检查到本次检查的差值，然后根据这个差值以及校准值计算出CPU负载。<br>回调函数用新的计算结果更新cyg_cpuload结构，<br>0.1秒负载只是简单地复制最近的测量结果，然后通过一个简单的滤波计算1秒和10秒负载。<br>由于舍入误差的存在，即使系统满负载，1秒和10秒测量值也永远都不会达到100%，通常看到的是99%。</p>
<p>如前所述，电源管理代码将干扰上述测量结果。<br>CPU负载测量的基本假设是：空闲线程可以无障碍地运行，而且运行条件与校准时的运行条件保持一致。<br>如果降低CPU时钟频率，那么空闲线程的计数器累加速率将变慢，<br>因此CPU负载测量结果值将偏高，如果CPU被完全挂起，那么CPU负载测量结果将是100%。</p>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a><strong>Ref</strong></h3><ol>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/cpuload-functions.html" target="_blank" rel="noopener">Chapter 68. CPU Load Measurements</a></li>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/ecos-ref.html" target="_blank" rel="noopener">eCos Reference Manual</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-stack-info/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-stack-info/" class="post-title-link" itemprop="url">eCos Stack Info[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eCos/" itemprop="url" rel="index">
                    <span itemprop="name">eCos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>如何获得eCos系统的线程堆栈和中断堆栈使用情况。<br>eCos是开源免版税的抢占式实时操作系统。其最大亮点是可配置，<br>与其配套的图形化配置工具提供组件管理、选项配置、自动化单元测试等。<br>eCos官网<a href="http://ecos.sourceware.org。" target="_blank" rel="noopener">http://ecos.sourceware.org。</a></p>
<p>在嵌入式系统中，堆栈是静态分配的，<br>不会依据堆栈的使用情况自动增加堆栈深度，存在堆栈溢出的风险。<br>一旦发生堆栈溢出，后果很严重，可能会立即导致死机，也可能埋了一颗定时炸弹，<br>在随后的开发过程随时导致死机。<br>事实上，堆栈溢出导致死机还算是不错的状况，<br>更糟糕的情况是，有时候正常，有时候功能错误，捉摸不定，<br>如果又是在修改了与这个堆栈压根就没什么关系的代码的情况下出现，<br>那真的要吐血，因为第一感觉会告诉你，刚刚修改的代码存在错误。<br>好在可以预防这种情况，稍微专业点的RTOS就会提供堆栈检查API，<br>eCos当然也不例外，在有堆栈检查API的RTOS中，<br>即使已经发生了堆栈溢出，也可以快速诊断哪个堆栈产生溢出。</p>
<h3 id="堆栈检查选项"><a href="#堆栈检查选项" class="headerlink" title="堆栈检查选项"></a><strong>堆栈检查选项</strong></h3><p>堆栈检查通常是发生在开发和测试阶段，<br>因此在eCos中堆栈检查功能是一个可选项，<br>要使用eCos堆栈检查功能，首先要打开对应的选项。</p>
<pre><code>&gt; eCos kernel  
    &gt; Thread-related options  
        &gt; Measure stack usage  </code></pre><h3 id="堆栈检查API"><a href="#堆栈检查API" class="headerlink" title="堆栈检查API"></a><strong>堆栈检查API</strong></h3><p>使能Measure stack usage选项后，cyg_thread_measure_stack_usage函数可用，函数原型如下：</p>
<pre><code>cyg_uint32 cyg_thread_measure_stack_usage(cyg_handle_t thread)  </code></pre><p>这个函数以线程句柄为入参，返回该线程已使用的堆栈深度，以字节为单位。</p>
<p>仅有已使用堆栈深度是不够的，<br>使用cyg_thread_get_stack_size获取线程堆栈大小，<br>使用cyg_thread_get_stack_base获取线程堆栈基址。<br>通过这三个函数可以确定线程堆栈存储位置，分配空间大小，已使用堆栈大小，<br>通过已使用堆栈大小与分配空间大小相比可以评估线程堆栈是否存在堆栈溢出的风险。<br>此外，可以使用cyg_thread_get_info函数一次性获取上述三个参数。</p>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a><strong>代码示例</strong></h3><p>使用cyg_thread_get_info可以一次性地获取上述三个参数，<br>而且还可以获取其他线程信息，使用cyg_thread_get_next可以枚举当前运行环境下的所有线程。<br>下面的代码使用cyg_thread_get_next函数枚举所有线程，<br>然后调用cyg_thread_get_info获取线程信息，<br>并打印线程名称和堆栈使用情况。<br>如果堆栈检查选项未使能，那么thread_info.stack_used为0。</p>
<pre><code>cyg_handle_t thread = 0;  
cyg_uint16 id;  
cyg_thread_info thread_info;  

while(cyg_thread_get_next(&amp;thread, &amp;id))  
{  
    if(cyg_thread_get_info(thread, id, &amp;thread_info))  
    {  
        diag_printf(&quot;name: %s, handle: 0x%08x, id: 0x%04x, &quot;  
                &quot;stack_base: 0x%08x, stack_size: %d, stack_used: %d\n&quot;,  
                thread_info.name, thread_info.handle, thread_info.id,  
                thread_info.stack_base, thread_info.stack_size, thread_info.stack_used);  
    }  
    else  
    {  
        diag_printf(&quot;ERROR: get thread info failed, handle: 0x%08x, id: 0x%04x\n&quot;,  
                thread, id);  
    }  
}  </code></pre><h3 id="影响堆栈深度的因素"><a href="#影响堆栈深度的因素" class="headerlink" title="影响堆栈深度的因素"></a><strong>影响堆栈深度的因素</strong></h3><ol>
<li><p>函数调用深度，每调用1次函数至少需要8字节堆栈空间用来保存LR寄存器以及堆栈对齐，<br>因此嵌入式系统应当尽量避免递归调用，递归调用将大大增加对堆栈需求并且引入不确定性，最终可能导致堆栈溢出。</p>
</li>
<li><p>函数复杂度，函数越复杂使用的临时变量越多，<br>临时变量可以保存在寄存器或堆栈中，如果要保存在寄存器中，<br>那么首先要将原寄存器内容压栈保存，因此临时变量无论是保存在寄存器或堆栈都会增加堆栈深度。</p>
</li>
<li><p>编译选项，不同的编译参数会影响堆栈深度，<br>例如使用-O0编译出的代码要比-O2编译出的代码使用更多的堆栈。<br>因为使用-O0时，会将所有变量压栈，而不仅是保存在寄存器，这有利于调试，但会增加堆栈深度。</p>
</li>
<li><p>中断，产生中断时，中断服务函数将被中断线程的上下文保存到被中断线程的堆栈，<br>因此中断也会加深线程堆栈深度，中断嵌套将会加深中断堆栈。</p>
</li>
</ol>
<h3 id="堆栈检查原理"><a href="#堆栈检查原理" class="headerlink" title="堆栈检查原理"></a><strong>堆栈检查原理</strong></h3><p>在线程初始化时，将线程堆栈所有空间填入预设值，eCos预设值为0xDEADBEEF，<br>在调用cyg_thread_measure_stack_usage或者cyg_thread_get_info时从堆栈底部开始检查堆栈存储的内容是否为预设值，<br>如果是预设值说明该地址可能未被使用，如果不是那么说明该地址已经被使用。<br>预设值不是0而是0xDEADBEEF的原因是：变量值为0的可能性非常大，<br>而为0xDEADBEEF的可能性非常小，减少因为变量值与预设值相同而导致计算偏差的可能性。</p>
<pre><code>// kernel/&lt;version&gt;/include/thread.inl:222  
inline void Cyg_HardwareThread::attach_stack(CYG_ADDRESS s_base, cyg_uint32 s_size)  
{  
    ......  
#ifdef CYGFUN_KERNEL_THREADS_STACK_MEASUREMENT  
    {  
        CYG_WORD *base = (CYG_WORD *)s_base;  
        cyg_uint32 size = s_size/sizeof(CYG_WORD);  
        cyg_ucount32 i;  

        for (i=0; i&lt;size; i++) {  
            base[i] = 0xDEADBEEF;  
        }  
    }  
#endif  
    ......  
}  
&lt;/version&gt;  

// kernel/&lt;version&gt;/include/thread.inl:157  
inline cyg_uint32 Cyg_HardwareThread::measure_stack_usage(void)  
{  
    CYG_WORD *base = (CYG_WORD *)stack_base;  
    cyg_uint32 size = stack_size/sizeof(CYG_WORD);  
    cyg_ucount32 i;  

    for (i=0; i&lt;size; i++) {  
        if (base[i] != 0xDEADBEEF)  
            break;  
    }  
    return (size - i)*sizeof(CYG_WORD);  
}  
&lt;/version&gt;  </code></pre><h3 id="中断堆栈"><a href="#中断堆栈" class="headerlink" title="中断堆栈"></a><strong>中断堆栈</strong></h3><p>eCos提供了线程堆栈检查，但没有发现中断堆栈检查，<br>中断堆栈同样会有溢出的风险，因此编写了stkinfo组件对中断堆栈进行检查，<br>此外该组件还可以对不包含内核情况下的应用程序主堆栈进行检查。</p>
<h3 id="stkinfo组件"><a href="#stkinfo组件" class="headerlink" title="stkinfo组件"></a><strong>stkinfo组件</strong></h3><p>目前该组件仅支持Cortex-M架构，可能支持其他架构，但未经验证。</p>
<p>stkinfo扩展组件包提供的接口如下：</p>
<pre><code>typedef struct _cyg_stack_info  
{  
CYG_ADDRWORD    base;  
cyg_uint32      size;  
cyg_uint32      used;  
}cyg_stack_info;  

// initialize interrupt stack with known value.  
void cyg_interrupt_stack_measure_init(void);  

// Measure the stack usage of the interrupt.  
void cyg_get_interrupt_stack_info(cyg_stack_info* info);  

// initialize main stack with known value.  
void cyg_main_stack_measure_init(void);  

// Measure the stack usage of the user program.  
void cyg_get_main_stack_info(cyg_stack_info* info);  </code></pre><ol>
<li><p>堆栈信息数据结构，包括堆栈基址，堆栈大小，已使用堆栈大小。</p>
</li>
<li><p>中断堆栈检查初始化，这个函数将中断堆栈写入预设值，<br>但是仅写到堆栈的下半段，因为eCos使用中断堆栈作为初始化过程的堆栈，<br>因此中断的上半段已经在使用中，不能写入预设值，<br>从这里可以看出，只有在中断堆栈使用量超过堆栈大小一半时检查结果才比较精确，<br>但是用来判断堆栈溢出已经足够啦。</p>
</li>
<li><p>获取中断堆栈信息，包括堆栈已使用大小，<br>如果堆栈已使用量小于堆栈的一半，<br>那么总是返回堆栈的一半大小值，例如堆栈分配1024字节，实际仅使用378字节，<br>该函数返回的使用量是512字节，如果堆栈已使用量超过堆栈的一半，那么返回堆栈的实际使用量。</p>
</li>
<li><p>应用程序主堆栈初始化，与中断堆栈一样仅初始化下半段，如果当前配置包含内核，那么该函数什么都不做。</p>
</li>
<li><p>获取应用程序主堆栈信息，包括堆栈已使用大小，如果当前配置包含内核，那么info数据结构的所有值为0。</p>
</li>
</ol>
<h3 id="安装stkinfo组件"><a href="#安装stkinfo组件" class="headerlink" title="安装stkinfo组件"></a><strong>安装stkinfo组件</strong></h3><p>使用ecosadmin.tcl脚本安装stkinnfo组件，该脚本在eCos源代码的packages子目录下。</p>
<pre><code>cd &lt;ecos-prefix&gt;/packages  
tclsh ecosadmin.tcl add &lt;download-prefix&gt;/stkinfo-&lt;version&gt;.epk  
&lt;/version&gt;&lt;/download-prefix&gt;&lt;/ecos-prefix&gt;  </code></pre><p>也可以手动安装该组件。</p>
<pre><code>tar -xf &lt;download-prefix&gt;/stkinfo-&lt;version&gt;.epk  
cat &lt;download-prefix&gt;/pkgadd.db &gt;&gt; &lt;ecos-prefix&gt;/packages/ecos.db  
cp -R &lt;donwload-prefix&gt;/services &lt;ecos-prefix&gt;/packages/  
&lt;/ecos-prefix&gt;&lt;/donwload-prefix&gt;&lt;/ecos-prefix&gt;&lt;/download-prefix&gt;&lt;/version&gt;&lt;/download-prefix&gt;  </code></pre><h3 id="使用stkinfo组件"><a href="#使用stkinfo组件" class="headerlink" title="使用stkinfo组件"></a><strong>使用stkinfo组件</strong></h3><p>在对堆栈进行检查之前，首先要对堆栈进行预设值填充，<br>为了保证预设值不会覆盖当前正在使用的堆栈空间，<br>要在初始化的早期对堆栈进行预设值填充，<br>因此在hal_system_init函数中调用cyg_interrupt_stack_measure_init进行堆栈预设值填充。<br>hal_system_init是平台HAL的一部分，<br>在系统初始化早期被架构HAL调用。这里以Olimex LPC-1766-STK目标机为例。</p>
<pre><code>// hal/cortexm/lpc17xx/lpc1766stk/&lt;version&gt;/src/lpc1766stk_misc.c:78  
......  
#ifdef CYGPKG_STKINFO  
# include &lt;cyg/stkinfo/stkinfo.h&gt;  
#endif  
......  
    __externC void  
hal_system_init(void)  
{  
#ifdef CYGPKG_STKINFO  
    cyg_interrupt_stack_measure_init();  
    cyg_main_stack_measure_init();  
#endif  
    ......  
}  
......  </code></pre><p>初始化过后，可以在任意时刻调用cyg_get_interrupt_stack_info获取堆栈信息，<br>并打印堆栈的使用情况，<br>将上面打印堆栈使用情况的代码示例添加上中断堆栈后的示例如下，<br>这个示例的完整代码见stkinfo组件的测试用例。</p>
<pre><code>cyg_handle_t thread = 0;  
cyg_uint16 id;  
cyg_thread_info thread_info;  
cyg_stack_info  stack_info;  

cyg_get_interrupt_stack_info(&amp;stack_info);  
diag_printf(&quot;name: %s, &quot;  
        &quot;stack_base: 0x%08x, stack_size: %d, stack_used: &lt;=%d\n&quot;,  
        &quot;ISR/DSR&quot;,  
        stack_info.base, stack_info.size, stack_info.used);  

while(cyg_thread_get_next(&amp;thread, &amp;id))  
{  
    if(cyg_thread_get_info(thread, id, &amp;thread_info))  
    {  
        diag_printf(&quot;name: %s, handle: 0x%08x, id: 0x%04x, &quot;  
                &quot;stack_base: 0x%08x, stack_size: %d, stack_used: %d\n&quot;,  
                thread_info.name, thread_info.handle, thread_info.id,  
                thread_info.stack_base, thread_info.stack_size, thread_info.stack_used);  
    }  
    else  
    {  
        diag_printf(&quot;ERROR: get thread info failed, handle: 0x%08x, id: 0x%04x\n&quot;,  
                thread, id);  
    }  
}  </code></pre><p>Line4声明中断堆栈信息变量。</p>
<p>Line6调用cyg_get_interrupt_stack_info获取堆栈信息。</p>
<p>Line7打印中断堆栈基址、大小、已使用大小。</p>
<h3 id="Statue"><a href="#Statue" class="headerlink" title="Statue"></a><strong>Statue</strong></h3><pre><code>static const unsigned char * const thread_state_str[] = {
    &quot;RUN&quot;,      /* 0 - Running */
    &quot;SLEEP&quot;,    /* 1 - Sleeping */
    &quot;CNTSLP&quot;,   /* 2 - Counted sleep */
    &quot;SLPSET&quot;,   /* 3 - Sleep set */     
    &quot;SUSP&quot;,     /* 4 - Suspended */
    NULL,       /* 5 - INVALID */
    NULL,       /* 6 - INVALID */
    NULL,       /* 7 - INVALID */
    &quot;CREAT&quot;,    /* 8 - Creating */
    NULL,       /* 9 - INVALID */
    NULL,       /* 10 - INVALID */
    NULL,       /* 11 - INVALID */
    NULL,       /* 12 - INVALID */
    NULL,       /* 13 - INVALID */
    NULL,       /* 14 - INVALID */
    NULL,       /* 15 - INVALID */
    &quot;EXIT&quot;      /* 16 - Exiting */
};</code></pre><p>参考代码<strong>&lt;ecos3.0/packages/net/httpd/v3_0/src/monitor.c&gt;</strong></p>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a><strong>Ref</strong></h3><ol>
<li><a href="http://blog.csdn.net/zoomdy/article/details/16970395" target="_blank" rel="noopener">获取eCos堆栈使用情况</a></li>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/ecos-ref.html" target="_blank" rel="noopener">eCos Reference Manual</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/10/lua-run/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/10/lua-run/" class="post-title-link" itemprop="url">Linux lua及依赖库安装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-11T00:00:00+08:00">2015-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>655</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>lua5.2暂时不使用，使用lua5.1+luarocks</p>
<ol>
<li>看readline软件包是否安装（dpkg -l | grep -i 软件名）</li>
<li>是否安装ncurses安装包（ncurses安装包 ）</li>
<li>是否安装libncurses5-dev 或libncursesw5-dev软件包（apt-get install libncurses5-dev）</li>
</ol>
<h2 id="ncurses-5-9-tar-gz"><a href="#ncurses-5-9-tar-gz" class="headerlink" title="ncurses-5.9.tar.gz"></a>ncurses-5.9.tar.gz</h2><pre><code>$ ./configure
$ make
$ sudo make install</code></pre><h2 id="readline-6-3-tar-gz"><a href="#readline-6-3-tar-gz" class="headerlink" title="readline-6.3.tar.gz"></a>readline-6.3.tar.gz</h2><pre><code>$ ./configure
$ make
$ sudo make install
$ sudo ldconfig</code></pre><h2 id="lua-5-2-3-tar-gz"><a href="#lua-5-2-3-tar-gz" class="headerlink" title="lua-5.2.3.tar.gz"></a>lua-5.2.3.tar.gz</h2><pre><code>$ sudo apt-get install libreadline6-dev
$ sudo apt-get install libreadline6-dbg
$ make linux
$ OK</code></pre><h2 id="lua-cjson"><a href="#lua-cjson" class="headerlink" title="lua-cjson"></a>lua-cjson</h2><pre><code>$ vim Makefile
LUA_VERSION = 5.2    
$ make
$ sudo make install</code></pre><h2 id="lua-rocks"><a href="#lua-rocks" class="headerlink" title="lua rocks"></a>lua rocks</h2><p>luarocks会自动安装lua版本，现在版本为5.1，如果版本不一致，会导致找不到安装包，建议使用手动方式安装需要的包；</p>
<p>如果使用luarocks管理包，不要单独安装lua，或者必须保证版本一致为5.1</p>
<pre><code>$ sudo apt-get install luarocks
$ sudo luarocks install luasocket
$ luarocks list
$ sudo luarocks install lua-cjson
$ luarocks search **</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/04/cmake-03/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/04/cmake-03/" class="post-title-link" itemprop="url">cmake 常用命令</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-05T00:00:00+08:00">2015-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>##Commands</p>
<p>头文件路径，相当于编译器参数 -Idir1 -Idir2</p>
<pre><code>INCLUDE_DIRECTORIES( &quot;dir1&quot; &quot;dir2&quot; ... )</code></pre><p>库文件路径。注意：<br>由于历史原因，相对路径会原样传递给链接器。<br>尽量使用FIND_LIBRARY而避免使用这个。</p>
<pre><code>LINK_DIRECTORIES(&quot;dir1&quot; &quot;dir2&quot;)</code></pre><p>收集目录中的文件名并赋值给变量</p>
<pre><code>AUX_SOURCE_DIRECTORY( “sourcedir” variable)</code></pre><p>可执行程序目标</p>
<pre><code>ADD_EXECUTABLE</code></pre><p>库目标</p>
<pre><code>ADD_LIBRARY</code></pre><p>自定义目标</p>
<pre><code>ADD_CUSTOM_TARGET</code></pre><p>目标target1依赖于t2 t3</p>
<pre><code>ADD_DEPENDENCIES( target1 t2 t3 )</code></pre><p>本意是供设置 -D… /D… 等编译预处理需要的宏定义参数，对比 REMOVE_DEFINITIONS()</p>
<pre><code>ADD_DEFINITIONS( &quot;-Wall -ansi&quot;)</code></pre><p>设置单个目标需要链接的库</p>
<pre><code>TARGET_LINK_LIBRARIES( target-name lib1 lib2 ...)</code></pre><p>设置所有目标需要链接的库</p>
<pre><code>LINK_LIBRARIES( lib1 lib2 ...)</code></pre><p>设置目标的属性 OUTPUT_NAME, VERSION, ….</p>
<pre><code>SET_TARGET_PROPERTIES( ... )</code></pre><p>打印输出信息</p>
<pre><code>MESSAGE(...)</code></pre><p>DESTINATION 相对于 ${CMAKE_INSTALL_PREFIX}</p>
<pre><code>INSTALL( FILES “f1” “f2”DESTINATION . )</code></pre><p>变量赋值</p>
<pre><code>SET( VAR value [CACHE TYPE DOCSTRING [FORCE]])</code></pre><p>列表操作</p>
<pre><code>LIST( APPEND|INSERT|LENGTH|GET| REMOVE_ITEM|REMOVE_AT|SORT ...)</code></pre><p>字符串操作</p>
<pre><code>STRING( TOUPPER|TOLOWER|LENGTH| SUBSTRING|REPLACE|REGEX ...)</code></pre><p>转换空格分隔的字符串到列表</p>
<pre><code>SEPARATE_ARGUMENTS( VAR )</code></pre><p>文件操作</p>
<pre><code>FILE( WRITE|READ|APPEND|GLOB| GLOB_RECURSE|REMOVE|MAKE_DIRECTORY ...)</code></pre><p>注意 CMAKE_INCLUDE_PATH</p>
<pre><code>FIND_FILE</code></pre><p>注意 CMAKE_INCLUDE_PATH</p>
<pre><code>FIND_PATH</code></pre><p>注意 CMAKE_LIBRARY_PATH</p>
<pre><code>FIND_LIBRARY
FIND_PROGRAM</code></pre><p>注意 CMAKE_MODULE_PATH</p>
<pre><code>FIND_PACKAGE</code></pre><p>执行外部程序</p>
<pre><code>EXEC_PROGRAM( bin [work_dir] ARGS &lt;..&gt; [OUTPUT_VARIABLE var] [RETURN_VALUE var] )</code></pre><p>设置选项</p>
<pre><code>OPTION( OPTION_VAR “description” [initial value] )</code></pre><p>##Ref</p>
<p>引用文档：</p>
<ol>
<li><a href="http://www.cmake.org/cmake/help/v3.0/manual/cmake-language.7.html#syntax" target="_blank" rel="noopener">cmake syntax</a></li>
<li><a href="http://www.cmake.org/Wiki/CMake_Useful_Variables" target="_blank" rel="noopener">CMake常用变量列表</a></li>
<li><a href="http://www.cmake.org/cmake/help/v3.0/manual/cmake-commands.7.html" target="_blank" rel="noopener">cmake command</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/04/git-push/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/04/git-push/" class="post-title-link" itemprop="url">github push避免输入用户名和密码</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-05T00:00:00+08:00">2015-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/GitHub/" itemprop="url" rel="index">
                    <span itemprop="name">GitHub</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>601</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>github上传代码时，每次都需要输入用户名和密码，原因是使用了https方式进行push：</p>
<pre><code>$ git clone https://github.com/breezetemple/breezetemple.github.com.git</code></pre><p>使用以下命令更换为使用ssh方式：</p>
<pre><code>$ git remote -v
origin  https://github.com/breezetemple/breezetemple.github.com.git (fetch)
origin  https://github.com/breezetemple/breezetemple.github.com.git (push)
$ git remote rm origin
$ git remote add origin git@github.com:breezetemple/breezetemple.github.com.git
$ git push origin master 
Everything up-to-date</code></pre><p>或者使用如下命令初始化：</p>
<pre><code>git clone git@github.com:breezetemple/breezetemple.github.com.git</code></pre><p>另外，需要将ssh pub key上传到github：</p>
<pre><code>$ ls ~/.ssh/id_rsa.pub                
/home/yanwzh/.ssh/id_rsa.pub
$ xclip -sel clip &lt; ~/.ssh/id_rsa.pub</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/04/cmake-02/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/04/cmake-02/" class="post-title-link" itemprop="url">cmake使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-05T00:00:00+08:00">2015-03-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<h2 id="A-Basic-Starting-Point-Step1"><a href="#A-Basic-Starting-Point-Step1" class="headerlink" title="A Basic Starting Point (Step1)"></a>A Basic Starting Point (Step1)</h2><p>CMakeLists.txt文件：</p>
<pre><code>cmake_minimum_required (VERSION 2.6)
project (Tutorial)
add_executable(Tutorial tutorial.cxx)</code></pre><p>cmake_minimum_required：是判断需要cmake的最小版本号。所有程序都需要这个。</p>
<p>project:用于指定工程的名字。</p>
<p>add_executable命令用于指定程序从哪些源文件生成。此例中 程序 Tutorial则是tutorial.cxx 源文件生成。</p>
<p><strong>添加版本号和配置头文件：</strong></p>
<pre><code>cmake_minimum_required (VERSION 2.6)
project (Tutorial)
# The version number.
set (Tutorial_VERSION_MAJOR 1)
set (Tutorial_VERSION_MINOR 0)

# configure a header file to pass some of the CMake settings
# to the source code
configure_file (
        &quot;${PROJECT_SOURCE_DIR}/TutorialConfig.h.in&quot;
        &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot;
        )

# add the binary tree to the search path for include files
# so that we will find TutorialConfig.h
include_directories(&quot;${PROJECT_BINARY_DIR}&quot;)

# add the executable
add_executable(Tutorial tutorial.cxx)</code></pre><p>因为配置文件会被生成到二进制目录中，所以我们需要把二进制目录加入到头文件搜索路径中<br>(include），然后我们在源码目录中建立如下 ‘TutorialConfig.h.in’：</p>
<pre><code>    // the configured options and settings for Tutorial
    #define Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@
    #define Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@</code></pre><p>执行cmake时，配置文件头文件中@Tutorial_VERSION_MAJOR@ 和 @Tutorial_VERSION_MINOR@的值将会被<br>CMakeLists.txt文件中指定的值所替换。然后我们可以在源文件tutorial.cxx引用这个所定义的宏：</p>
<pre><code>fprintf(stdout,&quot;%s Version %d.%d\n&quot;,
    argv[0],
    Tutorial_VERSION_MAJOR,
    Tutorial_VERSION_MINOR);
fprintf(stdout,&quot;Usage: %s number\n&quot;,argv[0]);</code></pre><h2 id="Adding-a-Library-Step-2"><a href="#Adding-a-Library-Step-2" class="headerlink" title="Adding a Library (Step 2)"></a>Adding a Library (Step 2)</h2><p>添加一个库到工程中：</p>
<pre><code>add_library(MathFunctions mysqrt.cxx)</code></pre><p>将mysqrt.cxx源文件打包为库文件MathFunctions，<br>使用add_subdirectory命令指示这个目录需要进行编译。<br>用include_directories命令添加MathFunctions目录，<br>是为了能让编译程序找到 mysqrt.h 头文件。<br>然后用target_link_libraries命令把生成的库链接到执行文件中：</p>
<pre><code>#增加头文件搜索目录
include_directories (&quot;${PROJECT_SOURCE_DIR}/MathFunctions&quot;)
#增加子目录
add_subdirectory (MathFunctions) 
# 生成执行文件
add_executable (Tutorial tutorial.cxx)
#链接库
target_link_libraries (Tutorial MathFunctions)</code></pre><h2 id="Installing-and-Testing-Step-3"><a href="#Installing-and-Testing-Step-3" class="headerlink" title="Installing and Testing (Step 3)"></a>Installing and Testing (Step 3)</h2><p>在工程中增加一个安装规则和测试支持。我们需要把库安装到bin目录下，把头文件安装到include下：</p>
<pre><code>install (TARGETS MathFunctions DESTINATION bin)
install (FILES MathFunctions.h DESTINATION include)</code></pre><p>对于这个向导程序，需要在顶层CMakeList.txt文件中增加下面行，安装执行文件和头文件。</p>
<pre><code># 安装程序 Tutorial到安装目录的bin子目录中
install (TARGETS Tutorial DESTINATION bin)
#安装头文件到安装目录中的include目录中
install (FILES &quot;${PROJECT_BINARY_DIR}/TutorialConfig.h&quot; DESTINATION include)</code></pre><p>CMake用变量CMAKE_INSTALL_PREFIX决定安装的根目录。</p>
<h2 id="常用cmake命令"><a href="#常用cmake命令" class="headerlink" title="常用cmake命令"></a>常用cmake命令</h2><h3 id="检查CMake版本"><a href="#检查CMake版本" class="headerlink" title="检查CMake版本"></a>检查CMake版本</h3><p>cmake版本至少为2.8</p>
<pre><code>cmake_minimum_required(VERSION 2.8)</code></pre><h3 id="定义工程名称"><a href="#定义工程名称" class="headerlink" title="定义工程名称"></a>定义工程名称</h3><p>工程名为helloworld</p>
<pre><code>project(helloworld)</code></pre><h3 id="查找源文件"><a href="#查找源文件" class="headerlink" title="查找源文件"></a>查找源文件</h3><p>查找当前目录下所有的源文件并保存到SRC_LIST变量里</p>
<pre><code>aux_source_directory(. SRC_LIST)</code></pre><p>查找src目录下所有以cmake开头的文件并保存到CMAKE_FILES变量里</p>
<pre><code>file(GLOB CMAKE_FILES &quot;src/cmake*&quot;)</code></pre><p>file命令同时支持目录递归查找</p>
<pre><code>file(GLOB_RECURSE CMAKE_FILES &quot;src/cmake*&quot;)</code></pre><p>按照官方文档的说法，不建议使用file的GLOB指令来收集工程的源文件，原文解释如下：</p>
<p>We do not recommend using GLOB to collect a list of source files from your source tree.<br>If no CMakeLists.txt file changes when a source is added or removed<br>then the generated build system cannot know when to ask CMake to regenerate.<br>大意就是，GLOB收集的源文件增加或删除，而CMakeLists.txt没有发生修改时，CMake不能识别这些文件。<br>其实，当CMakeLists.txt使用aux_source_directory和file glob查找工程源文件时，如果添加或删除源文件，都需要重新运行CMake。</p>
<h3 id="set命令"><a href="#set命令" class="headerlink" title="set命令"></a>set命令</h3><p>经常配合set命令使用的CMake变量，使用set(variable value)进行设置。</p>
<ul>
<li>CMAKE_VERBOSE_MAKEFILE on 输出详细的编译和链接信息</li>
<li>CMAKE_CXX_COMPILER “g++” c++编译器</li>
<li>CMAKE_CXX_FLAGS “-Wall” c++编译器参数<ul>
<li>CMAKE_CXX_FLAGS_DEBUG debug版本对应的编译器参数</li>
<li>CMAKE_CXX_FLAGS_RELEASE release版本对应的编译器参数</li>
</ul>
</li>
<li>EXECUTABLE_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/bin 可执行文件的输出目录</li>
<li>LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/lib 链接库的输出目录</li>
</ul>
<p>set命令还可以设置自定义变量，比如</p>
<pre><code>set(MY_GREETINGS &quot;hello world&quot;)</code></pre><h3 id="包含目录和链接目录"><a href="#包含目录和链接目录" class="headerlink" title="包含目录和链接目录"></a>包含目录和链接目录</h3><p>将./include和./abc加入包含目录列表</p>
<pre><code>include_directories(
        ./include
        ./abc
        )</code></pre><p>将./lib加入编译器链接阶段的搜索目录列表</p>
<pre><code>link_directories(
        ./lib
        )</code></pre><h3 id="添加生成目标"><a href="#添加生成目标" class="headerlink" title="添加生成目标"></a>添加生成目标</h3><p>使用SRC_LIST源文件列表里的文件生成一个可执行文件hello</p>
<pre><code>add_executable(hello ${SRC_LIST})</code></pre><p>使用SRC_LIST源文件列表里的文件生成一个静态链接库libhello.a</p>
<pre><code>add_library(hello STATIC ${SRC_LIST})</code></pre><p>使用SRC_LIST源文件列表里的文件生成一个动态链接库libhello.so</p>
<pre><code>add_library(hello SHARED ${SRC_LIST})</code></pre><p>将若干库文件链接到生成的目标hello(libhello.a或libhello.so)</p>
<pre><code>target_link_libraries(hello A B.a C.so)</code></pre><p><strong>需要注意的是，target_link_libraries里库文件的顺序符合gcc链接顺序的规则，<br>即被依赖的库放在依赖它的库的后面，比如上面的命令里，<br>libA.so可能依赖于libB.a和libC.so，<br>如果顺序有错，链接时会报错。<br>还有一点，B.a会告诉CMake优先使用静态链接库libB.a，<br>C.so会告诉CMake优先使用动态链接库libC.so，也可直接使用库文件的相对路径或绝对路径。</strong></p>
<h3 id="自定义链接选项"><a href="#自定义链接选项" class="headerlink" title="自定义链接选项"></a>自定义链接选项</h3><p>有时候需要自定义链接选项，比如需要单独对B.a使用–whole-archive选项，可以</p>
<pre><code>target_link_libraryies(hello A -Wl,--whole-archive B.a -Wl,--no-whole-archive C.so)</code></pre><h3 id="自定义Makefile目标"><a href="#自定义Makefile目标" class="headerlink" title="自定义Makefile目标"></a>自定义Makefile目标</h3><p>运行下面的whatever目标make whatever，会先创建一个目录./hello，然后将当前目录的a.txt拷贝到新建的./hello目录里。</p>
<pre><code>add_custom_command(
        OUTPUT ./hello/a.txt
        COMMAND mkdir -p ./hello 
        cp a.txt ./hello
        DEPENDS a.txt
        )
add_custom_target(whatever DEPENDS ./hello/a.txt)</code></pre><p>自定义目标还可以使用add_dependencies命令加入到其他目标的依赖列表里，当执行make demo时，whatever目标会被自动调用。</p>
<pre><code>add_executable(demo ${SRC_LIST})
add_dependencies(demo whatever)</code></pre><h3 id="其他常用命令"><a href="#其他常用命令" class="headerlink" title="其他常用命令"></a>其他常用命令</h3><p>包含其他目录的CMakeLists.txt</p>
<pre><code>include(/path/to/another/CMakeLists.txt)</code></pre><p>if命令</p>
<pre><code>if(${MY_BUILD_TYPE} MATCHES &quot;debug&quot;)
    ...
else()
    ...
endif()</code></pre><p>list命令</p>
<pre><code>list(APPEND SRC_LIST 
        a.cpp
        b.cpp
    )

list(REMOVE_ITEM SRC_LIST
        a.cpp
    )</code></pre><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><pre><code>CMAKE_MINIMUM_REQUIRED(VERSION 2.8)
PROJECT(demo)

# add include dir
INCLUDE_DIRECTORIES(.)
INCLUDE_DIRECTORIES(lua/src)

# add source dir
AUX_SOURCE_DIRECTORY(lua/src/           SRCS)
AUX_SOURCE_DIRECTORY(lua/lua-cjson-xml/ SRCS)

ADD_LIBRARY(demo ${SRCS})

SET(CMAKE_BUILD_TYPE &quot;Release&quot;)

ADD_DEFINITIONS(-D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE -Wno-deprecated-declarations )

SET(CMAKE_EXE_LINKER_FLAGS &quot;--static&quot;)
ADD_EXECUTABLE(test main.cpp)
TARGET_LINK_LIBRARIES(A demo jansson dl pthread curl z)

INSTALL(FILES demo.hpp http.hpp DESTINATION include)</code></pre><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>引用文档：</p>
<ol>
<li><a href="http://www.cmake.org/cmake/help/v3.0/manual/cmake-language.7.html#syntax" target="_blank" rel="noopener">cmake syntax</a></li>
<li><a href="http://www.cmake.org/cmake-tutorial/" target="_blank" rel="noopener">cmake tutorial</a></li>
<li><a href="http://www.cmake.org/Wiki/CMake_Useful_Variables" target="_blank" rel="noopener">CMake常用变量列表</a></li>
<li><a href="http://www.cmake.org/documentation/" target="_blank" rel="noopener">CMake文档列表</a></li>
<li><a href="http://www.cmake.org/cmake/help/v3.0/manual/cmake-modules.7.html" target="_blank" rel="noopener">cmake modules</a></li>
<li><a href="http://blog.atime.me/note/cmake.html" target="_blank" rel="noopener">CMake 使用总结</a></li>
<li><a href="http://www.cnblogs.com/coderfenghc/archive/2013/01/20/2846621.html" target="_blank" rel="noopener">CMake 用法导览</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/03/cmake/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/03/cmake/" class="post-title-link" itemprop="url">cmake语法简介</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-04 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-04T00:00:00+08:00">2015-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-20 10:50:17" itemprop="dateModified" datetime="2020-07-20T10:50:17+08:00">2020-07-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>CMake意为cross-platform make，可用于管理c/c++工程。<br>CMake解析配置文件CMakeLists.txt生成Makefile，相比直接用Makefile管理工程，CMake更灵活和简单。</p>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>Cmake的输入是源码目录下的 ‘CMakeLists.txt’ 文件，或者后缀为’.cmake’。<br>这个文件可以用 ‘include’ 或者 ‘add_subdirectory’ 命令增加入其它的输入文件。组织结构有以下几部分组成：</p>
<ul>
<li><strong>Directories (CMakeLists.txt)</strong></li>
<li><strong>Scripts (&lt;script&gt;.cmake)</strong></li>
<li><strong>Modules (&lt;module&gt;.cmake)</strong></li>
</ul>
<h3 id="Directories"><a href="#Directories" class="headerlink" title="Directories"></a>Directories</h3><p>顶层目录下的 ‘CMakeLists.txt’ 文件可以使用命令 ‘add_subdirectory’ 来添加子目录，<br>此子目录下必须存在 ‘CMakeLists.txt’ 文件</p>
<pre><code>add_subdirectory(source_dir [binary_dir] [EXCLUDE_FROM_ALL])</code></pre><h3 id="Scripts"><a href="#Scripts" class="headerlink" title="Scripts"></a>Scripts</h3><p>脚本模式可以使用以下命令运行给定的CMake源文件中的命令，但是不会构建系统。</p>
<pre><code>cmake [&lt;options&gt;] (&lt;path-to-source&gt; | &lt;path-to-existing-build&gt;)
cmake [(-D&lt;var&gt;=&lt;value&gt;)...] -P &lt;cmake-script-file&gt;
cmake --build &lt;dir&gt; [&lt;options&gt;] [-- &lt;build-tool-options&gt;...]
cmake -E &lt;command&gt; [&lt;options&gt;]
cmake --find-package &lt;options&gt;...</code></pre><h3 id="Modeles"><a href="#Modeles" class="headerlink" title="Modeles"></a>Modeles</h3><p>使用命令 ‘include’ 来导入 ‘<module>.cmake’ 源文件</p>
<pre><code>include(&lt;file|module&gt; [OPTIONAL] [RESULT_VARIABLE &lt;VAR&gt;] [NO_POLICY_SCOPE])</code></pre><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="编码"><a href="#编码" class="headerlink" title="编码"></a>编码</h3><p>使用7-bit ASCII进行编码，新行可使用 ‘\n’ 或 ‘\r\n’，将被转换为 ‘\n’ 做为输入文件读取</p>
<h3 id="源文件"><a href="#源文件" class="headerlink" title="源文件"></a>源文件</h3><p>CMakeList.txt文件是由注释、命令和空白字符组成。</p>
<h3 id="命令调用"><a href="#命令调用" class="headerlink" title="命令调用"></a>命令调用</h3><p>命令是由：命令名、（、空格分隔的参数、）组成。<br>‘CMakeLists.txt’ 文件中命令调用大小写不敏感的。 例如：</p>
<pre><code>command (args….)</code></pre><p>上面的command可以是一个命令名；或者是一个宏；也可以是一个函数名。</p>
<h3 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h3><p>args是以空格分隔的参数例表（如果参数中包含空格，则要加双引号）</p>
<p>除了用于分隔参数的空白字符（空格、换行号、tabs）都是被忽略不计的。任何包含在双引号中的字符都做为一个参数。</p>
<p>三种参数类型：括号、引号和普通</p>
<p><strong>Bracket Argument</strong>:</p>
<pre><code>message([=[
This is the first line in a bracket argument with bracket length 1.
No \-escape sequences or ${variable} references are evaluated.
This is always one argument even though it contains a ; character.
The text does not end on a closing bracket of length 0 like ]].
It does end in a closing bracket of length 1.
]=])</code></pre><p><strong>Quoted Argument</strong>:</p>
<pre><code>message(&quot;This is a quoted argument containing multiple lines.
This is always one argument even though it contains a ; character.
Both \\-escape sequences and ${variable} references are evaluated.
The text does not end on an escaped double-quote like \&quot;.
It does end in an unescaped double quote.
&quot;)</code></pre><p>可以在行尾添加 ‘&#39; 进行行连接，例如：</p>
<pre><code>message(&quot;\
This is the first line of a quoted argument. \
In fact it is the only line but since it is long \
the source code uses line continuation.\
&quot;)</code></pre><p><strong>Unquoted Argument</strong>:</p>
<pre><code>foreach(arg
        NoSpace
        Escaped\ Space
        This;Divides;Into;Five;Arguments
        Escaped\;Semicolon
    )
    message(&quot;${arg}&quot;)
endforeach()</code></pre><p>前两种都是提供一个参数，而且不会进行转义，最后一个需要注意转义！</p>
<h3 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h3><p>‘&#39;后跟的部分字符进行转义:</p>
<pre><code>escape_sequence  ::=  escape_identity | escape_encoded | escape_semicolon
escape_identity  ::=  &#39;\(&#39; | &#39;\)&#39; | &#39;\#&#39; | &#39;\&quot;&#39; | &#39;\ &#39; |
                    &#39;\\&#39; | &#39;\$&#39; | &#39;\@&#39; | &#39;\^&#39;
escape_encoded   ::=  &#39;\t&#39; | &#39;\r&#39; | &#39;\n&#39;
escape_semicolon ::=  &#39;\;&#39;</code></pre><p>‘(‘,’)’,’#’,’”‘,’ ‘,’&#39;,’$’,‘@’,’^’ 进行简单转义；’\t’ : tab ‘\r’ : return ‘\n’ : newline；’;‘ 用于参数中不表示隔离参数</p>
<h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><p>变量引用的形式为 ‘${variable_name}’，替换为变量的值，或空字符串（变量未赋值）。</p>
<p>变量引用可以嵌套，从内到外展开，例如 ‘${outer_${inner_variable}_variable}’</p>
<p>环境变量引用形式为 ‘$ENV{VAR}’</p>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><p>注释由一个不是 （括号中的参数、引用参数或’&#39;转义）一部分的’#’字符开始，有行注释和括号注释：</p>
<p>括号注释：</p>
<pre><code>#[[This is a bracket comment.
It runs until the close bracket.]]
message(&quot;First Argument\n&quot; #[[Bracket Comment]] &quot;Second Argument&quot;)</code></pre><p>行注释：</p>
<pre><code># This is a line comment.
message(&quot;First Argument\n&quot; # This is a line comment :)
        &quot;Second Argument&quot;) # This is a line comment.</code></pre><h2 id="控制结构"><a href="#控制结构" class="headerlink" title="控制结构"></a>控制结构</h2><h3 id="Conditional-Blocks"><a href="#Conditional-Blocks" class="headerlink" title="Conditional Blocks"></a>Conditional Blocks</h3><pre><code># some_command will be called if the variable&#39;s value is not:
# empty, 0, N, NO, OFF, FALSE, NOTFOUND, or -NOTFOUND. 
if(var)
    some_command(...)
elseif()
    some_command(...)
else()
    some_command(...)
endif() </code></pre><h3 id="Loops"><a href="#Loops" class="headerlink" title="Loops"></a>Loops</h3><pre><code>set(VAR a b c) 

# loop over a, b,c with the variable f 
foreach(f ${VAR}) 
    message(${f}) 
endforeach(f)

while(condition)
    command(args ...)
    command(args ...)
endwhile(condition)</code></pre><h3 id="Command-Definitions"><a href="#Command-Definitions" class="headerlink" title="Command Definitions"></a>Command Definitions</h3><p>macro()/endmacro() 和 function()/endfunction() 进行宏和函数的定义：</p>
<pre><code># define a macro hello 
macro(hello MESSAGE)
    message(${MESSAGE})
endmacro(hello) 

# call the macro with the string &quot;hello world&quot; 
hello(&quot;hello world&quot;) 

# define a function hello 
function(hello MESSAGE)
    message(${MESSAGE}) 
endfunction(hello)</code></pre><h3 id="Variables"><a href="#Variables" class="headerlink" title="Variables"></a>Variables</h3><p>变量命名大小写敏感，set()/unset()对变量进行赋值操作：</p>
<pre><code>set (VAR &quot; hello world &quot;)   #赋值
unset (VAR)                 #取消赋值</code></pre><p>CMake支持简单的变量：字符串或字符串列表。用${VAR} 语法得到变量的引用。</p>
<p>可以用一个set命令把一个字符串列表设置为一个变量，然后把这个变量传递给需要传递多参数的函数。例如：</p>
<pre><code>set(Foo a b c)
command(${Foo})</code></pre><p>上面两行等效 </p>
<pre><code>command(a b c)</code></pre><p>如果你想传把一个字符串列表做为一个单独的参数传递给函数，用双引号包含它。例如：</p>
<pre><code>Command(“${Foo}”)
#等效于
command(“a b c”)</code></pre><p>环境变量：</p>
<p>用$ENV{VAR}得到环境变量的引用</p>
<p>设置环境变量：</p>
<p>Set(ENV{VAR} /home)</p>
<h3 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h3><p>字符串(string)和字符串列表（lists）</p>
<p>CMake的基本数据类型是字符串（string）。<br>CMake也支持由字符串组成的字符串列表。字符串列表可以由；或空格分隔的组成。例如：下面设置变量var是等效的。</p>
<pre><code>set(var a;b;c)
set(var a b c)</code></pre><p>字符串列表可以用 foreach命令叠代（iterated）或list命令操作。</p>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>一些CMake命令（如if和 string），能使用正则表达式或使用正则表达式作为参数。<br>一个简单的形式，一个正则表达式用于在一个序列的字符串中精确查找一个字符。<br>然而在大多时候，一个精确查找是不知道的或者只是匹配最前或者最后字符。<br>所以这里用正则表达式进行不同的转换。<br>Cmake标准是可被描述的。这个描述是基于开源的正则表达式类（Texas Instruments）。</p>
<ul>
<li>^ 匹配一行或一字符串开头</li>
<li>$匹配一行或一字符串结尾</li>
<li>.匹配单一字符或一个新行</li>
<li>[ ]匹配括号中的任一字符</li>
<li>[^ ] 匹配不在括号内的任一字符</li>
<li>[-] 匹配指定范围内的字符</li>
<li>* 匹配0次或多次</li>
<li>+ 匹配一次或多次</li>
<li>? 匹配0次或一次</li>
<li>()保存匹配的表达式并用随后的替换它</li>
</ul>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol>
<li><a href="http://www.cmake.org/cmake/help/v3.0/manual/cmake-language.7.html#syntax" target="_blank" rel="noopener">cmake syntax</a></li>
<li><a href="http://www.cmake.org/cmake-tutorial/" target="_blank" rel="noopener">cmake tutorial</a></li>
<li><a href="http://www.cmake.org/Wiki/CMake_Useful_Variables" target="_blank" rel="noopener">CMake常用变量列表</a></li>
<li><a href="http://www.cmake.org/documentation/" target="_blank" rel="noopener">CMake文档列表</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/27/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><span class="page-number current">28</span><a class="page-number" href="/page/29/">29</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/29/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Breeze.Temple"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Breeze.Temple</p>
  <div class="site-description" itemprop="description">Breeze.Temple</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">451</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">481</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/breezetemple" title="GitHub &rarr; https://github.com/breezetemple" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org" title="BitBucket &rarr; https://bitbucket.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-bitbucket"></i>BitBucket</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://breezetemple.github.io/" title="http://breezetemple.github.io/" rel="noopener" target="_blank">Breeze.Temple's HomePage</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Breeze.Temple</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">18:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  


  <link rel="stylesheet" href="/js/highlight/styles/solarized-dark.css">
  <script src="/js/highlight/highlight.pack.js"></script>
  <script type="text/javascript">
      $(function() {
          hljs.initHighlighting();
      });
  </script>

</body>
</html>

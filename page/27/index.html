<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Breeze.Temple">
<meta property="og:type" content="website">
<meta property="og:title" content="IT日记">
<meta property="og:url" content="http://yoursite.com/page/27/index.html">
<meta property="og:site_name" content="IT日记">
<meta property="og:description" content="Breeze.Temple">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Breeze.Temple">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>IT日记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Life is Now.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/27/unused-sourcecode-ld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/27/unused-sourcecode-ld/" class="post-title-link" itemprop="url">不链接未使用代码</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-28T00:00:00+08:00">2015-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>833</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="默认编译"><a href="#默认编译" class="headerlink" title="默认编译"></a>默认编译</h2><p>默认编译环境下.c文件会编译为.o文件，当链接时会链接.o文件，整个.o文件为一个section，当此section存在无用函数时会造成控件浪费。</p>
<pre><code>gcc -o main main.c x.o</code></pre><p>可以使用命令来查看二进制可执行文件中的符号表，所有函数都链接进去：</p>
<pre><code>nm -S main
readelf -S x.o</code></pre><p>GCC链接时，按照section来链接，不论section中符号是否都使用到！</p>
<h2 id="拆分默认section"><a href="#拆分默认section" class="headerlink" title="拆分默认section"></a>拆分默认section</h2><pre><code>-ffunction-sections （为每个function函数分配独立的section）
-fdata-sections （为每个data item数据项分配独立的section）

gcc -c -ffunction-sections -fdata-sections x.c x.o</code></pre><p>x.o大小会明显变大，因为section大量增加。</p>
<h2 id="排除不链接section-Wl-–gc-sections"><a href="#排除不链接section-Wl-–gc-sections" class="headerlink" title="排除不链接section -Wl,–gc-sections"></a>排除不链接section -Wl,–gc-sections</h2><pre><code>-Wl,的意思是将后面的内容传递给链接器
--gc-sections是链接器参数，不链接未使用的section

gcc -Wl,--gc-sections -o main main.c x.o</code></pre><p>可以保证代码量最优。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/10/gcc-attributes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/10/gcc-attributes/" class="post-title-link" itemprop="url">几个有用的gcc attribute</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-11T00:00:00+08:00">2015-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="align属性"><a href="#align属性" class="headerlink" title="align属性"></a>align属性</h2><p>align属性不仅可以修饰变量，类型， 还可以修饰函数， 举个例子：</p>
<h3 id="修饰变量"><a href="#修饰变量" class="headerlink" title="修饰变量"></a>修饰变量</h3><pre><code>int a = 0;

int main(void)
{
    printf(&quot;a = %d\n&quot;, a);
}</code></pre><p>用gdb看下变量a的地址：</p>
<pre><code>(gdb) p/x &amp;a
$1 = 0x60087c</code></pre><p>变量a地址是编译器随意生成的， 这个例子碰巧分配到了8字节对齐的位置上。<br>用align属性修饰下：</p>
<pre><code>int a __attribute__((aligned(8))) = 0;

(gdb) p/x &amp;a
$1 = 0x600880</code></pre><p>编译器会把变量a生成在8字节对齐的内存地址上。</p>
<h3 id="修饰类型"><a href="#修饰类型" class="headerlink" title="修饰类型"></a>修饰类型</h3><pre><code>int a __attribute__((aligned(8))) = 0;

struct test {
    int a;
} __attribute__((aligned(8)));

struct test aa;

int main(void)
{
    printf(&quot;a = %d\n&quot;, a);
}</code></pre><p>经过align修饰后，struct test数据结构定义的所有变量都会出现在8字节对齐的内存上。</p>
<pre><code>(gdb) p/x &amp;aa
$1 = 0x600888</code></pre><h3 id="修饰函数"><a href="#修饰函数" class="headerlink" title="修饰函数"></a>修饰函数</h3><pre><code>void test1(void) __attribute__((aligned(2)));

void  test1(void)
{
    printf(&quot;hello, world.\n&quot;);
}

int main(void)
{
    test1();
}</code></pre><p>经过align修饰后，函数出现在8字节对齐的内存上。</p>
<pre><code>(gdb) p test1 
$1 = {&lt;text variable, no debug info&gt;} 0x400538 &lt;test1&gt;</code></pre><h2 id="always-inline属性"><a href="#always-inline属性" class="headerlink" title="always_inline属性"></a>always_inline属性</h2><p>gcc有个inline关键字，可以将一个函数定义为内嵌形式：</p>
<pre><code>static inline void test2(void);

void test1(void)
{
    printf(&quot;hehe.\n&quot;);
}

void test2(void)
{
    asm(&quot;nop&quot;);
}

void test(void)
{
    test1();
    test2();
}

int main(void)
{
    test();
}</code></pre><p>按照inline的定义， test在调用test2函数的时候， 会直接将test2函数的代码展开在test函数内部，<br>这样就减少了一次函数调用过程， 加快了代码的执行速度， 用gdb反汇编看下：</p>
<pre><code>(gdb) disass test
Dump of assembler code for function test:
0x00000000004004a8 :    push   %rbp
0x00000000004004a9 :    mov    %rsp,%rbp
0x00000000004004ac :    callq  0x400498 
0x00000000004004b1 :    callq  0x4004b8 
0x00000000004004b6 :   leaveq
0x00000000004004b7 :   retq
End of assembler dump.</code></pre><p>你可以看到，gcc并没有把test2函数展开，明明已经使用inline修饰了。<br>因为虽然用inline做了修饰，但是gcc会根据代码的逻辑来优化到底有没有必要使用inline代码。<br>像这种简单的代码，用inline代码效果不大，因此gcc并没有按照inline要求来生成代码。</p>
<pre><code>static inline void test2(void) __attribute__((always_inline));
加入always_inline属性后呢？
(gdb) disass test
Dump of assembler code for function test:
0x00000000004004a8 :    push   %rbp
0x00000000004004a9 :    mov    %rsp,%rbp
0x00000000004004ac :    callq  0x400498 
0x00000000004004b1 :    nop
0x00000000004004b2 :   leaveq
0x00000000004004b3 :   retq
End of assembler dump.</code></pre><p>这次你会看到在调用完test1后， 直接把test2的代码， 也是nop语句加入在了test函数内。</p>
<h2 id="constructor-amp-destructor"><a href="#constructor-amp-destructor" class="headerlink" title="constructor &amp; destructor"></a>constructor &amp; destructor</h2><p>很犀利的2个属性，用于修饰某个函数，经过constructor属性修饰过的函数，<br>可以在main函数运行前就可以先运行完毕，同理destructor在进程exit之前执行。</p>
<pre><code>#include&lt;stdio.h&gt;

void test1(void) __attribute__((aligned(8)));

void  test1(void)
{
    printf(&quot;hello, world.\n&quot;);
}

void __attribute__((constructor)) test2(void)
{
    printf(&quot;hehe.\n&quot;);
}

void __attribute__((destructor)) test3(void)
{
    printf(&quot;haha.\n&quot;);
}

int main(void)
{
    test1();
}</code></pre><p>执行输出如下：</p>
<pre><code>➜  /data/test/1  &gt; ./main 
hehe.
hello, world.
haha.</code></pre><h2 id="fastcall-amp-regparm属性"><a href="#fastcall-amp-regparm属性" class="headerlink" title="fastcall &amp; regparm属性"></a>fastcall &amp; regparm属性</h2><p>在c语言中，通过函数传递参数通常使用堆栈的方式，如：<br>    test(a, b, c);<br>参数从右到左依次压入堆栈c, b, a。<br>函数执行完后，还要把这3个参数从堆栈中弹出来，如果一个函数每秒钟有上万次调用，<br>这将非常耗时，为了加快代码运行速度，gcc扩展了fastcall和regparm2个属性，<br>对于fastcall属性，一个函数的前2个参数分别通过ecx和edx来传递，剩下的则是使用堆栈来传递。<br>对于regparm，它的用法如下regparm(n), 函数的1到n个参数，分别通过eax, edx, ecx来传递，最多就使用3个寄存器，<br>其余参数通过堆栈来传递。注意这2个属性只在x86平台有效。很对编译平台fastcall默认开启。</p>
<pre><code>int __attribute__((fastcall)) test1(int a, int b)
{
    return a + b;
}

int __attribute__((regparm(2))) test2(int a, int b)
{
    return a + b;
}

int test3(int a, int b)
{
    return a + b;
}

int main(void)
{
    test1(1, 2);
    test2(1, 2);
    test3(1, 2);
}

(gdb) disass test1
Dump of assembler code for function test1:
0x08048354 :   push   %ebp
0x08048355 :   mov    %esp,%ebp
0x08048357 :   sub    $0x8,%esp 在堆栈里先分配了8个字节的空间
0x0804835a :   mov    %ecx,-0x4(%ebp) 将ecx的值放入第一个变量里
0x0804835d :   mov    %edx,-0x8(%ebp) 将edx的值放入第二个变量里
0x08048360 :  mov    -0x8(%ebp),%eax
0x08048363 :  add    -0x4(%ebp),%eax
0x08048366 :  leave
0x08048367 :  ret
End of assembler dump.

(gdb) disass test2
Dump of assembler code for function test2:
0x08048368 :   push   %ebp
0x08048369 :   mov    %esp,%ebp
0x0804836b :   sub    $0x8,%esp
0x0804836e :   mov    %eax,-0x4(%ebp)
0x08048371 :   mov    %edx,-0x8(%ebp)
0x08048374 :  mov    -0x8(%ebp),%eax
0x08048377 :  add    -0x4(%ebp),%eax
0x0804837a :  leave
0x0804837b :  ret
End of assembler dump.

(gdb) disass test3
Dump of assembler code for function test3:
0x0804837c :   push   %ebp
0x0804837d :   mov    %esp,%ebp
0x0804837f :   mov    0xc(%ebp),%eax 堆栈形式来传递参数，0×c(%ebp)保存第二个参数
0x08048382 :   add    0x8(%ebp),%eax 堆栈形式来传递参数，0×8(%ebp)保存第一个参数
0x08048385 :   pop    %ebp
0x08048386 :  ret
End of assembler dump.</code></pre><h2 id="packed属性"><a href="#packed属性" class="headerlink" title="packed属性"></a>packed属性</h2><p>用于修饰struct, union, enum数据结构，看如下的例子：</p>
<pre><code>struct test {
    char a;
    int b;
};

struct test1 {
    char a;
    int b;
}__attribute__((packed));

int main(void)
{
    printf(&quot;%d, %d\n&quot;, sizeof(struct test), sizeof(struct test1));
}</code></pre><p>struct test结构，理论来说一共有1+4=5字节的大小，但是gcc默认编译出来的大小是8，也就是说char是按照4字节来分配空间的。<br>加上packed修饰后，就会按照实际的类型大小来计算。</p>
<pre><code>➜  /data/test/1  &gt; ./main 
8, 5</code></pre><h2 id="section属性"><a href="#section属性" class="headerlink" title="section属性"></a>section属性</h2><p>gcc编译后的二进制文件为elf格式，代码中的函数部分会默认的链接到elf文件的text section中，<br>变量则会链接到bss和data section中。如果想把代码或变量放到特定的section中，就可以使用section属性来修饰。</p>
<pre><code>int __attribute__((section(&quot;TEST&quot;))) test1(int a, int b)
{
    return a + b;
}

int test2(int a, int b)
{
    return a + b;
}

int main(void)
{
    test1(1, 2);
    test2(1, 2);
}</code></pre><p>使用readelf来观察下test二进制格式。</p>
<pre><code>➜  /data/test/1  &gt; readelf -S main
[13] .text             PROGBITS         0000000000400400  00000400
00000000000001a2  0000000000000000  AX       0     0     16
[14] TEST              PROGBITS         00000000004005a2  000005a2
0000000000000014  0000000000000000  AX       0     0     1</code></pre><p>文件多出了一个TEST section，它的起始地址为0x4005a2, 大小为0x14， 它的地址范围在 0x4005a2 – 0x4005b6。<br>text section的起始地址为0x400400, 大小为0x1a2， 它的地址范围在0x400400 – 0x4005a2。</p>
<p>在来看下test1, test2符号表的地址：</p>
<pre><code>➜  /data/test/1  &gt; readelf -s main
57: 00000000004005a2    20 FUNC    GLOBAL DEFAULT   14 test1
68: 00000000004004f6    20 FUNC    GLOBAL DEFAULT   13 test2</code></pre><p>可以看到test2确实被链接在text section中， 而test1链接在TEST section中。</p>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p>更多关于gcc attribute的介绍请看<a href="http://gcc.gnu.org/onlinedocs/gcc-4.3.2//gcc/Variable-Attributes.html#Variable-Attributes" target="_blank" rel="noopener">gcc手册</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/10/attribute-aligned/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/10/attribute-aligned/" class="post-title-link" itemprop="url">\#pragma pack(n)和\_\_attribute\_\_((aligned(m)))的区别</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-11T00:00:00+08:00">2015-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="pragma-pack-n-和-attribute-aligned-m-的区别："><a href="#pragma-pack-n-和-attribute-aligned-m-的区别：" class="headerlink" title="#pragma pack(n)和__attribute__((aligned(m)))的区别："></a>#pragma pack(n)和__attribute__((aligned(m)))的区别：</h2><p>前者告诉编译器结构体或类内部的成员变量相对于第一个变量的地址的偏移量的对齐方式，<br>缺省情况下，编译器按照自然边界对齐，当变量所需的自然对齐边界比n大时，按照n对齐，<br>否则按照自然边界对齐；<br>后者告诉编译器一个结构体或者类或者联合或者一个类型的变量(对象)分配地址空间时的地址对齐方式。<br>也就是说，如果将__attribute__((aligned(m)))作用于一个类型，那么该类型的变量在分配地址空间时，<br>其存放的地址一定按照m字节对齐(m必须是2的幂次方)。<br>并且其占用的空间，即大小,也是m的整数倍，以保证在申请连续存储空间的时候，<br>每一个元素的地址也是按照m字节对齐。 __attribute__((aligned(m)))也可以作用于一个单独的变量。举例说明：</p>
<pre><code>#include&lt;stdio.h&gt;
#pragma pack(4)

typedef struct{
    uint32_t f1;
    uint8_t f2;
    uint8_t f3;
    uint32_t f4;
    uint64_t f5;
}__attribute__((aligned(1024))) ts;

int main()
{
    printf(&quot;Struct size is: %d, aligned on 1024\n&quot;,sizeof(ts));
    printf(&quot;Allocate f1 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f1));
    printf(&quot;Allocate f2 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f2));
    printf(&quot;Allocate f3 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f3));
    printf(&quot;Allocate f4 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f4));
    printf(&quot;Allocate f5 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f5));
    return 0;
}</code></pre><p>输出：</p>
<font color="#00FF00">
    Struct size is: 1024, aligned on 1024
<br/>
</font>
    Allocate f1 on address: 0x0
<br/>
<font color="#FF0000">
    Allocate f2 on address: 0x4
<br/>
    Allocate f3 on address: 0x5
<br/>
</font>
    Allocate f4 on address: 0x8
<br/>
<font color="#FF00FF">
    Allocate f5 on address: 0xc
<br/>
</font>

<p>注意:</p>
<p>绿色部分表明了__attribute__((aligned(1024))) 的作用<br/><br>红色部分说明#pragma pack(4)只对大小大于4的成员变量的地址偏移起作用<br/><br>紫色部分说明对于大小大于4的成员变量，其地址偏移按照4字节对齐</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/19/analysis-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/08/19/analysis-tools/" class="post-title-link" itemprop="url">代码分析工具</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-08-20 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-20T00:00:00+08:00">2015-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>toc<br>{:toc}</li>
</ul>
<h2 id="Cppcheck"><a href="#Cppcheck" class="headerlink" title="Cppcheck"></a>Cppcheck</h2><p><strong>Cppcheck</strong> is a static analysis tool for C/C++ code.<br>Unlike C/C++ compilers and many other analysis tools it does not detect syntax errors in the code.<br>Cppcheck primarily detects the types of bugs that the compilers normally do not detect.<br>The goal is to detect only real errors in the code (i.e. have zero false positives).</p>
<ol>
<li><a href="http://cppcheck.sourceforge.net/" target="_blank" rel="noopener">官网</a></li>
<li><a href="http://cppcheck.sourceforge.net/#documentation" target="_blank" rel="noopener">documentation</a></li>
</ol>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install cppcheck cppcheck-gui</code></pre>
<p>用法：</p>
<pre><code class="bash">cppcheck-gui

cppcheck -h

# Recursively check the current folder. Print the progress on the screen and
# write errors to a file:
cppcheck . 2&gt; err.txt

# Recursively check ../myproject/ and don&#39;t print progress:
cppcheck --quiet ../myproject/

# Check test.cpp, enable all checks:
cppcheck --enable=all --inconclusive --std=posix test.cpp

# Check f.cpp and search include files from inc1/ and inc2/:
cppcheck -I inc1/ -I inc2/ f.cpp</code></pre>
<h2 id="Understand"><a href="#Understand" class="headerlink" title="Understand"></a>Understand</h2><p>Understand® is an IDE built from the ground up to help you fully comprehend your source code. Analyze it, measure it, visualize it, maintain it - Understand it.</p>
<ol>
<li><a href="https://scitools.com/" target="_blank" rel="noopener">官网</a></li>
<li><a href="https://scitools.com/support/" target="_blank" rel="noopener">support</a> </li>
<li><a href="https://scitools.com/support/running-understand-headless-linux-server/" target="_blank" rel="noopener">Running Understand on a headless linux server</a></li>
</ol>
<p>Understand软件的功能主要<strong>定位于代码的阅读理解</strong>。</p>
<p>具备如下特性：</p>
<ol>
<li>支持多语言：Ada, C, C++, C#, Java, FORTRAN, Delphi, Jovial, and PL/M ，混合语言的project也支持</li>
<li>多平台： Windows/Linux/Solaris/HP-UX/IRIX/MAC OS X</li>
<li>代码语法高亮、代码折叠、交叉跳转、书签等基本阅读功能。</li>
<li>可以对整个project的architecture、metrics进行分析并输出报表。</li>
<li>可以对代码生成多种图（butterfly graph、call graph、called by graph、control flow graph、UML class graph等），<br>在图上点击节点可以跳转到对应的源代码位置。</li>
<li>提供Perl API便于扩展。作图全部是用Perl插件实现的，直接读取分析好的数据库作图。</li>
<li>内置的目录和文件比较器。</li>
<li>支持project的snapshot，并能和自家的TrackBack集成便于监视project的变化。</li>
</ol>
<h2 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h2><ol>
<li><a href="http://valgrind.org/" target="_blank" rel="noopener">valgrind</a></li>
<li><a href="http://alleyoop.sourceforge.net/" target="_blank" rel="noopener">Alleyoop</a></li>
<li><a href="http://valgrind.org/downloads/guis.html" target="_blank" rel="noopener">Valkyrie</a></li>
<li><a href="http://valgrind.org/docs/manual/manual.html" target="_blank" rel="noopener">Valgrind User Manual</a></li>
<li><a href="http://valgrind.org/info/tools.html" target="_blank" rel="noopener">Valgrind’s Tool Suite</a></li>
<li><a href="http://cstriker1407.info/blog/c-language-code-detection-use-valgrind/" target="_blank" rel="noopener">C语言代码检测：valgrind的使用</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-valgrind/" target="_blank" rel="noopener">应用 Valgrind 发现 Linux 程序的内存问题</a></li>
<li><a href="http://www.oschina.net/translate/valgrind-memcheck" target="_blank" rel="noopener">如何使用Valgrind memcheck工具进行C/C++的内存泄漏检测</a></li>
</ol>
<p>Valgrind是一套Linux下，开放源代码（GPL V2）的仿真调试工具的集合。<br>Valgrind由内核（core）以及基于内核的其他调试工具组成。<br>内核类似于一个框架（framework），它模拟了一个CPU环境，并提供服务给其他工具；<br>而其他工具则类似于插件 (plug-in)，利用内核提供的服务完成各种特定的内存调试任务。</p>
<p>它支持 C/C++，支持各类 Unix 系统。 </p>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install valgrind</code></pre>
<p>工具集：</p>
<ul>
<li>Memcheck。这是valgrind应用最广泛的工具，一个重量级的内存检查器，<br>能够发现开发中绝大多数内存错误使用情况，<br>比如：使用未初始化的内存，使用已经释放了的内存，内存访问越界等。</li>
<li>Callgrind。它主要用来检查程序中函数调用过程中出现的问题。</li>
<li>Cachegrind。它主要用来检查程序中缓存使用出现的问题。它与Cachegrind的功能有重叠，但也收集Cachegrind不收集的一些信息。</li>
<li>Helgrind。它主要用来检查多线程程序中出现的竞争问题。</li>
<li>Massif。它主要用来检查程序中堆栈使用中出现的问题。它有助于使你的程序使用更少的内存。</li>
<li>DRD也是一个线程错误检测器。它和Helgrind相似，但使用不同的分析技术，所以可能找到不同的问题。</li>
</ul>
<p>编译选项使用<code>-g -O0</code>, <strong>交叉编译</strong>之后在目标机上执行内存检测：</p>
<pre><code class="bash">valgrind --tool=memcheck --leak-check=full ./a.out
==2888== Memcheck, a memory error detector
==2888== Copyright (C) 2002-2009, and GNU GPL&#39;d, by Julian Seward et al.
==2888== Using Valgrind-3.6.0.SVN-Debian and LibVEX; rerun with -h for copyright info
==2888== Command: ./val
==2888==

[a]
==2888==
==2888== HEAP SUMMARY:
==2888==     in use at exit: 1 bytes in 1 blocks
==2888==   total heap usage: 1 allocs, 0 frees, 1 bytes allocated
==2888==
==2888== 1 bytes in 1 blocks are definitely lost in loss record 1 of 1
==2888==    at 0x4C274A8: malloc (vg_replace_malloc.c:236)
==2888==    by 0x400575: main (valgrind.c:6)
==2888==
==2888== LEAK SUMMARY:
==2888==    definitely lost: 1 bytes in 1 blocks
==2888==    indirectly lost: 0 bytes in 0 blocks
==2888==      possibly lost: 0 bytes in 0 blocks
==2888==    still reachable: 0 bytes in 0 blocks
==2888==         suppressed: 0 bytes in 0 blocks
==2888==
==2888== For counts of detected and suppressed errors, rerun with: -v
==2888== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 4 from 4)</code></pre>
<p>memcheck可以检测下列与内存相关的问题 :</p>
<ul>
<li>未释放内存的使用</li>
<li>对释放后内存的读/写</li>
<li>对已分配内存块尾部的读/写</li>
<li>内存泄露</li>
<li>不匹配的使用malloc/new/new[] 和 free/delete/delete[]</li>
<li>重复释放内存</li>
</ul>
<h2 id="KCachegrind"><a href="#KCachegrind" class="headerlink" title="KCachegrind"></a><strong>KCachegrind</strong></h2><ol>
<li><a href="https://kcachegrind.github.io/html/Home.html" target="_blank" rel="noopener">Callgrind and KCachegrind</a></li>
<li><a href="https://kcachegrind.github.io/html/Screenshots.html" target="_blank" rel="noopener">Screenshots</a></li>
<li><a href="https://kcachegrind.github.io/html/Documentation.html" target="_blank" rel="noopener">Documentation</a></li>
</ol>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install kcachegrind</code></pre>
<p><code>valgrind</code>安装之后有工具<code>callgrind</code>，使用此工具生成<code>性能日志</code>，使用<code>kcachegrind</code>进行分析：</p>
<pre><code class="bash">/data/test  &gt; gcc -g -O0 main.c -o perf
/data/test  &gt; valgrind --tool=callgrind ./perf 
==27075== Callgrind, a call-graph generating cache profiler
==27075== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Josef Weidendorfer et al.
==27075== Using Valgrind-3.11.0 and LibVEX; rerun with -h for copyright info
==27075== Command: ./perf
==27075== 
==27075== For interactive control, run &#39;callgrind_control -h&#39;.
hello world!
hello world!
hello world!
test 
hello world!
test 
hello world!
test 
==27075== 
==27075== Events    : Ir
==27075== Collected : 155985
==27075== 
==27075== I   refs:      155,985
/data/test  &gt; ls
1  a.out  callgrind.out.27075  main.c  output  perf  photorec.ses  recup_dir.1  rgb  testdisk.log
/data/test  &gt; kcachegrind callgrind.out.27075 </code></pre>
<img src="https://kcachegrind.github.io/images/KcgShot3Large.gif" height="600" width="800" />

<p>在<code>Call Graph</code>中，你能看到每一个函数的开销百分比包括Inclusive,即涵带子函数的总开销和Self，函数自己的开销，<br>另外每一个函数的调用次数也列写在上面。<br>也可以分析出函数的调用关系和流程，这是一个非常好的辅助工具，帮助你快速理解系统的工作流Work Flow。</p>
<h2 id="gprof"><a href="#gprof" class="headerlink" title="gprof"></a>gprof</h2><ol>
<li><a href="https://sourceware.org/binutils/docs/gprof/" target="_blank" rel="noopener">gprof</a></li>
<li><a href="http://www.thegeekstuff.com/2012/08/gprof-tutorial/" target="_blank" rel="noopener">GPROF Tutorial – How to use Linux GNU GCC Profiling Tool</a></li>
<li><a href="https://sourceware.org/binutils/docs-2.17/gprof/index.html" target="_blank" rel="noopener">GNU gprof</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-gnuprof.html" target="_blank" rel="noopener">使用 GNU profiler 来提高代码运行速度</a></li>
<li><a href="http://www.cnblogs.com/onlyforcloud/p/4395917.html" target="_blank" rel="noopener">GNU–gprof使用总结</a></li>
</ol>
<p>Gprof 是GNU gnu binutils工具之一，默认情况下linux系统当中都带有这个工具：</p>
<ol>
<li>可以显示“flat profile”，包括每个函数的调用次数，每个函数消耗的处理器时间，</li>
<li>可以显示“Call graph”，包括函数的调用关系，每个函数调用花费了多少时间。</li>
<li>可以显示“注释的源代码”－－是程序源代码的一个复本，标记有程序中每行代码的执行次数。</li>
</ol>
<p>Gprof基本用法：</p>
<ol>
<li>使用 <code>-pg</code> 编译和链接你的应用程序。</li>
<li>执行你的应用程序使之生成供gprof 分析的数据。</li>
<li>使用gprof 程序分析你的应用程序生成的数据。</li>
</ol>
<pre><code class="bash">gcc gprof.c -pg -o example1 -O0 -g
./example1
✔ /data/test  &gt; ls gmon.out
gmon.out

# flat profile
gprof example1 gmon.out -p
Flat profile:

Each sample counts as 0.01 seconds.
%   cumulative   self              self     total           
time   seconds   seconds    calls  ms/call  ms/call  name    
50.43      0.01     0.01        3     3.36     3.36  count_sum
50.43      0.02     0.01        1    10.09    13.45  my_print2
0.00      0.02     0.00        2     0.00     3.36  my_print

# call graph
gprof example1 gmon.out -q

# gprof - display call graph profile data
man gprof</code></pre>
<p><strong>带注解的源代码</strong></p>
<p>如果希望获得一个 “带注解的源代码” 清单，它会将源代码输出到应用程序中，并加上每个函数被调用了多少次的注释。<br>要使用这种功能，请使用启用调试功能的标志来编译源代码，这样源代码就会被加入可执行程序中：</p>
<pre><code class="bash">gcc example1.c -g -pg -o example1 -O2 -lc</code></pre>
<p>像以前一样重新运行这个应用程序：</p>
<pre><code class="bash">./example1 50000</code></pre>
<p>gprof 命令现在应该是：</p>
<pre><code class="bash">gprof example1 gmon.out -A</code></pre>
<p><strong>常用参数</strong></p>
<ul>
<li>-b 不再输出统计图表中每个字段的详细描述。</li>
<li>-p 只输出函数的调用图（Call graph的那部分信息）。</li>
<li>-q 只输出函数的时间消耗列表。</li>
<li>-e Name 不再输出函数Name 及其子函数的调用图（除非它们有未被限制的其它父函数）。可以给定多个 -e 标志。一个 -e 标志只能指定一个函数。</li>
<li>-E Name 不再输出函数Name 及其子函数的调用图，此标志类似于 -e 标志，但它在总时间和百分比时间的计算中排除了由函数Name 及其子函数所用的时间。</li>
<li>-f Name 输出函数Name 及其子函数的调用图。可以指定多个 -f 标志。一个 -f 标志只能指定一个函数。</li>
<li>-F Name 输出函数Name 及其子函数的调用图，它类似于 -f 标志，但它在总时间和百分比时间计算中仅使用所打印的例程的时间。可以指定多个 -F 标志。一个 -F 标志只能指定一个函数。-F 标志覆盖 -E 标志。</li>
<li>-z 显示使用次数为零的例程（按照调用计数和累积时间计算）。</li>
</ul>
<p><strong>用户时间与内核时间</strong></p>
<p>gprof 的最大缺陷：它只能分析应用程序在运行过程中所消耗掉的用户时间，无法得到程序内核空间的运行时间。通常来说，应用程序在运行时既要花费一些时间来运行用户代码，也要花费一些时间来运行 “系统代码”，例如内核系统调用sleep()。</p>
<p>有一个方法可以查看应用程序的运行时间组成，在 time 命令下面执行程序。这个命令会显示一个应用程序的实际运行时间、用户空间运行时间、内核空间运行时间。</p>
<pre><code class="bash">✔ /data/test  &gt; time ./example1 
./example1  0.02s user 0.00s system 93% cpu 0.026 total</code></pre>
<p><strong>注意事项</strong></p>
<ol>
<li>g++在编译和链接两个过程，都要使用-pg选项。</li>
<li>只能使用静态连接libc库，否则在初始化<code>*.so</code>之前就调用profile代码会引起“segmentation fault”，<br>解决办法是编译时加上-static-libgcc或-static。</li>
<li>如果不用g++而使用ld直接链接程序，要加上链接文件/lib/gcrt0.o，如ld -o myprog /lib/gcrt0.o myprog.o utils.o -lc_p。<br>也可能是gcrt1.o</li>
<li>要监控到第三方库函数的执行时间，第三方库也必须是添加 –pg 选项编译的。</li>
<li>gprof只能分析应用程序所消耗掉的用户时间.</li>
<li>程序不能以demon方式运行。否则采集不到时间。（可采集到调用次数）</li>
<li>首先使用 time 来运行程序从而判断 gprof 是否能产生有用信息是个好方法。</li>
<li>如果 gprof 不适合您的剖析需要，那么还有其他一些工具可以克服 gprof 部分缺陷，包括 OProfile 和 Sysprof。</li>
<li>gprof对于代码大部分是用户空间的CPU密集型的程序用处明显。<br>对于大部分时间运行在内核空间或者由于外部因素（例如操作系统的 I/O 子系统过载）而运行得非常慢的程序难以进行优化。</li>
<li>gprof 不支持多线程应用，多线程下只能采集主线程性能数据。原因是gprof采用ITIMER_PROF信号，在多线程内只有主线程才能响应该信号。<br>但是有一个<a href="http://sam.zoy.org/writings/programming/gprof.html" target="_blank" rel="noopener">简单的方法</a>可以解决这一问题</li>
<li>gprof只能在程序正常结束退出之后才能生成报告（gmon.out）。<ul>
<li>gprof通过在atexit()里注册了一个函数来产生结果信息，任何非正常退出都不会执行atexit()的动作，所以不会产生gmon.out文件。</li>
<li>程序可从main函数中正常退出，或者通过系统调用exit()函数退出。</li>
</ul>
</li>
</ol>
<h2 id="KProf"><a href="#KProf" class="headerlink" title="KProf"></a>KProf</h2><blockquote>
<p>KProf - Profiling made easy</p>
</blockquote>
<ol>
<li><a href="http://kprof.sourceforge.net/" target="_blank" rel="noopener">KProf</a></li>
<li><a href="https://sourceforge.net/projects/kprof/files/" target="_blank" rel="noopener">download</a></li>
</ol>
<p>将gprof ， GUI化了，更加友好，它也利用graphviz绘制运行时流程图，但是对于大的程序，似乎效果不太好，流程图感觉完全乱掉了</p>
<img src="http://kprof.sourceforge.net/kprof_flat.png"/>

<img src="http://kprof.sourceforge.net/kprof_object.png"/>


<h2 id="gprof2dot"><a href="#gprof2dot" class="headerlink" title="gprof2dot"></a><strong>gprof2dot</strong></h2><ol>
<li><a href="https://github.com/jrfonseca/gprof2dot" target="_blank" rel="noopener">gprof2dot</a></li>
<li><a href="https://github.com/jrfonseca/xdot.py" target="_blank" rel="noopener">xdot.py</a></li>
</ol>
<pre><code class="bash">sudo apt-get install python graphviz
git clone https://github.com/jrfonseca/gprof2dot.git
python setup.py build
sudo python steup.py install</code></pre>
<p>用法：</p>
<pre><code class="bash">gcc -pg linpack.c -o linpack_gprof
gprof ./linpack_gprof | python2.7 gprof2dot.py -n0 -e0 |dot - Tpng -o output.png</code></pre>
<img src="http://img.blog.csdn.net/20160412124253219?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"/>

<p>还可通过以下命令得到函数调用图:</p>
<pre><code class="bash">gprof linpack_gprof &gt; prof.log  
./gprof2dot.py prof.log | dot -Tpng -o output.png  </code></pre>
<img src="http://img.blog.csdn.net/20160424203320165?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"/>

<p><strong>通过对比以上两种方法，可以发现第二种方法无法得到调用时间过短的函数调用关系</strong></p>
<p>gprof2dot默认是部分函数调用图，对性能影响不大的函数调用都不显示，例如上图中没有出现类的构造，析构函数，<br>如果想要显示全部的函数调用，可以 gprof2dot -n0 -e0 ，默认是n0.5即影响小于5%的函数就不显示了。<br>当然这样图片会很乱，因为显示内容很多，可以 gprof2dot -n0 -e0 -s #-s表示不显示诸如模板，函数入口参数等等，使得<br>函数名称显示更加精简。</p>
<p><code>dot</code>用于生成图片，使用<code>xdot.py</code>不需要生成图片，直接交互</p>
<pre><code class="bash">gprof ./linpack_gprof | python2.7 gprof2dot.py -n0 -e0 | ./xdot.py</code></pre>
<p><em>python环境变量设置有问题，xdot单独可以工作，使用管道不能正常工作</em></p>
<pre><code class="bash">function showCall()
{
    gprof $1 | python3 /data/Installer/gprof2dot/gprof2dot.py &gt; /tmp/__call_tmp
    xdot /tmp/__call_tmp
    rm /tmp/__call_tmp
}</code></pre>
<h2 id="gperftools"><a href="#gperftools" class="headerlink" title="gperftools"></a><strong>gperftools</strong></h2><ol>
<li><a href="https://github.com/gperftools/gperftools" target="_blank" rel="noopener">gperftools</a></li>
<li><a href="http://airekans.github.io/cpp/2014/07/04/gperftools-profile" target="_blank" rel="noopener">用gperftools对C/C++程序进行profile</a></li>
<li><a href="http://www.cnblogs.com/persistentsnail/p/3294843.html" target="_blank" rel="noopener">Google performance Tools (gperftools) 使用心得</a></li>
<li><a href="http://qiaoyong.lofter.com/post/2b36f_1140c82" target="_blank" rel="noopener">gperftools使用详解</a></li>
</ol>
<p>在Linux的C/C++编程的世界里，性能调优一直是个让人头疼的事。<br>最出名的<code>gprof</code>虽然大家都知道， 其用法比较单一(只支持程序从启动到结束的profile)，<br>而且对程序的运行时间会有比较大的影响， 所以其profile不一定准确。</p>
<p>而<code>valgrind</code>功能十分强大，但profile也一般针对整个程序的运行，很难只对程序运行中的某段时间进行profile。<br>而且也多少会影响程序的运行，且使用的难度也较大。</p>
<p><strong>如何profile</strong></p>
<p>在gperftools的文档中，就简单的说了下面的方式来进行profile：</p>
<pre><code class="bash">gcc [...] -o myprogram -lprofiler
CPUPROFILE=/tmp/profile ./myprogram</code></pre>
<p>是的，在编译和安装了gperftools之后，只需要上面的步骤就可以进行profile了，非常简单。<br>而profile的结果就保存在/tmp/profile。查看结果只需要用gperftools自带的一个pprof脚本来看就可以：</p>
<pre><code class="bash">$ pprof --text ./myprogram /tmp/profile
14   2.1%  17.2%       58   8.7% std::_Rb_tree::find</code></pre>
<p>pprof的输出也很直观，不过也还不够好，从这个输出中还不好看出调用关系，包括caller和callee。<br>而pprof也可以输出图示，还可以输出<code>callgrind</code>兼容的格式，这样就可以用<code>kcachegrind</code>来看profile结果了。</p>
<pre><code class="bash">$ pprof --callgrind ./myprogram /tmp/profile &gt; callgrind.res</code></pre>
<p>然后利用kcachegrind打开这个callgrind.res文件</p>
<p><strong>动态profile</strong></p>
<p>上面说到的方式是通过环境变量来触发profile，而跨度也是整个程序的生命周期。<br>那如果是想要在程序运行的某段时间进行profile呢？如果我想在程序不结束的情况下就拿到profile的结果呢？</p>
<p>这种情况下就需要用到动态profile的方式了。要实现这种方式，就需要改动程序的代码了，不过也比较简单：</p>
<pre><code class="bash">#include &lt;gperftools/profiler.h&gt;

int main()
{
    ProfilerStart(&quot;/tmp/profile&quot;);
    some_func_to_profile();
    ProfilerStop();

    return 0;
}</code></pre>
<p>没错，你只需要在你想要profile的函数的开头和结尾加上<code>ProfilerStart</code>和<code>ProfilerStop</code>调用就可以了。<br>在ProfilerStop结束之后，profile的结果就会保存在/tmp/profile里面了。<br>利用这种方式就可以在指定的时间点对程序进行profile了。</p>
<p>最后需要说的一点是，gperftools的profile过程采用的是采样的方式，而且对profile中的程序性能影响极小，<br>这对于在线或者离线profile都是一个极其重要的特点。</p>
<h2 id="include-what-you-use"><a href="#include-what-you-use" class="headerlink" title="include-what-you-use"></a>include-what-you-use</h2><ol>
<li><a href="https://github.com/include-what-you-use/include-what-you-use" target="_blank" rel="noopener">include-what-you-use</a></li>
<li><a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&action=printable&tid=4145378" target="_blank" rel="noopener">找出C文件中不必要的头文件</a></li>
<li><a href="http://xinsuiyuer.github.io/blog/2013/10/30/include-what-you-use/" target="_blank" rel="noopener">使用I.W.Y.U整理头文件引用</a></li>
</ol>
<p>首先安装CLang开发包，然后编译IWYU：</p>
<pre><code class="bash">sudo apt-get install llvm llvm-devel llvm-clang llvm-clang-devel
git clone https://github.com/include-what-you-use/include-what-you-use.git
mkdir build &amp;&amp; cd build
cmake -G &quot;Unix Makefiles&quot; -DIWYU_LLVM_ROOT_PATH=/usr/lib/llvm-3.8 ../../include-what-you-use
make</code></pre>
<p>使用：</p>
<pre><code class="shell">make -k CC=/data/OpenSourceCode/include-what-you-use/build/include-what-you-use -I/usr/lib/llvm-3.8/lib/clang/3.8.0/include

-e compiling [/data/OpenSourceCode/include-what-you-use/build/include-what-you-use]: ./ca/thinew/app_tnt_baseinfo.c
In file included from ca/thinew/app_tnt_baseinfo.c:19:
In file included from ./include/app_module.h:22:
In file included from ./include/module/app_play_control.h:22:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/gxcore.h:4:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/common/gxcore_common.h:4:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/stdlib.h:70:
/home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/stddef.h:63:15: fatal error: 
    &#39;stddef.h&#39; file not found
#include_next &lt;stddef.h&gt;
^

ca/thinew/app_tnt_baseinfo.c should add these lines:

ca/thinew/app_tnt_baseinfo.c should remove these lines:
- #include &quot;app_module.h&quot;  // lines 19-19

The full include-list for ca/thinew/app_tnt_baseinfo.c:
#include &quot;app_config.h&quot;  // for TNTCAS_SUPPORT
---
deps:17: recipe for target &#39;/home/workspace/Solution-for-debug/dishcas/solution/output/objects/app_tnt_baseinfo.o&#39; failed
make[1]: *** [/home/workspace/Solution-for-debug/dishcas/solution/output/objects/app_tnt_baseinfo.o] Error 3</code></pre>
<blockquote>
<p><strong>fatal error: ‘stddef.h’ file not found</strong>待排除，可能与CLang环境设置有关，或与<code>include_next</code>有关<br><a href="https://github.com/include-what-you-use/include-what-you-use" target="_blank" rel="noopener">How to Install</a></p>
</blockquote>
<p>可以将 IWYU 保存到文件中，之后使用其附带的 fix_includes.py 自动对代码进行修复。 <strong>但应该慎重….</strong></p>
<pre><code class="bash">$ make -B -k CXX=include-what-you-use &gt; iwyu.out
$ fix_includes.py &lt; iwyu.out</code></pre>
<h2 id="OCLint"><a href="#OCLint" class="headerlink" title="OCLint"></a>OCLint</h2><ol>
<li><a href="http://oclint.org/" target="_blank" rel="noopener">OCLint</a></li>
<li><a href="https://github.com/oclint/oclint" target="_blank" rel="noopener">The OCLint Static Code Analysis Tool</a></li>
<li><a href="https://segmentfault.com/a/1190000005150573" target="_blank" rel="noopener">OCLint 安装与使用</a></li>
<li><a href="http://ceyang.me/dai-ma-du-liang-bang-zhu-xie-chu-gao-zhi-liang-dai-ma-de-gong-ju/" target="_blank" rel="noopener">代码度量：帮助写出高质量代码的工具</a></li>
<li><a href="http://lrdcq.com/me/read.php/48.htm" target="_blank" rel="noopener">oc代码静态检查方案</a></li>
<li><a href="http://docs.oclint.org/en/stable/intro/build.html" target="_blank" rel="noopener">Building OCLint</a></li>
<li><a href="http://docs.oclint.org/en/stable/intro/installation.html" target="_blank" rel="noopener">Installation</a></li>
<li><a href="https://github.com/oclint/oclint/releases" target="_blank" rel="noopener">downloading pre-compiled binaries</a></li>
</ol>
<p>下载<code>预编译</code>版本，然后将<code>PATH</code>添加到<code>.zshrc</code>中，测试如下：</p>
<pre><code class="bash">oclint
oclint: Not enough positional command line arguments specified!
Must specify at least 1 positional arguments: See: oclint -help</code></pre>
<p>如果使用<code>make</code>来构建系统，使用方式如下：</p>
<pre><code class="bash">sudo apt-get install bear

#compile_commands.json
bear make 

#oclint-json-compilation-database for code analysis
oclint-json-compilation-database

oclint -p &lt;build path&gt; &lt;source0&gt; [... &lt;sourceN&gt;]</code></pre>
<p><strong>OCLint配置规则</strong></p>
<h2 id="Clang-Static-Analyzer"><a href="#Clang-Static-Analyzer" class="headerlink" title="Clang Static Analyzer"></a><strong>Clang Static Analyzer</strong></h2><ol>
<li><a href="http://clang-analyzer.llvm.org/index.html" target="_blank" rel="noopener">Clang Static Analyzer</a></li>
<li><a href="http://clang-analyzer.llvm.org/installation#OtherPlatforms" target="_blank" rel="noopener">Building the Analyzer from Source</a></li>
<li><a href="http://blog.csdn.net/sealjin/article/details/45221209" target="_blank" rel="noopener">How to use Clang Static Analyzer</a></li>
<li><a href="http://xinsuiyuer.github.io/blog/2014/01/12/clang-static-analyzer/" target="_blank" rel="noopener">静态代码分析工具</a></li>
</ol>
<p>在编译安装 <code>llvm/clang</code> 或者 <code>sudo apt-get install clang</code> 之后，<code>scan-build</code> 和 <code>scan-view</code> 分别在</p>
<pre><code class="bash">$(SRC)/llvm/tools/clang/tools/scan-build
$(SRC)/llvm/tools/clang/tools/scan-view</code></pre>
<p>使用：</p>
<pre><code class="bash">scan-build make
.
scan-build: 3 bugs found.
scan-build: Run &#39;scan-view /tmp/scan-build-2016-06-23-124956-25166-1&#39; to examine bug reports.
scan-view /tmp/scan-build-2016-06-23-124956-25166-1</code></pre>
<p><strong>checker – 检查规则</strong></p>
<p>内置的 checker 存放在 <code>$(SRC)/llvm/tools/clang/lib/StaticAnalyzer/Checkers</code> 目录下。<br>这些 <code>checker</code> 默认情况下并没有全部开启，所以需要根据情况启用合适的 checker。<br>可以使用 <code>-enable-checker</code> 和 <code>-disable-checker</code> 开启和禁用具体的 checker 或者 某种类别的 checker。</p>
<pre><code class="bash">$ scan-build -enable-checker alpha.security.ArrayBoundV2 make # 启用数组边界检查</code></pre>
<p>所有支持的 checkers 可以使用如下命令查看：</p>
<pre><code class="bash">$ clang -cc1 -analyzer-checker-help
alpha.core.BoolAssignment       Warn about assigning non-{0,1} values to Boolean variables
alpha.core.CastSize             Check when casting a malloced type T, whether the size is a multiple of the size of T
alpha.core.CastToStruct         Check for cast from non-struct pointer to struct pointer
alpha.core.FixedAddr            Check for assignment of a fixed address to a pointer
alpha.core.IdenticalExpr        Warn about unintended use of identical expressions in operators
alpha.core.PointerArithm        Check for pointer arithmetic on locations other than array elements
alpha.core.PointerSub           Check for pointer subtractions on two pointers pointing to different memory chunks
alpha.core.SizeofPtr            Warn about unintended use of sizeof() on pointer expressions
alpha.cplusplus.NewDeleteLeaks  Check for memory leaks. Traces memory managed by new/delete.
alpha.cplusplus.VirtualCall     Check virtual function calls during construction or destruction
...
alpha.security.ArrayBound       Warn about buffer overflows (older checker)
alpha.security.ArrayBoundV2     Warn about buffer overflows (newer checker)
alpha.security.MallocOverflow   Check for overflows in the arguments to malloc()
alpha.security.ReturnPtrRange   Check for an out-of-bound pointer being returned to callers
...
core.CallAndMessage             Check for logical errors for function calls and Objective-C message expressions (e.g., uninitialized arguments, null function pointers)
core.DivideZero                 Check for division by zero
core.DynamicTypePropagation     Generate dynamic type information
core.NonNullParamChecker        Check for null pointers passed as arguments to a function whose arguments are references or marked with the &#39;nonnull&#39; attribute
core.NullDereference            Check for dereferences of null pointers
core.StackAddressEscape         Check that addresses to stack memory do not escape the function
...
unix.API                        Check calls to various UNIX/Posix functions
unix.Malloc                     Check for memory leaks, double free, and use-after-free problems. Traces memory managed by malloc()/free().
unix.MallocSizeof               Check for dubious malloc arguments involving sizeof
unix.MismatchedDeallocator      Check for mismatched deallocators.
unix.cstring.BadSizeArg         Check the size argument passed into C string functions for common erroneous patterns
unix.cstring.NullArg            Check for null pointers being passed as arguments to C string functions</code></pre>
<p>在使用 <code>-enable-checker</code> 或者 <code>-disable-checker</code> 时，不需要完整的指定某个 checker 的名称， 也可以是某一类的，如：</p>
<pre><code class="bash">$ scan-build -enable-checker alpha ...
$ scan-build -enable-checker alpha.security ...</code></pre>
<p>例如：</p>
<pre><code class="bash">$ scan-build -enable-checker alpha.security make
-e compiling [/usr/share/clang/scan-build-3.8/bin/../libexec/ccc-analyzer]: ./channel_edit.c
channel_edit.c:202:15: warning: Value stored to &#39;data&#39; during its initialization is never read
    list_data data = {0};
            ^~~~   ~~~
1 warning generated.
scan-build: 150 bugs found.
scan-build: Run &#39;scan-view /tmp/scan-build-2016-06-23-125458-27549-1&#39; to examine bug reports.

# scan-view-3.8 ImportError: No module named ScanView
$ scan-view-3.4 /tmp/scan-build-2016-06-23-125458-27549-1</code></pre>
<p><strong>相比 cppcheck，它提供了更多的检查规则。</strong></p>
<h2 id="Purify"><a href="#Purify" class="headerlink" title="Purify"></a>Purify</h2><ol>
<li><a href="http://brantc.blog.51cto.com/410705/116674/" target="_blank" rel="noopener">Purify使用体验</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/rational/r-cail/" target="_blank" rel="noopener">Rational Purify 使用及分析实例</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/rational/07/0306_chitale/" target="_blank" rel="noopener">使用 IBM Rational PurifyPlus</a></li>
</ol>
<h2 id="Infer"><a href="#Infer" class="headerlink" title="Infer"></a>Infer</h2><p>Facebook 的 Infer 是一个静态分析工具。Infer 可以分析 Objective-C， Java 或者 C 代码，报告潜在的问题。</p>
<ol>
<li><a href="http://infer.liaohuqiu.net/" target="_blank" rel="noopener">Infer</a></li>
<li><a href="http://infer.liaohuqiu.net/docs/getting-started.html" target="_blank" rel="noopener">documentation</a></li>
</ol>
<h2 id="coverity"><a href="#coverity" class="headerlink" title="coverity"></a>coverity</h2><ol>
<li><a href="http://www.coverity.com/html_cn/products/index.html" target="_blank" rel="noopener">coverity</a></li>
<li><a href="http://blog.csdn.net/yasi_xi/article/details/8349985" target="_blank" rel="noopener">Coverity 代码静态安全检测</a></li>
</ol>
<h2 id="PVS-Studio"><a href="#PVS-Studio" class="headerlink" title="PVS-Studio"></a>PVS-Studio</h2><p><a href="http://www.hkaco.com/software/viva64/home.html" target="_blank" rel="noopener">C/C++/C++11 静态代码分析工具</a></p>
<h2 id="PC-lint"><a href="#PC-lint" class="headerlink" title="PC-lint"></a>PC-lint</h2><p><a href="http://www.gimpel.com/html/pcl.htm" target="_blank" rel="noopener">PC-lint</a></p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><!--
1. [C++ static code analysis tool on Windows](http://stackoverflow.com/questions/97454/c-static-code-analysis-tool-on-windows)
2. [静态代码分析工具汇总](http://blog.csdn.net/dongwuming/article/details/49423909)
3. [C/C++ 编程有哪些值得推荐的工具](https://www.zhihu.com/question/23357089)
4. [linux环境下 C++性能测试工具 gprof + kprof + gprof2dot](http://www.cnblogs.com/rocketfan/archive/2009/11/15/1603465.html)
5. [源码分析：动态分析 C 程序函数调用关系](http://blog.csdn.net/tinylab/article/details/45051097)
6. [Tutorial: Using GNU Profiling (gprof) with ARM Cortex-M](https://mcuoneclipse.com/2015/08/23/tutorial-using-gnu-profiling-gprof-with-arm-cortex-m/)
7. [如何使用gprof对软件做profiling](https://forums.xilinx.com/t5/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%B7%A5%E5%85%B7%E4%B8%8EIP/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8gprof%E5%AF%B9%E8%BD%AF%E4%BB%B6%E5%81%9Aprofiling/td-p/397451)
-->
<ol start="5">
<li><a href="https://en.wikipedia.org/wiki/List_of_tools_for_static_code_analysis#C.2C_C.2B.2B" target="_blank" rel="noopener">List of tools for static code analysis</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-OOM-Killer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-OOM-Killer/" class="post-title-link" itemprop="url">Linux下malloc函数和OOM Killer</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="Malloc函数和OOM-Killer"><a href="#Malloc函数和OOM-Killer" class="headerlink" title="Malloc函数和OOM Killer"></a><strong>Malloc函数和OOM Killer</strong></h3><p>Linux下malloc函数主要用来在用户空间从heap申请内存，申请成功返回指向所分配内存的指针，申请失败返回NULL。<br><strong>默认情况下，Linux内核使用“乐观的”分配内存策略</strong>，首先粗略估计系统可使用的内存数，然后分配内存，<br>但是在使用的时候才真正把这块分配的内存给你。<br>这样一来，即使用malloc申请内存没有返回NULL，你也不一定能完全使用这块内存，<br>特别是在一次或连续多次申请很多内存的时候。</p>
<p>如果一直连续用malloc申请内存，而不真正使用，所申请的内存总数可以超过真正可以使用的内存数。<br>但是当真正使用这块内存，比如用memset或bzero函数一次性把所申请到的大块内存“使用掉”，<br>Linux系统就会Out Of Memory，这个时候OOM Killer就会kill掉用户空间的其他进程来腾出更多可使用内存。</p>
<p>OOM Killer根据OOM score来决定kill哪个进程，OOM score可以看/proc/<PID>/oom_score，<br>score由badness函数计算得出，根据进程运行时间长短，进程优先级，进程所使用的内存数等等。<br>可以通过/proc/<PID>/oom_adj来干预计算socre，这个值的取值范围是-17～15，<br>如果是-17该进程就永远不会被kill（这个可能也和内核版本有关，不见得所有内核版本都支持，得实际试试）。</p>
<p>“默认情况”Linux是这种做的，“默认情况”是指/proc/sys/vm/overcommit_memory为0的时候。<br>这个参数也可以调整，如果为1表示“来着不拒”，只要你malloc过来申请，我啥都不做，立马给你分配内存，<br>这样的话性能就会有大幅度的提高；<br>如果为2表示Linux会精确计算所有可使用的内存和所申请的内存，如果所申请的超过的可使用的内存数就返回NULL。<br>可使用的内存值计算方法，虚拟内存（swap）+ /proc/sys/vm/overcommit_memory（百分比） × 物理内存。<br>/proc/sys/vm/overcommit_memory默认值为50,计算起来就是50%的物理内存数。</p>
<p>Linux自身内核会占一部分内存，还有buffer/cache所占用的内存，<br>所以实际上能被malloc申请后使用的内存并非物理内存大小，<br>demsg的输出里面包含了相关信息（如果看不到，可能是被别的信息冲掉了，重启系统，在系统起来后马上看）：</p>
<pre><code>Memory: 2071220k/2097152k available (2122k kernel code, 24584k reserved, 884k data, 228k init, 1179584k highmem)</code></pre><h3 id="关于OOM-Killer的proc文件系统"><a href="#关于OOM-Killer的proc文件系统" class="headerlink" title="关于OOM Killer的proc文件系统"></a><strong>关于OOM Killer的proc文件系统</strong></h3><p>下面开始介绍与OOM Killer相关的proc文件系统。</p>
<h4 id="proc-PID-oom-adj"><a href="#proc-PID-oom-adj" class="headerlink" title="/proc/PID/oom_adj"></a><strong>/proc/PID/oom_adj</strong></h4><p>为/proc/PID/oom_adj设置值就可以调整得分。<br>调整值的范围为–16~15。正的值容易被OOM Killer选定。负值可能性较低。<br>例如，当指定3时，得分就变为23倍；当指定–5时，得分就变为1/25。</p>
<p>“–17”是一个特殊的值。如果设置为–17，就会禁止OOM Killer发出的信号（从Linux 2.6.12开始支持设置–17）。</p>
<p>在OOM Killer运行的情况下，为了实现远程登录而想要将sshd排除在对象外时，可以执行下列命令。</p>
<pre><code># cat /proc/&#39;cat /var/run/sshd.pid&#39;/oom_score
15
# echo -17 &gt;  /proc/&#39;cat /var/run/sshd.pid&#39;/oom_adj
# tail /proc/&#39;cat /var/run/sshd.pid&#39;/oom_*
==&gt; /proc/2278/oom_adj &lt;==
-17
==&gt; /proc/2278/oom_score &lt;==
0                               /*得分变成0*/</code></pre><p>从Linux 2.6.18开始可以使用/proc/PID/oom_adj。内容记载在Documentation /filesystems/proc.txt中。</p>
<h4 id="proc-sys-vm-panic-on-oom"><a href="#proc-sys-vm-panic-on-oom" class="headerlink" title="/proc/sys/vm/panic_on_oom"></a><strong>/proc/sys/vm/panic_on_oom</strong></h4><p>将/proc/sys/vm/panic_on_oom设置为1时，在OOM Killer运行时可以不发送进程信号，而是使内核产生重大故障。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/panic_on_oom</code></pre><h4 id="proc-sys-vm-oom-kill-allocating-task"><a href="#proc-sys-vm-oom-kill-allocating-task" class="headerlink" title="/proc/sys/vm/oom_kill_allocating_task"></a><strong>/proc/sys/vm/oom_kill_allocating_task</strong></h4><p>从Linux 2.6.24开始proc文件系统就有oom_kill_allocating_task。<br>如果对此设置除0以外的值，则促使OOM Killer运行的进程自身将接收信号。此处省略对所有进程的得分计算过程。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_kill_allocating_task</code></pre><p>这样就不需要参照所有进程，但是也不会考虑进程的优先级和root权限等，只发送信号。</p>
<h4 id="proc-sys-vm-oom-dump-tasks"><a href="#proc-sys-vm-oom-dump-tasks" class="headerlink" title="/proc/sys/vm/oom_dump_tasks"></a><strong>/proc/sys/vm/oom_dump_tasks</strong></h4><p>从Linux 2.6.25开始，将oom_dump_tasks设置为除0以外的值时，在OOM Killer运行时的输出中会增加进程的列表信息。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_dump_tasks</code></pre><p>列表信息显示如下，可以使用dmesg或syslog来确认。</p>
<pre><code>[ pid ]   uid  tgid total_vm      rss cpu oom_adj name
[    1]     0     1     2580        1   0       0 init
[  500]     0   500     3231        0   1     -17 udevd
[ 2736]     0  2736     1470        1   0       0 syslogd
[ 2741]     0  2741      944        0   0       0 klogd
[ 2765]    81  2765     5307        0   0       0 dbus-daemon
[ 2861]     0  2861      944        0   0       0 acpid
...
[ 3320]     0  3320   525842   241215   1       0 stress</code></pre><h4 id="proc-PID-oom-score-adj"><a href="#proc-PID-oom-score-adj" class="headerlink" title="/proc/PID/oom_score_adj"></a><strong>/proc/PID/oom_score_adj</strong></h4><p>从Linux 2.6.36开始都安装了/proc/<PID>/oom_score_adj，<br>此后将替换为/proc/PID/oom_adj。<br>即使当前是对/proc/PID/oom_adj进行的设置，在内核内部进行变换后的值也是针对/proc/PID/oom_score_adj设置的。</p>
<p>可以设置–1000~1000之间的值。设置为–1000时，该进程就被排除在OOM Killer强制终止的对象外。</p>
<p>在内核2.6.36以后的版本中写入oom_adj，只会输出一次如下的信息。</p>
<pre><code># dmesg
.....
udevd (60): /proc/60/oom_adj is deprecated, please use /proc/60/oom_score_adj instead.</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-malloc/" class="post-title-link" itemprop="url">linux内存分配原理（brk和mmap）（转载）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="如何查看进程发生缺页中断的次数？"><a href="#如何查看进程发生缺页中断的次数？" class="headerlink" title="如何查看进程发生缺页中断的次数？"></a><strong>如何查看进程发生缺页中断的次数？</strong></h3><pre><code>ps -o majflt,minflt -C program</code></pre><p>majflt代表major fault，中文名叫大错误，minflt代表minor fault，中文名叫小错误。<br>这两个数值表示一个进程自启动以来所发生的缺页中断的次数。</p>
<h3 id="发成缺页中断后，执行了那些操作？"><a href="#发成缺页中断后，执行了那些操作？" class="headerlink" title="发成缺页中断后，执行了那些操作？"></a><strong>发成缺页中断后，执行了那些操作？</strong></h3><p>当一个进程发生缺页中断的时候，进程会陷入内核态，执行以下操作： </p>
<ol>
<li>检查要访问的虚拟地址是否合法 </li>
<li>查找/分配一个物理页 </li>
<li>填充物理页内容（读取磁盘，或者直接置0，或者啥也不干） </li>
<li>建立映射关系（虚拟地址到物理地址） </li>
<li>重新执行发生缺页中断的那条指令 </li>
</ol>
<p>如果第3步，需要读取磁盘，那么这次缺页中断就是majflt，否则就是minflt。 </p>
<h3 id="内存分配的原理"><a href="#内存分配的原理" class="headerlink" title="内存分配的原理"></a><strong>内存分配的原理</strong></h3><p>从操作系统角度来看，进程分配内存有两种方式，分别由两个系统调用完成：brk和mmap（不考虑共享内存）。</p>
<ol>
<li>brk是将数据段(.data)的最高地址指针_edata往高地址推；</li>
<li>mmap是在进程的虚拟地址空间中（堆和栈中间，称为文件映射区域的地方）找一块空闲的虚拟内存。</li>
</ol>
<p><strong>这两种方式分配的都是虚拟内存，没有分配物理内存。<br>在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立虚拟内存和物理内存之间的映射关系。</strong><br>在标准C库中，提供了malloc/free函数分配释放内存，这两个函数底层是由brk，mmap，munmap这些系统调用实现的。</p>
<h3 id="以例子来说明内存分配的原理"><a href="#以例子来说明内存分配的原理" class="headerlink" title="以例子来说明内存分配的原理"></a><strong>以例子来说明内存分配的原理</strong></h3><h4 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a><strong>情况一</strong></h4><p>malloc小于128k的内存，使用brk分配内存，<br>将_edata往高地址推(只分配虚拟空间，不对应物理内存(因此没有初始化)，<br>第一次读/写数据时，引起内核缺页中断，内核才分配对应的物理内存，然后虚拟地址空间建立映射关系)，如下图：</p>
<p><img src="/images/malloc/1.jpg" alt="brk" title="wizard"></p>
<ul>
<li><p>进程启动的时候，其（虚拟）内存空间的初始布局如图1所示。<br>其中，mmap内存映射文件是在堆和栈的中间（例如libc-2.2.93.so，其它数据文件等），为了简单起见，省略了内存映射文件。<br>_edata指针（glibc里面定义）指向数据段的最高地址。 </p>
</li>
<li><p>进程调用A=malloc(30K)以后，内存空间如图2：<br>malloc函数会调用brk系统调用，将_edata指针往高地址推30K，就完成虚拟内存分配。<br>你可能会问：只要把_edata+30K就完成内存分配了？<br>事实是这样的，_edata+30K只是完成虚拟地址的分配，A这块内存现在还是没有物理页与之对应的，<br>等到进程第一次读写A这块内存的时候，发生缺页中断，这个时候，内核才分配A这块内存对应的物理页。<br>也就是说，如果用malloc分配了A这块内容，然后从来不访问它，那么，A对应的物理页是不会被分配的。 </p>
</li>
<li><p>进程调用B=malloc(40K)以后，内存空间如图3。</p>
</li>
</ul>
<h4 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a><strong>情况二</strong></h4><p>malloc大于128k的内存，使用mmap分配内存，在堆和栈之间找一块空闲内存分配(对应独立内存，而且初始化为0)，如下图：</p>
<p><img src="/images/malloc/2.jpg" alt="mmap" title="build"></p>
<ul>
<li><p>进程调用C=malloc(200K)以后，内存空间如图4：<br>默认情况下，malloc函数分配内存，如果请求内存大于128K（可由M_MMAP_THRESHOLD选项调节），<br>那就不是去推_edata指针了，而是利用mmap系统调用，从堆和栈的中间分配一块虚拟内存。<br>  <strong>这样子做主要是因为:<br>  brk分配的内存需要等到高地址内存释放以后才能释放<br>  （例如，在B释放之前，A是不可能释放的，这就是内存碎片产生的原因，什么时候紧缩看下面），<br>  而mmap分配的内存可以单独释放。</strong><br>  当然，还有其它的好处，也有坏处，再具体下去，有兴趣的同学可以去看glibc里面malloc的代码了。 </p>
</li>
<li><p>进程调用D=malloc(100K)以后，内存空间如图5；</p>
</li>
<li><p>进程调用free(C)以后，C对应的虚拟内存和物理内存一起释放。</p>
</li>
</ul>
<p><img src="/images/malloc/3.jpg" alt="free" title="dot"></p>
<ul>
<li><p>进程调用free(B)以后，如图7所示：<br>B对应的虚拟内存和物理内存都没有释放，因为只有一个_edata指针，如果往回推，那么D这块内存怎么办呢？<br>当然，B这块内存，是可以重用的，如果这个时候再来一个40K的请求，那么malloc很可能就把B这块内存返回回去了。 </p>
</li>
<li><p>进程调用free(D)以后，如图8所示：<br>B和D连接起来，变成一块140K的空闲内存。</p>
</li>
<li><p>默认情况下：<br>当最高地址空间的空闲内存超过128K（可由M_TRIM_THRESHOLD选项调节）时，执行内存紧缩操作（trim）。<br>在上一个步骤free的时候，发现最高地址空闲内存超过128K，于是内存紧缩，变成图9所示。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/doxygen-graphviz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/doxygen-graphviz/" class="post-title-link" itemprop="url">Ubuntu下使用Doxygen和graphviz来产生源代码函数调用图</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Doxygen/" itemprop="url" rel="index">
                    <span itemprop="name">Doxygen</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>721</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><pre><code>sudo apt-get install doxygen doxygen-doc doxygen-gui graphviz
doxywizard
doxygen -g</code></pre><h3 id="生成函数调用图"><a href="#生成函数调用图" class="headerlink" title="生成函数调用图"></a><strong>生成函数调用图</strong></h3><h4 id="DoxyWizard"><a href="#DoxyWizard" class="headerlink" title="DoxyWizard"></a><strong>DoxyWizard</strong></h4><p>打开DoxyWizard，弹出Doxygen配置界面。如下图，标出了主要需要设置的选项:</p>
<p><img src="/images/doxygen/1.png" alt="wizard" title="wizard"></p>
<ol>
<li>Step1：设置doxygen的工作目录，这里主要是生成doxygen运行的目录</li>
<li>Step2：选项设置，wizard和expert选项可以同时设置。</li>
</ol>
<p>wizard选项卡中，选择Project Name作为工程名称，将来会显示在文档的标题中；<br>选择Source code directory，设置源代码所在目录，Destination directory设置文档的生成目录；<br>选择Scan recursively则递归分析源代码目录中的子目录内的源代码。</p>
<h4 id="build"><a href="#build" class="headerlink" title="build"></a><strong>build</strong></h4><p>需要从没有任何标记的源代码中分析出函数调用关系，所以还需要设置expert选项卡:</p>
<p><img src="/images/doxygen/2.png" alt="build" title="build"></p>
<p>勾选Build选项中的与函数有关的选项，EXTRACT_ALL必须勾选；<br>sourcebrowser: 需要查看代码，勾选Inline sources和souce Browser。</p>
<h4 id="dot"><a href="#dot" class="headerlink" title="dot"></a><strong>dot</strong></h4><p>由于使用到了Graphviz，所以要设置Dot选项，勾选HAVE_DOT，并设置DOT_PATH为Graphviz的bin目录。</p>
<p><img src="/images/doxygen/3.png" alt="dot1" title="dot"></p>
<p>Dot: 这里可以勾选CLASS_DIAGRAMS/HAVE_DOT/CALL_GRAPH/CALLER_GRAPH/DOT_PATH</p>
<p><img src="/images/doxygen/4.png" alt="dot2" title="dot2"></p>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a><strong>run</strong></h4><p>然后就可以点RUN标签，运行后，会生成HTML，查看INDEX.HTML既可以看到结果</p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_7a1c18a80102vd2p.html" target="_blank" rel="noopener">Ubuntu 下使用 Doxygen</a></li>
<li><a href="http://www.07net01.com/program/229677.html" target="_blank" rel="noopener">使用Doxygen+graphviz+Sublime2来看代码，查看函数调用关系</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/grep-special/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/grep-special/" class="post-title-link" itemprop="url">Grep搜索特定文件</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>120</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a><strong>Script</strong></h3><pre><code>grep XXYYZZ * -Rn --include=&#39;*.c&#39;
grep XXYYZZ * -Rn --include=&#39;*.h&#39;
grep XXYYZZ * -Rn --include=&#39;*.[ch]&#39;</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/vim-multifile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/vim-multifile/" class="post-title-link" itemprop="url">VIM多文件查找与替换</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>708</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a><strong>Script</strong></h3><pre><code>find . -name &quot;*.c&quot; | xargs sed -i &quot;s/$1/$2/g&quot;</code></pre><h3 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a><strong>VIM</strong></h3><h4 id="多文件查找"><a href="#多文件查找" class="headerlink" title="多文件查找"></a><strong>多文件查找</strong></h4><h5 id="grep"><a href="#grep" class="headerlink" title="grep"></a><strong>grep</strong></h5><p>直接在vim中输入</p>
<pre><code>:grep abc * </code></pre><p>这是直接调用unix下的grep命令 </p>
<h5 id="vimgrep"><a href="#vimgrep" class="headerlink" title="vimgrep"></a><strong>vimgrep</strong></h5><p>基本用法就是</p>
<pre><code>:vimgrep /匹配模式/[g][j] 要搜索的文件/范围 
:vim[grep][!] /{pattern}/[g][j] {file} ...</code></pre><p>g 和 j 是两个可选的标志位，g表示是否把每一行的多个匹配结果都加入。j表示是否搜索完后定位到第一个匹配位置。<br>要搜索的文件可以是具体的文件路径，也可以是带通配符的路径比如 <em>.as **/</em>.as ，**表示递归所有子目录。<br>要搜索的文件和或搜索范围都可以写多个，用空格分开。 例子：</p>
<pre><code>:vimgrep /\/ **/*.as 搜索当前目录以及所有子目录内as文件中的 &quot;flash&quot;
:vimgrep /an error/ *.c 就是在所有的.c文件中搜索an error。
:vimgrep/an error/* 意思是查找当前目录下的文件中的an error，不包括子目录</code></pre><h5 id="定位"><a href="#定位" class="headerlink" title="定位"></a><strong>定位</strong></h5><p>输入上述的命令后，可以像输入:make命令，那样定位匹配到的文件位置 </p>
<pre><code>:cnext (:cn)           下一个匹配位置
:cprevious (:cp)     上一个匹配位置
:cwindow (:cw)     quickfix窗口，可以选择匹配的文件位置
:cl(:clist)                查看所有匹配的位置</code></pre><h4 id="多文件替换-arg"><a href="#多文件替换-arg" class="headerlink" title="多文件替换(arg)"></a><strong>多文件替换(arg)</strong></h4><ol>
<li>加入要处理的文件  :args *.txt</li>
<li>输入对上述文件的动作  :argdo %s/hate/love/gc | update  （这里将hate替换成love，update表示要写入到文件中，否则只作替换而不写入）</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/05/07/lib32-for-ubuntu64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/05/07/lib32-for-ubuntu64/" class="post-title-link" itemprop="url">ubuntu64位系统32位兼容包</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-05-08 00:00:00" itemprop="dateCreated datePublished" datetime="2015-05-08T00:00:00+08:00">2015-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ubuntu/" itemprop="url" rel="index">
                    <span itemprop="name">ubuntu</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>612</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ubuntu 14.04 64位无法安装ia32-libs，此包已被移除</p>
<pre><code>sudo apt-get install ia32-libs</code></pre><p>替换为</p>
<pre><code>sudo apt-get install libc6:i386
sudo apt-get install lib32z1 lib32ncurses5 lib32bz2-1.0</code></pre><p>上面这些包基本上都是基本必备库，另外编译中需要到的各个库可以搜索相应的版本，进行安装，例如：</p>
<pre><code>➜  /home/yanwzh  &gt; sudo apt-cache search libelf

libelf-dev - libelf1 development libraries and header files
libelf1 - library to read and write ELF files
libelfg0 - an ELF object file access library
libelfg0-dev - an ELF object file access library: development files
libelf-freebsd-1 - library to read and write ELF files
libelf-freebsd-dev - Development files for libelf (FreeBSD version)

➜  /home/yanwzh  &gt; sudo apt-get install libelf-dev:i386</code></pre><p>使用sudo apt-get install somepkg:i386 来强制安装32位版本</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/05/nm-symbols/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/05/nm-symbols/" class="post-title-link" itemprop="url">nm symbols 类型及程序组成</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-06 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-06T00:00:00+08:00">2015-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/Linker/" itemprop="url" rel="index">
                    <span itemprop="name">Linker</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>nm symbols</code> 类型列表</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2015/04/05/nm-symbols/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-cpu-load/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-cpu-load/" class="post-title-link" itemprop="url">Ecos Cpu Load[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ecos/" itemprop="url" rel="index">
                    <span itemprop="name">Ecos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>cpuload组件包提供了一种估算CPU负载的方式。它可以估算最近0.1秒、1秒和10秒内的CPU负载百分比。</p>
<h3 id="负载测量API"><a href="#负载测量API" class="headerlink" title="负载测量API"></a><strong>负载测量API</strong></h3><p>首先，必须在被测目标机上对测量算法进行校准，一旦校准完成后就可以开始测量。<br>测量是一个连续过程，因此总是提供最近的测量数据，测量过程可以根据需要随时停止。<br>一旦开始测量过程，就可以获取测量结果。</p>
<p>需要注意的是：如果目标机或CPU执行任何节能措施，例如降低时钟频率或者挂起CPU等，<br>这些节能措施将干扰CPU负载测量，在这种情况下，测量结果是未定义的。<br>Synthetic Target就是这样的情况之一。阅读本文后续实现细节章节可以了解更多。</p>
<p>『译注』Cortex-M架构的默认实现会在执行空闲任务时挂起CPU，<br>因此默认情况下，测量结果并非是实际的CPU负载，<br>需要重定义HAL_IDLE_THREAD_ACTION宏取消空闲时挂起，<br>HAL_IDLE_THREAD_ACTION宏的默认实现位于hal/cortexm/arch/<version>/include/hal_arch.h:336。</p>
<p>负载测量不支持SMP系统，仅支持单CPU系统。</p>
<p>负载测量API可以在cyg/cpuload/cpuload.h中找到。</p>
<p>『译注』源代码位于services/cpuload</p>
<h4 id="cyg-cpuload-calibrate"><a href="#cyg-cpuload-calibrate" class="headerlink" title="cyg_cpuload_calibrate"></a><strong>cyg_cpuload_calibrate</strong></h4><p>这个函数用来校准CPU负载测量算法。它执行一次特别的测量过程确定空闲时的CPU性能。</p>
<pre><code>void cyg_cpuload_calibrate(cyg_uint32* calibration);  </code></pre><p>该函数通过calibration指针返回校准值。<br>这个函数是非常特别的，为了获得正确的校准结果需要满足若干条件。<br>该函数使用了2个最高线程优先级，当该函数被使用时，其它线程不能使用这两个优先级。<br>调用该函数时，内核调度器必须已经启动而且调度器未加锁。<br>该函数将花费0.1秒的时间完成校准操作，在这0.1秒校准期间不能有任何其它线程执行。</p>
<p>『译注』这个函数使用了线程优先级1和2，为了获得正确的测量结果，<br>其它线程不能使用优先级1和2。eCos的最高线程优先级是0，如果有优先级为0的线程，<br>必须保证在校准过程该线程处于挂起状态，<br>否则校准过程可能被优先级为0的线程抢占而导致错误的校准结果。</p>
<p>『译注』该函数将会创建一个线程，线程堆栈大小为CYGNUM_HAL_STACK_SIZE_MINIMUM，<br>在Cortex-M架构下约1.5KB，该线程仅在校准过程执行一次，<br>随后被删除永远都不会再执行，如果目标机内存非常有限，<br>应当知晓CPU负载测量校准时使用了1.5KB的堆栈空间。</p>
<h4 id="cyg-cpuload-create"><a href="#cyg-cpuload-create" class="headerlink" title="cyg_cpuload_create"></a><strong>cyg_cpuload_create</strong></h4><p>这个函数启动CPU负载测量。</p>
<pre><code>void cyg_cpuload_create(cyg_cpuload_t* cpuload,  
        cyg_uint32 calibrate,  
        cyg_handle_t* handle);  </code></pre><p>调用该函数启动测量过程，handle返回操作句柄，通过该句柄可以读取测量结果以及停止测量过程。</p>
<h4 id="cyg-cpuload-delete"><a href="#cyg-cpuload-delete" class="headerlink" title="cyg_cpuload_delete"></a><strong>cyg_cpuload_delete</strong></h4><p>这个函数停止CPU负载测量。</p>
<pre><code>void cyg_cpuload_delete(cyg_handle_t handle);  </code></pre><p>handle必须是cyg_cpuload_create函数返回的操作句柄。</p>
<h4 id="cyg-cpuload-get"><a href="#cyg-cpuload-get" class="headerlink" title="cyg_cpuload_get"></a><strong>cyg_cpuload_get</strong></h4><p>这个函数返回最近的测量结果。</p>
<pre><code>void cyg_cpuload_get(cyg_handle_t handle,  
        cyg_uint32* average_point1s,  
        cyg_uint32* average_1s,  
        cyg_uint32* average_10s);  </code></pre><p>handle必须是cyg_cpuload_create函数返回的操作句柄。<br>最近0.1秒、1秒和10秒的负载测量结果通过average_point1s、average_1s和average_10s返回。</p>
<h3 id="实现细节"><a href="#实现细节" class="headerlink" title="实现细节"></a><strong>实现细节</strong></h3><p>这一节给出一些测量过程的实现细节，这些细节可以帮助我们理解测量结果的意义。<br>当没有其它线程可以执行时，eCos将执行空闲线程，空闲线程总是可执行的而且使用最低线程优先级。<br>空闲线程只做一点点事情，它有一个永远都不会退出的循环，每次循环将idle_thread_loops变量加1，<br>然后调用HAL_IDLE_THREAD_ACTION宏。<br>CPU负载测量算法就是使用了idle_thread_loops变量，<br>测量算法周期性地检查idle_thread_loops变量，并记录前后两次检查的差值，<br>系统越空这个差值就越大，通过这个简单的手段就可以确定系统的负载。</p>
<p>cyg_cpuload_calibrate函数执行空闲任务0.1秒，<br>从而确定系统空闲0.1秒的时间内idle_thread_loops会被累加多少次。<br>cyg_cpuload_create函数启动一个闹钟，这个闹钟每隔0.1秒调用回调函数，<br>回调函数计算idle_thread_loops从上次检查到本次检查的差值，然后根据这个差值以及校准值计算出CPU负载。<br>回调函数用新的计算结果更新cyg_cpuload结构，<br>0.1秒负载只是简单地复制最近的测量结果，然后通过一个简单的滤波计算1秒和10秒负载。<br>由于舍入误差的存在，即使系统满负载，1秒和10秒测量值也永远都不会达到100%，通常看到的是99%。</p>
<p>如前所述，电源管理代码将干扰上述测量结果。<br>CPU负载测量的基本假设是：空闲线程可以无障碍地运行，而且运行条件与校准时的运行条件保持一致。<br>如果降低CPU时钟频率，那么空闲线程的计数器累加速率将变慢，<br>因此CPU负载测量结果值将偏高，如果CPU被完全挂起，那么CPU负载测量结果将是100%。</p>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a><strong>Ref</strong></h3><ol>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/cpuload-functions.html" target="_blank" rel="noopener">Chapter 68. CPU Load Measurements</a></li>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/ecos-ref.html" target="_blank" rel="noopener">eCos Reference Manual</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-stack-info/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-stack-info/" class="post-title-link" itemprop="url">Ecos Stack Info[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ecos/" itemprop="url" rel="index">
                    <span itemprop="name">Ecos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>如何获得eCos系统的线程堆栈和中断堆栈使用情况。<br>eCos是开源免版税的抢占式实时操作系统。其最大亮点是可配置，<br>与其配套的图形化配置工具提供组件管理、选项配置、自动化单元测试等。<br>eCos官网<a href="http://ecos.sourceware.org。" target="_blank" rel="noopener">http://ecos.sourceware.org。</a></p>
<p>在嵌入式系统中，堆栈是静态分配的，<br>不会依据堆栈的使用情况自动增加堆栈深度，存在堆栈溢出的风险。<br>一旦发生堆栈溢出，后果很严重，可能会立即导致死机，也可能埋了一颗定时炸弹，<br>在随后的开发过程随时导致死机。<br>事实上，堆栈溢出导致死机还算是不错的状况，<br>更糟糕的情况是，有时候正常，有时候功能错误，捉摸不定，<br>如果又是在修改了与这个堆栈压根就没什么关系的代码的情况下出现，<br>那真的要吐血，因为第一感觉会告诉你，刚刚修改的代码存在错误。<br>好在可以预防这种情况，稍微专业点的RTOS就会提供堆栈检查API，<br>eCos当然也不例外，在有堆栈检查API的RTOS中，<br>即使已经发生了堆栈溢出，也可以快速诊断哪个堆栈产生溢出。</p>
<h3 id="堆栈检查选项"><a href="#堆栈检查选项" class="headerlink" title="堆栈检查选项"></a><strong>堆栈检查选项</strong></h3><p>堆栈检查通常是发生在开发和测试阶段，<br>因此在eCos中堆栈检查功能是一个可选项，<br>要使用eCos堆栈检查功能，首先要打开对应的选项。</p>
<pre><code>&gt; eCos kernel  
    &gt; Thread-related options  
        &gt; Measure stack usage  </code></pre><h3 id="堆栈检查API"><a href="#堆栈检查API" class="headerlink" title="堆栈检查API"></a><strong>堆栈检查API</strong></h3><p>使能Measure stack usage选项后，cyg_thread_measure_stack_usage函数可用，函数原型如下：</p>
<pre><code>cyg_uint32 cyg_thread_measure_stack_usage(cyg_handle_t thread)  </code></pre><p>这个函数以线程句柄为入参，返回该线程已使用的堆栈深度，以字节为单位。</p>
<p>仅有已使用堆栈深度是不够的，<br>使用cyg_thread_get_stack_size获取线程堆栈大小，<br>使用cyg_thread_get_stack_base获取线程堆栈基址。<br>通过这三个函数可以确定线程堆栈存储位置，分配空间大小，已使用堆栈大小，<br>通过已使用堆栈大小与分配空间大小相比可以评估线程堆栈是否存在堆栈溢出的风险。<br>此外，可以使用cyg_thread_get_info函数一次性获取上述三个参数。</p>
<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a><strong>代码示例</strong></h3><p>使用cyg_thread_get_info可以一次性地获取上述三个参数，<br>而且还可以获取其他线程信息，使用cyg_thread_get_next可以枚举当前运行环境下的所有线程。<br>下面的代码使用cyg_thread_get_next函数枚举所有线程，<br>然后调用cyg_thread_get_info获取线程信息，<br>并打印线程名称和堆栈使用情况。<br>如果堆栈检查选项未使能，那么thread_info.stack_used为0。</p>
<pre><code>cyg_handle_t thread = 0;  
cyg_uint16 id;  
cyg_thread_info thread_info;  

while(cyg_thread_get_next(&amp;thread, &amp;id))  
{  
    if(cyg_thread_get_info(thread, id, &amp;thread_info))  
    {  
        diag_printf(&quot;name: %s, handle: 0x%08x, id: 0x%04x, &quot;  
                &quot;stack_base: 0x%08x, stack_size: %d, stack_used: %d\n&quot;,  
                thread_info.name, thread_info.handle, thread_info.id,  
                thread_info.stack_base, thread_info.stack_size, thread_info.stack_used);  
    }  
    else  
    {  
        diag_printf(&quot;ERROR: get thread info failed, handle: 0x%08x, id: 0x%04x\n&quot;,  
                thread, id);  
    }  
}  </code></pre><h3 id="影响堆栈深度的因素"><a href="#影响堆栈深度的因素" class="headerlink" title="影响堆栈深度的因素"></a><strong>影响堆栈深度的因素</strong></h3><ol>
<li><p>函数调用深度，每调用1次函数至少需要8字节堆栈空间用来保存LR寄存器以及堆栈对齐，<br>因此嵌入式系统应当尽量避免递归调用，递归调用将大大增加对堆栈需求并且引入不确定性，最终可能导致堆栈溢出。</p>
</li>
<li><p>函数复杂度，函数越复杂使用的临时变量越多，<br>临时变量可以保存在寄存器或堆栈中，如果要保存在寄存器中，<br>那么首先要将原寄存器内容压栈保存，因此临时变量无论是保存在寄存器或堆栈都会增加堆栈深度。</p>
</li>
<li><p>编译选项，不同的编译参数会影响堆栈深度，<br>例如使用-O0编译出的代码要比-O2编译出的代码使用更多的堆栈。<br>因为使用-O0时，会将所有变量压栈，而不仅是保存在寄存器，这有利于调试，但会增加堆栈深度。</p>
</li>
<li><p>中断，产生中断时，中断服务函数将被中断线程的上下文保存到被中断线程的堆栈，<br>因此中断也会加深线程堆栈深度，中断嵌套将会加深中断堆栈。</p>
</li>
</ol>
<h3 id="堆栈检查原理"><a href="#堆栈检查原理" class="headerlink" title="堆栈检查原理"></a><strong>堆栈检查原理</strong></h3><p>在线程初始化时，将线程堆栈所有空间填入预设值，eCos预设值为0xDEADBEEF，<br>在调用cyg_thread_measure_stack_usage或者cyg_thread_get_info时从堆栈底部开始检查堆栈存储的内容是否为预设值，<br>如果是预设值说明该地址可能未被使用，如果不是那么说明该地址已经被使用。<br>预设值不是0而是0xDEADBEEF的原因是：变量值为0的可能性非常大，<br>而为0xDEADBEEF的可能性非常小，减少因为变量值与预设值相同而导致计算偏差的可能性。</p>
<pre><code>// kernel/&lt;version&gt;/include/thread.inl:222  
inline void Cyg_HardwareThread::attach_stack(CYG_ADDRESS s_base, cyg_uint32 s_size)  
{  
    ......  
#ifdef CYGFUN_KERNEL_THREADS_STACK_MEASUREMENT  
    {  
        CYG_WORD *base = (CYG_WORD *)s_base;  
        cyg_uint32 size = s_size/sizeof(CYG_WORD);  
        cyg_ucount32 i;  

        for (i=0; i&lt;size; i++) {  
            base[i] = 0xDEADBEEF;  
        }  
    }  
#endif  
    ......  
}  
&lt;/version&gt;  

// kernel/&lt;version&gt;/include/thread.inl:157  
inline cyg_uint32 Cyg_HardwareThread::measure_stack_usage(void)  
{  
    CYG_WORD *base = (CYG_WORD *)stack_base;  
    cyg_uint32 size = stack_size/sizeof(CYG_WORD);  
    cyg_ucount32 i;  

    for (i=0; i&lt;size; i++) {  
        if (base[i] != 0xDEADBEEF)  
            break;  
    }  
    return (size - i)*sizeof(CYG_WORD);  
}  
&lt;/version&gt;  </code></pre><h3 id="中断堆栈"><a href="#中断堆栈" class="headerlink" title="中断堆栈"></a><strong>中断堆栈</strong></h3><p>eCos提供了线程堆栈检查，但没有发现中断堆栈检查，<br>中断堆栈同样会有溢出的风险，因此编写了stkinfo组件对中断堆栈进行检查，<br>此外该组件还可以对不包含内核情况下的应用程序主堆栈进行检查。</p>
<h3 id="stkinfo组件"><a href="#stkinfo组件" class="headerlink" title="stkinfo组件"></a><strong>stkinfo组件</strong></h3><p>目前该组件仅支持Cortex-M架构，可能支持其他架构，但未经验证。</p>
<p>stkinfo扩展组件包提供的接口如下：</p>
<pre><code>typedef struct _cyg_stack_info  
{  
CYG_ADDRWORD    base;  
cyg_uint32      size;  
cyg_uint32      used;  
}cyg_stack_info;  

// initialize interrupt stack with known value.  
void cyg_interrupt_stack_measure_init(void);  

// Measure the stack usage of the interrupt.  
void cyg_get_interrupt_stack_info(cyg_stack_info* info);  

// initialize main stack with known value.  
void cyg_main_stack_measure_init(void);  

// Measure the stack usage of the user program.  
void cyg_get_main_stack_info(cyg_stack_info* info);  </code></pre><ol>
<li><p>堆栈信息数据结构，包括堆栈基址，堆栈大小，已使用堆栈大小。</p>
</li>
<li><p>中断堆栈检查初始化，这个函数将中断堆栈写入预设值，<br>但是仅写到堆栈的下半段，因为eCos使用中断堆栈作为初始化过程的堆栈，<br>因此中断的上半段已经在使用中，不能写入预设值，<br>从这里可以看出，只有在中断堆栈使用量超过堆栈大小一半时检查结果才比较精确，<br>但是用来判断堆栈溢出已经足够啦。</p>
</li>
<li><p>获取中断堆栈信息，包括堆栈已使用大小，<br>如果堆栈已使用量小于堆栈的一半，<br>那么总是返回堆栈的一半大小值，例如堆栈分配1024字节，实际仅使用378字节，<br>该函数返回的使用量是512字节，如果堆栈已使用量超过堆栈的一半，那么返回堆栈的实际使用量。</p>
</li>
<li><p>应用程序主堆栈初始化，与中断堆栈一样仅初始化下半段，如果当前配置包含内核，那么该函数什么都不做。</p>
</li>
<li><p>获取应用程序主堆栈信息，包括堆栈已使用大小，如果当前配置包含内核，那么info数据结构的所有值为0。</p>
</li>
</ol>
<h3 id="安装stkinfo组件"><a href="#安装stkinfo组件" class="headerlink" title="安装stkinfo组件"></a><strong>安装stkinfo组件</strong></h3><p>使用ecosadmin.tcl脚本安装stkinnfo组件，该脚本在eCos源代码的packages子目录下。</p>
<pre><code>cd &lt;ecos-prefix&gt;/packages  
tclsh ecosadmin.tcl add &lt;download-prefix&gt;/stkinfo-&lt;version&gt;.epk  
&lt;/version&gt;&lt;/download-prefix&gt;&lt;/ecos-prefix&gt;  </code></pre><p>也可以手动安装该组件。</p>
<pre><code>tar -xf &lt;download-prefix&gt;/stkinfo-&lt;version&gt;.epk  
cat &lt;download-prefix&gt;/pkgadd.db &gt;&gt; &lt;ecos-prefix&gt;/packages/ecos.db  
cp -R &lt;donwload-prefix&gt;/services &lt;ecos-prefix&gt;/packages/  
&lt;/ecos-prefix&gt;&lt;/donwload-prefix&gt;&lt;/ecos-prefix&gt;&lt;/download-prefix&gt;&lt;/version&gt;&lt;/download-prefix&gt;  </code></pre><h3 id="使用stkinfo组件"><a href="#使用stkinfo组件" class="headerlink" title="使用stkinfo组件"></a><strong>使用stkinfo组件</strong></h3><p>在对堆栈进行检查之前，首先要对堆栈进行预设值填充，<br>为了保证预设值不会覆盖当前正在使用的堆栈空间，<br>要在初始化的早期对堆栈进行预设值填充，<br>因此在hal_system_init函数中调用cyg_interrupt_stack_measure_init进行堆栈预设值填充。<br>hal_system_init是平台HAL的一部分，<br>在系统初始化早期被架构HAL调用。这里以Olimex LPC-1766-STK目标机为例。</p>
<pre><code>// hal/cortexm/lpc17xx/lpc1766stk/&lt;version&gt;/src/lpc1766stk_misc.c:78  
......  
#ifdef CYGPKG_STKINFO  
# include &lt;cyg/stkinfo/stkinfo.h&gt;  
#endif  
......  
    __externC void  
hal_system_init(void)  
{  
#ifdef CYGPKG_STKINFO  
    cyg_interrupt_stack_measure_init();  
    cyg_main_stack_measure_init();  
#endif  
    ......  
}  
......  </code></pre><p>初始化过后，可以在任意时刻调用cyg_get_interrupt_stack_info获取堆栈信息，<br>并打印堆栈的使用情况，<br>将上面打印堆栈使用情况的代码示例添加上中断堆栈后的示例如下，<br>这个示例的完整代码见stkinfo组件的测试用例。</p>
<pre><code>cyg_handle_t thread = 0;  
cyg_uint16 id;  
cyg_thread_info thread_info;  
cyg_stack_info  stack_info;  

cyg_get_interrupt_stack_info(&amp;stack_info);  
diag_printf(&quot;name: %s, &quot;  
        &quot;stack_base: 0x%08x, stack_size: %d, stack_used: &lt;=%d\n&quot;,  
        &quot;ISR/DSR&quot;,  
        stack_info.base, stack_info.size, stack_info.used);  

while(cyg_thread_get_next(&amp;thread, &amp;id))  
{  
    if(cyg_thread_get_info(thread, id, &amp;thread_info))  
    {  
        diag_printf(&quot;name: %s, handle: 0x%08x, id: 0x%04x, &quot;  
                &quot;stack_base: 0x%08x, stack_size: %d, stack_used: %d\n&quot;,  
                thread_info.name, thread_info.handle, thread_info.id,  
                thread_info.stack_base, thread_info.stack_size, thread_info.stack_used);  
    }  
    else  
    {  
        diag_printf(&quot;ERROR: get thread info failed, handle: 0x%08x, id: 0x%04x\n&quot;,  
                thread, id);  
    }  
}  </code></pre><p>Line4声明中断堆栈信息变量。</p>
<p>Line6调用cyg_get_interrupt_stack_info获取堆栈信息。</p>
<p>Line7打印中断堆栈基址、大小、已使用大小。</p>
<h3 id="Statue"><a href="#Statue" class="headerlink" title="Statue"></a><strong>Statue</strong></h3><pre><code>static const unsigned char * const thread_state_str[] = {
    &quot;RUN&quot;,      /* 0 - Running */
    &quot;SLEEP&quot;,    /* 1 - Sleeping */
    &quot;CNTSLP&quot;,   /* 2 - Counted sleep */
    &quot;SLPSET&quot;,   /* 3 - Sleep set */     
    &quot;SUSP&quot;,     /* 4 - Suspended */
    NULL,       /* 5 - INVALID */
    NULL,       /* 6 - INVALID */
    NULL,       /* 7 - INVALID */
    &quot;CREAT&quot;,    /* 8 - Creating */
    NULL,       /* 9 - INVALID */
    NULL,       /* 10 - INVALID */
    NULL,       /* 11 - INVALID */
    NULL,       /* 12 - INVALID */
    NULL,       /* 13 - INVALID */
    NULL,       /* 14 - INVALID */
    NULL,       /* 15 - INVALID */
    &quot;EXIT&quot;      /* 16 - Exiting */
};</code></pre><p>参考代码<strong>&lt;ecos3.0/packages/net/httpd/v3_0/src/monitor.c&gt;</strong></p>
<h3 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a><strong>Ref</strong></h3><ol>
<li><a href="http://blog.csdn.net/zoomdy/article/details/16970395" target="_blank" rel="noopener">获取eCos堆栈使用情况</a></li>
<li><a href="http://ecos.sourceware.org/docs-3.0/ref/ecos-ref.html" target="_blank" rel="noopener">eCos Reference Manual</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/04/ecos-mem-info/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/04/04/ecos-mem-info/" class="post-title-link" itemprop="url">Ecos Mem Info[转]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-04-05 00:00:00" itemprop="dateCreated datePublished" datetime="2015-04-05T00:00:00+08:00">2015-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Ecos/" itemprop="url" rel="index">
                    <span itemprop="name">Ecos</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>嵌入式系统的内存资源是非常有限的，<br>如果配置不当可导致eCos应用程序因为存储空间不足而链接失败。<br>解决这个问题的办法可以是增加更多的内存或者是减少软件对内存资源的使用，通常是后一种办法。<br>既然要减少内存使用量，那么首先要找出都是哪些变量吃光了内存，<br>就是说要对映像符号进行分析，找出最占内存的变量，<br>看看能否避免使用该变量或减少该变量的占用容量。<br>GNU工具链中的nm就是做这个事情用的，按照用户手册的说法，<br>nm是用来解析映像符号的，包括符号使用容量和所在的文件。</p>
<h2 id="查找最占内存变量"><a href="#查找最占内存变量" class="headerlink" title="查找最占内存变量"></a><strong>查找最占内存变量</strong></h2><pre><code>$ nm --print-size --line-numbers --size-sort app.elf | grep &quot; [dDbB] &quot;  
......  
10004154 00000800 b var_data    /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/ecos/sys_arch.c:84  
10002fb0 00000b00 b timer_table  
10001f98 00001000 b main_stack  
10004994 00001800 b stack_data  /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/ecos/sys_arch.c:95  
2007c000 000018b8 b emac_ahb_ram        /cygdrive/f/ecos/hg/packages/devs/eth/arm/lpc2xxx/current/src/if_lpc2xxx.c:357  
20080388 0000283b b memp_memory /cygdrive/f/ecos/hg/packages/net/lwip_tcpip/current/src/core/memp.c:146  </code></pre><ul>
<li>–print-size：打印符号符号占用内存量</li>
<li>–line-numbers：打印符号所在的源文件名及行号</li>
<li>–size-sort：以符号占用内存量来排序</li>
<li>app.elf：eCos应用映像文件名</li>
<li>输出内容按列分别为：符号地址、符号占用内存量、符号类型、所在文件及行号</li>
<li>grep的作用是过滤不需要的符号，我们这里仅需要存储在RAM中的变量，将常量和函数等过滤掉，<br>注意grep参数的引号和方括号之间有空格。<br>输出结果按照变量内容占用量排序输出，最后输出的是占用量最大的变量。<br>从上面的输出可以看出memp_memory占用的内存最多，通过文件名可以判断这是lwIP内存池，<br>修改lwIP配置减少连接数和缓存数目等可以减少该变量的内存占用量。</li>
</ul>
<h2 id="链接失败时的办法"><a href="#链接失败时的办法" class="headerlink" title="链接失败时的办法"></a><strong>链接失败时的办法</strong></h2><p>如果容量超限，压根就不能编译完成，也就谈不上映像文件了，<br>这时候可以修改target.ld文件，修改内存容量，内存容量可以修改成比目标机实际容量更大的值，<br>修改target.ld的目的是可以正确地生成映像文件然后使用nm来分析内存使用情况并进行调整，<br>而不是下载到目标机运行，如果target.ld设定的内存容量比目标机实际内存容量大，<br>即使下载到目标机也不能正常运行。根据nm输出结果及应用需求调整内存使用量，<br>当映像使用的内存容量小于目标机实际内存容量后，恢复target.ld的内存容量设置。</p>
<h2 id="使用size查看总内存量"><a href="#使用size查看总内存量" class="headerlink" title="使用size查看总内存量"></a><strong>使用size查看总内存量</strong></h2><p>nm打印出每个符号占用的内存量，而size打印映像的总内存量，<br>可以使用size输出快速判断容量是否超限的问题，size还可以显示srec和ihex格式的映像容量。</p>
<pre><code>$ size app.elf  
text    data     bss     dec     hex filename  
158712    1852   43503  204067   31d23 app.elf  </code></pre><h2 id="使用哪个nm？"><a href="#使用哪个nm？" class="headerlink" title="使用哪个nm？"></a><strong>使用哪个nm？</strong></h2><p>nm和size只是对ELF格式的映像文件符号和加载段进行分析，<br>因此跟硬件架构没多大关系，<br>使用nm或arm-eabi-nm的效果是一样的，如果不放心，那就用arm-eabi-nm吧，size同理。</p>
<h2 id="nm常用参数"><a href="#nm常用参数" class="headerlink" title="nm常用参数"></a><strong>nm常用参数</strong></h2><h3 id="C-–demangle"><a href="#C-–demangle" class="headerlink" title="-C, –demangle"></a><strong>-C, –demangle</strong></h3><p>逆向解析C++符号转换，编译C++源代码时，<br>会将C++符号转换成符号汇编器要求的符号，<br>如果不对C++符号进行逆向解析，那么看到的是汇编符号而不是C++源文件中的符号名。</p>
<p>使用该参数前，输出汇编符号，晦涩难懂</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
00006adc T _ZN10Cyg_Thread5delayEy  
......  </code></pre><p>使用该参数后，输出C++符号，与源文件符号一致</p>
<pre><code>$ arm-eabi-nm -C app.elf  
    ......  
00006adc T Cyg_Thread::delay(unsigned long long)  
    ......  </code></pre><h3 id="l-–line-numbers"><a href="#l-–line-numbers" class="headerlink" title="-l, –line-numbers"></a><strong>-l, –line-numbers</strong></h3><p>输出符号所在的文件名和行号。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
0001a0c4 T write  </code></pre><p>使用该参数后，行尾追加文件名和行号</p>
<pre><code>$ arm-eabi-nm -l app.elf  
......  
0001a0c4 T write        /cygdrive/f/ecos/hg/packages/io/fileio/current/src/io.cxx:169  </code></pre><h3 id="S-–print-size"><a href="#S-–print-size" class="headerlink" title="-S, –print-size"></a><strong>-S, –print-size</strong></h3><p>输出符号占用内存量。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
0001a0c4 T write  </code></pre><p>使用该参数后，第2列数字为符号占用内存量</p>
<pre><code>$ arm-eabi-nm -S app.elf  
......  
0001a0c4 00000034 T write  </code></pre><h3 id="n-–numeric-sort"><a href="#n-–numeric-sort" class="headerlink" title="-n, –numeric-sort"></a><strong>-n, –numeric-sort</strong></h3><p>输出结果按照符号地址排序。使用该参数前</p>
<pre><code>$ arm-eabi-nm app.elf  
......  
000202c8 T udp_sendto_if  
00018ec0 t update_arp_entry  
10004154 b var_data  
1000497c b var_handle  
10004954 b var_mempool  
00009a60 T vfnprintf  
0001a0c4 T write  </code></pre><p>使用该参数后，根据第1列数值排序</p>
<pre><code>$ arm-eabi-nm -n app.elf  
......  
100070b0 A __heap1  
10007fe0 A hal_startup_stack  
2007c000 A __ahb_sram0_start  
2007c000 b emac_ahb_ram  
2007d8b8 A __ahb_sram0_end  
20080000 A __ahb_sram1_start  
20080000 b ram_heap  
20080388 b memp_memory  
20082bc3 A __ahb_sram1_end  </code></pre><h3 id="–size-sort"><a href="#–size-sort" class="headerlink" title="–size-sort"></a><strong>–size-sort</strong></h3><p>按照内存使用量排序。使用该参数前</p>
<pre><code>$ arm-eabi-nm -S app.elf  
......  
10004154 00000800 b var_data  
1000497c 00000004 b var_handle  
10004954 00000028 b var_mempool  
00009a60 000015f4 T vfnprintf  
0001a0c4 00000034 T write  </code></pre><p>使用该参数后，根据第2列数值进行排序</p>
<pre><code>$ arm-eabi-nm -S --size-sort app.elf  
......  
10001f98 00001000 b _ZL10main_stack  
0001cf38 000011dc t tcp_receive  
00009a60 000015f4 T vfnprintf  
10004994 00001800 b stack_data  
2007c000 000018b8 b emac_ahb_ram  
20080388 0000283b b memp_memory </code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/10/lua-run/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/03/10/lua-run/" class="post-title-link" itemprop="url">Linux lua及依赖库安装</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-03-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-03-11T00:00:00+08:00">2015-03-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-31 13:02:18" itemprop="dateModified" datetime="2020-03-31T13:02:18+08:00">2020-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>655</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>lua5.2暂时不使用，使用lua5.1+luarocks</p>
<ol>
<li>看readline软件包是否安装（dpkg -l | grep -i 软件名）</li>
<li>是否安装ncurses安装包（ncurses安装包 ）</li>
<li>是否安装libncurses5-dev 或libncursesw5-dev软件包（apt-get install libncurses5-dev）</li>
</ol>
<h2 id="ncurses-5-9-tar-gz"><a href="#ncurses-5-9-tar-gz" class="headerlink" title="ncurses-5.9.tar.gz"></a>ncurses-5.9.tar.gz</h2><pre><code>$ ./configure
$ make
$ sudo make install</code></pre><h2 id="readline-6-3-tar-gz"><a href="#readline-6-3-tar-gz" class="headerlink" title="readline-6.3.tar.gz"></a>readline-6.3.tar.gz</h2><pre><code>$ ./configure
$ make
$ sudo make install
$ sudo ldconfig</code></pre><h2 id="lua-5-2-3-tar-gz"><a href="#lua-5-2-3-tar-gz" class="headerlink" title="lua-5.2.3.tar.gz"></a>lua-5.2.3.tar.gz</h2><pre><code>$ sudo apt-get install libreadline6-dev
$ sudo apt-get install libreadline6-dbg
$ make linux
$ OK</code></pre><h2 id="lua-cjson"><a href="#lua-cjson" class="headerlink" title="lua-cjson"></a>lua-cjson</h2><pre><code>$ vim Makefile
LUA_VERSION = 5.2    
$ make
$ sudo make install</code></pre><h2 id="lua-rocks"><a href="#lua-rocks" class="headerlink" title="lua rocks"></a>lua rocks</h2><p>luarocks会自动安装lua版本，现在版本为5.1，如果版本不一致，会导致找不到安装包，建议使用手动方式安装需要的包；</p>
<p>如果使用luarocks管理包，不要单独安装lua，或者必须保证版本一致为5.1</p>
<pre><code>$ sudo apt-get install luarocks
$ sudo luarocks install luasocket
$ luarocks list
$ sudo luarocks install lua-cjson
$ luarocks search **</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Breeze.Temple"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Breeze.Temple</p>
  <div class="site-description" itemprop="description">Breeze.Temple</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">440</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">470</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/breezetemple" title="GitHub &rarr; https://github.com/breezetemple" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org" title="BitBucket &rarr; https://bitbucket.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-bitbucket"></i>BitBucket</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://breezetemple.github.io/" title="http://breezetemple.github.io/" rel="noopener" target="_blank">Breeze.Temple's HomePage</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Breeze.Temple</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">18:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  


  <link rel="stylesheet" href="/js/highlight/styles/solarized-dark.css">
  <script src="/js/highlight/highlight.pack.js"></script>
  <script type="text/javascript">
      $(function() {
          hljs.initHighlighting();
      });
  </script>

</body>
</html>

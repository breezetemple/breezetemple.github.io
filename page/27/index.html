<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Breeze.Temple">
<meta property="og:type" content="website">
<meta property="og:title" content="IT日记">
<meta property="og:url" content="http://yoursite.com/page/27/index.html">
<meta property="og:site_name" content="IT日记">
<meta property="og:description" content="Breeze.Temple">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Breeze.Temple">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>IT日记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Life is Now.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/25/makefile-and-shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/25/makefile-and-shell/" class="post-title-link" itemprop="url">Makefile中嵌入一段shell脚本及函数列表</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-26T00:00:00+08:00">2015-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Make/" itemprop="url" rel="index">
                    <span itemprop="name">Make</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>


<p>Makefile中需要在编译前进行一些处理，shell可以方便完成。以下为在Makefile中使用shell需要注意的一些事项：</p>
<h2 id="makefile和shell区别"><a href="#makefile和shell区别" class="headerlink" title="makefile和shell区别"></a>makefile和shell区别</h2><h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><p>shell中所有引用<strong>以$打头的变量其后要加{}</strong>,而在Makefile中的变量是<strong>以$打头的后加()</strong>。如下：</p>
<pre><code>Makefile
PATH=&quot;/data/&quot;
SUBPATH=$(PATH)

Shell
PATH=&quot;/data/&quot;
SUBPATH=${PATH}</code></pre><h3 id="引用shell变量"><a href="#引用shell变量" class="headerlink" title="引用shell变量"></a>引用shell变量</h3><p>Makefile中所有以$打头的单词都会被解释成Makefile中的变量。<br>如果<strong>需要调用shell中的变量（或者正则表达式中锚定句位$），都需要加两个$符号（$$）</strong>。如下：</p>
<pre><code>PATH=&quot;/data/&quot;
all:
    echo $(PATH)
    echo $$PATH</code></pre><p>第一个$(PATH)引用的是Makefile中的变量，而不是shell中的PATH环境变量，后者引用的是Shell中的PATH环境变量。</p>
<h3 id="通配符区别"><a href="#通配符区别" class="headerlink" title="通配符区别"></a>通配符区别</h3><p>shell 中通配符*表示所有的字符；Makefile 中通配符%表示所有的字符</p>
<h3 id="打印输出"><a href="#打印输出" class="headerlink" title="打印输出"></a>打印输出</h3><p>在Makefile中只能在target中调用Shell脚本，其他地方是不能输出的。比如如下代码就是没有任何输出：</p>
<pre><code>VAR=&quot;Hello&quot;
echo &quot;$VAR&quot;
all:</code></pre><p>以上代码任何时候都不会输出，没有在target内，如果上述代码改为如下：</p>
<pre><code>VAR=&quot;Hello&quot;
all:
    echo &quot;$VAR&quot;</code></pre><p>以上代码，在make all的时候将会执行echo命令。</p>
<h3 id="代码片段"><a href="#代码片段" class="headerlink" title="代码片段"></a>代码片段</h3><p>Makefile中的shell，每一行是一个进程，不同行之间变量值不能传递。所以，Makefile中的shell不管多长也要写在一行<br>在Makefile中执行shell命令，一行创建一个进程来执行。<br>不同行之间变量值不能传递。<br>这也是为什么很多Makefile中有很多行的末尾都是“;\”，<br>以此来保证代码是一行而不是多行，这样Makefile可以在一个进程中执行，例如：</p>
<pre><code>SUBDIR=src example
all:
    @for subdir in $(SUBDIR); \     #shell代码开始
    do\
        echo &quot;building &quot;; \
    done</code></pre><p>上述可以看出for循环中每行都是以”; \”结尾的。</p>
<h3 id="shell代码范围"><a href="#shell代码范围" class="headerlink" title="shell代码范围"></a>shell代码范围</h3><p>在Makefile文件的目标项冒号后的另起一行的代码才是shell代码。</p>
<pre><code>xx = xx1       #这里时makefile代码
yy：xx = xx2   #这是是makefile代码，makefile允许变量赋值时，&#39;=&#39;号两边留空格
yy：
    xx=xx3     #只有这里是shell代码 ，shell不允许‘=’号两边有空格哦。

有一个例外：
xx=$(shell 这里的代码也是shell代码)</code></pre><h3 id="makefile总的反引号"><a href="#makefile总的反引号" class="headerlink" title="makefile总的反引号`"></a>makefile总的反引号<strong>`</strong></h3><p>反引号括起来的字符串被shell解释为命令行，<br>在执行时，shell首先执行该命令行，并以它的标准输出结果取代整个反引号（包括两个反引号）部分</p>
<pre><code>PATH=`pwd`
TODAY=`date`

#等同于
PATH=$(shell pwd)
TODAY=$(shell date)</code></pre><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>获取当前目录</strong></p>
<pre><code>TOPDIR:=$(shell pwd)</code></pre><p><strong>获取日期</strong></p>
<pre><code>DATE:=$(shell date +%Y%m%d)</code></pre><p><strong>获取源文件列表</strong></p>
<pre><code>SRC += $(shell find . -iname &quot;*.c&quot;  | grep -v &quot;./opensource/*&quot;)
SRC += $(shell find . -iname &quot;*.cpp&quot;)

PRE_SRC=$(shell find -name &quot;*.c&quot; | xargs grep &quot;HANDLER&quot; | awk -F &#39;:&#39; &#39;{print $$1}&#39; | sort -u) #注意awk中使用的是 $$1</code></pre><p><strong>Makefile打印输出</strong></p>
<pre><code>print_version:
    @echo $(BR2_VERSION_FULL)</code></pre><p><strong>Makefile嵌入脚本</strong></p>
<pre><code>env:                                                                                                                                
    sh $(SRC_PATH)/scripts/connect.sh
    find $(SRC_PATH) -name &quot;sysinfo.o&quot; | xargs rm -f

signalpre:                                                                                                                          
    sed -i &#39;s/HANDLER/HANDLER HANDLERX/g&#39; $(LIB_PATH)/include/core.h
    @mkdir -p $(SRC_PATH)/output/signalpres
    @echo &quot;\033[031msignale handler processor...\033[0m&quot;
    @for f in $(PRE_SRC); do \
        OBJ=$(SRC_PATH)/output/signalpres/`basename $$f|sed -e &#39;s/\.c/\.i/&#39;`; \
        $(CC) $(CFLAGS) -E $$f -o $$OBJ;\
        echo -n &quot;.&quot;;\
    done
    sed -i &#39;s/HANDLER HANDLERX/HANDLER/g&#39; $(LIB_PATH)/include/core.h
    echo &quot;\n&quot;

prepare_config:
    @chmod +x scripts/proj.sh
    @scripts/proj.sh
    @chmod +x scripts/theme.sh
    @scripts/theme.sh</code></pre><p><strong>Makefile中的exec执行脚本</strong></p>
<pre><code>format:
    @echo &quot;Makeing format...&quot;;
    @find -name &quot;*.c&quot; -exec dos2unix -qU 2&gt;d2utmp1 {} \;
    @find -name &quot;*.h&quot; -exec dos2unix -qU 2&gt;d2utmp1 {} \; 
#   @find -name &quot;*.c&quot; -exec indent -npro -kr -i8 -sob -l120 -ss -ncs  {} \;
    @find -name &quot;*~&quot; -exec rm {} \;
    @find -name &quot;d2utmp*&quot; -exec rm {} \;
    @find -name &quot;deps*&quot; -exec rm {} \;</code></pre><p><strong>循环处理文件行</strong></p>
<pre><code>cat config_tmp | while read line
do
    echo &quot;${line}&quot;

    MACRO=$(echo ${line} | awk -F &#39; &#39; &#39;{print $2}&#39;)
    VALUE=$(echo ${line} | awk -F &#39; &#39; &#39;{print $3}&#39;)
    echo &quot;Macro: $MACRO Value: $VALUE\n&quot;

    #cat &quot;$SIGNALE_HANDLER_FILE&quot; | sed -e &quot;s/$MACRO/$VALUE/g&quot; &gt; signal_tmp
    sed -i &quot;s/$MACRO/$VALUE/g&quot; ${SIGNALE_HANDLER_FILE}
done</code></pre><p><strong>grep反选</strong></p>
<pre><code>cat $CONFIG_FILE | sed -s &#39;/^$/d&#39; | grep -v -e &quot;LangName&quot; -e &quot;__CONFIG_H__&quot; -e &quot;#endif&quot; -e &quot;//&quot; &gt; config_tmp</code></pre><p><strong>Makefile依赖规则</strong></p>
<pre><code>OBJS=$(addprefix $(SRC_PATH)/objects/, $(addsuffix .o, $(basename $(notdir $(SRC)))))

deps: $(SRC)
    @-rm -f deps;
    @for f in $(SRC); do \
        OBJ=$(SRC_PATH)/objects/`basename $$f|sed -e &#39;s/\.c/\.o/&#39;`; \
        echo $$OBJ: $$f&gt;&gt; deps; \
        echo &#39;  @echo -e &quot;compiling \033[032m[$(CC)]\033[0m&quot;: &#39; $$f &gt;&gt; deps; \
        echo &#39;  $(CC) $$(CFLAGS) -c -o $$@ $$^&#39;&gt;&gt; deps; \
    done</code></pre><p><strong>Makefile模式规则</strong></p>
<pre><code>%.d: %.c
    @set -e; rm -f $@; \
    $(CC) -M $(CPPFLAGS) $&lt; &gt; $@.$$$$; \
    sed &#39;s,\($*\)\.o[ : ]*,\1.o $@ : ,g&#39; &lt; $@.$$$$ &gt; $@; \
    rm -f $@.$$$$</code></pre><p>这个规则的意思是，所有的[.d]文件依赖于[.c]文件，“rm -f $@”的意思是删除所有的目标，也就是[.d]文件，<br>第二行的意思是，为每个依赖文件“$&lt;”，也就是[.c]文件生成依赖文件，“$@”表示模式“%.d”文件，<br>如果有一个C文件是name.c，那么“%”就是 “name”，“$$$$”意为一个随机编号，<br>第二行生成的文件有可能是“name.d.12345”，<br>第三行使用sed命令做了一个替换，关于sed命令的用法请参看相关的使用文档。<br>第四行就是删除临时文件。</p>
<p><strong>变量值的替换</strong></p>
<pre><code>foo := a.o b.o c.o
bar := $(foo:.o=.c)

foo := a.o b.o c.o
bar := $(foo:%.o=%.c)</code></pre><p>变量<em>.o替换为</em>.c</p>
<h2 id="makefile函数列表"><a href="#makefile函数列表" class="headerlink" title="makefile函数列表"></a>makefile函数列表</h2><p>函数调用，很像变量的使用，也是以“$”来标识的，其語法如下：</p>
<pre><code>$(&lt;function&gt; &lt;arguments&gt;)</code></pre><p>或是</p>
<pre><code>${&lt;function&gt; &lt;arguments&gt;}</code></pre><p>这里，&lt;function&gt;就是函数名，make支持的函数不多。<br>&lt;arguments&gt;为函数的参数，参数间以逗号“,”分隔，而函数名和参数之间以“空格”分隔。<br>函数调用以“$”开头，以圆括号或花括号把函数名和参数括起。<br>感觉很像一个变量，是不是？函数中的参数可以使用变量，为了风格的统一，函数和变量的括号最好一样，<br>如使用“$(subst a,b,$(x))”这样的形式，而不是“$(subst a,b, ${x})”的形式。<br>因为统一会更清楚，也会减少一些不必要的麻烦。</p>
<h3 id="字符串处理函数"><a href="#字符串处理函数" class="headerlink" title="字符串处理函数"></a>字符串处理函数</h3><ul>
<li>$(subst &lt;from&gt;,&lt;to&gt;,&lt;text&gt;), 字符串替换函数</li>
<li>$(patsubst &lt;pattern&gt;,&lt;replacement&gt;,&lt;text&gt;), 模式字符串替换函数</li>
<li>$(strip &lt;string&gt;), 去空格函数,字串中开头和结尾的空字符</li>
<li>$(findstring &lt;find&gt;,&lt;in&gt;), 查找字符串函数</li>
<li>$(filter &lt;pattern…&gt;,&lt;text&gt;), 以&lt;pattern&gt;模式过滤&lt;text&gt;字符串中的单词，保留符合模式&lt;pattern&gt;的单词。可以有多个模式</li>
<li>$(filter-out &lt;pattern…&gt;,&lt;text&gt;), 以&lt;pattern&gt;模式过滤&lt;text&gt;字符串中的单词，去除符合模式&lt;pattern&gt;的单词。可以有多个模式</li>
<li>$(sort &lt;list&gt;), 给字符串&lt;list&gt;中的单词排序（升序）。</li>
<li>$(word &lt;n&gt;,&lt;text&gt;), 取字符串&lt;text&gt;中第&lt;n&gt;个单词。（从一开始）</li>
<li>$(wordlist &lt;ss&gt;,&lt;e&gt;,&lt;text&gt;), 从字符串&lt;text&gt;中取从&lt;ss&gt;开始到&lt;e&gt;的单词串。&lt;ss&gt;和&lt;e&gt;是一个数字</li>
<li>$(words &lt;text&gt;), 统计&lt;text&gt;中字符串中的单词个数</li>
<li>$(firstword &lt;text&gt;), 取字符串&lt;text&gt;中的第一个单词</li>
</ul>
<p>搭配使用：</p>
<pre><code>override CFLAGS += $(patsubst %,-I%,$(subst :, ,$(VPATH)))</code></pre><p>如果我们的“$(VPATH)”值是“src:../headers”，<br>那么“$(patsubst %,-I%,$(subst :, ,$(VPATH)))”将返回“-Isrc -I../headers”，这正是cc或gcc搜索头文件路径的参数</p>
<h3 id="文件名操作函数"><a href="#文件名操作函数" class="headerlink" title="文件名操作函数"></a>文件名操作函数</h3><ul>
<li><p>$(dir &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出目录部分。目录部分是指最后一个反斜杠（“/”）之前的部分。如果没有反斜杠，那么返回“./”</p>
</li>
<li><p>$(notdir &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出非目录部分。非目录部分是指最後一个反斜杠（“/”）之后的部分</p>
</li>
<li><p>$(suffix &lt;names…&gt;) , 从文件名序列&lt;names&gt;中取出各个文件名的后缀</p>
</li>
<li><p>$(basename &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出各个文件名的前缀部分</p>
</li>
<li><p>$(addsuffix &lt;suffix&gt;,&lt;names…&gt;), 把后缀&lt;suffix&gt;加到&lt;names&gt;中的每个单词后面</p>
</li>
<li><p>$(addprefix &lt;prefix&gt;,&lt;names…&gt;), 把前缀&lt;prefix&gt;加到&lt;names&gt;中的每个单词后面</p>
</li>
<li><p>$(join &lt;list1&gt;,&lt;list2&gt;), 把&lt;list2&gt;中的单词对应地加到&lt;list1&gt;的单词后面。<br>如果&lt;list1&gt;的单词个数要比&lt;list2&gt;的多，那么，&lt;list1&gt;中的多出来的单词将保持原样。<br>如果&lt;list2&gt;的单词个数要比&lt;list1&gt;多，那么，&lt;list2&gt;多出来的单词将被复制到&lt;list1&gt;中</p>
<p>  $(join aaa bbb , 111 222 333)返回值是“aaa111 bbb222 333”</p>
</li>
</ul>
<h3 id="foreach-函数"><a href="#foreach-函数" class="headerlink" title="foreach 函数"></a>foreach 函数</h3><p>foreach函数和别的函数非常的不一样。<br>因为这个函数是用来做循环用的，<br>Makefile中的foreach函数几乎是仿照于Unix标准 Shell（/bin/sh）中的for语句，<br>或是C-Shell（/bin/csh）中的foreach语句而构建的。它的语法是：</p>
<pre><code>$(foreach   &lt;var&gt;,&lt;list&gt;,&lt;text&gt;)</code></pre><p>这个函数的意思是，把参数&lt;list&gt;中的单词逐一取出放到参数&lt;var&gt;所指定的变量中，<br>然后再执行&lt; text&gt;所包含的表达式。<br>每一次&lt;text&gt;会返回一个字符串，循环过程中，&lt;text&gt;的所返回的每个字符串会以空格分隔，<br>最后当整个循环结束时，<br>&lt;text&gt;所返回的每个字符串所组成的整个字符串（以空格分隔）将会是foreach函数的返回值。</p>
<p>所以，&lt;var&gt;最好是一个变量名，&lt;list&gt;可以是一个表达式，而&lt;text&gt;中一般会使用&lt;var&gt;这个参数来依次枚举&lt;list&gt;中的单词。举个例子：</p>
<pre><code>names := a b c d
files := $(foreach n,$(names),$(n).o)</code></pre><p>上面的例子中，$(name)中的单词会被挨个取出，并存到变量“n”中，“$(n).o”每次根据“$(n)”计算出一个值，<br>这些值以空格分隔，最后作为foreach函数的返回，所以，$(files)的值是“a.o b.o c.o d.o”。</p>
<p>注意，foreach中的&lt;var&gt;参数是一个临时的局部变量，foreach函数执行完后，参数&lt;var&gt;的变量将不在作用，其作用域只在foreach函数当中。</p>
<h3 id="if-函数"><a href="#if-函数" class="headerlink" title="if 函数"></a>if 函数</h3><p>if函数很像GNU的make所支持的条件语句——ifeq，if函数的语法是：</p>
<pre><code>$(if &lt;condition&gt;,&lt;then-part&gt;) </code></pre><p>或是</p>
<pre><code>$(if &lt;condition&gt;,&lt;then-part&gt;,&lt;else-part&gt;)</code></pre><h3 id="call函数"><a href="#call函数" class="headerlink" title="call函数"></a>call函数</h3><p>call函数是唯一一个可以用来创建新的参数化的函数。<br>你可以写一个非常复杂的表达式，这个表达式中，你可以定义许多参数，然后你可以用call函数来向这个表达式传递参数。其语法是：</p>
<pre><code>$(call &lt;expression&gt;;,&lt;parm1&gt;;,&lt;parm2&gt;;,&lt;parm3&gt;;...)</code></pre><p>当make执行这个函数时，&lt;expression&gt;;参数中的变量，<br>如$(1)，$(2)，$(3)等，会被参数&lt; parm1&gt;;，&lt;parm2&gt;;，&lt;parm3&gt;;依次取代。<br>而&lt;expression&gt;;的返回值就是 call函数的返回值。例如：</p>
<pre><code>reverse =  $(1) $(2)
foo = $(call reverse,a,b)</code></pre><p>那么，foo的值就是“a b”。当然，参数的次序是可以自定义的，不一定是顺序的，如：</p>
<pre><code>reverse =  $(2) $(1)
foo = $(call reverse,a,b)</code></pre><p>此时的foo的值就是“b a”。</p>
<h3 id="origin函数"><a href="#origin函数" class="headerlink" title="origin函数"></a>origin函数</h3><p>origin函数不像其它的函数，他并不操作变量的值，他只是告诉你你的这个变量是哪里来的？其语法是：</p>
<pre><code>$(origin &lt;variable&gt;;)</code></pre><p>注意，&lt;variable&gt;;是变量的名字，不应该是引用。<br>所以你最好不要在&lt;variable&gt;;中使用“$”字符。<br>Origin函数会以其返回值来告诉你这个变量的“出生情况”，下面，是origin函数的返回值:</p>
<ul>
<li>“undefined” 如果&lt;variable&gt;;从来没有定义过，origin函数返回这个值“undefined”。</li>
<li>“default” 如果&lt;variable&gt;;是一个默认的定义，比如“CC”这个变量，这种变量我们将在后面讲述。</li>
<li>“environment” 如果&lt;variable&gt;;是一个环境变量，并且当Makefile被执行时，“-e”参数没有被打开。</li>
<li>“file” 如果&lt;variable&gt;;这个变量被定义在Makefile中。</li>
<li>“command line” 如果&lt;variable&gt;;这个变量是被命令行定义的。</li>
<li>“override” 如果&lt;variable&gt;;是被override指示符重新定义的。</li>
<li>“automatic” 如果&lt;variable&gt;;是一个命令运行中的自动化变量。关于自动化变量将在后面讲述。</li>
</ul>
<p>这些信息对于我们编写Makefile是非常有用的，<br>例如，假设我们有一个Makefile其包了一个定义文件Make.def，<br>在 Make.def中定义了一个变量“bletch”，而我们的环境中也有一个环境变量“bletch”，<br>此时，我们想判断一下，如果变量来源于环境，那么我们就把之重定义了，<br>如果来源于Make.def或是命令行等非环境的，那么我们就不重新定义它。于是，在我们的Makefile中，我们可以这样写：</p>
<pre><code>ifdef bletch
    ifeq &quot;$(origin bletch)&quot; &quot;environment&quot;
        bletch = barf, gag, etc.
    endif
endif</code></pre><h3 id="shell函数"><a href="#shell函数" class="headerlink" title="shell函数"></a>shell函数</h3><p>它的参数应该就是操作系统Shell的命令。它和反引号<strong>`</strong>是相同的功能。<br>这就是说，shell函数把执行操作系统命令后的输出作为函数返回。<br>于是，我们可以用操作系统命令以及字符串处理命令awk，sed等等命令来生成一个变量，如：</p>
<pre><code>contents := $(shell cat foo)
files := $(shell echo *.c)</code></pre><p>注意，这个函数会新生成一个Shell程序来执行命令，所以你要注意其运行性能，<br>如果你的Makefile中有一些比较复杂的规则，并大量使用了这个函数，那么对于你的系统性能是有害的。<br>特别是Makefile的隐晦的规则可能会让你的shell函数执行的次数比你想像的多得多。</p>
<h2 id="自动化变量"><a href="#自动化变量" class="headerlink" title="自动化变量"></a>自动化变量</h2><ul>
<li><p>$@ 表示规则中的目标文件集。在模式规则中，如果有多个目标，那么，”$@”就是匹配于目标中模式定义的集合。</p>
</li>
<li><p>$% 仅当目标是函数库文件中，表示规则中的目标成员名。<br>例如，如果一个目标是”foo.a(bar.o)”，那么，”$%”就是 “bar.o”，”$@”就是”foo.a”。<br>如果目标不是函数库文件（Unix下是[.a]，Windows下是[.lib]），那么，其值为空。</p>
</li>
<li><p>$&lt; 依赖目标中的第一个目标名字。如果依赖目标是以模式（即”%”）定义的，那么”$&lt;”将是符合模式的一系列的文件集。<br>注意，其是一个一个取出来的。</p>
</li>
<li><p>$? 所有比目标新的依赖目标的集合。以空格分隔。</p>
</li>
<li><p>$^ 所有的依赖目标的集合。以空格分隔。如果在依赖目标中有多个重复的，那个这个变量会去除重复的依赖目标，只保留一份。</p>
</li>
<li><p>$+ 这个变量很像”$^”，也是所有依赖目标的集合。只是它不去除重复的依赖目标。</p>
</li>
<li><p>$* 这个变量表示目标模式中”%”及其之前的部分。如果目标是”dir/a.foo.b”，并且目标的模式是”a.%.b”，<br>那么，”$*“的值就是”dir/a.foo”。这个变量对于构造有关联的文件名是比较有较。如果目标中没有模式的定义，<br>那么”$*“也就不能被推导出，但是，如果目标文件的后缀是make所识别的，那么”$*“就是除了后缀的那一部分。<br>例如：如果目标是”foo.c”，因为”.c”是make所能识别的后缀名，<br>所以，” $*“的值就是”foo”。这个特性是GNU make的，很有可能不兼容于其它版本的make，<br>所以，你应该尽量避免使用”$*“，除非是在隐含规则或是静态模式中。如果目标中的后缀是make所不能识别的，那么”$*“就是空值。<br>当你希望只对更新过的依赖文件进行操作时，”$?”在显式规则中很有用，<br>例如，假设有一个函数库文件叫”lib”，其由其它几个object文件更新。那么把object文件打包的比较有效率的Makefile规则是：</p>
<p>  lib : foo.o bar.o lose.o win.o</p>
<pre><code>  ar r lib $?</code></pre></li>
</ul>
<p>在上述所列出来的自动量变量中。四个变量（$@、$&lt;、$%、$*）在扩展时只会有一个文件，<br>而另三个的值是一个文件列表。</p>
<p>对于”$&lt;”，为了避免产生不必要的麻烦，我们最好给$后面的那个特定字符都加上圆括号，比如，”$(&lt;)”就要比”$&lt;”要好一些。</p>
<ol>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0#shell.E5.87.BD.E6.95.B0" target="_blank" rel="noopener">makefile:使用函数</a></li>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile" target="_blank" rel="noopener">跟我一起写Makefile</a></li>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:%E9%9A%90%E5%90%AB%E8%A7%84%E5%88%99#.E4.BD.BF.E7.94.A8.E9.9A.90.E5.90.AB.E8.A7.84.E5.88.99" target="_blank" rel="noopener">makefile:隐含规则</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/21/compile-warning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/21/compile-warning/" class="post-title-link" itemprop="url">解决C编译警告</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-22 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-22T00:00:00+08:00">2015-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="implicit-declaration-of-function"><a href="#implicit-declaration-of-function" class="headerlink" title="implicit declaration of function"></a>implicit declaration of function</h2><pre><code>warning: implicit declaration of function &#39;app_create_dialog&#39;</code></pre><p>包含函数’app_create_dialog’定义的头文件解决警告。<br>如果没有声明头文件，可以将函数extern声明一下。</p>
<h2 id="unused-variable"><a href="#unused-variable" class="headerlink" title="unused variable"></a>unused variable</h2><pre><code>warning: unused variable &#39;buf&#39;</code></pre><p>删除不使用的变量</p>
<h2 id="initialization-discards-qualifiers-from-pointer-target-type"><a href="#initialization-discards-qualifiers-from-pointer-target-type" class="headerlink" title="initialization discards qualifiers from pointer target type"></a>initialization discards qualifiers from pointer target type</h2><pre><code>xx.c: In function &#39;cmm_cascam_create_dialog1&#39;:
xx.c:95:26: warning: initialization discards qualifiers from pointer target type</code></pre><p>添加类型强制转换</p>
<h2 id="pointer-targets-in-return-differ-in-signedness"><a href="#pointer-targets-in-return-differ-in-signedness" class="headerlink" title="pointer targets in return differ in signedness"></a>pointer targets in return differ in signedness</h2><pre><code>xx.c: In function &#39;cmm_ca_get_notice_str&#39;:
xx.c:58:5: warning: pointer targets in return differ in signedness</code></pre><p>数据类型不匹配，强制转换</p>
<h2 id="assignment-discards-qualifiers-from-pointer-target-type"><a href="#assignment-discards-qualifiers-from-pointer-target-type" class="headerlink" title="assignment discards qualifiers from pointer target type"></a>assignment discards qualifiers from pointer target type</h2><pre><code>ca/common_menu/cmm_cascam_dialog3.c: In function &#39;_create_dialog_check&#39;:
ca/common_menu/cmm_cascam_dialog3.c:150:17: warning: assignment discards qualifiers from pointer target type</code></pre><p>强制转换解决</p>
<h2 id="defined-but-not-used"><a href="#defined-but-not-used" class="headerlink" title="defined but not used"></a>defined but not used</h2><pre><code>x.c:59:12: warning: &#39;_mutex_delete&#39; defined but not used</code></pre><p>删除无用代码</p>
<h2 id="control-reaches-end-of-non-void-function"><a href="#control-reaches-end-of-non-void-function" class="headerlink" title="control reaches end of non-void function"></a>control reaches end of non-void function</h2><pre><code>module/cascam/cas/thinew/adapter/tnt_demux.c: In function &#39;_nit_set_equal_filter&#39;:
module/cascam/cas/thinew/adapter/tnt_demux.c:600:1: warning: control reaches end of non-void function</code></pre><p>添加</p>
<pre><code>return ret;</code></pre><h2 id="pointer-targets-in-passing-argument-1-of-‘cascam-strlen’-differ-in-signedness"><a href="#pointer-targets-in-passing-argument-1-of-‘cascam-strlen’-differ-in-signedness" class="headerlink" title="pointer targets in passing argument 1 of ‘cascam_strlen’ differ in signedness"></a>pointer targets in passing argument 1 of ‘cascam_strlen’ differ in signedness</h2><pre><code>module/cascam/cas/thinew/adapter/tnt_baseinfo.c: In function &#39;_get_basic_information&#39;:
module/cascam/cas/thinew/adapter/tnt_baseinfo.c:45:9: warning: pointer targets in passing argument 1 of &#39;cascam_strlen&#39; differ in signedness
module/cascam/cas/thinew/adapter/../../../include/cascam_os.h:61:14: note: expected &#39;char *&#39; but argument is of type &#39;unsigned char *&#39;</code></pre><p>形参与实参类型不匹配，强制转换</p>
<h2 id="warning-missing-braces-around-initializer"><a href="#warning-missing-braces-around-initializer" class="headerlink" title="warning: missing braces around initializer"></a>warning: missing braces around initializer</h2><pre><code>module/cascam/adapter/cascam_osd_adapter.c: In function &#39;cascam_osd_pop_dialog5&#39;:
module/cascam/adapter/cascam_osd_adapter.c:295:5: warning: missing braces around initializer
module/cascam/adapter/cascam_osd_adapter.c:295:5: warning: (near initialization for &#39;para.title&#39;)</code></pre><p>初始化大括号不明确，内部加上一个大括号，二维数组初始化。</p>
<h2 id="may-be-used-uninitialized-in-this-function"><a href="#may-be-used-uninitialized-in-this-function" class="headerlink" title="may be used uninitialized in this function"></a>may be used uninitialized in this function</h2><p>初始化变量</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/20/gdb-disassemble-debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/20/gdb-disassemble-debug/" class="post-title-link" itemprop="url">使用反汇编定位未开源库问题</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-21T00:00:00+08:00">2015-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>整合版本时，遇到一个必现死机问题，每次出现问题都是调用库中的一个函数。<br>经过排查，初步怀疑是库存在一些问题，或者与外部使用配合出现问题。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><pre><code>(gdb) set $pc=$epc
(gdb) i r r10
r10            0x970038656
(gdb) info registers 
r0             0x90972c100x90972c10
r1             0x90486564-1874303644
r2             0x970038656
r3             0xff255
r4             0x904895de-1874291234
r5             0xae174
r6             0x00
r7             0x00
r8             0x904d03a0-1874000992
r9             0x11110009286326793
r10            0x970038656
r11            0x6096
r12            0x11
r13            0x904d03a0-1874000992
r14            0x904d02a0-1874001248
r15            0x90142750-1877727408
pc             0x9000060a0x9000060a &lt;__default_14&gt;
epc            0x902abd300x902abd30 &lt;inflate_fast+708&gt;
psr            0x8f0e0010-1894907888
epsr           0x800e0150-2146565808
(gdb) pc
#0  0x9014279cin xxx_xxm()at xx.c:574
#1  0x90142750in xxx_xxm()at xx.c:568
#2  0x9014144ein xxx_xx()at xx.c:2659
#3  0x90141446in xxx_xx()at xx.c:2658
#4  0x9014143ein xxx_xx()at xx.c:2657
#5  0x901413f2in xxx_xx()at xx.c:2657
#6  0x901413dein xxx_xx()at xx.c:2652
#7  0x901413d2in xxx_xx()at xx.c:2652
(gdb) disassemble $pc-10,$pc+10
Dump of assembler code from 0x90000600 to 0x90000614:
0x90000600 &lt;__hardware_accelerator+2&gt;:br0x90000600
0x90000602 &lt;__trap0+0&gt;:bkpt
0x90000604 &lt;__trap0+2&gt;:br0x90000604
0x90000606 &lt;__default_13+0&gt;:bkpt
0x90000608 &lt;__default_13+2&gt;:br0x90000608
=&gt; 0x9000060a &lt;__default_14+0&gt;:bkpt
0x9000060c &lt;__default_14+2&gt;:br0x9000060c
0x9000060e &lt;__default_15+0&gt;:bkpt
0x90000610 &lt;__default_15+2&gt;:br0x90000610
0x90000612 &lt;__default_17+0&gt;:bkpt
End of assembler dump.
(gdb) bt
#0  0x9000060a in __default_14 ()
#1  0x90142750 in xxx_xxm () at xx.c:568
#2  0x9013cfb8 in func () at c1.c:167
#3  0x9013f394 in main_entry (args=&lt;value optimized out&gt;) at init.c:14
#4  0x9008724c in default_thread_function (arg=0x907f32b8) at os/ecos/osapi.c:371
#5  0x901232f2 in pthread_entry(unsigned int) ()
#6  0x90127030 in Cyg_HardwareThread::thread_entry(Cyg_Thread*) ()
#7  0x9012701c in Cyg_Thread::exit() ()
#8  0xb0b6ccd0 in ?? ()</code></pre><p>可以判断出r10中值出现问题，并且问题出现在文件xx.c的函数xxx_xxm()中，重启跟踪代码：</p>
<pre><code>(gdb) b xxx_xxm 
Breakpoint 3 at 0x901425f4: file xx.c, line 524.
(gdb) c
Continuing.

Breakpoint 3, xxx_xxm () at xx.c:524
524xx.c: 没有那个文件或目录.
in xx.c
(gdb) display /i $r10
1: x/i $r10
0x1111000a:ldm r3-r15, (r0)
(gdb) display /i $pc
2: x/i $pc
=&gt; 0x901425f4 &lt;xxx_xxm+20&gt;:lrw r7, 0x903BA9CC
(gdb) n
526in xx.c
(gdb) 
574in xx.c
2: x/i $pc
=&gt; 0x9014279c &lt;xxx_xxm+444&gt;:mov r7, r2
1: x/i $r10
0x1111000a:movi r4, 86
(gdb) 
575in xx.c
2: x/i $pc
=&gt; 0x901427a6 &lt;xxx_xxm+454&gt;:mov r2, r10
1: x/i $r10
0x9700:movi r4, 86</code></pre><p><strong>问题很可能出现在源文件xx.c的574行</strong>，执行过这一行之后，r10的值修改为0x9700，最后请客户检查代码，确认为野指针。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/18/vim-map-nmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/18/vim-map-nmap/" class="post-title-link" itemprop="url">VIM键值映射规则</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-19 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-19T00:00:00+08:00">2015-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="map模式"><a href="#map模式" class="headerlink" title="map模式"></a>map模式</h2><p>有五种映射存在： </p>
<ol>
<li>Normal mode: 普通模式, 输入命令时</li>
<li>Visual mode: 可视模式: 可视区域高亮并输入命令时</li>
<li>Select mode: 选择模式: 与可视模式区别是会替换选择文本</li>
<li>Operator-pending mode: 操作符等待模式: 操作符等待中 (“d”，”y”，”c” 等等之后)。 见下: |omap-info|。 </li>
<li>Insert mode: 插入模式: 也用于替换模式。 </li>
<li>Command-line mode: 命令行模式: 输入 “:” 或 “/“ 命令时。 </li>
</ol>
<h2 id="快捷键映射"><a href="#快捷键映射" class="headerlink" title="快捷键映射"></a>快捷键映射</h2><p>快捷键映射分两种: map 和 noremap</p>
<h3 id="递归映射-map"><a href="#递归映射-map" class="headerlink" title="递归映射 (map)"></a>递归映射 (map)</h3><p>如果键 b 映射为键 a，然后键 c 映射为键 b，那么当按键 c 时会产生按键 a 的效果。</p>
<pre><code>:map b a
:map c b</code></pre><p>相当于</p>
<pre><code>:map c a</code></pre><h3 id="非递归映射-noremap"><a href="#非递归映射-noremap" class="headerlink" title="非递归映射 (noremap)"></a>非递归映射 (noremap)</h3><pre><code>:noremap b a
:noremap c b</code></pre><p>非递归映射则不会产生递归映射一样的效果。</p>
<h2 id="不同模式下的快捷键映射"><a href="#不同模式下的快捷键映射" class="headerlink" title="不同模式下的快捷键映射"></a>不同模式下的快捷键映射</h2><h3 id="映射模式"><a href="#映射模式" class="headerlink" title="映射模式"></a>映射模式</h3><p>在 map 与 noremap 前分别可以加 ‘n’, ‘v’, ‘x’, ‘s’, ‘o’, ‘i’, ‘l’, ‘c’ 以及 ‘map!’ 和 ‘noremap!’：</p>
<ul>
<li><Space>    Normal, Visual, Select and Operator-pending</li>
<li>n    Normal</li>
<li>v    Visual and Select</li>
<li>s    Select (在可视模式下Ctrl+G进入)</li>
<li>x    Visual</li>
<li>o    Operator-pending</li>
<li>!    Insert and Command-line</li>
<li>i    Insert</li>
<li>l    “:lmap” mappings for Insert, Command-line and Lang-Arg</li>
<li>c    Command-line</li>
</ul>
<p>常用参数：</p>
<ul>
<li>{lhs} 表示左手边 *{lhs}*</li>
<li>{rhs} 表示右手边 *{rhs}*</li>
</ul>
<h3 id="普通模式的映射命令"><a href="#普通模式的映射命令" class="headerlink" title="普通模式的映射命令"></a>普通模式的映射命令</h3><p>可以随时<strong><em>:help map</em></strong>一下，查看相关命令具体信息。</p>
<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><pre><code>:map {lhs} {rhs} 
:map {lhs} {rhs} |mapmode-nvo| *:map* </code></pre><p>作用模式： n、v、o （普通、可视和选择、操作符等待）。<br>在:map作用的模式中把键系列 {lhs} 映射为 {rhs}，{rhs}可进行映射扫描，也就是可递归映射。 </p>
<p>举例： </p>
<pre><code>:map td :tabnew .&lt;cr&gt; </code></pre><p>在其作用模式（普通、可视、操作符）下，输入td等价于输入 :tabnew . <cr>。<br>而普通模式下输入:tabnew . <cr>就是打开当前目录，<br>如果再定义绑定：</p>
<pre><code>:map ts td</code></pre><p>就是指在其作用模式下输入ts等价于td，也就是打开当前目录。不过如果没有特殊需要，一般不建议递归映射。 </p>
<h4 id="noremap"><a href="#noremap" class="headerlink" title="noremap"></a>noremap</h4><p>:moremap和:map命令相对，作用模式和命令格式都相同，<br>只不过不允许再对{rhs}进行映射扫描，也就是{lhs}定义后的映射就是{rhs}的键序列，不会再对{rhs}键序列重新解释扫描。<br>它一般用于重定义一个命令，当然如果:map不需要递归映射的话，建议使用:noremap，比如： </p>
<pre><code>:noremap ts td </code></pre><p>它的意思是在其作用模式下，输入ts就是输入td，但是和:map不同的是，此时td再不会做进一步扫描解释。<br>虽然之前已经定义了td，但是不会对td再做扫描 </p>
<h4 id="unmap"><a href="#unmap" class="headerlink" title="unmap"></a>unmap</h4><p>:unmap是对应取消:map绑定的{lhs}，作用模式相同，命令格式</p>
<pre><code>:unmap {lhs}</code></pre><p>例如： </p>
<pre><code>:unmap td </code></pre><p>就是取消在其作用模式中td的绑定，比如之前td被绑定为:tabnew .<cr>，此时此绑定消失。 </p>
<h4 id="mapclear"><a href="#mapclear" class="headerlink" title="mapclear"></a>mapclear</h4><p>:mapclear时对应取消所有:map绑定的，慎用！ </p>
<h4 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h4><p>:nmap是:map的普通模式板，也就是说其绑定的键只作用于普通模式。例如： </p>
<pre><code>:nmap td :tabnew .&lt;cr&gt; </code></pre><p>在普通模式下等效 </p>
<pre><code>:map td :tabnew .&lt;cr&gt; </code></pre><h4 id="nnoremap"><a href="#nnoremap" class="headerlink" title="nnoremap"></a>nnoremap</h4><p>:nnorempa和:nmap的关系和:noremap和:map的关系一样，只是:nmap的非递归版 </p>
<h4 id="nunmap"><a href="#nunmap" class="headerlink" title="nunmap"></a>nunmap</h4><p>:nunmap和:nmap的关系和:unmap和:map的关系一样，取消:nmap的绑定。 </p>
<h4 id="nmapclear"><a href="#nmapclear" class="headerlink" title="nmapclear"></a>nmapclear</h4><p>:nmapclear是对应取消所有:map绑定的，慎用！ </p>
<p><strong>可以发现一个规律，前4个是一组，后4个时一组，后一组比前一组多一个n就是指只作用于普通模式。<br>其中每组内*nore*是其对应的非递归版、*un*是取消绑定某个&lt;lhs&gt;绑定、clear后缀是取消所有绑定。<br>发现了这个规律，再翻到前面的模式代号表，<br>大体可以猜到vmap、xmap、smap、omap是什么意思，以及相对应的nore版本、un版本、clear版本。</strong></p>
<p>另外，{rhs} 之前可能显示一个特殊字符: </p>
<ul>
<li>* 表示它不可重映射 </li>
<li>&amp; 表示仅脚本的局部映射可以被重映射 </li>
<li>@ 表示缓冲区的局部映射 </li>
</ul>
<h3 id="键表-key-notation"><a href="#键表-key-notation" class="headerlink" title="键表|key-notation|"></a>键表|key-notation|</h3><ul>
<li>&lt;k0&gt; - &lt;k9&gt; 小键盘 0 到 9 *keypad-0* *keypad-9* </li>
<li>&lt;S-…&gt; Shift＋键 *shift* *&lt;S-* </li>
<li>&lt;C-…&gt; Control＋键 *control* *ctrl* *&lt;C-* </li>
<li>&lt;M-…&gt; Alt＋键 或 meta＋键 *meta* *alt* *&lt;M-* </li>
<li>&lt;A-…&gt; 同 &lt;m-…&gt; *&lt;A-* </li>
<li>&lt;t_xx&gt; termcap 里的 “xx” 入口键 </li>
</ul>
<h3 id="特殊参数"><a href="#特殊参数" class="headerlink" title="特殊参数"></a>特殊参数</h3><ul>
<li>&lt;buffer&gt; </li>
<li>&lt;nowait&gt; </li>
<li>&lt;silent&gt; </li>
<li>&lt;special&gt; </li>
<li>&lt;script&gt; </li>
<li>&lt;expr&gt; </li>
<li>&lt;unique&gt; </li>
</ul>
<p>可以按任意顺序使用。它们必须紧跟在命令的后边，而在其它任何参数的前边。</p>
<h4 id="lt-buffer-gt"><a href="#lt-buffer-gt" class="headerlink" title="&lt;buffer&gt;"></a>&lt;buffer&gt;</h4><p>如果这些映射命令的第一个参数是&lt;buffer&gt;，映射将只局限于当前缓冲区（也就是你此时正编辑的文件）内。比如： </p>
<pre><code>:map &lt;buffer&gt; ,w /a&lt;CR&gt; </code></pre><p>它的意思时在当前缓冲区里定义键绑定，“,w”将在当前缓冲区里查找字符a。同样你可以在其他缓冲区里定义： </p>
<pre><code>:map &lt;buffer&gt; ,w /b&lt;CR&gt; </code></pre><p>其作用域也只在各自的标签里。同样要清除这些缓冲区的键绑定也要加上&lt;buffer&gt;参数，比如： </p>
<pre><code>:unmap &lt;buffer&gt; ,w 
:mapclear &lt;buffer&gt; </code></pre><h4 id="lt-nowait-gt"><a href="#lt-nowait-gt" class="headerlink" title="&lt;nowait&gt;"></a>&lt;nowait&gt;</h4><p>定义局部于缓冲区的映射 “,” 时，可能有另一个全局映射也以 “,” 开始。<br>这时你需要键入另一个字符，Vim 才能知道是用 “,” 映射还是更长的那个。<br>要避免这个问题，加入 <nowait> 参数。<br>这样映射一旦匹配就会被使用，Vim 不会等待更多字符的输入。但如果那些字符已经输入了，还是会使用的。</p>
<h4 id="lt-silent-gt"><a href="#lt-silent-gt" class="headerlink" title="&lt;silent&gt;"></a>&lt;silent&gt;</h4><p>执行键绑定时不在命令行上回显，比如： </p>
<pre><code>:map &lt;silent&gt; ,w /abcd&lt;CR&gt; </code></pre><p>输入,w查找abcd时，命令行上不会显示/abcd，如果没有&lt;silent&gt;参数就会显示出来 </p>
<h4 id="lt-special-gt"><a href="#lt-special-gt" class="headerlink" title="&lt;special&gt;"></a>&lt;special&gt;</h4><p>一般用于定义特殊键怕有副作用的场合。比如： </p>
<pre><code>:map &lt;special&gt; &lt;F12&gt; /Header&lt;CR&gt; </code></pre><h4 id="lt-unique-gt"><a href="#lt-unique-gt" class="headerlink" title="&lt;unique&gt;"></a>&lt;unique&gt;</h4><p>一般用于定义新的键映射或者缩写命令的同时检查是否该键已经被映射，如果该映射或者缩写已经存在，则该命令会失败 </p>
<pre><code>:map &lt;unique&gt; ,w  /[#&amp;!]&lt;CR&gt;</code></pre><p>这个例子将失败:</p>
<pre><code>:map ,w  /[#&amp;!]&lt;CR&gt;
:map &lt;buffer&gt; &lt;unique&gt; ,w  /[.,;]&lt;CR&gt;</code></pre><h4 id="lt-expr-gt"><a href="#lt-expr-gt" class="headerlink" title="&lt;expr&gt;"></a>&lt;expr&gt;</h4><p>如果定义新映射的第一个参数是&lt;expr&gt;，那么参数会作为表达式来进行计算，结果使用实际使用的&lt;rhs&gt;，例如： </p>
<pre><code>:inoremap &lt;expr\&gt; . InsertDot() </code></pre><p>这可以用来检查光标之前的文本并在一定条件下启动全能 (omni) 补全。 </p>
<p>这里是插入递增的列表编号的例子:</p>
<pre><code>let counter = 0 
inoremap &lt;expr&gt; &lt;C-L&gt; ListItem() 
inoremap &lt;expr&gt; &lt;C-R&gt; ListReset() 

func ListItem() 
    let g:counter += 1 
    return g:counter . &#39;. &#39; 
endfunc 

func ListReset() 
    let g:counter = 0 
    return &#39;&#39; 
endfunc </code></pre><p>CTRL-L 插入下一个数值，CTRL-R 复位计数且返回空字符串，这样就不会插入任何内容。</p>
<h3 id="lt-Leader-gt-mapleader"><a href="#lt-Leader-gt-mapleader" class="headerlink" title="&lt;Leader&gt;mapleader"></a>&lt;Leader&gt;mapleader</h3><p>要定义一个使用 “mapleader” 变量的映射，可以使用特殊字串 “<Leader>“。<br>它会被 “mapleader” 的字串值所替换。如果 “mapleader” 未设置或为空，则用反斜杠代替，例如:</p>
<pre><code>:map &lt;Leader&gt;A  oanother line&lt;Esc&gt;</code></pre><p>和下面一样:</p>
<pre><code>:map \A  oanother line&lt;Esc&gt;</code></pre><p>但是当:</p>
<pre><code>:let mapleader = &quot;,&quot;</code></pre><p>又相当于:</p>
<pre><code>:map ,A  oanother line&lt;Esc&gt;</code></pre><p>注意 “mapleader” 的值仅当定义映射时被使用。后来改变的 “mapleader” 不会影响已定义的映射。</p>
<ol>
<li><a href="http://vimcdoc.sourceforge.net/doc/map.html#:map-commands" target="_blank" rel="noopener">VIM 参考手册-MAP</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/15/go-with-vim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/15/go-with-vim/" class="post-title-link" itemprop="url">vim配置golang开发环境</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-16T00:00:00+08:00">2015-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="vim配置"><a href="#vim配置" class="headerlink" title="vim配置"></a>vim配置</h2><p>Vim-go是当前使用最为广泛的用于搭建Golang开发环境的vim插件：</p>
<pre><code>Bundle &#39;fatih/vim-go&#39;
:BundleInstall</code></pre><p>Tagbar配合gotags配置：</p>
<pre><code>let g:tagbar_type_go = {
    \ &#39;ctagstype&#39; : &#39;go&#39;,
    \ &#39;kinds&#39;     : [
        \ &#39;p:package&#39;,
    \ &#39;i:imports:1&#39;,
    \ &#39;c:constants&#39;,
    \ &#39;v:variables&#39;,
    \ &#39;t:types&#39;,
    \ &#39;n:interfaces&#39;,
    \ &#39;w:fields&#39;,
    \ &#39;e:embedded&#39;,
    \ &#39;m:methods&#39;,
    \ &#39;r:constructor&#39;,
    \ &#39;f:functions&#39;
        \ 
    ],
    \ &#39;sro&#39; : &#39;.&#39;,
    \ &#39;kind2scope&#39; : {
        \ &#39;t&#39; : &#39;ctype&#39;,
        \ &#39;n&#39; : &#39;ntype&#39;
            \ 
    },
    \ &#39;scope2kind&#39; : {
        \ &#39;ctype&#39; : &#39;t&#39;,
        \ &#39;ntype&#39; : &#39;n&#39;
            \ 
    },
    \ &#39;ctagsbin&#39;  : &#39;gotags&#39;,
    \ &#39;ctagsargs&#39; : &#39;-sort -silent&#39;
    \ }</code></pre><h2 id="安装Binaries"><a href="#安装Binaries" class="headerlink" title="安装Binaries"></a>安装Binaries</h2><p>还需要安装其他tools，vim-go安装说明中提到所有必要的binary需要先安装好，比如gocode、godef、goimports等。通过：</p>
<pre><code>:GoInstallBinaries</code></pre><p>查看文件.vim/bundle/vim-go/plugin/go.vim：</p>
<pre><code>let s:packages = [
    \ &quot;github.com/nsf/gocode&quot;,
    \ &quot;golang.org/x/tools/cmd/goimports&quot;,
    \ &quot;github.com/rogpeppe/godef&quot;,
    \ &quot;golang.org/x/tools/cmd/oracle&quot;,
    \ &quot;golang.org/x/tools/cmd/gorename&quot;,
    \ &quot;github.com/golang/lint/golint&quot;,
    \ &quot;github.com/kisielk/errcheck&quot;,
    \ &quot;github.com/jstemmer/gotags&quot;,
    \ ]</code></pre><p>这些vim-go依赖的二进制工具将会自动被下载，并被安装到$GOBIN下，但是自动安装很可能部分tools安装不成功，此时需要手动安装：</p>
<pre><code>go get -u github.com/nsf/gocode

//或者
git clone https://go.googlesource.com/tools $GOPATH/src/golang.org/x/tools
go build golang.org/x/tools/cmd/goimports</code></pre><p>安装golint：</p>
<pre><code>./3rdpkg/src/github.com/golang
git clone git@github.com:golang/lint.git
cd ../../../../go/bin
pwd
./go/bin
go build -x github.com/golang/lint/golint
cp $WORK/github.com/golang/lint/golint/_obj/exe/a.out golint</code></pre><h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><p>安装完毕$GOBIN目录如下：</p>
<pre><code>.
├── errcheck
├── go
├── gocode
├── godef
├── godoc
├── gofmt
├── goimports
├── gorename
├── gotags
└── oracle</code></pre><ul>
<li><a href="https://github.com/jstemmer/gotags" target="_blank" rel="noopener">gotags</a> 这个用来配合vim的tagbar，查看方便的生成和查看文件中的各种方法，并进行跳转</li>
<li><a href="https://godoc.org/golang.org/x/tools/cmd/goimports" target="_blank" rel="noopener">goimport</a> 根据你所使用的方法，自动调整import中引用的内容，比较方便。<br>可以随时用vim命令 :Fmt 来格式化你的代码，也可以每次保存代码的时候，让vim自动为你格式化代码</li>
<li><a href="https://github.com/dgryski/vim-godef" target="_blank" rel="noopener">godef</a> 实现在代码中的跳转，从函数调用的地方，直接跳转到函数的定义。默认的命令是：gd</li>
<li><a href="https://github.com/nsf/gocode" target="_blank" rel="noopener">gocode</a>实现Golang的代码自动补全</li>
</ul>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><ul>
<li>新起一行输入fmt.，然后ctrl+x, ctrl+o，Vim 会弹出补齐提示下拉框，不过并非实时跟随的那种补齐，这个补齐是由gocode提供的。</li>
<li>输入一行代码：time.Sleep(time.Second)，执行:GoImports，Vim会自动导入time包。</li>
<li>将光标移到Sleep函数上，执行:GoDef或命令模式下敲入gd，Vim会打开$GOROOT/src/time/sleep.go中 的Sleep函数的定义。执行:b 1返回到hellogolang.go。</li>
<li>执行:GoLint，运行golint在当前Go源文件上。</li>
<li>执行:GoDoc，打开当前光标对应符号的Go文档。</li>
<li>执行:GoVet，在当前目录下运行go vet在当前Go源文件上。</li>
<li>执行:GoRun，编译运行当前main package。</li>
<li>执行:GoBuild，编译当前包，这取决于你的源文件，GoBuild不产生结果文件。</li>
<li>执行:GoInstall，安装当前包。</li>
<li>执行:GoTest，测试你当前路径下地_test.go文件。</li>
<li>执行:GoCoverage，创建一个测试覆盖结果文件，并打开浏览器展示当前包的情况。</li>
<li>执行:GoErrCheck，检查当前包种可能的未捕获的errors。</li>
<li>执行:GoFiles，显示当前包对应的源文件列表。</li>
<li>执行:GoDeps，显示当前包的依赖包列表。</li>
<li>执行:GoImplements，显示当前类型实现的interface列表。</li>
<li>执行:GoRename [to]，将当前光标下的符号替换为[to]。</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="http://studygolang.com/articles/1785" target="_blank" rel="noopener">Golang开发环境搭建</a></li>
<li><a href="https://github.com/nsf/gocode" target="_blank" rel="noopener">gocode</a></li>
<li><a href="https://github.com/golang" target="_blank" rel="noopener">Go</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/13/GB-set/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/13/GB-set/" class="post-title-link" itemprop="url">GBK、GB2312和GB18030</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-14 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-14T00:00:00+08:00">2015-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Font/" itemprop="url" rel="index">
                    <span itemprop="name">Font</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="GB2312-80"><a href="#GB2312-80" class="headerlink" title="GB2312-80"></a>GB2312-80</h2><p><strong>GB 2312或GB 2312-80 是中国国家标准简体中文字符集</strong>，<br>全称《信息交换用汉字编码字符集·基本集》，又称GB0，由中国国家标准总局发布，1981年5月1日实施。<br>GB2312编码通行于中国大陆；新加坡等地也采用此编码。中国大陆几乎所有的中文系统和国际化的软件都支持GB 2312。</p>
<p><strong>GB 2312标准共收录6763个汉字，其中一级汉字3755个，二级汉字3008个；</strong><br>同时收录了包括拉丁字母、希腊字母、日文平假名及片假名字母、俄语西里尔字母在内的682个字符。</p>
<ul>
<li>GB 2312的出现，基本满足了汉字的计算机处理需要，它所收录的汉字已经覆盖中国大陆99.75%的使用频率。</li>
<li>对于人名、古汉语等方面出现的罕用字，GB 2312不能处理，这导致了后来GBK及GB 18030汉字字符集的出现。</li>
</ul>
<p><strong>GB2312对任意一个图形字符都采用两个字节表示</strong>，并对所收汉字进行了“分区”处理，每区含有94个汉字／符号，<br>分别对应第一字节和第二字节。这种表示方式也称为区位码。</p>
<ul>
<li>01-09区为特殊符号。</li>
<li>16-55区为一级汉字，按拼音排序。</li>
<li>56-87区为二级汉字，按部首／笔画排序。</li>
<li>10-15区及88-94区则未有编码。</li>
</ul>
<p><strong>GB2312的编码范围为2121H-777EH，与ASCII有重叠，通行方法是将GB码两个字节的最高位置1以示区别。</strong></p>
<h2 id="GBK"><a href="#GBK" class="headerlink" title="GBK"></a>GBK</h2><p><strong>GBK即汉字内码扩展规范</strong>，K为汉语拼音 Kuo Zhan（扩展）中“扩”字的声母。英文全称Chinese Internal Code Specification。</p>
<p><strong>GBK共收入21886个汉字和图形符号</strong>，包括：</p>
<ul>
<li>GB2312中的全部汉字、非汉字符号。</li>
<li>BIG5中的全部汉字。</li>
<li>与ISO 10646相应的国家标准GB13000中的其它CJK汉字，以上合计20902个汉字。</li>
<li>其它汉字、部首、符号，共计984个。</li>
</ul>
<p>GBK向下与GB2312 完全兼容，向上支持ISO 10646国际标准，在前者向后者过渡过程中起到的承上启下的作用。</p>
<p><strong>GBK 采用双字节表示，总体编码范围为8140-FEFE之间，首字节在81-FE之间，尾字节在40-FE之间，剔除XX7F一条线。</strong>GBK编码区分三部分：</p>
<ul>
<li>汉字区：<ul>
<li>GBK/2：OXBOA1-F7FE, 收录GB2312汉字6763个，按原序排列；</li>
<li>GBK/3：OX8140-AOFE，收录CJK汉字6080个；</li>
<li>GBK/4：OXAA40-FEAO，收录CJK汉字和增补的汉字8160个。</li>
</ul>
</li>
<li>图形符号区：<ul>
<li>GBK/1：OXA1A1-A9FE，除GB2312的符号外，还增补了其它符号</li>
<li>GBK/5：OXA840-A9AO，扩除非汉字区。</li>
</ul>
</li>
<li>用户自定义区<ul>
<li>GBK区域中的空白区，用户可以自己定义字符。</li>
</ul>
</li>
</ul>
<h2 id="GB18030"><a href="#GB18030" class="headerlink" title="GB18030"></a>GB18030</h2><p><strong>GB 18030，全称：国家标准GB 18030-2005《信息技术中文编码字符集》</strong>，<br>是中华人民共和国现时最新的内码字集，是GB 18030-2000《信息技术信息交换用汉字编码字符集基本集的扩充》的修订版。<br><strong>GB 18030与GB 2312-1980完全兼容，与GBK基本兼容，支持GB 13000及Unicode的全部统一汉字，共收录汉字70244个。</strong></p>
<ul>
<li>与 UTF-8 相同，采用多字节编码，每个字可以由1个、2个或4个字节组成。</li>
<li>编码空间庞大，最多可定义161万个字符。</li>
<li>支持中国国内少数民族的文字，不需要动用造字区。</li>
<li>汉字收录范围包含繁体汉字以及日韩汉字</li>
</ul>
<p>GB18030 编码是一二四字节变长编码。</p>
<ul>
<li>单字节，其值从0到0x7F，与 ASCII 编码兼容。</li>
<li>双字节，第一个字节的值从0x81到0xFE，第二个字节的值从0x40到0xFE（不包括0x7F），与 GBK标准基本兼容。</li>
<li>四字节，第一个字节的值从0x81到0xFE，第二个字节的值从0x30到0x39，第三个字节从0x81到0xFE，第四个字节从0x30到0x39。</li>
</ul>
<h2 id="CP936"><a href="#CP936" class="headerlink" title="CP936"></a>CP936</h2><p><strong>代码页936（Codepage 936）是 Microsoft 的简体中文字元集标准</strong>，<br>是东亚语文的四种双字节字元集（DBCS）之一。其最初版本和 GB 2312 一模一样，<br>但在推出 Windows 95 时扩展成包含绝大部分的 GBK 字元（代码页936 比 GBK 少95个字元，皆为当时尚未收入 Unicode 的字元）；<br>虽然该等字元现在已全部收入 Unicode，但代码页936 至今都没有修订。</p>
<h2 id="libiconv"><a href="#libiconv" class="headerlink" title="libiconv"></a><a href="https://www.gnu.org/software/libiconv/" target="_blank" rel="noopener">libiconv</a></h2><p>几个函数入口及相关转换表：</p>
<pre><code>static int ces_gbk_mbtowc (conv_t conv, ucs4_t *pwc, const unsigned char *s, int n);
static int gbk_mbtowc (conv_t conv, ucs4_t *pwc, const unsigned char *s, int n);</code></pre><p>重要头文件：</p>
<pre><code>lib/encodings.def
lib/ces_gbk.h
lib/gbk.h
lib/gb2312.h
lib/cp936ext.h</code></pre><ol>
<li><a href="https://zh.wikipedia.org/wiki/GB_2312" target="_blank" rel="noopener">GB 2312</a></li>
<li><a href="http://www.knowsky.com/resource/gb2312tbl.htm" target="_blank" rel="noopener">GB2312简体中文编码表</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E6%B1%89%E5%AD%97%E5%86%85%E7%A0%81%E6%89%A9%E5%B1%95%E8%A7%84%E8%8C%83" target="_blank" rel="noopener">汉字内码扩展规范</a></li>
<li><a href="https://zh.wikipedia.org/wiki/GB_18030" target="_blank" rel="noopener">GB 18030</a></li>
<li><a href="https://zh.wikipedia.org/zh-cn/%E4%BB%A3%E7%A2%BC%E9%A0%81936" target="_blank" rel="noopener">代码页936</a></li>
<li><a href="http://r12a.github.io/apps/conversion/" target="_blank" rel="noopener">Unicode code converter</a></li>
<li><a href="http://code.web.idv.hk/" target="_blank" rel="noopener">中文編碼網頁GB18030</a></li>
<li><a href="http://icu-project.org/repos/icu/data/trunk/charset/source/gb18030/" target="_blank" rel="noopener">International Components for Unicode ː Repository Browser</a></li>
<li><a href="ftp://ftp.oreilly.com/examples/cjkvinfo/unicode/gb2312-80.txt">GB2312-80 to Unicode table</a></li>
<li><a href="ftp://ftp.software.ibm.com/software/globalization/gb18030.pdf">GB18030 Conversion Documentation</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/11/va-list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/11/va-list/" class="post-title-link" itemprop="url">C语言不定参数的使用</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-12 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-12T00:00:00+08:00">2015-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="变长参数"><a href="#变长参数" class="headerlink" title="变长参数"></a>变长参数</h2><p>在c语言中使用变长参数最常见的就是下面两个函数了：</p>
<pre><code>int printf(const char *format, ...);
int scanf(const char *format, ...);</code></pre><p>在使用变长参数的函数（这里假设是func）实现部分其实用到了stdarg.h里面的多个宏来访问那些不确定的参数，它们分别是：</p>
<pre><code>void va_start(va_list ap, last);
type va_arg(va_list ap, type);
void va_end(va_list ap);</code></pre><p>假设lastarg是func的最后一个具名参数，即在func函数定义中…之前的那个参数（在printf中lastarg是format），<br>在func中首先定义一个变量：</p>
<pre><code>va_list ap</code></pre><p>这个变量以后会依次指向各个可变参数。ap在使用之前必须用宏va_start初始化一次，如下所示：</p>
<pre><code>va_start(ap, lastarg);</code></pre><p>其中lastarg是func中的最后一个具名参数。然后就可以用va_arg来获得下一个不定参数（前提是知道这个不定参数的类型type）：</p>
<pre><code>type next = va_arg(ap, type)</code></pre><p>最后就是用宏va_end来清理现场。例子：</p>
<pre><code>void _printf(char *format, ...)                                                                                               
{
    #define BUFFER_LEN  256
    char Buf[BUFFER_LEN];
    va_list args;
    memset(Buf,0, BUFFER_LEN);

    va_start(args, format);
    vsnprintf(Buf, BUFFER_LEN, format, args);
    va_end(args);

    printf(&quot;%s&quot;, Buf);
}</code></pre><p>另一个例子：</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;stdarg.h&gt;

void func(char *fmt, ...)
{
    va_list ap;

    va_start(ap, fmt);

    while (*fmt)
    {
        switch(*fmt)
        {
            case &#39;d&#39;:
                fprintf(stdout, &quot;%d\n&quot;, (int)va_arg(ap, int));
                break;
            case &#39;c&#39;:
                fprintf(stdout, &quot;%c\n&quot;, (char)va_arg(ap, int));
                break;
            case &#39;s&#39;:
                fprintf(stdout, &quot;%s\n&quot;, (char *)va_arg(ap, char *));
                break;
            default:
                fprintf(stderr, &quot;error fmt\n&quot;);

        }
        fmt ++;
    }
    va_end(ap);
}

int main ( int argc, char *argv[]  )
{
    func(&quot;dcs&quot;, 10, &#39;s&#39;, &quot;hello&quot;);
        return 0;

}               /* ----------  end of function main  ---------- */</code></pre><h2 id="函数参数的传递原理"><a href="#函数参数的传递原理" class="headerlink" title="函数参数的传递原理"></a>函数参数的传递原理</h2><p>函数参数是以数据结构:栈的形式存取,从右至左入栈。</p>
<p>首先是参数的内存存放格式：参数存放在内存的堆栈段中，在执行函数的时候，从最后一个开始入栈。<br>因此栈底高地址，栈顶低地址，举个例子如下：</p>
<pre><code>void func(int x, float y, char z);</code></pre><p>那么，调用函数的时候，实参 char z 先进栈，然后是 float y，最后是 int x，<br>因此在内存中变量的存放次序是 x-&gt;y-&gt;z，<br>因此，从理论上说，我们只要探测到任意一个变量的地址，<br>并且知道其他变量的类型，通过指针移位运算，则总可以顺藤摸瓜找到其他的输入变量。<br>va_list 是一个字符指针，可以理解为指向当前参数的一个指针，取参必须通过这个指针进行。</p>
<ol>
<li>在调用参数表之前，定义一个 va_list 类型的变量，(假设va_list 类型变量被定义为ap)；</li>
<li>然后应该对ap 进行初始化，让它指向可变参数表里面的第一个参数，<br>这是通过 va_start 来实现的，第一个参数是 ap 本身，第二个参数是在变参表前面紧挨着的一个变量,即“…”之前的那个参数；</li>
<li>然后是获取参数，调用va_arg，它的第一个参数是ap，第二个参数是要获取的参数的指定类型，<br>然后返回这个指定类型的值，并且把 ap 的位置指向变参表的下一个变量位置；</li>
<li>获取所有的参数之后，我们有必要将这个 ap 指针关掉，以免发生危险，方法是调用 va_end，<br>他是输入的参数 ap 置为 NULL，应该养成获取完参数表之后关闭指针的习惯。<br>通常va_start和va_end是成对出现。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/27/unused-sourcecode-ld/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/27/unused-sourcecode-ld/" class="post-title-link" itemprop="url">不链接未使用代码</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-28 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-28T00:00:00+08:00">2015-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>833</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="默认编译"><a href="#默认编译" class="headerlink" title="默认编译"></a>默认编译</h2><p>默认编译环境下.c文件会编译为.o文件，当链接时会链接.o文件，整个.o文件为一个section，当此section存在无用函数时会造成控件浪费。</p>
<pre><code>gcc -o main main.c x.o</code></pre><p>可以使用命令来查看二进制可执行文件中的符号表，所有函数都链接进去：</p>
<pre><code>nm -S main
readelf -S x.o</code></pre><p>GCC链接时，按照section来链接，不论section中符号是否都使用到！</p>
<h2 id="拆分默认section"><a href="#拆分默认section" class="headerlink" title="拆分默认section"></a>拆分默认section</h2><pre><code>-ffunction-sections （为每个function函数分配独立的section）
-fdata-sections （为每个data item数据项分配独立的section）

gcc -c -ffunction-sections -fdata-sections x.c x.o</code></pre><p>x.o大小会明显变大，因为section大量增加。</p>
<h2 id="排除不链接section-Wl-–gc-sections"><a href="#排除不链接section-Wl-–gc-sections" class="headerlink" title="排除不链接section -Wl,–gc-sections"></a>排除不链接section -Wl,–gc-sections</h2><pre><code>-Wl,的意思是将后面的内容传递给链接器
--gc-sections是链接器参数，不链接未使用的section

gcc -Wl,--gc-sections -o main main.c x.o</code></pre><p>可以保证代码量最优。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/10/attribute-aligned/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/10/attribute-aligned/" class="post-title-link" itemprop="url">\#pragma pack(n)和\_\_attribute\_\_((aligned(m)))的区别</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-11T00:00:00+08:00">2015-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="pragma-pack-n-和-attribute-aligned-m-的区别："><a href="#pragma-pack-n-和-attribute-aligned-m-的区别：" class="headerlink" title="#pragma pack(n)和__attribute__((aligned(m)))的区别："></a>#pragma pack(n)和__attribute__((aligned(m)))的区别：</h2><p>前者告诉编译器结构体或类内部的成员变量相对于第一个变量的地址的偏移量的对齐方式，<br>缺省情况下，编译器按照自然边界对齐，当变量所需的自然对齐边界比n大时，按照n对齐，<br>否则按照自然边界对齐；<br>后者告诉编译器一个结构体或者类或者联合或者一个类型的变量(对象)分配地址空间时的地址对齐方式。<br>也就是说，如果将__attribute__((aligned(m)))作用于一个类型，那么该类型的变量在分配地址空间时，<br>其存放的地址一定按照m字节对齐(m必须是2的幂次方)。<br>并且其占用的空间，即大小,也是m的整数倍，以保证在申请连续存储空间的时候，<br>每一个元素的地址也是按照m字节对齐。 __attribute__((aligned(m)))也可以作用于一个单独的变量。举例说明：</p>
<pre><code>#include&lt;stdio.h&gt;
#pragma pack(4)

typedef struct{
    uint32_t f1;
    uint8_t f2;
    uint8_t f3;
    uint32_t f4;
    uint64_t f5;
}__attribute__((aligned(1024))) ts;

int main()
{
    printf(&quot;Struct size is: %d, aligned on 1024\n&quot;,sizeof(ts));
    printf(&quot;Allocate f1 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f1));
    printf(&quot;Allocate f2 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f2));
    printf(&quot;Allocate f3 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f3));
    printf(&quot;Allocate f4 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f4));
    printf(&quot;Allocate f5 on address: 0x%x\n&quot;,&amp;(((ts*)0)-&gt;f5));
    return 0;
}</code></pre><p>输出：</p>
<font color="#00FF00">
    Struct size is: 1024, aligned on 1024
<br/>
</font>
    Allocate f1 on address: 0x0
<br/>
<font color="#FF0000">
    Allocate f2 on address: 0x4
<br/>
    Allocate f3 on address: 0x5
<br/>
</font>
    Allocate f4 on address: 0x8
<br/>
<font color="#FF00FF">
    Allocate f5 on address: 0xc
<br/>
</font>

<p>注意:</p>
<p>绿色部分表明了__attribute__((aligned(1024))) 的作用<br/><br>红色部分说明#pragma pack(4)只对大小大于4的成员变量的地址偏移起作用<br/><br>紫色部分说明对于大小大于4的成员变量，其地址偏移按照4字节对齐</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/09/10/gcc-attributes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/09/10/gcc-attributes/" class="post-title-link" itemprop="url">几个有用的gcc attribute</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-09-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-09-11T00:00:00+08:00">2015-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="align属性"><a href="#align属性" class="headerlink" title="align属性"></a>align属性</h2><p>align属性不仅可以修饰变量，类型， 还可以修饰函数， 举个例子：</p>
<h3 id="修饰变量"><a href="#修饰变量" class="headerlink" title="修饰变量"></a>修饰变量</h3><pre><code>int a = 0;

int main(void)
{
    printf(&quot;a = %d\n&quot;, a);
}</code></pre><p>用gdb看下变量a的地址：</p>
<pre><code>(gdb) p/x &amp;a
$1 = 0x60087c</code></pre><p>变量a地址是编译器随意生成的， 这个例子碰巧分配到了8字节对齐的位置上。<br>用align属性修饰下：</p>
<pre><code>int a __attribute__((aligned(8))) = 0;

(gdb) p/x &amp;a
$1 = 0x600880</code></pre><p>编译器会把变量a生成在8字节对齐的内存地址上。</p>
<h3 id="修饰类型"><a href="#修饰类型" class="headerlink" title="修饰类型"></a>修饰类型</h3><pre><code>int a __attribute__((aligned(8))) = 0;

struct test {
    int a;
} __attribute__((aligned(8)));

struct test aa;

int main(void)
{
    printf(&quot;a = %d\n&quot;, a);
}</code></pre><p>经过align修饰后，struct test数据结构定义的所有变量都会出现在8字节对齐的内存上。</p>
<pre><code>(gdb) p/x &amp;aa
$1 = 0x600888</code></pre><h3 id="修饰函数"><a href="#修饰函数" class="headerlink" title="修饰函数"></a>修饰函数</h3><pre><code>void test1(void) __attribute__((aligned(2)));

void  test1(void)
{
    printf(&quot;hello, world.\n&quot;);
}

int main(void)
{
    test1();
}</code></pre><p>经过align修饰后，函数出现在8字节对齐的内存上。</p>
<pre><code>(gdb) p test1 
$1 = {&lt;text variable, no debug info&gt;} 0x400538 &lt;test1&gt;</code></pre><h2 id="always-inline属性"><a href="#always-inline属性" class="headerlink" title="always_inline属性"></a>always_inline属性</h2><p>gcc有个inline关键字，可以将一个函数定义为内嵌形式：</p>
<pre><code>static inline void test2(void);

void test1(void)
{
    printf(&quot;hehe.\n&quot;);
}

void test2(void)
{
    asm(&quot;nop&quot;);
}

void test(void)
{
    test1();
    test2();
}

int main(void)
{
    test();
}</code></pre><p>按照inline的定义， test在调用test2函数的时候， 会直接将test2函数的代码展开在test函数内部，<br>这样就减少了一次函数调用过程， 加快了代码的执行速度， 用gdb反汇编看下：</p>
<pre><code>(gdb) disass test
Dump of assembler code for function test:
0x00000000004004a8 :    push   %rbp
0x00000000004004a9 :    mov    %rsp,%rbp
0x00000000004004ac :    callq  0x400498 
0x00000000004004b1 :    callq  0x4004b8 
0x00000000004004b6 :   leaveq
0x00000000004004b7 :   retq
End of assembler dump.</code></pre><p>你可以看到，gcc并没有把test2函数展开，明明已经使用inline修饰了。<br>因为虽然用inline做了修饰，但是gcc会根据代码的逻辑来优化到底有没有必要使用inline代码。<br>像这种简单的代码，用inline代码效果不大，因此gcc并没有按照inline要求来生成代码。</p>
<pre><code>static inline void test2(void) __attribute__((always_inline));
加入always_inline属性后呢？
(gdb) disass test
Dump of assembler code for function test:
0x00000000004004a8 :    push   %rbp
0x00000000004004a9 :    mov    %rsp,%rbp
0x00000000004004ac :    callq  0x400498 
0x00000000004004b1 :    nop
0x00000000004004b2 :   leaveq
0x00000000004004b3 :   retq
End of assembler dump.</code></pre><p>这次你会看到在调用完test1后， 直接把test2的代码， 也是nop语句加入在了test函数内。</p>
<h2 id="constructor-amp-destructor"><a href="#constructor-amp-destructor" class="headerlink" title="constructor &amp; destructor"></a>constructor &amp; destructor</h2><p>很犀利的2个属性，用于修饰某个函数，经过constructor属性修饰过的函数，<br>可以在main函数运行前就可以先运行完毕，同理destructor在进程exit之前执行。</p>
<pre><code>#include&lt;stdio.h&gt;

void test1(void) __attribute__((aligned(8)));

void  test1(void)
{
    printf(&quot;hello, world.\n&quot;);
}

void __attribute__((constructor)) test2(void)
{
    printf(&quot;hehe.\n&quot;);
}

void __attribute__((destructor)) test3(void)
{
    printf(&quot;haha.\n&quot;);
}

int main(void)
{
    test1();
}</code></pre><p>执行输出如下：</p>
<pre><code>➜  /data/test/1  &gt; ./main 
hehe.
hello, world.
haha.</code></pre><h2 id="fastcall-amp-regparm属性"><a href="#fastcall-amp-regparm属性" class="headerlink" title="fastcall &amp; regparm属性"></a>fastcall &amp; regparm属性</h2><p>在c语言中，通过函数传递参数通常使用堆栈的方式，如：<br>    test(a, b, c);<br>参数从右到左依次压入堆栈c, b, a。<br>函数执行完后，还要把这3个参数从堆栈中弹出来，如果一个函数每秒钟有上万次调用，<br>这将非常耗时，为了加快代码运行速度，gcc扩展了fastcall和regparm2个属性，<br>对于fastcall属性，一个函数的前2个参数分别通过ecx和edx来传递，剩下的则是使用堆栈来传递。<br>对于regparm，它的用法如下regparm(n), 函数的1到n个参数，分别通过eax, edx, ecx来传递，最多就使用3个寄存器，<br>其余参数通过堆栈来传递。注意这2个属性只在x86平台有效。很对编译平台fastcall默认开启。</p>
<pre><code>int __attribute__((fastcall)) test1(int a, int b)
{
    return a + b;
}

int __attribute__((regparm(2))) test2(int a, int b)
{
    return a + b;
}

int test3(int a, int b)
{
    return a + b;
}

int main(void)
{
    test1(1, 2);
    test2(1, 2);
    test3(1, 2);
}

(gdb) disass test1
Dump of assembler code for function test1:
0x08048354 :   push   %ebp
0x08048355 :   mov    %esp,%ebp
0x08048357 :   sub    $0x8,%esp 在堆栈里先分配了8个字节的空间
0x0804835a :   mov    %ecx,-0x4(%ebp) 将ecx的值放入第一个变量里
0x0804835d :   mov    %edx,-0x8(%ebp) 将edx的值放入第二个变量里
0x08048360 :  mov    -0x8(%ebp),%eax
0x08048363 :  add    -0x4(%ebp),%eax
0x08048366 :  leave
0x08048367 :  ret
End of assembler dump.

(gdb) disass test2
Dump of assembler code for function test2:
0x08048368 :   push   %ebp
0x08048369 :   mov    %esp,%ebp
0x0804836b :   sub    $0x8,%esp
0x0804836e :   mov    %eax,-0x4(%ebp)
0x08048371 :   mov    %edx,-0x8(%ebp)
0x08048374 :  mov    -0x8(%ebp),%eax
0x08048377 :  add    -0x4(%ebp),%eax
0x0804837a :  leave
0x0804837b :  ret
End of assembler dump.

(gdb) disass test3
Dump of assembler code for function test3:
0x0804837c :   push   %ebp
0x0804837d :   mov    %esp,%ebp
0x0804837f :   mov    0xc(%ebp),%eax 堆栈形式来传递参数，0×c(%ebp)保存第二个参数
0x08048382 :   add    0x8(%ebp),%eax 堆栈形式来传递参数，0×8(%ebp)保存第一个参数
0x08048385 :   pop    %ebp
0x08048386 :  ret
End of assembler dump.</code></pre><h2 id="packed属性"><a href="#packed属性" class="headerlink" title="packed属性"></a>packed属性</h2><p>用于修饰struct, union, enum数据结构，看如下的例子：</p>
<pre><code>struct test {
    char a;
    int b;
};

struct test1 {
    char a;
    int b;
}__attribute__((packed));

int main(void)
{
    printf(&quot;%d, %d\n&quot;, sizeof(struct test), sizeof(struct test1));
}</code></pre><p>struct test结构，理论来说一共有1+4=5字节的大小，但是gcc默认编译出来的大小是8，也就是说char是按照4字节来分配空间的。<br>加上packed修饰后，就会按照实际的类型大小来计算。</p>
<pre><code>➜  /data/test/1  &gt; ./main 
8, 5</code></pre><h2 id="section属性"><a href="#section属性" class="headerlink" title="section属性"></a>section属性</h2><p>gcc编译后的二进制文件为elf格式，代码中的函数部分会默认的链接到elf文件的text section中，<br>变量则会链接到bss和data section中。如果想把代码或变量放到特定的section中，就可以使用section属性来修饰。</p>
<pre><code>int __attribute__((section(&quot;TEST&quot;))) test1(int a, int b)
{
    return a + b;
}

int test2(int a, int b)
{
    return a + b;
}

int main(void)
{
    test1(1, 2);
    test2(1, 2);
}</code></pre><p>使用readelf来观察下test二进制格式。</p>
<pre><code>➜  /data/test/1  &gt; readelf -S main
[13] .text             PROGBITS         0000000000400400  00000400
00000000000001a2  0000000000000000  AX       0     0     16
[14] TEST              PROGBITS         00000000004005a2  000005a2
0000000000000014  0000000000000000  AX       0     0     1</code></pre><p>文件多出了一个TEST section，它的起始地址为0x4005a2, 大小为0x14， 它的地址范围在 0x4005a2 – 0x4005b6。<br>text section的起始地址为0x400400, 大小为0x1a2， 它的地址范围在0x400400 – 0x4005a2。</p>
<p>在来看下test1, test2符号表的地址：</p>
<pre><code>➜  /data/test/1  &gt; readelf -s main
57: 00000000004005a2    20 FUNC    GLOBAL DEFAULT   14 test1
68: 00000000004004f6    20 FUNC    GLOBAL DEFAULT   13 test2</code></pre><p>可以看到test2确实被链接在text section中， 而test1链接在TEST section中。</p>
<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p>更多关于gcc attribute的介绍请看<a href="http://gcc.gnu.org/onlinedocs/gcc-4.3.2//gcc/Variable-Attributes.html#Variable-Attributes" target="_blank" rel="noopener">gcc手册</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/08/19/analysis-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/08/19/analysis-tools/" class="post-title-link" itemprop="url">代码分析工具</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-08-20 00:00:00" itemprop="dateCreated datePublished" datetime="2015-08-20T00:00:00+08:00">2015-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>toc<br>{:toc}</li>
</ul>
<h2 id="Cppcheck"><a href="#Cppcheck" class="headerlink" title="Cppcheck"></a>Cppcheck</h2><p><strong>Cppcheck</strong> is a static analysis tool for C/C++ code.<br>Unlike C/C++ compilers and many other analysis tools it does not detect syntax errors in the code.<br>Cppcheck primarily detects the types of bugs that the compilers normally do not detect.<br>The goal is to detect only real errors in the code (i.e. have zero false positives).</p>
<ol>
<li><a href="http://cppcheck.sourceforge.net/" target="_blank" rel="noopener">官网</a></li>
<li><a href="http://cppcheck.sourceforge.net/#documentation" target="_blank" rel="noopener">documentation</a></li>
</ol>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install cppcheck cppcheck-gui</code></pre>
<p>用法：</p>
<pre><code class="bash">cppcheck-gui

cppcheck -h

# Recursively check the current folder. Print the progress on the screen and
# write errors to a file:
cppcheck . 2&gt; err.txt

# Recursively check ../myproject/ and don&#39;t print progress:
cppcheck --quiet ../myproject/

# Check test.cpp, enable all checks:
cppcheck --enable=all --inconclusive --std=posix test.cpp

# Check f.cpp and search include files from inc1/ and inc2/:
cppcheck -I inc1/ -I inc2/ f.cpp</code></pre>
<h2 id="Understand"><a href="#Understand" class="headerlink" title="Understand"></a>Understand</h2><p>Understand® is an IDE built from the ground up to help you fully comprehend your source code. Analyze it, measure it, visualize it, maintain it - Understand it.</p>
<ol>
<li><a href="https://scitools.com/" target="_blank" rel="noopener">官网</a></li>
<li><a href="https://scitools.com/support/" target="_blank" rel="noopener">support</a> </li>
<li><a href="https://scitools.com/support/running-understand-headless-linux-server/" target="_blank" rel="noopener">Running Understand on a headless linux server</a></li>
</ol>
<p>Understand软件的功能主要<strong>定位于代码的阅读理解</strong>。</p>
<p>具备如下特性：</p>
<ol>
<li>支持多语言：Ada, C, C++, C#, Java, FORTRAN, Delphi, Jovial, and PL/M ，混合语言的project也支持</li>
<li>多平台： Windows/Linux/Solaris/HP-UX/IRIX/MAC OS X</li>
<li>代码语法高亮、代码折叠、交叉跳转、书签等基本阅读功能。</li>
<li>可以对整个project的architecture、metrics进行分析并输出报表。</li>
<li>可以对代码生成多种图（butterfly graph、call graph、called by graph、control flow graph、UML class graph等），<br>在图上点击节点可以跳转到对应的源代码位置。</li>
<li>提供Perl API便于扩展。作图全部是用Perl插件实现的，直接读取分析好的数据库作图。</li>
<li>内置的目录和文件比较器。</li>
<li>支持project的snapshot，并能和自家的TrackBack集成便于监视project的变化。</li>
</ol>
<h2 id="valgrind"><a href="#valgrind" class="headerlink" title="valgrind"></a>valgrind</h2><ol>
<li><a href="http://valgrind.org/" target="_blank" rel="noopener">valgrind</a></li>
<li><a href="http://alleyoop.sourceforge.net/" target="_blank" rel="noopener">Alleyoop</a></li>
<li><a href="http://valgrind.org/downloads/guis.html" target="_blank" rel="noopener">Valkyrie</a></li>
<li><a href="http://valgrind.org/docs/manual/manual.html" target="_blank" rel="noopener">Valgrind User Manual</a></li>
<li><a href="http://valgrind.org/info/tools.html" target="_blank" rel="noopener">Valgrind’s Tool Suite</a></li>
<li><a href="http://cstriker1407.info/blog/c-language-code-detection-use-valgrind/" target="_blank" rel="noopener">C语言代码检测：valgrind的使用</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-valgrind/" target="_blank" rel="noopener">应用 Valgrind 发现 Linux 程序的内存问题</a></li>
<li><a href="http://www.oschina.net/translate/valgrind-memcheck" target="_blank" rel="noopener">如何使用Valgrind memcheck工具进行C/C++的内存泄漏检测</a></li>
</ol>
<p>Valgrind是一套Linux下，开放源代码（GPL V2）的仿真调试工具的集合。<br>Valgrind由内核（core）以及基于内核的其他调试工具组成。<br>内核类似于一个框架（framework），它模拟了一个CPU环境，并提供服务给其他工具；<br>而其他工具则类似于插件 (plug-in)，利用内核提供的服务完成各种特定的内存调试任务。</p>
<p>它支持 C/C++，支持各类 Unix 系统。 </p>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install valgrind</code></pre>
<p>工具集：</p>
<ul>
<li>Memcheck。这是valgrind应用最广泛的工具，一个重量级的内存检查器，<br>能够发现开发中绝大多数内存错误使用情况，<br>比如：使用未初始化的内存，使用已经释放了的内存，内存访问越界等。</li>
<li>Callgrind。它主要用来检查程序中函数调用过程中出现的问题。</li>
<li>Cachegrind。它主要用来检查程序中缓存使用出现的问题。它与Cachegrind的功能有重叠，但也收集Cachegrind不收集的一些信息。</li>
<li>Helgrind。它主要用来检查多线程程序中出现的竞争问题。</li>
<li>Massif。它主要用来检查程序中堆栈使用中出现的问题。它有助于使你的程序使用更少的内存。</li>
<li>DRD也是一个线程错误检测器。它和Helgrind相似，但使用不同的分析技术，所以可能找到不同的问题。</li>
</ul>
<p>编译选项使用<code>-g -O0</code>, <strong>交叉编译</strong>之后在目标机上执行内存检测：</p>
<pre><code class="bash">valgrind --tool=memcheck --leak-check=full ./a.out
==2888== Memcheck, a memory error detector
==2888== Copyright (C) 2002-2009, and GNU GPL&#39;d, by Julian Seward et al.
==2888== Using Valgrind-3.6.0.SVN-Debian and LibVEX; rerun with -h for copyright info
==2888== Command: ./val
==2888==

[a]
==2888==
==2888== HEAP SUMMARY:
==2888==     in use at exit: 1 bytes in 1 blocks
==2888==   total heap usage: 1 allocs, 0 frees, 1 bytes allocated
==2888==
==2888== 1 bytes in 1 blocks are definitely lost in loss record 1 of 1
==2888==    at 0x4C274A8: malloc (vg_replace_malloc.c:236)
==2888==    by 0x400575: main (valgrind.c:6)
==2888==
==2888== LEAK SUMMARY:
==2888==    definitely lost: 1 bytes in 1 blocks
==2888==    indirectly lost: 0 bytes in 0 blocks
==2888==      possibly lost: 0 bytes in 0 blocks
==2888==    still reachable: 0 bytes in 0 blocks
==2888==         suppressed: 0 bytes in 0 blocks
==2888==
==2888== For counts of detected and suppressed errors, rerun with: -v
==2888== ERROR SUMMARY: 1 errors from 1 contexts (suppressed: 4 from 4)</code></pre>
<p>memcheck可以检测下列与内存相关的问题 :</p>
<ul>
<li>未释放内存的使用</li>
<li>对释放后内存的读/写</li>
<li>对已分配内存块尾部的读/写</li>
<li>内存泄露</li>
<li>不匹配的使用malloc/new/new[] 和 free/delete/delete[]</li>
<li>重复释放内存</li>
</ul>
<h2 id="KCachegrind"><a href="#KCachegrind" class="headerlink" title="KCachegrind"></a><strong>KCachegrind</strong></h2><ol>
<li><a href="https://kcachegrind.github.io/html/Home.html" target="_blank" rel="noopener">Callgrind and KCachegrind</a></li>
<li><a href="https://kcachegrind.github.io/html/Screenshots.html" target="_blank" rel="noopener">Screenshots</a></li>
<li><a href="https://kcachegrind.github.io/html/Documentation.html" target="_blank" rel="noopener">Documentation</a></li>
</ol>
<p>安装：</p>
<pre><code class="bash">sudo apt-get install kcachegrind</code></pre>
<p><code>valgrind</code>安装之后有工具<code>callgrind</code>，使用此工具生成<code>性能日志</code>，使用<code>kcachegrind</code>进行分析：</p>
<pre><code class="bash">/data/test  &gt; gcc -g -O0 main.c -o perf
/data/test  &gt; valgrind --tool=callgrind ./perf 
==27075== Callgrind, a call-graph generating cache profiler
==27075== Copyright (C) 2002-2015, and GNU GPL&#39;d, by Josef Weidendorfer et al.
==27075== Using Valgrind-3.11.0 and LibVEX; rerun with -h for copyright info
==27075== Command: ./perf
==27075== 
==27075== For interactive control, run &#39;callgrind_control -h&#39;.
hello world!
hello world!
hello world!
test 
hello world!
test 
hello world!
test 
==27075== 
==27075== Events    : Ir
==27075== Collected : 155985
==27075== 
==27075== I   refs:      155,985
/data/test  &gt; ls
1  a.out  callgrind.out.27075  main.c  output  perf  photorec.ses  recup_dir.1  rgb  testdisk.log
/data/test  &gt; kcachegrind callgrind.out.27075 </code></pre>
<img src="https://kcachegrind.github.io/images/KcgShot3Large.gif" height="600" width="800" />

<p>在<code>Call Graph</code>中，你能看到每一个函数的开销百分比包括Inclusive,即涵带子函数的总开销和Self，函数自己的开销，<br>另外每一个函数的调用次数也列写在上面。<br>也可以分析出函数的调用关系和流程，这是一个非常好的辅助工具，帮助你快速理解系统的工作流Work Flow。</p>
<h2 id="gprof"><a href="#gprof" class="headerlink" title="gprof"></a>gprof</h2><ol>
<li><a href="https://sourceware.org/binutils/docs/gprof/" target="_blank" rel="noopener">gprof</a></li>
<li><a href="http://www.thegeekstuff.com/2012/08/gprof-tutorial/" target="_blank" rel="noopener">GPROF Tutorial – How to use Linux GNU GCC Profiling Tool</a></li>
<li><a href="https://sourceware.org/binutils/docs-2.17/gprof/index.html" target="_blank" rel="noopener">GNU gprof</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-gnuprof.html" target="_blank" rel="noopener">使用 GNU profiler 来提高代码运行速度</a></li>
<li><a href="http://www.cnblogs.com/onlyforcloud/p/4395917.html" target="_blank" rel="noopener">GNU–gprof使用总结</a></li>
</ol>
<p>Gprof 是GNU gnu binutils工具之一，默认情况下linux系统当中都带有这个工具：</p>
<ol>
<li>可以显示“flat profile”，包括每个函数的调用次数，每个函数消耗的处理器时间，</li>
<li>可以显示“Call graph”，包括函数的调用关系，每个函数调用花费了多少时间。</li>
<li>可以显示“注释的源代码”－－是程序源代码的一个复本，标记有程序中每行代码的执行次数。</li>
</ol>
<p>Gprof基本用法：</p>
<ol>
<li>使用 <code>-pg</code> 编译和链接你的应用程序。</li>
<li>执行你的应用程序使之生成供gprof 分析的数据。</li>
<li>使用gprof 程序分析你的应用程序生成的数据。</li>
</ol>
<pre><code class="bash">gcc gprof.c -pg -o example1 -O0 -g
./example1
✔ /data/test  &gt; ls gmon.out
gmon.out

# flat profile
gprof example1 gmon.out -p
Flat profile:

Each sample counts as 0.01 seconds.
%   cumulative   self              self     total           
time   seconds   seconds    calls  ms/call  ms/call  name    
50.43      0.01     0.01        3     3.36     3.36  count_sum
50.43      0.02     0.01        1    10.09    13.45  my_print2
0.00      0.02     0.00        2     0.00     3.36  my_print

# call graph
gprof example1 gmon.out -q

# gprof - display call graph profile data
man gprof</code></pre>
<p><strong>带注解的源代码</strong></p>
<p>如果希望获得一个 “带注解的源代码” 清单，它会将源代码输出到应用程序中，并加上每个函数被调用了多少次的注释。<br>要使用这种功能，请使用启用调试功能的标志来编译源代码，这样源代码就会被加入可执行程序中：</p>
<pre><code class="bash">gcc example1.c -g -pg -o example1 -O2 -lc</code></pre>
<p>像以前一样重新运行这个应用程序：</p>
<pre><code class="bash">./example1 50000</code></pre>
<p>gprof 命令现在应该是：</p>
<pre><code class="bash">gprof example1 gmon.out -A</code></pre>
<p><strong>常用参数</strong></p>
<ul>
<li>-b 不再输出统计图表中每个字段的详细描述。</li>
<li>-p 只输出函数的调用图（Call graph的那部分信息）。</li>
<li>-q 只输出函数的时间消耗列表。</li>
<li>-e Name 不再输出函数Name 及其子函数的调用图（除非它们有未被限制的其它父函数）。可以给定多个 -e 标志。一个 -e 标志只能指定一个函数。</li>
<li>-E Name 不再输出函数Name 及其子函数的调用图，此标志类似于 -e 标志，但它在总时间和百分比时间的计算中排除了由函数Name 及其子函数所用的时间。</li>
<li>-f Name 输出函数Name 及其子函数的调用图。可以指定多个 -f 标志。一个 -f 标志只能指定一个函数。</li>
<li>-F Name 输出函数Name 及其子函数的调用图，它类似于 -f 标志，但它在总时间和百分比时间计算中仅使用所打印的例程的时间。可以指定多个 -F 标志。一个 -F 标志只能指定一个函数。-F 标志覆盖 -E 标志。</li>
<li>-z 显示使用次数为零的例程（按照调用计数和累积时间计算）。</li>
</ul>
<p><strong>用户时间与内核时间</strong></p>
<p>gprof 的最大缺陷：它只能分析应用程序在运行过程中所消耗掉的用户时间，无法得到程序内核空间的运行时间。通常来说，应用程序在运行时既要花费一些时间来运行用户代码，也要花费一些时间来运行 “系统代码”，例如内核系统调用sleep()。</p>
<p>有一个方法可以查看应用程序的运行时间组成，在 time 命令下面执行程序。这个命令会显示一个应用程序的实际运行时间、用户空间运行时间、内核空间运行时间。</p>
<pre><code class="bash">✔ /data/test  &gt; time ./example1 
./example1  0.02s user 0.00s system 93% cpu 0.026 total</code></pre>
<p><strong>注意事项</strong></p>
<ol>
<li>g++在编译和链接两个过程，都要使用-pg选项。</li>
<li>只能使用静态连接libc库，否则在初始化<code>*.so</code>之前就调用profile代码会引起“segmentation fault”，<br>解决办法是编译时加上-static-libgcc或-static。</li>
<li>如果不用g++而使用ld直接链接程序，要加上链接文件/lib/gcrt0.o，如ld -o myprog /lib/gcrt0.o myprog.o utils.o -lc_p。<br>也可能是gcrt1.o</li>
<li>要监控到第三方库函数的执行时间，第三方库也必须是添加 –pg 选项编译的。</li>
<li>gprof只能分析应用程序所消耗掉的用户时间.</li>
<li>程序不能以demon方式运行。否则采集不到时间。（可采集到调用次数）</li>
<li>首先使用 time 来运行程序从而判断 gprof 是否能产生有用信息是个好方法。</li>
<li>如果 gprof 不适合您的剖析需要，那么还有其他一些工具可以克服 gprof 部分缺陷，包括 OProfile 和 Sysprof。</li>
<li>gprof对于代码大部分是用户空间的CPU密集型的程序用处明显。<br>对于大部分时间运行在内核空间或者由于外部因素（例如操作系统的 I/O 子系统过载）而运行得非常慢的程序难以进行优化。</li>
<li>gprof 不支持多线程应用，多线程下只能采集主线程性能数据。原因是gprof采用ITIMER_PROF信号，在多线程内只有主线程才能响应该信号。<br>但是有一个<a href="http://sam.zoy.org/writings/programming/gprof.html" target="_blank" rel="noopener">简单的方法</a>可以解决这一问题</li>
<li>gprof只能在程序正常结束退出之后才能生成报告（gmon.out）。<ul>
<li>gprof通过在atexit()里注册了一个函数来产生结果信息，任何非正常退出都不会执行atexit()的动作，所以不会产生gmon.out文件。</li>
<li>程序可从main函数中正常退出，或者通过系统调用exit()函数退出。</li>
</ul>
</li>
</ol>
<h2 id="KProf"><a href="#KProf" class="headerlink" title="KProf"></a>KProf</h2><blockquote>
<p>KProf - Profiling made easy</p>
</blockquote>
<ol>
<li><a href="http://kprof.sourceforge.net/" target="_blank" rel="noopener">KProf</a></li>
<li><a href="https://sourceforge.net/projects/kprof/files/" target="_blank" rel="noopener">download</a></li>
</ol>
<p>将gprof ， GUI化了，更加友好，它也利用graphviz绘制运行时流程图，但是对于大的程序，似乎效果不太好，流程图感觉完全乱掉了</p>
<img src="http://kprof.sourceforge.net/kprof_flat.png"/>

<img src="http://kprof.sourceforge.net/kprof_object.png"/>


<h2 id="gprof2dot"><a href="#gprof2dot" class="headerlink" title="gprof2dot"></a><strong>gprof2dot</strong></h2><ol>
<li><a href="https://github.com/jrfonseca/gprof2dot" target="_blank" rel="noopener">gprof2dot</a></li>
<li><a href="https://github.com/jrfonseca/xdot.py" target="_blank" rel="noopener">xdot.py</a></li>
</ol>
<pre><code class="bash">sudo apt-get install python graphviz
git clone https://github.com/jrfonseca/gprof2dot.git
python setup.py build
sudo python steup.py install</code></pre>
<p>用法：</p>
<pre><code class="bash">gcc -pg linpack.c -o linpack_gprof
gprof ./linpack_gprof | python2.7 gprof2dot.py -n0 -e0 |dot - Tpng -o output.png</code></pre>
<img src="http://img.blog.csdn.net/20160412124253219?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"/>

<p>还可通过以下命令得到函数调用图:</p>
<pre><code class="bash">gprof linpack_gprof &gt; prof.log  
./gprof2dot.py prof.log | dot -Tpng -o output.png  </code></pre>
<img src="http://img.blog.csdn.net/20160424203320165?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center"/>

<p><strong>通过对比以上两种方法，可以发现第二种方法无法得到调用时间过短的函数调用关系</strong></p>
<p>gprof2dot默认是部分函数调用图，对性能影响不大的函数调用都不显示，例如上图中没有出现类的构造，析构函数，<br>如果想要显示全部的函数调用，可以 gprof2dot -n0 -e0 ，默认是n0.5即影响小于5%的函数就不显示了。<br>当然这样图片会很乱，因为显示内容很多，可以 gprof2dot -n0 -e0 -s #-s表示不显示诸如模板，函数入口参数等等，使得<br>函数名称显示更加精简。</p>
<p><code>dot</code>用于生成图片，使用<code>xdot.py</code>不需要生成图片，直接交互</p>
<pre><code class="bash">gprof ./linpack_gprof | python2.7 gprof2dot.py -n0 -e0 | ./xdot.py</code></pre>
<p><em>python环境变量设置有问题，xdot单独可以工作，使用管道不能正常工作</em></p>
<pre><code class="bash">function showCall()
{
    gprof $1 | python3 /data/Installer/gprof2dot/gprof2dot.py &gt; /tmp/__call_tmp
    xdot /tmp/__call_tmp
    rm /tmp/__call_tmp
}</code></pre>
<h2 id="gperftools"><a href="#gperftools" class="headerlink" title="gperftools"></a><strong>gperftools</strong></h2><ol>
<li><a href="https://github.com/gperftools/gperftools" target="_blank" rel="noopener">gperftools</a></li>
<li><a href="http://airekans.github.io/cpp/2014/07/04/gperftools-profile" target="_blank" rel="noopener">用gperftools对C/C++程序进行profile</a></li>
<li><a href="http://www.cnblogs.com/persistentsnail/p/3294843.html" target="_blank" rel="noopener">Google performance Tools (gperftools) 使用心得</a></li>
<li><a href="http://qiaoyong.lofter.com/post/2b36f_1140c82" target="_blank" rel="noopener">gperftools使用详解</a></li>
</ol>
<p>在Linux的C/C++编程的世界里，性能调优一直是个让人头疼的事。<br>最出名的<code>gprof</code>虽然大家都知道， 其用法比较单一(只支持程序从启动到结束的profile)，<br>而且对程序的运行时间会有比较大的影响， 所以其profile不一定准确。</p>
<p>而<code>valgrind</code>功能十分强大，但profile也一般针对整个程序的运行，很难只对程序运行中的某段时间进行profile。<br>而且也多少会影响程序的运行，且使用的难度也较大。</p>
<p><strong>如何profile</strong></p>
<p>在gperftools的文档中，就简单的说了下面的方式来进行profile：</p>
<pre><code class="bash">gcc [...] -o myprogram -lprofiler
CPUPROFILE=/tmp/profile ./myprogram</code></pre>
<p>是的，在编译和安装了gperftools之后，只需要上面的步骤就可以进行profile了，非常简单。<br>而profile的结果就保存在/tmp/profile。查看结果只需要用gperftools自带的一个pprof脚本来看就可以：</p>
<pre><code class="bash">$ pprof --text ./myprogram /tmp/profile
14   2.1%  17.2%       58   8.7% std::_Rb_tree::find</code></pre>
<p>pprof的输出也很直观，不过也还不够好，从这个输出中还不好看出调用关系，包括caller和callee。<br>而pprof也可以输出图示，还可以输出<code>callgrind</code>兼容的格式，这样就可以用<code>kcachegrind</code>来看profile结果了。</p>
<pre><code class="bash">$ pprof --callgrind ./myprogram /tmp/profile &gt; callgrind.res</code></pre>
<p>然后利用kcachegrind打开这个callgrind.res文件</p>
<p><strong>动态profile</strong></p>
<p>上面说到的方式是通过环境变量来触发profile，而跨度也是整个程序的生命周期。<br>那如果是想要在程序运行的某段时间进行profile呢？如果我想在程序不结束的情况下就拿到profile的结果呢？</p>
<p>这种情况下就需要用到动态profile的方式了。要实现这种方式，就需要改动程序的代码了，不过也比较简单：</p>
<pre><code class="bash">#include &lt;gperftools/profiler.h&gt;

int main()
{
    ProfilerStart(&quot;/tmp/profile&quot;);
    some_func_to_profile();
    ProfilerStop();

    return 0;
}</code></pre>
<p>没错，你只需要在你想要profile的函数的开头和结尾加上<code>ProfilerStart</code>和<code>ProfilerStop</code>调用就可以了。<br>在ProfilerStop结束之后，profile的结果就会保存在/tmp/profile里面了。<br>利用这种方式就可以在指定的时间点对程序进行profile了。</p>
<p>最后需要说的一点是，gperftools的profile过程采用的是采样的方式，而且对profile中的程序性能影响极小，<br>这对于在线或者离线profile都是一个极其重要的特点。</p>
<h2 id="include-what-you-use"><a href="#include-what-you-use" class="headerlink" title="include-what-you-use"></a>include-what-you-use</h2><ol>
<li><a href="https://github.com/include-what-you-use/include-what-you-use" target="_blank" rel="noopener">include-what-you-use</a></li>
<li><a href="http://bbs.chinaunix.net/forum.php?mod=viewthread&action=printable&tid=4145378" target="_blank" rel="noopener">找出C文件中不必要的头文件</a></li>
<li><a href="http://xinsuiyuer.github.io/blog/2013/10/30/include-what-you-use/" target="_blank" rel="noopener">使用I.W.Y.U整理头文件引用</a></li>
</ol>
<p>首先安装CLang开发包，然后编译IWYU：</p>
<pre><code class="bash">sudo apt-get install llvm llvm-devel llvm-clang llvm-clang-devel
git clone https://github.com/include-what-you-use/include-what-you-use.git
mkdir build &amp;&amp; cd build
cmake -G &quot;Unix Makefiles&quot; -DIWYU_LLVM_ROOT_PATH=/usr/lib/llvm-3.8 ../../include-what-you-use
make</code></pre>
<p>使用：</p>
<pre><code class="shell">make -k CC=/data/OpenSourceCode/include-what-you-use/build/include-what-you-use -I/usr/lib/llvm-3.8/lib/clang/3.8.0/include

-e compiling [/data/OpenSourceCode/include-what-you-use/build/include-what-you-use]: ./ca/thinew/app_tnt_baseinfo.c
In file included from ca/thinew/app_tnt_baseinfo.c:19:
In file included from ./include/app_module.h:22:
In file included from ./include/module/app_play_control.h:22:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/gxcore.h:4:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/common/gxcore_common.h:4:
In file included from /home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/stdlib.h:70:
/home/workspace/Solution-for-debug/dishcas/solution/../library/goxceed/csky-ecos/include/stddef.h:63:15: fatal error: 
    &#39;stddef.h&#39; file not found
#include_next &lt;stddef.h&gt;
^

ca/thinew/app_tnt_baseinfo.c should add these lines:

ca/thinew/app_tnt_baseinfo.c should remove these lines:
- #include &quot;app_module.h&quot;  // lines 19-19

The full include-list for ca/thinew/app_tnt_baseinfo.c:
#include &quot;app_config.h&quot;  // for TNTCAS_SUPPORT
---
deps:17: recipe for target &#39;/home/workspace/Solution-for-debug/dishcas/solution/output/objects/app_tnt_baseinfo.o&#39; failed
make[1]: *** [/home/workspace/Solution-for-debug/dishcas/solution/output/objects/app_tnt_baseinfo.o] Error 3</code></pre>
<blockquote>
<p><strong>fatal error: ‘stddef.h’ file not found</strong>待排除，可能与CLang环境设置有关，或与<code>include_next</code>有关<br><a href="https://github.com/include-what-you-use/include-what-you-use" target="_blank" rel="noopener">How to Install</a></p>
</blockquote>
<p>可以将 IWYU 保存到文件中，之后使用其附带的 fix_includes.py 自动对代码进行修复。 <strong>但应该慎重….</strong></p>
<pre><code class="bash">$ make -B -k CXX=include-what-you-use &gt; iwyu.out
$ fix_includes.py &lt; iwyu.out</code></pre>
<h2 id="OCLint"><a href="#OCLint" class="headerlink" title="OCLint"></a>OCLint</h2><ol>
<li><a href="http://oclint.org/" target="_blank" rel="noopener">OCLint</a></li>
<li><a href="https://github.com/oclint/oclint" target="_blank" rel="noopener">The OCLint Static Code Analysis Tool</a></li>
<li><a href="https://segmentfault.com/a/1190000005150573" target="_blank" rel="noopener">OCLint 安装与使用</a></li>
<li><a href="http://ceyang.me/dai-ma-du-liang-bang-zhu-xie-chu-gao-zhi-liang-dai-ma-de-gong-ju/" target="_blank" rel="noopener">代码度量：帮助写出高质量代码的工具</a></li>
<li><a href="http://lrdcq.com/me/read.php/48.htm" target="_blank" rel="noopener">oc代码静态检查方案</a></li>
<li><a href="http://docs.oclint.org/en/stable/intro/build.html" target="_blank" rel="noopener">Building OCLint</a></li>
<li><a href="http://docs.oclint.org/en/stable/intro/installation.html" target="_blank" rel="noopener">Installation</a></li>
<li><a href="https://github.com/oclint/oclint/releases" target="_blank" rel="noopener">downloading pre-compiled binaries</a></li>
</ol>
<p>下载<code>预编译</code>版本，然后将<code>PATH</code>添加到<code>.zshrc</code>中，测试如下：</p>
<pre><code class="bash">oclint
oclint: Not enough positional command line arguments specified!
Must specify at least 1 positional arguments: See: oclint -help</code></pre>
<p>如果使用<code>make</code>来构建系统，使用方式如下：</p>
<pre><code class="bash">sudo apt-get install bear

#compile_commands.json
bear make 

#oclint-json-compilation-database for code analysis
oclint-json-compilation-database

oclint -p &lt;build path&gt; &lt;source0&gt; [... &lt;sourceN&gt;]</code></pre>
<p><strong>OCLint配置规则</strong></p>
<h2 id="Clang-Static-Analyzer"><a href="#Clang-Static-Analyzer" class="headerlink" title="Clang Static Analyzer"></a><strong>Clang Static Analyzer</strong></h2><ol>
<li><a href="http://clang-analyzer.llvm.org/index.html" target="_blank" rel="noopener">Clang Static Analyzer</a></li>
<li><a href="http://clang-analyzer.llvm.org/installation#OtherPlatforms" target="_blank" rel="noopener">Building the Analyzer from Source</a></li>
<li><a href="http://blog.csdn.net/sealjin/article/details/45221209" target="_blank" rel="noopener">How to use Clang Static Analyzer</a></li>
<li><a href="http://xinsuiyuer.github.io/blog/2014/01/12/clang-static-analyzer/" target="_blank" rel="noopener">静态代码分析工具</a></li>
</ol>
<p>在编译安装 <code>llvm/clang</code> 或者 <code>sudo apt-get install clang</code> 之后，<code>scan-build</code> 和 <code>scan-view</code> 分别在</p>
<pre><code class="bash">$(SRC)/llvm/tools/clang/tools/scan-build
$(SRC)/llvm/tools/clang/tools/scan-view</code></pre>
<p>使用：</p>
<pre><code class="bash">scan-build make
.
scan-build: 3 bugs found.
scan-build: Run &#39;scan-view /tmp/scan-build-2016-06-23-124956-25166-1&#39; to examine bug reports.
scan-view /tmp/scan-build-2016-06-23-124956-25166-1</code></pre>
<p><strong>checker – 检查规则</strong></p>
<p>内置的 checker 存放在 <code>$(SRC)/llvm/tools/clang/lib/StaticAnalyzer/Checkers</code> 目录下。<br>这些 <code>checker</code> 默认情况下并没有全部开启，所以需要根据情况启用合适的 checker。<br>可以使用 <code>-enable-checker</code> 和 <code>-disable-checker</code> 开启和禁用具体的 checker 或者 某种类别的 checker。</p>
<pre><code class="bash">$ scan-build -enable-checker alpha.security.ArrayBoundV2 make # 启用数组边界检查</code></pre>
<p>所有支持的 checkers 可以使用如下命令查看：</p>
<pre><code class="bash">$ clang -cc1 -analyzer-checker-help
alpha.core.BoolAssignment       Warn about assigning non-{0,1} values to Boolean variables
alpha.core.CastSize             Check when casting a malloced type T, whether the size is a multiple of the size of T
alpha.core.CastToStruct         Check for cast from non-struct pointer to struct pointer
alpha.core.FixedAddr            Check for assignment of a fixed address to a pointer
alpha.core.IdenticalExpr        Warn about unintended use of identical expressions in operators
alpha.core.PointerArithm        Check for pointer arithmetic on locations other than array elements
alpha.core.PointerSub           Check for pointer subtractions on two pointers pointing to different memory chunks
alpha.core.SizeofPtr            Warn about unintended use of sizeof() on pointer expressions
alpha.cplusplus.NewDeleteLeaks  Check for memory leaks. Traces memory managed by new/delete.
alpha.cplusplus.VirtualCall     Check virtual function calls during construction or destruction
...
alpha.security.ArrayBound       Warn about buffer overflows (older checker)
alpha.security.ArrayBoundV2     Warn about buffer overflows (newer checker)
alpha.security.MallocOverflow   Check for overflows in the arguments to malloc()
alpha.security.ReturnPtrRange   Check for an out-of-bound pointer being returned to callers
...
core.CallAndMessage             Check for logical errors for function calls and Objective-C message expressions (e.g., uninitialized arguments, null function pointers)
core.DivideZero                 Check for division by zero
core.DynamicTypePropagation     Generate dynamic type information
core.NonNullParamChecker        Check for null pointers passed as arguments to a function whose arguments are references or marked with the &#39;nonnull&#39; attribute
core.NullDereference            Check for dereferences of null pointers
core.StackAddressEscape         Check that addresses to stack memory do not escape the function
...
unix.API                        Check calls to various UNIX/Posix functions
unix.Malloc                     Check for memory leaks, double free, and use-after-free problems. Traces memory managed by malloc()/free().
unix.MallocSizeof               Check for dubious malloc arguments involving sizeof
unix.MismatchedDeallocator      Check for mismatched deallocators.
unix.cstring.BadSizeArg         Check the size argument passed into C string functions for common erroneous patterns
unix.cstring.NullArg            Check for null pointers being passed as arguments to C string functions</code></pre>
<p>在使用 <code>-enable-checker</code> 或者 <code>-disable-checker</code> 时，不需要完整的指定某个 checker 的名称， 也可以是某一类的，如：</p>
<pre><code class="bash">$ scan-build -enable-checker alpha ...
$ scan-build -enable-checker alpha.security ...</code></pre>
<p>例如：</p>
<pre><code class="bash">$ scan-build -enable-checker alpha.security make
-e compiling [/usr/share/clang/scan-build-3.8/bin/../libexec/ccc-analyzer]: ./channel_edit.c
channel_edit.c:202:15: warning: Value stored to &#39;data&#39; during its initialization is never read
    list_data data = {0};
            ^~~~   ~~~
1 warning generated.
scan-build: 150 bugs found.
scan-build: Run &#39;scan-view /tmp/scan-build-2016-06-23-125458-27549-1&#39; to examine bug reports.

# scan-view-3.8 ImportError: No module named ScanView
$ scan-view-3.4 /tmp/scan-build-2016-06-23-125458-27549-1</code></pre>
<p><strong>相比 cppcheck，它提供了更多的检查规则。</strong></p>
<h2 id="Purify"><a href="#Purify" class="headerlink" title="Purify"></a>Purify</h2><ol>
<li><a href="http://brantc.blog.51cto.com/410705/116674/" target="_blank" rel="noopener">Purify使用体验</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/rational/r-cail/" target="_blank" rel="noopener">Rational Purify 使用及分析实例</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/rational/07/0306_chitale/" target="_blank" rel="noopener">使用 IBM Rational PurifyPlus</a></li>
</ol>
<h2 id="Infer"><a href="#Infer" class="headerlink" title="Infer"></a>Infer</h2><p>Facebook 的 Infer 是一个静态分析工具。Infer 可以分析 Objective-C， Java 或者 C 代码，报告潜在的问题。</p>
<ol>
<li><a href="http://infer.liaohuqiu.net/" target="_blank" rel="noopener">Infer</a></li>
<li><a href="http://infer.liaohuqiu.net/docs/getting-started.html" target="_blank" rel="noopener">documentation</a></li>
</ol>
<h2 id="coverity"><a href="#coverity" class="headerlink" title="coverity"></a>coverity</h2><ol>
<li><a href="http://www.coverity.com/html_cn/products/index.html" target="_blank" rel="noopener">coverity</a></li>
<li><a href="http://blog.csdn.net/yasi_xi/article/details/8349985" target="_blank" rel="noopener">Coverity 代码静态安全检测</a></li>
</ol>
<h2 id="PVS-Studio"><a href="#PVS-Studio" class="headerlink" title="PVS-Studio"></a>PVS-Studio</h2><p><a href="http://www.hkaco.com/software/viva64/home.html" target="_blank" rel="noopener">C/C++/C++11 静态代码分析工具</a></p>
<h2 id="PC-lint"><a href="#PC-lint" class="headerlink" title="PC-lint"></a>PC-lint</h2><p><a href="http://www.gimpel.com/html/pcl.htm" target="_blank" rel="noopener">PC-lint</a></p>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><!--
1. [C++ static code analysis tool on Windows](http://stackoverflow.com/questions/97454/c-static-code-analysis-tool-on-windows)
2. [静态代码分析工具汇总](http://blog.csdn.net/dongwuming/article/details/49423909)
3. [C/C++ 编程有哪些值得推荐的工具](https://www.zhihu.com/question/23357089)
4. [linux环境下 C++性能测试工具 gprof + kprof + gprof2dot](http://www.cnblogs.com/rocketfan/archive/2009/11/15/1603465.html)
5. [源码分析：动态分析 C 程序函数调用关系](http://blog.csdn.net/tinylab/article/details/45051097)
6. [Tutorial: Using GNU Profiling (gprof) with ARM Cortex-M](https://mcuoneclipse.com/2015/08/23/tutorial-using-gnu-profiling-gprof-with-arm-cortex-m/)
7. [如何使用gprof对软件做profiling](https://forums.xilinx.com/t5/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%B7%A5%E5%85%B7%E4%B8%8EIP/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8gprof%E5%AF%B9%E8%BD%AF%E4%BB%B6%E5%81%9Aprofiling/td-p/397451)
-->
<ol start="5">
<li><a href="https://en.wikipedia.org/wiki/List_of_tools_for_static_code_analysis#C.2C_C.2B.2B" target="_blank" rel="noopener">List of tools for static code analysis</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-OOM-Killer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-OOM-Killer/" class="post-title-link" itemprop="url">Linux下malloc函数和OOM Killer</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="Malloc函数和OOM-Killer"><a href="#Malloc函数和OOM-Killer" class="headerlink" title="Malloc函数和OOM Killer"></a><strong>Malloc函数和OOM Killer</strong></h3><p>Linux下malloc函数主要用来在用户空间从heap申请内存，申请成功返回指向所分配内存的指针，申请失败返回NULL。<br><strong>默认情况下，Linux内核使用“乐观的”分配内存策略</strong>，首先粗略估计系统可使用的内存数，然后分配内存，<br>但是在使用的时候才真正把这块分配的内存给你。<br>这样一来，即使用malloc申请内存没有返回NULL，你也不一定能完全使用这块内存，<br>特别是在一次或连续多次申请很多内存的时候。</p>
<p>如果一直连续用malloc申请内存，而不真正使用，所申请的内存总数可以超过真正可以使用的内存数。<br>但是当真正使用这块内存，比如用memset或bzero函数一次性把所申请到的大块内存“使用掉”，<br>Linux系统就会Out Of Memory，这个时候OOM Killer就会kill掉用户空间的其他进程来腾出更多可使用内存。</p>
<p>OOM Killer根据OOM score来决定kill哪个进程，OOM score可以看/proc/<PID>/oom_score，<br>score由badness函数计算得出，根据进程运行时间长短，进程优先级，进程所使用的内存数等等。<br>可以通过/proc/<PID>/oom_adj来干预计算socre，这个值的取值范围是-17～15，<br>如果是-17该进程就永远不会被kill（这个可能也和内核版本有关，不见得所有内核版本都支持，得实际试试）。</p>
<p>“默认情况”Linux是这种做的，“默认情况”是指/proc/sys/vm/overcommit_memory为0的时候。<br>这个参数也可以调整，如果为1表示“来着不拒”，只要你malloc过来申请，我啥都不做，立马给你分配内存，<br>这样的话性能就会有大幅度的提高；<br>如果为2表示Linux会精确计算所有可使用的内存和所申请的内存，如果所申请的超过的可使用的内存数就返回NULL。<br>可使用的内存值计算方法，虚拟内存（swap）+ /proc/sys/vm/overcommit_memory（百分比） × 物理内存。<br>/proc/sys/vm/overcommit_memory默认值为50,计算起来就是50%的物理内存数。</p>
<p>Linux自身内核会占一部分内存，还有buffer/cache所占用的内存，<br>所以实际上能被malloc申请后使用的内存并非物理内存大小，<br>demsg的输出里面包含了相关信息（如果看不到，可能是被别的信息冲掉了，重启系统，在系统起来后马上看）：</p>
<pre><code>Memory: 2071220k/2097152k available (2122k kernel code, 24584k reserved, 884k data, 228k init, 1179584k highmem)</code></pre><h3 id="关于OOM-Killer的proc文件系统"><a href="#关于OOM-Killer的proc文件系统" class="headerlink" title="关于OOM Killer的proc文件系统"></a><strong>关于OOM Killer的proc文件系统</strong></h3><p>下面开始介绍与OOM Killer相关的proc文件系统。</p>
<h4 id="proc-PID-oom-adj"><a href="#proc-PID-oom-adj" class="headerlink" title="/proc/PID/oom_adj"></a><strong>/proc/PID/oom_adj</strong></h4><p>为/proc/PID/oom_adj设置值就可以调整得分。<br>调整值的范围为–16~15。正的值容易被OOM Killer选定。负值可能性较低。<br>例如，当指定3时，得分就变为23倍；当指定–5时，得分就变为1/25。</p>
<p>“–17”是一个特殊的值。如果设置为–17，就会禁止OOM Killer发出的信号（从Linux 2.6.12开始支持设置–17）。</p>
<p>在OOM Killer运行的情况下，为了实现远程登录而想要将sshd排除在对象外时，可以执行下列命令。</p>
<pre><code># cat /proc/&#39;cat /var/run/sshd.pid&#39;/oom_score
15
# echo -17 &gt;  /proc/&#39;cat /var/run/sshd.pid&#39;/oom_adj
# tail /proc/&#39;cat /var/run/sshd.pid&#39;/oom_*
==&gt; /proc/2278/oom_adj &lt;==
-17
==&gt; /proc/2278/oom_score &lt;==
0                               /*得分变成0*/</code></pre><p>从Linux 2.6.18开始可以使用/proc/PID/oom_adj。内容记载在Documentation /filesystems/proc.txt中。</p>
<h4 id="proc-sys-vm-panic-on-oom"><a href="#proc-sys-vm-panic-on-oom" class="headerlink" title="/proc/sys/vm/panic_on_oom"></a><strong>/proc/sys/vm/panic_on_oom</strong></h4><p>将/proc/sys/vm/panic_on_oom设置为1时，在OOM Killer运行时可以不发送进程信号，而是使内核产生重大故障。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/panic_on_oom</code></pre><h4 id="proc-sys-vm-oom-kill-allocating-task"><a href="#proc-sys-vm-oom-kill-allocating-task" class="headerlink" title="/proc/sys/vm/oom_kill_allocating_task"></a><strong>/proc/sys/vm/oom_kill_allocating_task</strong></h4><p>从Linux 2.6.24开始proc文件系统就有oom_kill_allocating_task。<br>如果对此设置除0以外的值，则促使OOM Killer运行的进程自身将接收信号。此处省略对所有进程的得分计算过程。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_kill_allocating_task</code></pre><p>这样就不需要参照所有进程，但是也不会考虑进程的优先级和root权限等，只发送信号。</p>
<h4 id="proc-sys-vm-oom-dump-tasks"><a href="#proc-sys-vm-oom-dump-tasks" class="headerlink" title="/proc/sys/vm/oom_dump_tasks"></a><strong>/proc/sys/vm/oom_dump_tasks</strong></h4><p>从Linux 2.6.25开始，将oom_dump_tasks设置为除0以外的值时，在OOM Killer运行时的输出中会增加进程的列表信息。</p>
<pre><code># echo 1 &gt; /proc/sys/vm/oom_dump_tasks</code></pre><p>列表信息显示如下，可以使用dmesg或syslog来确认。</p>
<pre><code>[ pid ]   uid  tgid total_vm      rss cpu oom_adj name
[    1]     0     1     2580        1   0       0 init
[  500]     0   500     3231        0   1     -17 udevd
[ 2736]     0  2736     1470        1   0       0 syslogd
[ 2741]     0  2741      944        0   0       0 klogd
[ 2765]    81  2765     5307        0   0       0 dbus-daemon
[ 2861]     0  2861      944        0   0       0 acpid
...
[ 3320]     0  3320   525842   241215   1       0 stress</code></pre><h4 id="proc-PID-oom-score-adj"><a href="#proc-PID-oom-score-adj" class="headerlink" title="/proc/PID/oom_score_adj"></a><strong>/proc/PID/oom_score_adj</strong></h4><p>从Linux 2.6.36开始都安装了/proc/<PID>/oom_score_adj，<br>此后将替换为/proc/PID/oom_adj。<br>即使当前是对/proc/PID/oom_adj进行的设置，在内核内部进行变换后的值也是针对/proc/PID/oom_score_adj设置的。</p>
<p>可以设置–1000~1000之间的值。设置为–1000时，该进程就被排除在OOM Killer强制终止的对象外。</p>
<p>在内核2.6.36以后的版本中写入oom_adj，只会输出一次如下的信息。</p>
<pre><code># dmesg
.....
udevd (60): /proc/60/oom_adj is deprecated, please use /proc/60/oom_score_adj instead.</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/06/Linux-malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/06/Linux-malloc/" class="post-title-link" itemprop="url">linux内存分配原理（brk和mmap）（转载）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-07T00:00:00+08:00">2015-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="如何查看进程发生缺页中断的次数？"><a href="#如何查看进程发生缺页中断的次数？" class="headerlink" title="如何查看进程发生缺页中断的次数？"></a><strong>如何查看进程发生缺页中断的次数？</strong></h3><pre><code>ps -o majflt,minflt -C program</code></pre><p>majflt代表major fault，中文名叫大错误，minflt代表minor fault，中文名叫小错误。<br>这两个数值表示一个进程自启动以来所发生的缺页中断的次数。</p>
<h3 id="发成缺页中断后，执行了那些操作？"><a href="#发成缺页中断后，执行了那些操作？" class="headerlink" title="发成缺页中断后，执行了那些操作？"></a><strong>发成缺页中断后，执行了那些操作？</strong></h3><p>当一个进程发生缺页中断的时候，进程会陷入内核态，执行以下操作： </p>
<ol>
<li>检查要访问的虚拟地址是否合法 </li>
<li>查找/分配一个物理页 </li>
<li>填充物理页内容（读取磁盘，或者直接置0，或者啥也不干） </li>
<li>建立映射关系（虚拟地址到物理地址） </li>
<li>重新执行发生缺页中断的那条指令 </li>
</ol>
<p>如果第3步，需要读取磁盘，那么这次缺页中断就是majflt，否则就是minflt。 </p>
<h3 id="内存分配的原理"><a href="#内存分配的原理" class="headerlink" title="内存分配的原理"></a><strong>内存分配的原理</strong></h3><p>从操作系统角度来看，进程分配内存有两种方式，分别由两个系统调用完成：brk和mmap（不考虑共享内存）。</p>
<ol>
<li>brk是将数据段(.data)的最高地址指针_edata往高地址推；</li>
<li>mmap是在进程的虚拟地址空间中（堆和栈中间，称为文件映射区域的地方）找一块空闲的虚拟内存。</li>
</ol>
<p><strong>这两种方式分配的都是虚拟内存，没有分配物理内存。<br>在第一次访问已分配的虚拟地址空间的时候，发生缺页中断，操作系统负责分配物理内存，然后建立虚拟内存和物理内存之间的映射关系。</strong><br>在标准C库中，提供了malloc/free函数分配释放内存，这两个函数底层是由brk，mmap，munmap这些系统调用实现的。</p>
<h3 id="以例子来说明内存分配的原理"><a href="#以例子来说明内存分配的原理" class="headerlink" title="以例子来说明内存分配的原理"></a><strong>以例子来说明内存分配的原理</strong></h3><h4 id="情况一"><a href="#情况一" class="headerlink" title="情况一"></a><strong>情况一</strong></h4><p>malloc小于128k的内存，使用brk分配内存，<br>将_edata往高地址推(只分配虚拟空间，不对应物理内存(因此没有初始化)，<br>第一次读/写数据时，引起内核缺页中断，内核才分配对应的物理内存，然后虚拟地址空间建立映射关系)，如下图：</p>
<p><img src="/images/malloc/1.jpg" alt="brk" title="wizard"></p>
<ul>
<li><p>进程启动的时候，其（虚拟）内存空间的初始布局如图1所示。<br>其中，mmap内存映射文件是在堆和栈的中间（例如libc-2.2.93.so，其它数据文件等），为了简单起见，省略了内存映射文件。<br>_edata指针（glibc里面定义）指向数据段的最高地址。 </p>
</li>
<li><p>进程调用A=malloc(30K)以后，内存空间如图2：<br>malloc函数会调用brk系统调用，将_edata指针往高地址推30K，就完成虚拟内存分配。<br>你可能会问：只要把_edata+30K就完成内存分配了？<br>事实是这样的，_edata+30K只是完成虚拟地址的分配，A这块内存现在还是没有物理页与之对应的，<br>等到进程第一次读写A这块内存的时候，发生缺页中断，这个时候，内核才分配A这块内存对应的物理页。<br>也就是说，如果用malloc分配了A这块内容，然后从来不访问它，那么，A对应的物理页是不会被分配的。 </p>
</li>
<li><p>进程调用B=malloc(40K)以后，内存空间如图3。</p>
</li>
</ul>
<h4 id="情况二"><a href="#情况二" class="headerlink" title="情况二"></a><strong>情况二</strong></h4><p>malloc大于128k的内存，使用mmap分配内存，在堆和栈之间找一块空闲内存分配(对应独立内存，而且初始化为0)，如下图：</p>
<p><img src="/images/malloc/2.jpg" alt="mmap" title="build"></p>
<ul>
<li><p>进程调用C=malloc(200K)以后，内存空间如图4：<br>默认情况下，malloc函数分配内存，如果请求内存大于128K（可由M_MMAP_THRESHOLD选项调节），<br>那就不是去推_edata指针了，而是利用mmap系统调用，从堆和栈的中间分配一块虚拟内存。<br>  <strong>这样子做主要是因为:<br>  brk分配的内存需要等到高地址内存释放以后才能释放<br>  （例如，在B释放之前，A是不可能释放的，这就是内存碎片产生的原因，什么时候紧缩看下面），<br>  而mmap分配的内存可以单独释放。</strong><br>  当然，还有其它的好处，也有坏处，再具体下去，有兴趣的同学可以去看glibc里面malloc的代码了。 </p>
</li>
<li><p>进程调用D=malloc(100K)以后，内存空间如图5；</p>
</li>
<li><p>进程调用free(C)以后，C对应的虚拟内存和物理内存一起释放。</p>
</li>
</ul>
<p><img src="/images/malloc/3.jpg" alt="free" title="dot"></p>
<ul>
<li><p>进程调用free(B)以后，如图7所示：<br>B对应的虚拟内存和物理内存都没有释放，因为只有一个_edata指针，如果往回推，那么D这块内存怎么办呢？<br>当然，B这块内存，是可以重用的，如果这个时候再来一个40K的请求，那么malloc很可能就把B这块内存返回回去了。 </p>
</li>
<li><p>进程调用free(D)以后，如图8所示：<br>B和D连接起来，变成一块140K的空闲内存。</p>
</li>
<li><p>默认情况下：<br>当最高地址空间的空闲内存超过128K（可由M_TRIM_THRESHOLD选项调节）时，执行内存紧缩操作（trim）。<br>在上一个步骤free的时候，发现最高地址空闲内存超过128K，于是内存紧缩，变成图9所示。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/grep-special/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/grep-special/" class="post-title-link" itemprop="url">Grep搜索特定文件</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>120</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Script"><a href="#Script" class="headerlink" title="Script"></a><strong>Script</strong></h3><pre><code>grep XXYYZZ * -Rn --include=&#39;*.c&#39;
grep XXYYZZ * -Rn --include=&#39;*.h&#39;
grep XXYYZZ * -Rn --include=&#39;*.[ch]&#39;</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/01/doxygen-graphviz/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/07/01/doxygen-graphviz/" class="post-title-link" itemprop="url">Ubuntu下使用Doxygen和graphviz来产生源代码函数调用图</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-07-02 00:00:00" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">2015-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-18 19:37:25" itemprop="dateModified" datetime="2020-05-18T19:37:25+08:00">2020-05-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Doxygen/" itemprop="url" rel="index">
                    <span itemprop="name">Doxygen</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>721</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h3><pre><code>sudo apt-get install doxygen doxygen-doc doxygen-gui graphviz
doxywizard
doxygen -g</code></pre><h3 id="生成函数调用图"><a href="#生成函数调用图" class="headerlink" title="生成函数调用图"></a><strong>生成函数调用图</strong></h3><h4 id="DoxyWizard"><a href="#DoxyWizard" class="headerlink" title="DoxyWizard"></a><strong>DoxyWizard</strong></h4><p>打开DoxyWizard，弹出Doxygen配置界面。如下图，标出了主要需要设置的选项:</p>
<p><img src="/images/doxygen/1.png" alt="wizard" title="wizard"></p>
<ol>
<li>Step1：设置doxygen的工作目录，这里主要是生成doxygen运行的目录</li>
<li>Step2：选项设置，wizard和expert选项可以同时设置。</li>
</ol>
<p>wizard选项卡中，选择Project Name作为工程名称，将来会显示在文档的标题中；<br>选择Source code directory，设置源代码所在目录，Destination directory设置文档的生成目录；<br>选择Scan recursively则递归分析源代码目录中的子目录内的源代码。</p>
<h4 id="build"><a href="#build" class="headerlink" title="build"></a><strong>build</strong></h4><p>需要从没有任何标记的源代码中分析出函数调用关系，所以还需要设置expert选项卡:</p>
<p><img src="/images/doxygen/2.png" alt="build" title="build"></p>
<p>勾选Build选项中的与函数有关的选项，EXTRACT_ALL必须勾选；<br>sourcebrowser: 需要查看代码，勾选Inline sources和souce Browser。</p>
<h4 id="dot"><a href="#dot" class="headerlink" title="dot"></a><strong>dot</strong></h4><p>由于使用到了Graphviz，所以要设置Dot选项，勾选HAVE_DOT，并设置DOT_PATH为Graphviz的bin目录。</p>
<p><img src="/images/doxygen/3.png" alt="dot1" title="dot"></p>
<p>Dot: 这里可以勾选CLASS_DIAGRAMS/HAVE_DOT/CALL_GRAPH/CALLER_GRAPH/DOT_PATH</p>
<p><img src="/images/doxygen/4.png" alt="dot2" title="dot2"></p>
<h4 id="run"><a href="#run" class="headerlink" title="run"></a><strong>run</strong></h4><p>然后就可以点RUN标签，运行后，会生成HTML，查看INDEX.HTML既可以看到结果</p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_7a1c18a80102vd2p.html" target="_blank" rel="noopener">Ubuntu 下使用 Doxygen</a></li>
<li><a href="http://www.07net01.com/program/229677.html" target="_blank" rel="noopener">使用Doxygen+graphviz+Sublime2来看代码，查看函数调用关系</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Breeze.Temple"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Breeze.Temple</p>
  <div class="site-description" itemprop="description">Breeze.Temple</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">447</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">478</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/breezetemple" title="GitHub &rarr; https://github.com/breezetemple" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org" title="BitBucket &rarr; https://bitbucket.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-bitbucket"></i>BitBucket</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://breezetemple.github.io/" title="http://breezetemple.github.io/" rel="noopener" target="_blank">Breeze.Temple's HomePage</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Breeze.Temple</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">18:17</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  


  <link rel="stylesheet" href="/js/highlight/styles/solarized-dark.css">
  <script src="/js/highlight/highlight.pack.js"></script>
  <script type="text/javascript">
      $(function() {
          hljs.initHighlighting();
      });
  </script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Breeze.Temple">
<meta property="og:type" content="website">
<meta property="og:title" content="IT日记">
<meta property="og:url" content="http://yoursite.com/page/27/index.html">
<meta property="og:site_name" content="IT日记">
<meta property="og:description" content="Breeze.Temple">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Breeze.Temple">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>IT日记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Life is Now.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/16/makefile-automake-libs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/03/16/makefile-automake-libs/" class="post-title-link" itemprop="url">makefile根据文件目录来生成库</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-03-17 00:00:00" itemprop="dateCreated datePublished" datetime="2016-03-17T00:00:00+08:00">2016-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p><strong>根据src下目录名称来生成对应的库，不需要修改makefile，只需要添加文件夹从而生成新的库。</strong></p>
<p>相关知识点：<a href="http://breezetemple.github.io/2015/10/makefile-and-shell/" target="_blank" rel="noopener">Makefile中嵌入一段shell脚本及函数列表</a></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><pre><code>SRC = $(shell find . -iname &quot;*.c&quot;)
DIRS = $(shell ls -I include ./src)

.PHONY : clean install

all : objects libs

objects:$(SRC)
    @echo &quot;making objects dir&quot;
    @mkdir -p $(objects_dir)
    @echo &quot;Generating new objects file...&quot;;
    @for f in $(SRC); do \
        OBJ=$(objects_dir)/`basename $$f|sed -e &#39;s/\.c/\.o/&#39;`; \
        echo &quot;compiling \033[032m[$(CC)]\033[0m&quot;: $$f; \
        $(CC) $(CFLAGS) -c $$f -o $$OBJ; \
    done

libs:
    @echo &quot;\nmaking libs ...&quot;
    @for subdir in $(DIRS); do \
        target=$(addprefix lib, $(addsuffix .a, $$subdir)); \
        objs=`ls ./src/$$subdir|sed -e &#39;s/\.c/\.o/&#39;|sed -e &#39;s#^#./$(objects_dir)/#&#39;`; \
        $(AR) -rcs $$target $$objs; \
        echo &quot;In subdir\033[32m&quot; [$$subdir] &quot;\033[0mGenerating new lib\033[31m&quot;: $$target&quot;\033[0m&quot;; \
    done

clean :
    @echo [Clean all]
    @rm -rf $(objects_dir)
    @rm -rf $(install_dir)
    @find -name &quot;*.o&quot; | xargs rm -rf
    @rm -rf *.a

install : *.a
    @echo &quot;making install dir&quot;
    @mkdir -p $(install_dir)
    @mv *.a $(install_dir)
    @cp include/*.h $(install_dir)
    @cp porting/*.h $(install_dir)</code></pre><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><h3 id="addprefix"><a href="#addprefix" class="headerlink" title="addprefix"></a><strong>addprefix</strong></h3><pre><code>target=$(addprefix lib, $(addsuffix .a, $$subdir))</code></pre><p>addprefix在shell脚本片段中，处理的文本为多个时会失败，具体原因未知…</p>
<h3 id="shell变量与makefile变量"><a href="#shell变量与makefile变量" class="headerlink" title="shell变量与makefile变量"></a><strong>shell变量与makefile变量</strong></h3><p>$(objects_dir)为shell变量，$$target为makefile变量</p>
<h3 id="shell与-反引号"><a href="#shell与-反引号" class="headerlink" title="shell与``[反引号]"></a><strong>shell与``[反引号]</strong></h3><p>在for循环中，使用类似：</p>
<pre><code>objs=$(shell ls ./src/$$subdir|sed -e &#39;s/\.c/\.o/&#39;|sed -e &#39;s#^#./$(objects_dir)/#&#39;); \ </code></pre><p>执行不成功：</p>
<pre><code>/bin/sh: 3: ./output/objects/cmm: not found</code></pre><p>修改为：</p>
<pre><code>objs=`ls ./src/$$subdir|sed -e &#39;s/\.c/\.o/&#39;|sed -e &#39;s#^#./$(objects_dir)/#&#39;`; \</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/23/git-remote/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/02/23/git-remote/" class="post-title-link" itemprop="url">Git 远程操作详解[转载]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-24T00:00:00+08:00">2016-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<p>作者： 阮一峰<br>日期： 2014年6月12日<br><a href="http://www.ruanyifeng.com/blog/2014/06/git_remote.html" target="_blank" rel="noopener">原文</a></p>
<p>Git是目前最流行的版本管理系统，学会Git几乎成了开发者的必备技能。<br>Git有很多优势，其中之一就是远程操作非常简便。本文详细介绍5个Git命令，它们的概念和用法，理解了这些内容，你就会完全掌握Git远程操作。</p>
<ul>
<li><strong>git clone</strong></li>
<li><strong>git remote</strong></li>
<li><strong>git fetch</strong></li>
<li><strong>git pull</strong></li>
<li><strong>git push</strong></li>
</ul>
<p>本文针对初级用户，从最简单的讲起，但是需要读者对Git的基本用法有所了解。<br>同时，本文覆盖了上面5个命令的几乎所有的常用用法，所以对于熟练用户也有参考价值。</p>
<p><img src="/images/git/git_remote.jpg" alt="Git Remote" title="git remote"></p>
<h2 id="git-clone"><a href="#git-clone" class="headerlink" title="git clone"></a><strong>git clone</strong></h2><p>远程操作的第一步，通常是从远程主机克隆一个版本库，这时就要用到git clone命令。</p>
<pre><code>$ git clone &lt;版本库的网址&gt;</code></pre><p>比如，克隆jQuery的版本库。</p>
<pre><code>$ git clone https://github.com/jquery/jquery.git</code></pre><p>该命令会在本地主机生成一个目录，与远程主机的版本库同名。如果要指定不同的目录名，可以将目录名作为git clone命令的第二个参数。</p>
<pre><code>$ git clone &lt;版本库的网址&gt; &lt;本地目录名&gt;</code></pre><p>git clone支持多种协议，除了HTTP(s)以外，还支持SSH、Git、本地文件协议等，下面是一些例子。</p>
<pre><code>$ git clone http[s]://example.com/path/to/repo.git/
$ git clone ssh://example.com/path/to/repo.git/
$ git clone git://example.com/path/to/repo.git/
$ git clone /opt/git/project.git 
$ git clone file:///opt/git/project.git
$ git clone ftp[s]://example.com/path/to/repo.git/
$ git clone rsync://example.com/path/to/repo.git/</code></pre><p>SSH协议还有另一种写法。</p>
<pre><code>$ git clone [user@]example.com:path/to/repo.git/</code></pre><p>通常来说，Git协议下载速度最快，SSH协议用于需要用户认证的场合。各种协议优劣的详细讨论请参考官方文档。</p>
<h2 id="git-remote"><a href="#git-remote" class="headerlink" title="git remote"></a><strong>git remote</strong></h2><p>为了便于管理，Git要求每个远程主机都必须指定一个主机名。git remote命令就用于管理主机名。<br>不带选项的时候，git remote命令列出所有远程主机。</p>
<pre><code>$ git remote
origin</code></pre><p>使用-v选项，可以参看远程主机的网址。</p>
<pre><code>$ git remote -v
origin  git@github.com:jquery/jquery.git (fetch)
origin  git@github.com:jquery/jquery.git (push)</code></pre><p>上面命令表示，当前只有一台远程主机，叫做origin，以及它的网址。<br>克隆版本库的时候，所使用的远程主机自动被Git命名为origin。如果想用其他的主机名，需要用git clone命令的-o选项指定。</p>
<pre><code>$ git clone -o jQuery https://github.com/jquery/jquery.git
$ git remote
jQuery</code></pre><p>上面命令表示，克隆的时候，指定远程主机叫做jQuery。</p>
<p>git remote show命令加上主机名，可以查看该主机的详细信息。</p>
<pre><code>$ git remote show &lt;主机名&gt;</code></pre><p>git remote add命令用于添加远程主机。</p>
<pre><code>$ git remote add &lt;主机名&gt; &lt;网址&gt;</code></pre><p>git remote rm命令用于删除远程主机。</p>
<pre><code>$ git remote rm &lt;主机名&gt;</code></pre><p>git remote rename命令用于远程主机的改名。</p>
<pre><code>$ git remote rename &lt;原主机名&gt; &lt;新主机名&gt;</code></pre><h2 id="git-fetch"><a href="#git-fetch" class="headerlink" title="git fetch"></a><strong>git fetch</strong></h2><p>一旦远程主机的版本库有了更新（Git术语叫做commit），需要将这些更新取回本地，这时就要用到git fetch命令。</p>
<pre><code>$ git fetch &lt;远程主机名&gt;</code></pre><p>上面命令将某个远程主机的更新，全部取回本地。<br>git fetch命令通常用来查看其他人的进程，因为它取回的代码对你本地的开发代码没有影响。<br>默认情况下，git fetch取回所有分支（branch）的更新。如果只想取回特定分支的更新，可以指定分支名。</p>
<pre><code>$ git fetch &lt;远程主机名&gt; &lt;分支名&gt;</code></pre><p>比如，取回origin主机的master分支。</p>
<pre><code>$ git fetch origin master</code></pre><p>所取回的更新，在本地主机上要用”远程主机名/分支名”的形式读取。比如origin主机的master，就要用origin/master读取。<br>git branch命令的-r选项，可以用来查看远程分支，-a选项查看所有分支。</p>
<pre><code>$ git branch -r
origin/master

$ git branch -a
* master
  remotes/origin/master</code></pre><p>上面命令表示，本地主机的当前分支是master，远程分支是origin/master。<br>取回远程主机的更新以后，可以在它的基础上，使用git checkout命令创建一个新的分支。</p>
<pre><code>$ git checkout -b newBrach origin/master</code></pre><p>上面命令表示，在origin/master的基础上，创建一个新分支。<br>此外，也可以使用git merge命令或者git rebase命令，在本地分支上合并远程分支。</p>
<pre><code>$ git merge origin/master
$ git rebase origin/master</code></pre><p>上面命令表示在当前分支上，合并origin/master。</p>
<h2 id="git-pull"><a href="#git-pull" class="headerlink" title="git pull"></a><strong>git pull</strong></h2><p>git pull命令的作用是，取回远程主机某个分支的更新，再与本地的指定分支合并。它的完整格式稍稍有点复杂。</p>
<pre><code>$ git pull &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;</code></pre><p>比如，取回origin主机的next分支，与本地的master分支合并，需要写成下面这样。</p>
<pre><code>$ git pull origin next:master</code></pre><p>如果远程分支是与当前分支合并，则冒号后面的部分可以省略。</p>
<pre><code>$ git pull origin next</code></pre><p>上面命令表示，取回origin/next分支，再与当前分支合并。实质上，这等同于先做git fetch，再做git merge。</p>
<pre><code>$ git fetch origin
$ git merge origin/next</code></pre><p>在某些场合，Git会自动在本地分支与远程分支之间，建立一种追踪关系（tracking）。<br>比如，在git clone的时候，所有本地分支默认与远程主机的同名分支，建立追踪关系，<br>也就是说，本地的master分支自动”追踪”origin/master分支。<br>Git也允许手动建立追踪关系。</p>
<pre><code>git branch --set-upstream master origin/next</code></pre><p>上面命令指定master分支追踪origin/next分支。<br><strong>如果当前分支与远程分支存在追踪关系，git pull就可以省略远程分支名。</strong></p>
<pre><code>$ git pull origin</code></pre><p>上面命令表示，本地的当前分支自动与对应的origin主机”追踪分支”（remote-tracking branch）进行合并。<br>如果当前分支只有一个追踪分支，连远程主机名都可以省略。</p>
<pre><code>$ git pull</code></pre><p>上面命令表示，当前分支自动与唯一一个追踪分支进行合并。<br>如果合并需要采用rebase模式，可以使用–rebase选项。</p>
<pre><code>$ git pull --rebase &lt;远程主机名&gt; &lt;远程分支名&gt;:&lt;本地分支名&gt;</code></pre><p>如果远程主机删除了某个分支，默认情况下，git pull 不会在拉取远程分支的时候，删除对应的本地分支。<br>这是为了防止，由于其他人操作了远程主机，导致git pull不知不觉删除了本地分支。<br>但是，你可以改变这个行为，加上参数 -p 就会在本地删除远程已经删除的分支。</p>
<pre><code>$ git pull -p
# 等同于下面的命令
$ git fetch --prune origin 
$ git fetch -p</code></pre><h2 id="git-push"><a href="#git-push" class="headerlink" title="git push"></a><strong>git push</strong></h2><p>git push命令用于将本地分支的更新，推送到远程主机。它的格式与git pull命令相仿。</p>
<pre><code>$ git push &lt;远程主机名&gt; &lt;本地分支名&gt;:&lt;远程分支名&gt;</code></pre><p>注意，分支推送顺序的写法是&lt;来源地&gt;:&lt;目的地&gt;，所以git pull是&lt;远程分支&gt;:&lt;本地分支&gt;，而git push是&lt;本地分支&gt;:&lt;远程分支&gt;。<br>如果省略远程分支名，则表示将本地分支推送与之存在”追踪关系”的远程分支（通常两者同名），如果该远程分支不存在，则会被新建。</p>
<pre><code>$ git push origin master</code></pre><p>上面命令表示，将本地的master分支推送到origin主机的master分支。如果后者不存在，则会被新建。<br>如果省略本地分支名，则表示删除指定的远程分支，因为这等同于推送一个空的本地分支到远程分支。</p>
<pre><code>$ git push origin :master
# 等同于
$ git push origin --delete master</code></pre><p>上面命令表示删除origin主机的master分支。<br>如果当前分支与远程分支之间存在追踪关系，则本地分支和远程分支都可以省略。</p>
<pre><code>$ git push origin</code></pre><p>上面命令表示，将当前分支推送到origin主机的对应分支。<br>如果当前分支只有一个追踪分支，那么主机名都可以省略。</p>
<pre><code>$ git push</code></pre><p>如果当前分支与多个主机存在追踪关系，则可以使用-u选项指定一个默认主机，这样后面就可以不加任何参数使用git push。</p>
<pre><code>$ git push -u origin master</code></pre><p>上面命令将本地的master分支推送到origin主机，同时指定origin为默认主机，后面就可以不加任何参数使用git push了。<br>不带任何参数的git push，默认只推送当前分支，这叫做simple方式。<br>此外，还有一种matching方式，会推送所有有对应的远程分支的本地分支。<br>Git 2.0版本之前，默认采用matching方法，现在改为默认采用simple方式。如果要修改这个设置，可以采用git config命令。</p>
<pre><code>$ git config --global push.default matching
# 或者
$ git config --global push.default simple</code></pre><p>还有一种情况，就是不管是否存在对应的远程分支，将本地的所有分支都推送到远程主机，这时需要使用–all选项。</p>
<pre><code>$ git push --all origin</code></pre><p>上面命令表示，将所有本地分支都推送到origin主机。<br>如果远程主机的版本比本地版本更新，推送时Git会报错，要求先在本地做git pull合并差异，然后再推送到远程主机。<br>这时，如果你一定要推送，可以使用–force选项。</p>
<pre><code>$ git push --force origin </code></pre><p>上面命令使用–force选项，结果导致远程主机上更新的版本被覆盖。<br>除非你很确定要这样做，否则应该尽量避免使用–force选项。<br>最后，git push不会推送标签（tag），除非使用–tags选项。</p>
<pre><code>$ git push origin --tags</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/23/git-cheat-sheet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/02/23/git-cheat-sheet/" class="post-title-link" itemprop="url">常用 Git 命令清单[转载]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-24T00:00:00+08:00">2016-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<p>作者： 阮一峰<br>日期： 2014年6月12日<br><a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html" target="_blank" rel="noopener">原文</a></p>
<p>一般来说，日常使用只要记住下图6个命令，就可以了。但是熟练使用，恐怕要记住60～100个命令。</p>
<p><img src="/images/git/git_remote.jpg" alt="Git Remote" title="git remote"></p>
<p>下面是我整理的常用 Git 命令清单。几个专用名词的译名如下。</p>
<pre><code>Workspace：工作区
Index / Stage：暂存区
Repository：仓库区（或本地仓库）
Remote：远程仓库</code></pre><h2 id="新建代码库"><a href="#新建代码库" class="headerlink" title="新建代码库"></a>新建代码库</h2><pre><code># 在当前目录新建一个Git代码库
$ git init

# 新建一个目录，将其初始化为Git代码库
$ git init [project-name]

# 下载一个项目和它的整个代码历史
$ git clone [url]</code></pre><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Git的设置文件为.gitconfig，它可以在用户主目录下（全局配置），也可以在项目目录下（项目配置）。</p>
<pre><code># 显示当前的Git配置
$ git config --list

# 编辑Git配置文件
$ git config -e [--global]

# 设置提交代码时的用户信息
$ git config [--global] user.name &quot;[name]&quot;
$ git config [--global] user.email &quot;[email address]&quot;</code></pre><h2 id="增加-删除文件"><a href="#增加-删除文件" class="headerlink" title="增加/删除文件"></a>增加/删除文件</h2><pre><code># 添加指定文件到暂存区
$ git add [file1] [file2] ...

# 添加指定目录到暂存区，包括子目录
$ git add [dir]

# 添加当前目录的所有文件到暂存区
$ git add .

# 删除工作区文件，并且将这次删除放入暂存区
$ git rm [file1] [file2] ...

# 停止追踪指定文件，但该文件会保留在工作区
$ git rm --cached [file]

# 改名文件，并且将这个改名放入暂存区
$ git mv [file-original] [file-renamed]</code></pre><h2 id="代码提交"><a href="#代码提交" class="headerlink" title="代码提交"></a>代码提交</h2><pre><code># 提交暂存区到仓库区
$ git commit -m [message]

# 提交暂存区的指定文件到仓库区
$ git commit [file1] [file2] ... -m [message]

# 提交工作区自上次commit之后的变化，直接到仓库区
$ git commit -a

# 提交时显示所有diff信息
$ git commit -v

# 使用一次新的commit，替代上一次提交
# 如果代码没有任何新变化，则用来改写上一次commit的提交信息
$ git commit --amend -m [message]

# 重做上一次commit，并包括指定文件的新变化
$ git commit --amend [file1] [file2] ...</code></pre><h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><pre><code># 列出所有本地分支
$ git branch

# 列出所有远程分支
$ git branch -r

# 列出所有本地分支和远程分支
$ git branch -a

# 新建一个分支，但依然停留在当前分支
$ git branch [branch-name]

# 新建一个分支，并切换到该分支
$ git checkout -b [branch]

# 新建一个分支，指向指定commit
$ git branch [branch] [commit]

# 新建一个分支，与指定的远程分支建立追踪关系
$ git branch --track [branch] [remote-branch]

# 切换到指定分支，并更新工作区
$ git checkout [branch-name]

# 建立追踪关系，在现有分支与指定的远程分支之间
$ git branch --set-upstream [branch] [remote-branch]

# 合并指定分支到当前分支
$ git merge [branch]

# 选择一个commit，合并进当前分支
$ git cherry-pick [commit]

# 删除分支
$ git branch -d [branch-name]

# 删除远程分支
$ git push origin --delete [branch-name]
$ git branch -dr [remote/branch]</code></pre><h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><pre><code># 列出所有tag
$ git tag

# 新建一个tag在当前commit
$ git tag [tag]

# 新建一个tag在指定commit
$ git tag [tag] [commit]

# 删除本地tag
$ git tag -d [tag]

# 删除远程tag
$ git push origin :refs/tags/[tagName]

# 查看tag信息
$ git show [tag]

# 提交指定tag
$ git push [remote] [tag]

# 提交所有tag
$ git push [remote] --tags

# 新建一个分支，指向某个tag
$ git checkout -b [branch] [tag]</code></pre><h2 id="查看信息"><a href="#查看信息" class="headerlink" title="查看信息"></a>查看信息</h2><pre><code># 显示有变更的文件
$ git status

# 显示当前分支的版本历史
$ git log

# 显示commit历史，以及每次commit发生变更的文件
$ git log --stat

# 显示某个commit之后的所有变动，每个commit占据一行
$ git log [tag] HEAD --pretty=format:%s

# 显示某个commit之后的所有变动，其&quot;提交说明&quot;必须符合搜索条件
$ git log [tag] HEAD --grep feature

# 显示某个文件的版本历史，包括文件改名
$ git log --follow [file]
$ git whatchanged [file]

# 显示指定文件相关的每一次diff
$ git log -p [file]

# 显示指定文件是什么人在什么时间修改过
$ git blame [file]

# 显示暂存区和工作区的差异
$ git diff

# 显示暂存区和上一个commit的差异
$ git diff --cached [file]

# 显示工作区与当前分支最新commit之间的差异
$ git diff HEAD

# 显示两次提交之间的差异
$ git diff [first-branch]...[second-branch]

# 显示某次提交的元数据和内容变化
$ git show [commit]

# 显示某次提交发生变化的文件
$ git show --name-only [commit]

# 显示某次提交时，某个文件的内容
$ git show [commit]:[filename]

# 显示当前分支的最近几次提交
$ git reflog</code></pre><h2 id="远程同步"><a href="#远程同步" class="headerlink" title="远程同步"></a>远程同步</h2><pre><code># 下载远程仓库的所有变动
$ git fetch [remote]

# 显示所有远程仓库
$ git remote -v

# 显示某个远程仓库的信息
$ git remote show [remote]

# 增加一个新的远程仓库，并命名
$ git remote add [shortname] [url]

# 取回远程仓库的变化，并与本地分支合并
$ git pull [remote] [branch]

# 上传本地指定分支到远程仓库
$ git push [remote] [branch]

# 强行推送当前分支到远程仓库，即使有冲突
$ git push [remote] --force

# 推送所有分支到远程仓库
$ git push [remote] --all</code></pre><h2 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h2><pre><code># 恢复暂存区的指定文件到工作区
$ git checkout [file]

# 恢复某个commit的指定文件到暂存区和工作区
$ git checkout [commit] [file]

# 恢复暂存区的所有文件到工作区
$ git checkout .

# 重置暂存区的指定文件，与上一次commit保持一致，但工作区不变
$ git reset [file]

# 重置暂存区与工作区，与上一次commit保持一致
$ git reset --hard

# 重置当前分支的指针为指定commit，同时重置暂存区，但工作区不变
$ git reset [commit]

# 重置当前分支的HEAD为指定commit，同时重置暂存区和工作区，与指定commit一致
$ git reset --hard [commit]

# 重置当前HEAD为指定commit，但保持暂存区和工作区不变
$ git reset --keep [commit]

# 新建一个commit，用来撤销指定commit
# 后者的所有变化都将被前者抵消，并且应用到当前分支
$ git revert [commit]</code></pre><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><pre><code># 生成一个可供发布的压缩包
$ git archive</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/23/how-to-use-git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/02/23/how-to-use-git/" class="post-title-link" itemprop="url">Git 使用规范流程[转载]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-24T00:00:00+08:00">2016-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>toc<br>{:toc}</li>
</ul>
<p>作者： 阮一峰<br>日期： 2015年8月 5日<br><a href="http://www.ruanyifeng.com/blog/2015/08/git-use-process.html" target="_blank" rel="noopener">原文</a></p>
<p>团队开发中，遵循一个合理、清晰的Git使用流程，是非常重要的。<br>否则，每个人都提交一堆杂乱无章的commit，项目很快就会变得难以协调和维护。<br>下面是<a href="https://github.com/thoughtbot/guides/tree/master/protocol/git" target="_blank" rel="noopener">ThoughtBot</a> 的Git使用规范流程。<br>我从中学到了很多，推荐你也这样使用Git。</p>
<p><img src="/images/git/git_process.png" alt="Git Process" title="git process"></p>
<h2 id="第一步：新建分支"><a href="#第一步：新建分支" class="headerlink" title="第一步：新建分支"></a>第一步：新建分支</h2><p>首先，每次开发新功能，都应该新建一个单独的分支（这方面可以参考<a href="http://www.ruanyifeng.com/blog/2012/07/git.html" target="_blank" rel="noopener">《Git分支管理策略》</a>）。</p>
<pre><code># 获取主干最新代码
$ git checkout master
$ git pull

# 新建一个开发分支myfeature
$ git checkout -b myfeature</code></pre><h2 id="第二步：提交分支commit"><a href="#第二步：提交分支commit" class="headerlink" title="第二步：提交分支commit"></a>第二步：提交分支commit</h2><p>分支修改后，就可以提交commit了。</p>
<pre><code>$ git add --all
$ git status
$ git commit --verbose</code></pre><p>git add 命令的all参数，表示保存所有变化（包括新建、修改和删除）。<br>从Git 2.0开始，all是 git add 的默认参数，所以也可以用 git add . 代替。<br>git status 命令，用来查看发生变动的文件。<br>git commit 命令的verbose参数，会列出 diff 的结果。</p>
<h2 id="第三步：撰写提交信息"><a href="#第三步：撰写提交信息" class="headerlink" title="第三步：撰写提交信息"></a>第三步：撰写提交信息</h2><p>提交commit时，必须给出完整扼要的提交信息，下面是一个范本。</p>
<pre><code>Present-tense summary under 50 characters

* More information about commit (under 72 characters).
* More information about commit (under 72 characters).

http://project.management-system.com/ticket/123</code></pre><p>第一行是不超过50个字的提要，然后空一行，罗列出改动原因、主要变动、以及需要注意的问题。<br>最后，提供对应的网址（比如Bug ticket）。</p>
<h2 id="第四步：与主干同步"><a href="#第四步：与主干同步" class="headerlink" title="第四步：与主干同步"></a>第四步：与主干同步</h2><p>分支的开发过程中，要经常与主干保持同步。</p>
<pre><code>$ git fetch origin
$ git rebase origin/master</code></pre><h2 id="第五步：合并commit"><a href="#第五步：合并commit" class="headerlink" title="第五步：合并commit"></a>第五步：合并commit</h2><p>分支开发完成后，很可能有一堆commit，但是合并到主干的时候，往往希望只有一个（或最多两三个）commit，这样不仅清晰，也容易管理。<br>那么，怎样才能将多个commit合并呢？这就要用到 git rebase 命令。</p>
<pre><code>$ git rebase -i origin/master</code></pre><p>git rebase命令的i参数表示互动（interactive），这时git会打开一个互动界面，进行下一步操作。<br>下面采用<a href="https://robots.thoughtbot.com/git-interactive-rebase-squash-amend-rewriting-history" target="_blank" rel="noopener">Tute Costa</a> 的例子，来解释怎么合并commit。</p>
<pre><code>pick 07c5abd Introduce OpenPGP and teach basic usage
pick de9b1eb Fix PostChecker::Post#urls
pick 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend

# Rebase 8db7e8b..fa20af3 onto 8db7e8b
#
# Commands:
#  p, pick = use commit
#  r, reword = use commit, but edit the commit message
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#  f, fixup = like &quot;squash&quot;, but discard this commit&#39;s log message
#  x, exec = run command (the rest of the line) using shell
#
# These lines can be re-ordered; they are executed from top to bottom.
#
# If you remove a line here THAT COMMIT WILL BE LOST.
#
# However, if you remove everything, the rebase will be aborted.
#
# Note that empty commits are commented out</code></pre><p>上面的互动界面，先列出当前分支最新的4个commit（越下面越新）。<br>每个commit前面有一个操作命令，默认是pick，表示该行commit被选中，要进行rebase操作。<br>4个commit的下面是一大堆注释，列出可以使用的命令。</p>
<ul>
<li>pick：正常选中</li>
<li>reword：选中，并且修改提交信息；</li>
<li>edit：选中，rebase时会暂停，允许你修改这个commit（参考这里）</li>
<li>squash：选中，会将当前commit与上一个commit合并</li>
<li>fixup：与squash相同，但不会保存当前commit的提交信息</li>
<li>exec：执行其他shell命令</li>
</ul>
<p>上面这6个命令当中，squash和fixup可以用来合并commit。先把需要合并的commit前面的动词，改成squash（或者s）。</p>
<pre><code>pick 07c5abd Introduce OpenPGP and teach basic usage
s de9b1eb Fix PostChecker::Post#urls
s 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend</code></pre><p>这样一改，执行后，当前分支只会剩下两个commit。第二行和第三行的commit，都会合并到第一行的commit。<br>提交信息会同时包含，这三个commit的提交信息。</p>
<pre><code># This is a combination of 3 commits.
# The first commit&#39;s message is:
Introduce OpenPGP and teach basic usage

# This is the 2nd commit message:
Fix PostChecker::Post#urls

# This is the 3rd commit message:
Hey kids, stop all the highlighting</code></pre><p>如果将第三行的squash命令改成fixup命令。</p>
<pre><code>pick 07c5abd Introduce OpenPGP and teach basic usage
s de9b1eb Fix PostChecker::Post#urls
f 3e7ee36 Hey kids, stop all the highlighting
pick fa20af3 git interactive rebase, squash, amend</code></pre><p>运行结果相同，还是会生成两个commit，第二行和第三行的commit，都合并到第一行的commit。<br>但是，新的提交信息里面，第三行commit的提交信息，会被注释掉。</p>
<pre><code># This is a combination of 3 commits.
# The first commit&#39;s message is:
Introduce OpenPGP and teach basic usage

# This is the 2nd commit message:
Fix PostChecker::Post#urls

# This is the 3rd commit message:
# Hey kids, stop all the highlighting</code></pre><p>Pony Foo提出另外一种合并commit的简便方法，就是先撤销过去5个commit，然后再建一个新的。</p>
<pre><code>$ git reset HEAD~5
$ git add .
$ git commit -am &quot;Here&#39;s the bug fix that closes #28&quot;
$ git push --force</code></pre><p>squash和fixup命令，还可以当作命令行参数使用，自动合并commit。</p>
<pre><code>$ git commit --fixup  
$ git rebase -i --autosquash </code></pre><p>这个用法请参考<a href="http://fle.github.io/git-tip-keep-your-branch-clean-with-fixup-and-autosquash.html" target="_blank" rel="noopener">这篇文章</a>，这里就不解释了。</p>
<h2 id="第六步：推送到远程仓库"><a href="#第六步：推送到远程仓库" class="headerlink" title="第六步：推送到远程仓库"></a>第六步：推送到远程仓库</h2><p>合并commit后，就可以推送当前分支到远程仓库了。</p>
<pre><code>$ git push --force origin myfeature</code></pre><p>git push命令要加上force参数，因为rebase以后，分支历史改变了，跟远程分支不一定兼容，有可能要强行推送（<a href="http://willi.am/blog/2014/08/12/the-dark-side-of-the-force-push/" target="_blank" rel="noopener">参见这里</a>）。</p>
<h2 id="第七步：发出Pull-Request"><a href="#第七步：发出Pull-Request" class="headerlink" title="第七步：发出Pull Request"></a>第七步：发出Pull Request</h2><p>提交到远程仓库以后，就可以发出 Pull Request 到master分支，然后请求别人进行代码review，确认可以合并到master。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/23/git-workflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2016/02/23/git-workflow/" class="post-title-link" itemprop="url">Git 工作流程[转载]</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-02-24 00:00:00" itemprop="dateCreated datePublished" datetime="2016-02-24T00:00:00+08:00">2016-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Git/" itemprop="url" rel="index">
                    <span itemprop="name">Git</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<p>作者： 阮一峰<br>日期： 2015年12月24日<br><a href="http://www.ruanyifeng.com/blog/2015/12/git-workflow.html" target="_blank" rel="noopener">原文</a></p>
<p>Git 作为一个源码管理系统，不可避免涉及到多人协作。<br>协作必须有一个规范的工作流程，让大家有效地合作，使得项目井井有条地发展下去。<br>“工作流程”在英语里，叫做”workflow”或者”flow”，原意是水流，比喻项目像水流那样，顺畅、自然地向前流动，不会发生冲击、对撞、甚至漩涡。</p>
<p><img src="/images/git/git_workflow.png" alt="Git Workflow" title="git workflow"></p>
<p>本文介绍三种广泛使用的工作流程：</p>
<ul>
<li><strong>Git flow</strong></li>
<li><strong>Github flow</strong></li>
<li><strong>Gitlab flow</strong></li>
</ul>
<p>如果你对Git还不是很熟悉，可以先阅读下面的文章。</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2015/08/git-use-process.html" target="_blank" rel="noopener">《Git 使用规范流程》</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2015/12/git-cheat-sheet.html" target="_blank" rel="noopener">《常用 Git 命令清单》</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2014/06/git_remote.html" target="_blank" rel="noopener">《Git 远程操作详解》</a></li>
</ul>
<h2 id="功能驱动"><a href="#功能驱动" class="headerlink" title="功能驱动"></a>功能驱动</h2><p>本文的三种工作流程，有一个共同点：都采用<a href="https://en.wikipedia.org/wiki/Feature-driven_development" target="_blank" rel="noopener">“功能驱动式开发”</a>（Feature-driven development，简称FDD）。</p>
<p>它指的是，需求是开发的起点，先有需求再有功能分支（feature branch）或者补丁分支（hotfix branch）。<br>完成开发后，该分支就合并到主分支，然后被删除。</p>
<h2 id="Git-flow"><a href="#Git-flow" class="headerlink" title="Git flow"></a>Git flow</h2><p>最早诞生、并得到广泛采用的一种工作流程，就是Git flow 。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>它最主要的特点有两个。</p>
<p><img src="/images/git/gitflow.png" alt="gitflow" title="gitflow"></p>
<p>首先，项目存在两个长期分支。</p>
<ul>
<li><strong>主分支master</strong></li>
<li><strong>开发分支develop</strong></li>
</ul>
<p>前者用于存放对外发布的版本，任何时候在这个分支拿到的，都是稳定的分布版；后者用于日常开发，存放最新的开发版。</p>
<p>其次，项目存在三种短期分支。</p>
<ul>
<li><strong>功能分支（feature branch）</strong></li>
<li><strong>补丁分支（hotfix branch）</strong></li>
<li><strong>预发分支（release branch）</strong></li>
</ul>
<p>一旦完成开发，它们就会被合并进develop或master，然后被删除。<br>Git flow 的详细介绍，请阅读我翻译的中文版<a href="http://www.ruanyifeng.com/blog/2012/07/git.html" target="_blank" rel="noopener">《Git 分支管理策略》</a>。</p>
<h3 id="评价"><a href="#评价" class="headerlink" title="评价"></a>评价</h3><p>Git flow的优点是清晰可控，缺点是相对复杂，需要同时维护两个长期分支。<br>大多数工具都将master当作默认分支，可是开发是在develop分支进行的，这导致经常要切换分支，非常烦人。<br>更大问题在于，这个模式是基于”版本发布”的，目标是一段时间以后产出一个新版本。<br>但是，很多网站项目是”持续发布”，代码一有变动，就部署一次。<br>这时，master分支和develop分支的差别不大，没必要维护两个长期分支。</p>
<h2 id="Github-flow"><a href="#Github-flow" class="headerlink" title="Github flow"></a>Github flow</h2><p>Github flow 是Git flow的简化版，专门配合”持续发布”。它是 Github.com 使用的工作流程。</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>它只有一个长期分支，就是master，因此用起来非常简单。<br>官方推荐的<a href="https://guides.github.com/introduction/flow/index.html" target="_blank" rel="noopener">流程</a>如下。</p>
<p><img src="/images/git/github_flow.png" alt="github flow" title="github flow"></p>
<ol>
<li>根据需求，从master拉出新分支，不区分功能分支或补丁分支。</li>
<li>新分支开发完成后，或者需要讨论的时候，就向master发起一个<a href="https://help.github.com/articles/using-pull-requests/" target="_blank" rel="noopener">pull request</a>（简称PR）。</li>
<li>Pull Request既是一个通知，让别人注意到你的请求，又是一种对话机制，大家一起评审和讨论你的代码。对话过程中，你还可以不断提交代码。</li>
<li>你的Pull Request被接受，合并进master，重新部署后，原来你拉出来的那个分支就被删除。（先部署再合并也可。）</li>
</ol>
<h3 id="评价-1"><a href="#评价-1" class="headerlink" title="评价"></a>评价</h3><p>Github flow 的最大优点就是简单，对于”持续发布”的产品，可以说是最合适的流程。<br>问题在于它的假设：master分支的更新与产品的发布是一致的。也就是说，master分支的最新代码，默认就是当前的线上代码。<br>可是，有些时候并非如此，代码合并进入master分支，并不代表它就能立刻发布。<br>比如，苹果商店的APP提交审核以后，等一段时间才能上架。<br>这时，如果还有新的代码提交，master分支就会与刚发布的版本不一致。<br>另一个例子是，有些公司有发布窗口，只有指定时间才能发布，这也会导致线上版本落后于master分支。<br>上面这种情况，只有master一个主分支就不够用了。<br>通常，你不得不在master分支以外，另外新建一个production分支跟踪线上版本。</p>
<h2 id="Gitlab-flow"><a href="#Gitlab-flow" class="headerlink" title="Gitlab flow"></a>Gitlab flow</h2><p>Gitlab flow 是 Git flow 与 Github flow 的综合。<br>它吸取了两者的优点，既有适应不同开发环境的弹性，又有单一主分支的简单和便利。<br>它是 Gitlab.com 推荐的做法。</p>
<h3 id="上游优先"><a href="#上游优先" class="headerlink" title="上游优先"></a>上游优先</h3><p>Gitlab flow 的最大原则叫做”上游优先”（upsteam first），即只存在一个主分支master，它是所有其他分支的”上游”。<br>只有上游分支采纳的代码变化，才能应用到其他分支。</p>
<p><a href="https://www.chromium.org/chromium-os/chromiumos-design-docs/upstream-first" target="_blank" rel="noopener">Chromium项目</a>就是一个例子，<br>它明确规定，上游分支依次为：</p>
<ul>
<li><strong>Linus Torvalds的分支</strong></li>
<li><strong>子系统（比如netdev）的分支</strong></li>
<li><strong>设备厂商（比如三星）的分支</strong></li>
</ul>
<h3 id="持续发布"><a href="#持续发布" class="headerlink" title="持续发布"></a>持续发布</h3><p>Gitlab flow 分成两种情况，适应不同的开发流程。</p>
<p><img src="/images/git/gitlab_flow1.png" alt="gitlab flow" title="gitlab flow"></p>
<p>对于”持续发布”的项目，它建议在master分支以外，再建立不同的环境分支。<br>比如，”开发环境”的分支是master，”预发环境”的分支是pre-production，”生产环境”的分支是production。</p>
<p>开发分支是预发分支的”上游”，预发分支又是生产分支的”上游”。<br>代码的变化，必须由”上游”向”下游”发展。<br>比如，生产环境出现了bug，这时就要新建一个功能分支，先把它合并到master，确认没有问题，<br>再cherry-pick到pre-production，这一步也没有问题，才进入production。<br>只有紧急情况，才允许跳过上游，直接合并到下游分支。</p>
<h3 id="版本发布"><a href="#版本发布" class="headerlink" title="版本发布"></a>版本发布</h3><p><img src="/images/git/gitlab_release.png" alt="gitlab release" title="gitlab release"></p>
<p>对于”版本发布”的项目，建议的做法是每一个稳定版本，都要从master分支拉出一个分支，比如2-3-stable、2-4-stable等等。<br>以后，只有修补bug，才允许将代码合并到这些分支，并且此时要更新小版本号。</p>
<h2 id="一些小技巧"><a href="#一些小技巧" class="headerlink" title="一些小技巧"></a>一些小技巧</h2><h3 id="Pull-Request"><a href="#Pull-Request" class="headerlink" title="Pull Request"></a>Pull Request</h3><p><img src="/images/git/merge.png" alt="merge" title="merge"></p>
<p>功能分支合并进master分支，必须通过Pull Request（Gitlab里面叫做 Merge Request）。</p>
<p><img src="/images/git/request.png" alt="request" title="request"></p>
<p>前面说过，Pull Request本质是一种对话机制，你可以在提交的时候，<br>@相关<a href="https://github.com/blog/1004-mention-autocompletion" target="_blank" rel="noopener">人员</a>或<a href="https://github.com/blog/1121-introducing-team-mentions" target="_blank" rel="noopener">团队</a>，引起他们的注意。</p>
<h3 id="Protected-branch"><a href="#Protected-branch" class="headerlink" title="Protected branch"></a>Protected branch</h3><p>master分支应该受到保护，不是每个人都可以修改这个分支，以及拥有审批 Pull Request 的权力。</p>
<p><a href="https://help.github.com/articles/about-protected-branches/" target="_blank" rel="noopener">Github</a><br>和 <a href="http://doc.gitlab.com/ce/permissions/permissions.html" target="_blank" rel="noopener">Gitlab</a> 都提供”保护分支”（Protected branch）这个功能。</p>
<h3 id="Issue"><a href="#Issue" class="headerlink" title="Issue"></a>Issue</h3><p>Issue 用于 Bug追踪和需求管理。建议先新建 Issue，再新建对应的功能分支。功能分支总是为了解决一个或多个 Issue。<br>功能分支的名称，可以与issue的名字保持一致，并且以issue的编号起首，比如”15-require-a-password-to-change-it”。</p>
<p>开发完成后，在提交说明里面，可以写上”fixes #14”或者”closes #67”。<br>Github规定，只要commit message里面有下面这些<a href="https://help.github.com/articles/closing-issues-via-commit-messages/" target="_blank" rel="noopener">动词</a> + 编号，<br>就会关闭对应的issue。</p>
<ul>
<li>close</li>
<li>closes</li>
<li>closed</li>
<li>fix</li>
<li>fixes</li>
<li>fixed</li>
<li>resolve</li>
<li>resolves</li>
<li>resolved</li>
</ul>
<p>这种方式还可以一次关闭多个issue，或者关闭其他代码库的issue，格式是username/repository#issue_number。<br>Pull Request被接受以后，issue关闭，原始分支就应该删除。如果以后该issue重新打开，新分支可以复用原来的名字。</p>
<h3 id="Merge节点"><a href="#Merge节点" class="headerlink" title="Merge节点"></a>Merge节点</h3><p>Git有两种合并：一种是”直进式合并”（fast forward），不生成单独的合并节点；<br>另一种是”非直进式合并”（none fast-forword），会生成单独节点。</p>
<p>前者不利于保持commit信息的清晰，也不利于以后的回滚，建议总是采用后者（即使用–no-ff参数）。<br>只要发生合并，就要有一个单独的合并节点。</p>
<h3 id="Squash-多个commit"><a href="#Squash-多个commit" class="headerlink" title="Squash 多个commit"></a>Squash 多个commit</h3><p>为了便于他人阅读你的提交，也便于cherry-pick或撤销代码变化，在发起Pull Request之前，应该把多个commit合并成一个。<br>（前提是，该分支只有你一个人开发，且没有跟master合并过。）</p>
<p>这可以采用rebase命令附带的squash操作，具体方法请参考我写的<a href="http://www.ruanyifeng.com/blog/2015/08/git-use-process.html" target="_blank" rel="noopener">《Git 使用规范流程》</a>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/03/linux-modules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/03/linux-modules/" class="post-title-link" itemprop="url">Linux Modules分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-04 00:00:00" itemprop="dateCreated datePublished" datetime="2015-12-04T00:00:00+08:00">2015-12-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h3><p>源码：</p>
<pre><code>#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;

static int __init hello_init(void)
{
    printk(&quot;Hello, world!\n&quot;);
    return 0;
}

static void __exit hello_exit(void)
{
    printk(&quot;Goodbye, world!\n&quot;);
}

module_init(hello_init);
module_exit(hello_exit);

MODULE_LICENSE(&quot;GPL&quot;);
MODULE_AUTHOR(&quot;printk&quot;);
MODULE_DESCRIPTION(&quot;\&quot;Hello, world!\&quot;&quot;);
MODULE_VERSION(&quot;printk&quot;);     </code></pre><p>使用的交叉编译，Makefile：</p>
<pre><code>ARCH=xxx
CROSS_COMPILE=$(ARCH)-linux-
obj-m := printk.o

KDIR := /home/workspace/kernel/2.6.27.55
PWD   := $(shell pwd)

default:
    $(MAKE) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) -C $(KDIR) M=$(PWD) modules

clean:
    $(MAKE) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) -C $(KDIR) M=$(PWD) clean    </code></pre><p><strong>obj-m := printk.o 是kbuild Makefile中的目标定义部分</strong>，同时目标定义部分也是kbuild Makefile的重要组成部分。<br>该例子告诉Kbuild在这目录里，有一个名为printk.o的目标文件。<br>将会编译成一个可加载的模块而不是直接编译进内核</p>
<h3 id="makefiles-txt"><a href="#makefiles-txt" class="headerlink" title="makefiles.txt"></a><strong>makefiles.txt</strong></h3><p>根据Linux内核文档<strong>makefiles.txt</strong>的说明：</p>
<ol>
<li><strong>obj-y Built-in object goals 对应内核配置[Y]</strong></li>
<li><strong>obj-m Loadable module goals 对应内核配置[M]</strong></li>
</ol>
<p>obj-m由单个文件构成，其中$(CONFIG_ISDN_PPP_BSDCOMP)为配置系统配置为‘m’，示例：</p>
<pre><code>obj-$(CONFIG_ISDN_PPP_BSDCOMP) += isdn_bsdcomp.o</code></pre><p>obj-m由多个文件构成，其中$(CONFIG_ISDN)为配置系统配置为‘m’，示例：</p>
<pre><code>obj-$(CONFIG_ISDN) += isdn.o
isdn-objs := isdn_net_lib.o isdn_v110.o isdn_common.o</code></pre><p>如果.config中存在以下配置<code>CONFIG_SCSI=y</code>，那么drivers/Makefile中存在以下配置<code>obj-$(CONFIG_SCSI) += scsi/</code>，示例：</p>
<pre><code>obj-y               += base/ block/ misc/ mfd/ net/ media/
obj-$(CONFIG_NUBUS)     += nubus/
obj-$(CONFIG_ATM)       += atm/
obj-y               += macintosh/
obj-$(CONFIG_IDE)       += ide/
obj-$(CONFIG_SCSI)      += scsi/                                                                                                    
obj-$(CONFIG_ATA)       += ata/
obj-$(CONFIG_FUSION)        += message/</code></pre><p><strong>当将模块配置为build-in时，即表示要将这些代码的相关目录放入编译目录中！</strong></p>
<h3 id="Linux-Makefile"><a href="#Linux-Makefile" class="headerlink" title="Linux Makefile"></a><strong>Linux Makefile</strong></h3><p>Kernel/Documentation/kbuild/makefiles.txt 中描述Linux Makefile包含五部分：</p>
<ol>
<li>Makefile        the top Makefile.</li>
<li>.config         the kernel configuration file.                                                                                 </li>
<li>arch/$(ARCH)/Makefile   the arch Makefile.</li>
<li>scripts/Makefile.*  common rules etc. for all kbuild Makefiles.</li>
<li>kbuild Makefiles    there are about 500 of these.</li>
</ol>
<p>各个部分的作用：</p>
<ol>
<li>顶层Makefile读取.config内核配置文件，顶层Makefile负责编译两个主要的镜像文件：vmlinux（驻留内核镜像）和 内核模块，<br>它通过递归便利内核源码树的子目录来编译这些目标文件，访问的子目录列表取决于内核的配置。</li>
<li>.config内核配置文件</li>
<li>顶层Makefile还会包含arch/$(ARCH)/Makefile，这些平台Makefile向顶层Makefile提供架构特性信息</li>
<li>每一个子目录下有一个kbulid Makefile会展开从上面传下来的命令，<br>kbulid Makefile利用来自.config的配置信息通过kbulid构建各种不同的文件编译内置或是模块可加载的目标</li>
<li>scripts/Makefile.* 包含了所有的定义、规则等等，他们在kbulid makefiles的基础上构建内核</li>
</ol>
<h3 id="Makefile-modpost"><a href="#Makefile-modpost" class="headerlink" title="Makefile.modpost"></a><strong>Makefile.modpost</strong></h3><p>在script目录下有许多Makefile文件，由于各种情况；其中，Makefile.modpost由于module的生成。</p>
<p>第一步：</p>
<ol>
<li>编译驱动的每个.o文件。</li>
<li>将每个.o文件链接到.o。</li>
<li>在$(MODVERDIR)/生成一个.mod文件，列出.ko及每个.o文件。</li>
</ol>
<p>第二步：</p>
<ol>
<li>找出所有在$(MODVERDIR)/的modules。</li>
<li>接着使用modpost</li>
<li>为每个module创建.mod.c</li>
<li>创建一个Module.symvers文件，保存了所有引出符号及其CRC校验。</li>
<li>编译全部 .mod.c文件。</li>
<li>链接所有的module成为一个文件。</li>
</ol>
<p>第三步：替换module里一些ELF段，包括：</p>
<p>Version magic (see include/vermagic.h for full details)</p>
<ul>
<li>Kernel release</li>
<li>SMP is CONFIG_SMP</li>
<li>PREEMPT is CONFIG_PREEMPT</li>
<li>GCC Version</li>
</ul>
<p>Module info</p>
<ul>
<li>Module version (MODULE_VERSION)</li>
<li>Module alias’es (MODULE_ALIAS)</li>
<li>Module license (MODULE_LICENSE)</li>
<li>See include/linux/module.h for more details</li>
</ul>
<p>第四步：</p>
<p>Step 4 is solely used to allow module versioning in external modules,<br>where the CRC of each module is retrieved from the Module.symers file.<br>KBUILD_MODPOST_WARN can be set to avoid error out in case of undefined<br>symbols in the final module linking stage<br>KBUILD_MODPOST_NOFINAL can be set to skip the final link of modules.<br>This is solely usefull to speed up test compiles</p>
<h3 id="编译及结果"><a href="#编译及结果" class="headerlink" title="编译及结果"></a><strong>编译及结果</strong></h3><p>源码结构：</p>
<pre><code>.
├── hello_printk.c
└── Makefile</code></pre><p>编译过程：</p>
<pre><code>make ARCH=xxx CROSS_COMPILE=xxx-linux- -C /home/workspace/kernel/2.6.27.55 M=/data/linux_drivers/hello_printk modules
make[1]: Entering directory &#39;/home/workspace/kernel/2.6.27.55&#39;
CC [M]  /data/linux_drivers/hello_printk/hello_printk.o
Building modules, stage 2.
MODPOST 1 modules
CC      /data/linux_drivers/hello_printk/hello_printk.mod.o
LD [M]  /data/linux_drivers/hello_printk/hello_printk.ko
make[1]: Leaving directory &#39;/home/workspace/kernel/2.6.27.55&#39;</code></pre><p>结构：</p>
<pre><code>.
├── hello_printk.c
├── hello_printk.ko
├── .hello_printk.ko.cmd
├── hello_printk.mod.c
├── hello_printk.mod.o
├── .hello_printk.mod.o.cmd
├── hello_printk.o
├── .hello_printk.o.cmd
├── Makefile
├── modules.order
├── Module.symvers
└── .tmp_versions
    └── hello_printk.mod</code></pre><p>其中生成<code>&lt;module&gt;.mod.c</code>文件， 内容如下：</p>
<pre><code>#include &lt;linux/module.h&gt;
#include &lt;linux/vermagic.h&gt;
#include &lt;linux/compiler.h&gt;

MODULE_INFO(vermagic, VERMAGIC_STRING);

struct module __this_module
__attribute__((section(&quot;.gnu.linkonce.this_module&quot;))) = {
    .name = KBUILD_MODNAME,
    .init = init_module,
#ifdef CONFIG_MODULE_UNLOAD
    .exit = cleanup_module,
#endif                                                                                                                              
    .arch = MODULE_ARCH_INIT,
};



static const char __module_depends[]
__used
__attribute__((section(&quot;.modinfo&quot;))) =
&quot;depends=&quot;;


MODULE_INFO(srcversion, &quot;D9CAF6BFCBD9B121FB4765D&quot;);</code></pre><p><strong>其实就是在生成的文件里加入<code>.gnu.linkonce.this_module</code>这样一个段，<br>驱动加裁时会找到这个段并调用<code>.init</code>函数，卸载时调用<code>.exit</code>函数。</strong></p>
<p>定义一个module结构类型的变量<code>struct module __this_module</code>，<br>这个变量是放在ELF文件的段名为<code>.gnu.linkonce.this_module</code>的段中，通过readelf工具也可以看到相关的段：</p>
<pre><code>$ readelf -S hello_printk.mod.o
共有 11 个节头，从偏移量 0x218 开始：

节头：
    [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
    [ 0]                   NULL            00000000 000000 000000 00      0   0  0
    [ 1] .text             PROGBITS        00000000 000034 000000 00  AX  0   0  1
    [ 2] .data             PROGBITS        00000000 000034 000000 00  WA  0   0  1
    [ 3] .bss              NOBITS          00000000 000034 000000 00  WA  0   0  1
    [ 4] .gnu.linkonce.thi PROGBITS        00000000 000034 0000f4 00  WA  0   0  4
    [ 5] .rela.gnu.linkonc RELA            00000000 000524 000018 0c      9   4  4
    [ 6] .modinfo          PROGBITS        00000000 000128 00004f 00   A  0   0  4
    [ 7] .comment          PROGBITS        00000000 000177 000043 01  MS  0   0  1
    [ 8] .shstrtab         STRTAB          00000000 0001ba 00005d 00      0   0  1
    [ 9] .symtab           SYMTAB          00000000 0003d0 0000e0 10     10  11  4
    [10] .strtab           STRTAB          00000000 0004b0 000071 00      0   0  1
Key to Flags:
    W (write), A (alloc), X (execute), M (merge), S (strings)
    I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
    O (extra OS processing required) o (OS specific), p (processor specific)</code></pre><p>最后将<strong><code>hello_printk.mod.o</code></strong>和<strong><code>hello_printk.o</code></strong>链接为ko，ko符号表如下：</p>
<pre><code>nm hello_printk.ko
00000000 T cleanup_module
00000000 t hello_exit
00000000 t hello_init
00000000 T init_module
0000003c r __mod_author59
00000010 r __mod_description60
00000060 r __mod_license58
0000006c r __mod_srcversion23
00000090 r __module_depends
0000009c r __mod_vermagic5
00000000 r __mod_version61
U printk
00000000 D __this_module</code></pre><p>module中可以使用的符号表为<strong><code>cleanup_module</code></strong>和<strong><code>init_module</code></strong>，其他为局部符号，对外不可见。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/12/02/linux-device_drivers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/02/linux-device_drivers/" class="post-title-link" itemprop="url">Linux设备驱动程序基础</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-03 00:00:00" itemprop="dateCreated datePublished" datetime="2015-12-03T00:00:00+08:00">2015-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>8.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="Linux设备驱动程序示例"><a href="#Linux设备驱动程序示例" class="headerlink" title="Linux设备驱动程序示例"></a>Linux设备驱动程序示例</h2><p>源代码：</p>
<pre><code>#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/proc_fs.h&gt;
#include &lt;linux/init.h&gt;
#include &lt;linux/vmalloc.h&gt;

static int num = 1;                                                                                                                 
static char *mode = &quot;show&quot;;

static int __init hello_module_init(void)
{
    printk(&quot;Hello,world\n&quot;);
}

static void __exit hello_module_exit(void)
{
    printk(&quot;Good Bye\n&quot;);
}

module_init(hello_module_init);
module_exit(hello_module_exit);
module_param(mode, charp, S_IRUGO);
module_param(num, int, S_IRUGO);

MODULE_DESCRIPTION(&quot;driver for the Hello World.&quot;);
MODULE_AUTHOR(&quot;Hello&quot;);
MODULE_LICENSE(&quot;GPL&quot;);</code></pre><p>Makefile：</p>
<pre><code>obj-m += hello.o    #设置模块名
hello-objs := bsp_hello.o hello_mod_linux.o

all:
    $(MAKE) ARCH=$(ARCH) CROSS_COMPILE=$(CROSS_COMPILE) -C $(KERNEL_PATH) SUBDIRS=`pwd`

clean:
    rm -rf *.ko *.o *.mod.c .tmp_versions Module.symvers modules.order .tmp_versions
    find ../ -name &quot;*.cmd&quot; -delete

install:
    cp $(HELLO_TARGET) $(OUTDIR) -f</code></pre><p><strong>Tips:obj-m += (module name).o</strong></p>
<h2 id="相关宏定义"><a href="#相关宏定义" class="headerlink" title="相关宏定义"></a>相关宏定义</h2><p>Linux设备驱动编译时，如果<strong>MODULE</strong>未定义，表明设备驱动是<strong>build-in</strong>模式。<br>相应的<strong>module_init/module_exit</strong>宏定义展开不同。</p>
<p>linux对只需要初始化运行一次的函数都加上<strong>init属性，<br>__init 宏告诉编译器如果这个模块被编译到内核则把这个函数放到（.init.text）段，<br>module_exit的参数卸载时同</strong>init类似，如果驱动被编译进内核，<br>则<strong>exit宏会忽略清理函数，因为编译进内核的模块不需要做清理工作，<br>**显然</strong>init和__exit对动态加载的模块是无效的，只支持完全编译进内核**。</p>
<p>在kernel初始化后期，释放所有这些函数代码所占的内存空间。<br>连接器把带__init属性的函数放在同一个section里，在用完以后，把整个section释放掉。<br>当函数初始化完成后这个区域可以被清除掉以节约系统内存。<br>Kenrel启动时看到的消息“Freeing unused kernel memory: xxxk freed”同它有关。</p>
<p>start_kernel-&gt;rest_init-&gt;kernel_init-&gt;init_post-&gt;free_initmem()来释放初始化代码和数据。</p>
<h3 id="特殊宏定义"><a href="#特殊宏定义" class="headerlink" title="特殊宏定义"></a>特殊宏定义</h3><ul>
<li>MODULE_LICENSE(license)           代码使用的许可证</li>
<li>MODULE_AUTHOR(author)             描述模块作者</li>
<li>MODULE_DESCRIPTION(description)   说明模块用途的简短描述</li>
<li>MODULE_VERSION(version_string)    代码修订号</li>
<li>MODULE_DEVICE_TABLE(table_info)   告诉用户空间模块所支持的设备</li>
<li>MODULE_ALIAS(alternate_name)      模块的别名</li>
</ul>
<h3 id="加载函数宏定义module-init"><a href="#加载函数宏定义module-init" class="headerlink" title="加载函数宏定义module_init()"></a>加载函数宏定义<strong>module_init()</strong></h3><p>module_init定义如下：</p>
<pre><code>include/linux/init.h
#ifndef MODULE
/**
 * module_init() - driver initialization entry point
 * @x: function to be run at kernel boot time or module insertion
 * 
 * module_init() will either be called during do_initcalls() (if
 * builtin) or at module insertion time (if a module).  There can only
 * be one per module.
 */
#define module_init(x)  __initcall(x);
#else /* MODULE */
/* Each module must use one module_init(). */
#define module_init(initfn)                     \
    static inline initcall_t __inittest(void)   \
    { return initfn;  }                         \                                                                                           
    int init_module(void) __attribute__((alias(#initfn)));
#endif</code></pre><h4 id="build-in分支"><a href="#build-in分支" class="headerlink" title="build-in分支"></a><strong>build-in分支</strong></h4><pre><code>#define __initcall(fn) device_initcall(fn)
#define device_initcall(fn)     __define_initcall(&quot;6&quot;,fn,6)
#define __define_initcall(level,fn,id) \                                                                                            
    static initcall_t __initcall_##fn##id __used \
    __attribute__((__section__(&quot;.initcall&quot; level &quot;.init&quot;))) = fn</code></pre><p>因此使用module_init修饰的hello_module_init最终展开为：</p>
<pre><code>static initcall_t  __initcall_hello_module_init6 __used __attribute__((__section__(&quot;.initcall6.init&quot;))) = hello_module_init;</code></pre><p>就是声明一类型为<strong>initcall_t（typedef int (*initcall_t)(void)）</strong>函数指针类型的变量<br><strong>__initcall_hello_module_init6</strong>并将<strong>hello_module_init</strong>赋值与它。</p>
<p>其中<strong><strong>attribute</strong>((<strong>section</strong>(“.initcall6.init”)))</strong>表明变量<strong>__initcall_hello_module_init6</strong>放入section .initcall6.init中。</p>
<p>在文件<strong>vmlinux.lds</strong>中有以下定义：</p>
<pre><code>.initcall.init : AT(ADDR(.initcall.init) - 0) {                                                                                    
 __initcall_start = .;
 *(.initcallearly.init) __early_initcall_end = .; *(.initcall0.init) *(.initcall0s.init) *(.initcall1.init) 
                                                *(.initcall1s.init) *(.initcall2.init) *(.initcall2s.init) 
                                                *(.initcall3.init) *(.initcall3s.init) *(.initcall4.init) 
                                                *(.initcall4s.init) *(.initcall5.init) *(.initcall5s.init)
                                                *(.initcallrootfs.init) *(.initcall6.init) *(.initcall6s.init) 
                                                *(.initcall7.init) *(.initcall7s.init)
 __initcall_end = .;
}</code></pre><p><strong>启动顺序</strong></p>
<pre><code>init/main.c
start_kernel()-&gt;rest_init()-&gt;kernel_init()-&gt;do_basic_setup()-&gt;do_initcalls()

static void __init do_initcalls(void)
{ 
    initcall_t *call;

    for (call = __early_initcall_end; call &lt; __initcall_end; call++)
        do_one_initcall(*call);                                                                                                     

    /* Make sure there is no pending stuff from the initcall sequence */
    flush_scheduled_work();
} </code></pre><p>do_initcalls()将按顺序从由<strong>early_initcall_end开始，<br>到</strong>initcall_end结束的section中<strong>以函数指针的形式取出这些编译到内核的驱动模块中初始化函数起始地址</strong>，<br>来依次完成相应的初始化。</p>
<p>内核初始化函数do_basic_setup(): do_initcalls() 将从.initcall.init 中，<br>也就是这几个section中依次取出所有的函数指针，并调用这些函数指针所指向的函数，来完成内核的一些相关的初始化。</p>
<p><strong>内核的加载的时候，会搜索”.initcall”中的所有条目，并按优先级加载它们，普通驱动程序的优先级是6。<br>其它模块优先级列出如下：值越小，越先加载。</strong></p>
<h4 id="Module分支"><a href="#Module分支" class="headerlink" title="Module分支"></a><strong>Module分支</strong></h4><pre><code>/* Each module must use one module_init(). */
#define module_init(initfn)                     \
    static inline initcall_t __inittest(void)   \
    { return initfn;  }                         \                                                                                           
    int init_module(void) __attribute__((alias(#initfn)));

typedef int (*initcall_t)(void)</code></pre><p>其中</p>
<pre><code>typedef int (*initcall_t)(void)
#define module_init(initfn)                     \
    static inline initcall_t __inittest(void)   \
    { return initfn;  }                         \                                                                                           </code></pre><p>用于对传入的initfn进行类型检测，类型必须为 int (*initcall_t)(void) 的函数指针，然后通过alias将initfn变名为init_module：</p>
<pre><code>/* type newname __attribute__((alias(&quot;oldname&quot;))); */
int init_module(void) __attribute__((alias(#initfn)));</code></pre><p>当调用insmod和rmmod时，只与init_module和cleanup_module有关，insmod和rmmod中调用这两个函数。</p>
<pre><code>busybox/modutils/insmod.c:insmod_main()
rc = bb_init_module(filename, parse_cmdline_module_options(argv, /*quote_spaces:*/ 0));
.
busybox/modutils/modutils.c:bb_init_module()
init_module(image, image_size, options);
.
# define init_module(mod, len, opts) syscall(__NR_init_module, mod, len, opts)</code></pre><p>insmod最终会调用到 syscall <strong>__NR_init_module</strong>。</p>
<p>在Kernel中，各个arch下的文件unistd.h有如下定义：</p>
<pre><code>#define __NR_init_module        128
#define __NR_delete_module      129
#define __NR_get_kernel_syms    130
#define __NR_quotactl           131
#define __NR_getpgid            132</code></pre><p>然后，文件entry.S下有定义：</p>
<pre><code>.data
ALIGN
sys_call_table:
    .
    .
    .long sys_mprotect      /* 125 */
    .long sys_sigprocmask
    .long sys_ni_syscall    /* old &quot;create_module&quot; */
    .long sys_init_module
    .long sys_delete_module
    .long sys_ni_syscall    /* 130 - old &quot;get_kernel_syms&quot; */
    .long sys_quotactl
    .
    .</code></pre><p><strong>当insmod调用到系统调用号128时，sys_call_table中取出128地址的函数指针进行执行，及sys_init_module。</strong></p>
<p>现在来看系统调用<strong>sys_init_module</strong>：</p>
<pre><code>kernel/module.c
SYSCALL_DEFINE3(init_module, void __user *, umod, unsigned long, len, const char __user *, uargs)
.
#define SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)
#define SYSCALL_DEFINEx(x, name, ...)                   \                                                                           
    asmlinkage long sys##name(__SC_DECL##x(__VA_ARGS__))</code></pre><p>宏定义<strong>__SC_DECL##x</strong>作用是将参数之间的‘，’去掉，定义如下：</p>
<pre><code>#define __SC_DECL1(t1, a1)  t1 a1
#define __SC_DECL2(t2, a2, ...) t2 a2, __SC_DECL1(__VA_ARGS__)
#define __SC_DECL3(t3, a3, ...) t3 a3, __SC_DECL2(__VA_ARGS__)                                                                      
#define __SC_DECL4(t4, a4, ...) t4 a4, __SC_DECL3(__VA_ARGS__)
#define __SC_DECL5(t5, a5, ...) t5 a5, __SC_DECL4(__VA_ARGS__)
#define __SC_DECL6(t6, a6, ...) t6 a6, __SC_DECL5(__VA_ARGS__)</code></pre><p>宏定义中的‘##’为<strong>（token-pasting）符号连接操作符</strong>，全部展开之后为：</p>
<pre><code>asmlinkage long sys_init_module(void __user * umod, unsigned long len, const char __user * uargs)</code></pre><p>在文件<strong>include/linux/syscalls.h</strong>中可以看到所有的展开的系统调用，例如：</p>
<pre><code>asmlinkage long sys_init_module(void __user *umod, unsigned long len,                                                               
                const char __user *uargs);
asmlinkage long sys_delete_module(const char __user *name_user,
                unsigned int flags);

asmlinkage long sys_rt_sigprocmask(int how, sigset_t __user *set,
                sigset_t __user *oset, size_t sigsetsize);
asmlinkage long sys_rt_sigpending(sigset_t __user *set, size_t sigsetsize);
asmlinkage long sys_rt_sigtimedwait(const sigset_t __user *uthese,
                siginfo_t __user *uinfo,
                const struct timespec __user *uts,
                size_t sigsetsize);</code></pre><p>在系统调用<strong>sys_init_module</strong>中：</p>
<pre><code>.
mod = load_module(umod, len, uargs);  //主要过程都在这儿
.
.
/* Start the module */
if (mod-&gt;init != NULL)
    ret = do_one_initcall(mod-&gt;init);</code></pre><p>load_module做了绝大部分的工作，将驱动拷贝到内核，重定位等等，do_one_initcall调用module注册的init函数。</p>
<h3 id="卸载函数宏定义module-exit"><a href="#卸载函数宏定义module-exit" class="headerlink" title="卸载函数宏定义module_exit()"></a>卸载函数宏定义<strong>module_exit()</strong></h3><pre><code>#ifndef MODULE
/**
 * module_exit() - driver exit entry point
 * @x: function to be run when driver is removed
 * 
 * module_exit() will wrap the driver clean-up code
 * with cleanup_module() when used with rmmod when
 * the driver is a module.  If the driver is statically
 * compiled into the kernel, module_exit() has no effect.
 * There can only be one per module.
 */
#define module_exit(x)  __exitcall(x);
#else /* MODULE */
/* This is only required if you want to be unloadable. */
#define module_exit(exitfn)                 \
    static inline exitcall_t __exittest(void)       \
    { return exitfn;  }                  \
    void cleanup_module(void) __attribute__((alias(#exitfn)));
#endif</code></pre><h4 id="build-in"><a href="#build-in" class="headerlink" title="build-in"></a>build-in</h4><p>无效，没有意义</p>
<h4 id="module"><a href="#module" class="headerlink" title="module"></a>module</h4><p>busybox:</p>
<pre><code># define delete_module(mod, flags) syscall(__NR_delete_module, mod, flags)</code></pre><p>kernel:</p>
<pre><code>.long sys_delete_module
#define __NR_delete_module      129

SYSCALL_DEFINE2(delete_module, const char __user *, name_user, unsigned int, flags)
{
    .
    if (mod-&gt;exit != NULL)
        mod-&gt;exit();
    .
}

asmlinkage long sys_delete_module(const char __user *name_user, unsigned int flags);</code></pre><h3 id="模块传参宏定义module-param"><a href="#模块传参宏定义module-param" class="headerlink" title="模块传参宏定义module_param()"></a>模块传参宏定义<strong>module_param()</strong></h3><pre><code>include/linux/moduleparam.h
#define module_param(name, type, perm)              \                                                                               
    module_param_named(name, name, type, perm)</code></pre><p>用于向模块传递参数，其允许驱动程序声明参数，并且用户在系统启动或模块装载时为参数指定相应值，<br>在驱动程序里，参数的用法如同全局变量。</p>
<ul>
<li>name既是用户看到的参数名，又是模块内接受参数的变量;</li>
<li>type表示参数的数据类型，是下列之一：byte, short, ushort, int, uint, long, ulong, charp, bool, invbool;</li>
<li>perm指定了在sysfs中相应文件的访问权限。<br>访问权限与linux文件爱你访问权限相同的方式管理，如0644，或使用stat.h中的宏如S_IRUGO表示。0表示完全关闭在sysfs中相对应的项。</li>
</ul>
<p>这些宏不会声明变量，因此在使用宏之前，必须声明变量，典型地用法如下：</p>
<pre><code>static unsigned int int_var = 0;
module_param(int_var, uint, S_IRUGO);</code></pre><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ul>
<li>mod-&gt;exit()怎么调用到 <strong>alias 为 cleanup_module</strong>的函数</li>
<li>mod-&gt;init()怎么调用到 <strong>alias 为 init_module</strong>的函数</li>
</ul>
<p>接下来分析module具体组成</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/25/gdb-disassemble-debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/25/gdb-disassemble-debug/" class="post-title-link" itemprop="url">gdb反汇编调试</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-26T00:00:00+08:00">2015-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p><strong>重点命令</strong>：<strong>display /i $pc</strong></p>
<h2 id="gdb-命令"><a href="#gdb-命令" class="headerlink" title="gdb 命令"></a><strong>gdb 命令</strong></h2><ul>
<li>file &lt;文件名&gt;加载被调试的可执行程序文件。</li>
<li>r Run的简写，运行被调试的程序。</li>
<li>c Continue的简写，继续执行被调试程序， 直至下一个断点或程序结束。</li>
<li>b &lt;行号&gt;</li>
<li>b &lt;函数名称&gt;</li>
<li>b *&lt;函数名称&gt;</li>
<li>b *&lt;代码地址&gt;</li>
<li>b: Breakpoint的简写，设置断点。两可以使用“行号”“函数名称”“执行地址”等方式指定断点位置。<br>其中在函数名称前面加“*”符号表示将断点设置在“由编译器生成的prolog代码处”。</li>
<li>d [编号] Delete breakpoint的简写，删除指定编号的某个断点，或删除所有断点。断点编号从1开始递增。</li>
<li>s: 执行一行源程序代码，如果此行代码中有函数调用，则进入该函数；<br>s 相当于其它调试器中的“Step Into (单步跟踪进入)”；</li>
<li>n: 执行一行源程序代码，此行代码中的函数调用也一并执行。<br>n 相当于其它调试器中的“Step Over (单步跟踪)”。</li>
<li>si命令类似于s命令，ni命令类似于n命令。 所不同的是，这两个命令（si/ni）所针对的是汇编指令，而s/n针对的是源代码。</li>
<li>p &lt;变量名称&gt;Print的简写，显示指定变量（临时变量或全 局变量）的值。</li>
<li>display，设置程序中断后欲显示的数据及 其格式。<br>例如，<strong>如果希望每次程序中断后可以看到即将被执行的下一条汇编指令，可以使用命令<br>“display /i $pc”<br>其中 $pc 代表当前汇编指令，/i 表示以十六进行显示。当需要关心汇编代码时，此命令相当有用。</strong></li>
<li>undispaly，取消先前的display设 置，编号从1开始递增。</li>
<li>i Info的简写，用于显示各类信息，详情请查阅 “help i”。</li>
<li>q Quit的简写，退出GDB调试环境。</li>
<li>help [命令名称]GDB帮助命令，提供对GDB名种命令的解释说明。<br>如果指定了“命令名称”参数，则显示该命令的详细说明；如果没有指定参数，则分类显示所有GDB命令，供用户进一步浏览和查询。</li>
</ul>
<h2 id="反汇编调试"><a href="#反汇编调试" class="headerlink" title="反汇编调试"></a><strong>反汇编调试</strong></h2><p>　</p>
<h3 id="显示汇编命令-display-i-pc"><a href="#显示汇编命令-display-i-pc" class="headerlink" title="显示汇编命令 display /i $pc"></a><strong>显示汇编命令 display /i $pc</strong></h3><pre><code>(gdb) display /i $pc
(gdb) si
20 n++;
1: x/i $pc 0x8048363 &lt;main+23&gt;: lea 0xfffffffc(%ebp),%eax
(gdb) si
0x08048366 20 n++;
1: x/i $pc 0x8048366 &lt;main+26&gt;: incl (%eax)
(gdb) si
21 n--;
1: x/i $pc 0x8048368 &lt;main+28&gt;: lea 0xfffffffc(%ebp),%eax
(gdb) si
0x0804836b 21 n--;
1: x/i $pc 0x804836b &lt;main+31&gt;: decl (%eax)
(gdb) si
23 nGlobalVar += 100;
1: x/i $pc 0x804836d &lt;main+33&gt;: addl $0x64,0x80494fc</code></pre><p>　</p>
<h3 id="汇编断点设置"><a href="#汇编断点设置" class="headerlink" title="汇编断点设置"></a><strong>汇编断点设置</strong></h3><p>使用命令“b *main”在 main 函数的 prolog 代码处设置断点<br>（<strong>prolog、epilog，分别表示编译器在每个函数的开头和结尾自行插入的代码</strong>）：</p>
<pre><code>(gdb) b *main
Breakpoint 4 at 0x804834c: file gdb-sample.c, line 17.
(gdb) r
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /home/liigo/temp/test_jmp/test_jmp/gdb-sample

Breakpoint 4, main () at gdb-sample.c:17
17 {
1: x/i $pc 0x804834c &lt;main&gt;: push %ebp
(gdb) si
0x0804834d 17 {
1: x/i $pc 0x804834d &lt;main+1&gt;: mov %esp,%ebp
(gdb) si
0x0804834f in main () at gdb-sample.c:17
17 {
1: x/i $pc 0x804834f &lt;main+3&gt;: sub $0x8,%esp
(gdb) si
0x08048352 17 {
1: x/i $pc 0x8048352 &lt;main+6&gt;: and $0xfffffff0,%esp
(gdb) si
0x08048355 17 {
1: x/i $pc 0x8048355 &lt;main+9&gt;: mov $0x0,%eax
(gdb) si
0x0804835a 17 {
1: x/i $pc 0x804835a &lt;main+14&gt;: sub %eax,%esp
(gdb) si
19 n = 1;
1: x/i $pc 0x804835c &lt;main+16&gt;: movl $0x1,0xfffffffc(%ebp)</code></pre><p>此时可以使用“i r”命令显示寄存器中的当前值———“i r”即“Infomation Register”：</p>
<pre><code>(gdb) i r
eax 0xbffff6a4 -1073744220
ecx 0x42015554 1107383636
edx 0x40016bc8 1073834952
ebx 0x42130a14 1108544020
esp 0xbffff6a0 0xbffff6a0
ebp 0xbffff6a8 0xbffff6a8
esi 0x40015360 1073828704
edi 0x80483f0 134513648
eip 0x8048366 0x8048366
eflags 0x386 902
cs 0x23 35
ss 0x2b 43
ds 0x2b 43
es 0x2b 43
fs 0x0 0
gs 0x33 51
当然也可以显示任意一个指定的寄存器值：
(gdb) i r eax
eax 0xbffff6a4 -1073744220</code></pre><p>　<br>1.<a href="http://blog.csdn.net/winterttr/article/details/5537638" target="_blank" rel="noopener">gdb中汇编调试</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/18/deal-with-file-by-line/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/18/deal-with-file-by-line/" class="post-title-link" itemprop="url">逐行处理内存文本及正则表达式元字符列表</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-19 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-19T00:00:00+08:00">2015-11-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="文本内容"><a href="#文本内容" class="headerlink" title="文本内容"></a>文本内容</h2><pre><code>P:013.0:E:11054:H:27500:5DDC29D54BE4D7:F3381AD050DE3A
P:091.5:E:03960:H:29700:DAE69F8B6E0106:E0DE2F8903AE55
P:105.5:E:03960:H:27500:CEF7CE422FF89E:E42DB81767E02E
P:166.0:E:03760:V:27690:7199819B0CF04F:7EE0F00CFFBF66
P:138.0:E:03703:V:04444:AD5CDBA991505A:1E1376FD07FB13
P:166.0:E:03830:H:14000:956D98AD9E6E84:842F2801182286</code></pre><p>或者：</p>
<pre><code>B:042.0:E:11919:V:24444:00012:1000000000000000:TRT3
B:042.0:E:11954:A:08800:00001:1111110011111800:EINTERCOM
B:042.0:E:11953:A:02980:00001:1212123312121233:
B:042.0:E:11996:V:27500:00300:A33130046167824A:Sci-Tech TV
B:042.0:E:12015:H:27500:00009:1000001010000010:Teledunya 3D
B:042.0:E:12130:V:27500:00024:1000000000000000:Radio Migros
B:042.0:E:12130:V:27500:00025:1000000000000000:Radio Tansas</code></pre><h2 id="逐行读取文本strsep"><a href="#逐行读取文本strsep" class="headerlink" title="逐行读取文本strsep"></a>逐行读取文本strsep</h2><pre><code>char *tok = NULL;
for (tok = strsep(&amp;p, &quot;\n&quot;); tok != NULL; tok = strsep(&amp;p, &quot;\n&quot;))
{
    printf(&quot;\033[33m%s\n\033[0m&quot;, tok);
    //TODO
}</code></pre><h2 id="处理单行格式化文本sscanf"><a href="#处理单行格式化文本sscanf" class="headerlink" title="处理单行格式化文本sscanf"></a>处理单行格式化文本sscanf</h2><p>sscanf() - 从一个字符串中读进与指定格式相符的数据.　函数原型:</p>
<pre><code>int sscanf( string str, string fmt, mixed var1, mixed var2 ...  );
int scanf( const char \*format [,argument]...  );</code></pre><p>说明：</p>
<p>sscanf与scanf类似，都是用于输入的，只是后者以屏幕(stdin)为输入源，前者以固定字符串为输入源。<br>其中的format可以是一个或多个 %[*] [width] [{h | l | I64 | L}]type | ‘ ‘ | ‘\t’ | ‘\n’ | 非%符号：</p>
<ol>
<li>* 亦可用于格式中, (即 %*d 和 %*s) 加了星号 (*) 表示跳过此数据不读入. (也就是不把此数据读入参数中)</li>
<li>{a|b|c}表示a,b,c中选一，[d],表示可以有d也可以没有d。</li>
<li>width表示读取宽度。</li>
<li>{h | l | I64 | L}:参数的size,通常h表示单字节size，I表示2字节size,L表示4字节size(double例外),l64表示8字节size。</li>
<li>type :这就很多了，就是%s,%d,%c之类。</li>
<li>特别的：%*[width] [{h | l | I64 | L}]type 表示满足该条件的被过滤掉，不会向目标参数中写入值</li>
</ol>
<p>支持集合操作：</p>
<ol>
<li>%[a-z] 表示匹配a到z中任意字符，贪婪性(尽可能多的匹配)</li>
<li>%[A-Z] 表示匹配A到Z中任意字符，贪婪性(尽可能多的匹配)</li>
<li>%[aB’] 匹配a、B、’中一员，贪婪性</li>
<li>%[^a] 匹配非a的任意字符，贪婪性</li>
</ol>
<p>注意：在读入的字符串是空字符串时，sscanf函数并不改变待读入到的字符串的值。</p>
<p><strong>针对格式化文本的处理：</strong></p>
<pre><code>char longitude[6] = {0};
char direction = 0;
char frequency[6] = {0};
char polar = 0;
char symbol[6] = {0};
char sid[6] = {0};
char data0[EMU_KEY_STR_LEN] = {0};
char data1[EMU_KEY_STR_LEN] = {0};

if (type == 0)
{
    //B:004.0:W:11389:A:27500:00011:1A2B3C81C3B2A116:RTR                  
    sscanf(tok, &quot;%*1c:%5c:%1c:%5c:%1c:%5c:%5c:%16c:%16c&quot;,
            longitude, &amp;direction, frequency, &amp;polar, symbol, sid, data0, data1);
}
else
{ 
    //P:105.5:E:03960:H:27500:CEF7CE422FF89E:E42DB81767E02E
    sscanf(tok, &quot;%*1c:%5c:%1c:%5c:%1c:%5c:%14c:%14c&quot;,
            longitude, &amp;direction, frequency, &amp;polar, symbol, data0, data1);
}
pMinifs-&gt;symbol_rate = atoi(symbol);
.
.
.</code></pre><p>注意：<strong>%s与%c的区别，注意buf的长度包含字符串结束符‘\0’，长度如果不对，后续处理可能出现问题。</strong></p>
<h2 id="强制内存转换处理格式化文本"><a href="#强制内存转换处理格式化文本" class="headerlink" title="强制内存转换处理格式化文本"></a>强制内存转换处理格式化文本</h2><p>针对格式化文本还有一种内存强制转换的处理方式：</p>
<pre><code>struct DevData{
    char tag[2];
    char longitude[6];
    char direction[2];
    char frequency[6];
    char polar[2];
    char symbol_rate[6];
    char service_id[6];
    char key[KEY_STR_LEN+1];
    char prog_name[PROG_NAME_LENTH];
    char line_feed[2];//tail(0x0d0a or 0x0a)
} __attribute__((packed));

//获取文件数据
fd = fopen(path, &quot;r&quot;);
p = (char *)mallocz(size);
fseek(fd, 0, SEEK_SET);
fread(fd, p, 1, size);

//强制转换
struct DevData *pRootData=NULL;
for(i=0;i&lt;total_num;i++)
{
    pRootData = (struct DevData*)p1;
    .
    .
    //处理当前结构体pRootData，并获得偏移量用来取下一个结构体数据
    memset(atoi_buf,0,sizeof(atoi_buf));
    memcpy(atoi_buf,pRootData-&gt;symbol_rate,sizeof(pRootData-&gt;symbol_rate)-1);
    pMinifs-&gt;symbol_rate = atoi(atoi_buf);
    .
    p1 += offset;
}</code></pre><h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><h3 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a><strong>特殊字符</strong></h3><h4 id=""><a href="#" class="headerlink" title="\"></a>\</h4><p>转义字符，将下一字符标记为特殊字符、文本、反向引用或八进制转义符</p>
<pre><code>&#39;\n&#39;匹配换行，
&#39;\\&#39;匹配&#39;\&#39;</code></pre><h4 id="-1"><a href="#-1" class="headerlink" title="^"></a>^</h4><p>匹配搜索字符串开始的位置。如果标志中包括 m（多行搜索）字符，^ 还将匹配 \n 或 \r 后面的位置。<br>如果将 ^ 用作括号表达式中的第一个字符，则会对字符集求反。</p>
<pre><code>^\d{3} 与搜索字符串开始处的 3 个数字匹配。
[^abc] 与除 a、b 和 c 以外的任何字符匹配。</code></pre><h4 id="-2"><a href="#-2" class="headerlink" title="$"></a>$</h4><p>匹配搜索字符串结尾的位置。 如果标志中包括 m（多行搜索）字符，^ 还将匹配 \n 或 \r 前面的位置。</p>
<pre><code>\d{3}$ 与搜索字符串结尾处的 3 个数字匹配。</code></pre><h4 id="-3"><a href="#-3" class="headerlink" title="*"></a>*</h4><p>零次或多次匹配前面的字符或子表达式。等效于 {0,}。</p>
<pre><code>zo\* 与“z”和“zoo”匹配。</code></pre><h4 id="-4"><a href="#-4" class="headerlink" title="+"></a>+</h4><p>一次或多次匹配前面的字符或子表达式。 等效于 {1,}。</p>
<pre><code>zo+ 与“zo”和“zoo”匹配，但与“z”不匹配。</code></pre><h4 id="-5"><a href="#-5" class="headerlink" title="?"></a>?</h4><p>零次或一次匹配前面的字符或子表达式。 等效于 {0,1}。<br>当 ? 紧随任何其他限定符（*、+、?、{n}、{n,} 或 {n,m}）之后时，匹配模式是非贪婪的。<br>非贪婪模式匹配搜索到的、尽可能少的字符串， 而默认的贪婪模式匹配搜索到的、尽可能多的字符串。</p>
<pre><code>zo? 与“z”和“zo”匹配，但与“zoo”不匹配。
o+? 只与“oooo”中的单个“o”匹配，而 o+ 与所有“o”匹配。
do(es)? 与“do”或“does”中的“do”匹配。</code></pre><h4 id="-6"><a href="#-6" class="headerlink" title="."></a>.</h4><p>匹配除换行符 \n 之外的任何单个字符。 若要匹配包括 \n 在内的任意字符，请使用诸如 [\s\S] 之类的模式。</p>
<pre><code>a.c 与“abc”、“a1c”和“a-c”匹配</code></pre><h4 id="-7"><a href="#-7" class="headerlink" title="[]"></a>[]</h4><p>标记括号表达式的开始和结尾。</p>
<pre><code>[1-4] 与“1”、“2”、“3”或“4”匹配。 [^aAeEiIoOuU] 与任何非元音字符匹配</code></pre><h4 id="-8"><a href="#-8" class="headerlink" title="{}"></a>{}</h4><p>标记限定符表达式的开始和结尾。</p>
<pre><code>a{2,3} 与“aa”和“aaa”匹配</code></pre><h4 id="-9"><a href="#-9" class="headerlink" title="()"></a>()</h4><p>标记子表达式的开始和结尾。 可以保存子表达式以备将来之用。</p>
<pre><code>A(\d) 与“A0”至“A9”匹配。 保存该数字以备将来之用</code></pre><h4 id="-10"><a href="#-10" class="headerlink" title="|"></a>|</h4><p>指示在两个或多个项之间进行选择。</p>
<pre><code>z|food 与“z”或“food”匹配。 (z|f)ood 与“zood”或“food”匹配</code></pre><h3 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h3><h4 id="b"><a href="#b" class="headerlink" title="\b"></a>\b</h4><p>与一个字边界匹配；即字与空格间的位置。</p>
<pre><code>er\b 与“never”中的“er”匹配，但与“verb”中的“er”不匹配</code></pre><h4 id="B"><a href="#B" class="headerlink" title="\B"></a>\B</h4><p>非边界字匹配。</p>
<pre><code>er\B 与“verb”中的“er”匹配，但与“never”中的“er”不匹配</code></pre><h4 id="d"><a href="#d" class="headerlink" title="\d"></a>\d</h4><p>数字字符匹配。 等效于 [0-9]。</p>
<pre><code>在搜索字符串“12 345”中，\d{2} 与“12”和“34”匹配。 \d 与“1”、“2”、“3”、“4”和“5”匹配。</code></pre><h4 id="D"><a href="#D" class="headerlink" title="\D"></a>\D</h4><p>非数字字符匹配。 等效于 [^0-9]。</p>
<pre><code>\D+ 与“abc123 def”中的“abc”和“def”匹配。</code></pre><h4 id="w"><a href="#w" class="headerlink" title="\w"></a>\w</h4><p>与以下任意字符匹配：A-Z、a-z、0-9 和下划线。 等效于 [A-Za-z0-9_]。</p>
<pre><code>在搜索字符串“The quick brown fox…”中，\w+ 与“The”、“quick”、“brown”和“fox”匹配。</code></pre><h4 id="W"><a href="#W" class="headerlink" title="\W"></a>\W</h4><p>与除 A-Z、a-z、0-9 和下划线以外的任意字符匹配。 等效于 [^A-Za-z0-9_]。</p>
<pre><code>在搜索字符串“The quick brown fox…”中，\W+ 与“…”和所有空格匹配。</code></pre><h4 id="xyz"><a href="#xyz" class="headerlink" title="[xyz]"></a>[xyz]</h4><p>字符集。 与任何一个指定字符匹配。</p>
<pre><code>[abc] 与“plain”中的“a”匹配。</code></pre><h4 id="xyz-1"><a href="#xyz-1" class="headerlink" title="[^xyz]"></a>[^xyz]</h4><p>反向字符集。 与未指定的任何字符匹配。</p>
<pre><code>[^abc] 与“plain”中的“p”、“l”、“i”和“n”匹配。</code></pre><h4 id="a-z"><a href="#a-z" class="headerlink" title="[a-z]"></a>[a-z]</h4><p>字符范围。 匹配指定范围内的任何字符。</p>
<pre><code>[a-z] 与“a”到“z”范围内的任何小写字母字符匹配。</code></pre><h4 id="a-z-1"><a href="#a-z-1" class="headerlink" title="[^a-z]"></a>[^a-z]</h4><p>反向字符范围。 与不在指定范围内的任何字符匹配。</p>
<pre><code>[^a-z] 与不在范围“a”到“z”内的任何字符匹配。</code></pre><h4 id="n"><a href="#n" class="headerlink" title="{n}"></a>{n}</h4><p>正好匹配 n 次。 n 是非负整数。</p>
<pre><code>o{2} 与“Bob”中的“o”不匹配，但与“food”中的两个“o”匹配。</code></pre><h4 id="n-1"><a href="#n-1" class="headerlink" title="{n,}"></a>{n,}</h4><p>至少匹配 n 次。 n 是非负整数。</p>
<pre><code>* 与 {0,} 相等。
+ 与 {1,} 相等。
o{2,} 与“Bob”中的“o”不匹配，但与“foooood”中的所有“o”匹配。</code></pre><h4 id="n-m"><a href="#n-m" class="headerlink" title="{n,m}"></a>{n,m}</h4><p>匹配至少 n 次，至多 m 次。 n 和 m 是非负整数，其中 n &lt;= m。 逗号和数字之间不能有空格。</p>
<pre><code>? 与 {0,1} 相等。
在搜索字符串“1234567”中，\d{1,3} 与“123”、“456”和“7”匹配。</code></pre><h4 id="pattern"><a href="#pattern" class="headerlink" title="(pattern)"></a>(pattern)</h4><p>与pattern 匹配并保存匹配项。 若要匹配括号字符 (  )，请使用“(”或者“)”。</p>
<pre><code>(Chapter|Section) [1-9] 与“Chapter 5”匹配，保存“Chapter”以备将来之用。</code></pre><h4 id="pattern-1"><a href="#pattern-1" class="headerlink" title="(?:pattern)"></a>(?:pattern)</h4><p>与pattern 匹配，但不保存匹配项；即不会存储匹配项以备将来之用。 这对于用“or”字符 (|) 组合模式部件的情况很有用。</p>
<pre><code>industr(?:y|ies) 与 industry|industries 相等。</code></pre><h4 id="pattern-2"><a href="#pattern-2" class="headerlink" title="(?=pattern)"></a>(?=pattern)</h4><p>正预测先行。 找到一个匹配项后，将在匹配文本之前开始搜索下一个匹配项。 不会保存匹配项以备将来之用。</p>
<pre><code>^(?=.\*\d).{4,8}$ 对密码应用以下限制：其长度必须介于 4 到 8 个字符之间，并且必须至少包含一个数字。</code></pre><p>在该模式中，.*\d 查找后跟有数字的任意多个字符。 对于搜索字符串“abc3qr”，这与“abc3”匹配。<br>从该匹配项之前（而不是之后）开始，.{4,8} 与包含 4-8 个字符的字符串匹配。 这与“abc3qr”匹配。<br>^ 和 $ 指定搜索字符串的开始和结束位置。 这将在搜索字符串包含匹配字符之外的任何字符时阻止匹配。</p>
<h4 id="pattern-3"><a href="#pattern-3" class="headerlink" title="(?!pattern)"></a>(?!pattern)</h4><p>负预测先行。 匹配与模式 不匹配的搜索字符串。 找到一个匹配项后，将在匹配文本之前开始搜索下一个匹配项。 不会保存匹配项以备将来之用。</p>
<pre><code>\b(?!th)\w+\b 与不以“th”开头的单词匹配。</code></pre><p>在该模式中，\b 与一个字边界匹配。 对于搜索字符串“ quick ”，这与第一个空格匹配。 (?!th) 与非“th”字符串匹配。 这与“qu”匹配。<br>从该匹配项开始，\w+ 与一个字匹配。 这与“quick”匹配。</p>
<h4 id="cx"><a href="#cx" class="headerlink" title="\cx"></a>\cx</h4><p>匹配 x 指示的控制字符。 x 的值必须在 A-Z 或 a-z 范围内。 如果不是这样，则假定 c 就是文本“c”字符本身。</p>
<pre><code>\cM 与 Ctrl+M 或一个回车符匹配。</code></pre><h4 id="xn"><a href="#xn" class="headerlink" title="\xn"></a>\xn</h4><p>匹配 n，此处的 n 是一个十六进制转义码。<br>十六进制转义码必须正好是两位数长。 允许在正则表达式中使用 ASCII 代码。</p>
<pre><code>\x41 与“A”匹配。 \x041 等效于后跟有“1”的“\x04”（因为 n 必须正好是两位数）。</code></pre><h4 id="num"><a href="#num" class="headerlink" title="\num"></a>\num</h4><p>匹配 num，此处的 num 是一个正整数。 这是对已保存的匹配项的引用。</p>
<pre><code>(.)\1 与两个连续的相同字符匹配。</code></pre><h4 id="n-2"><a href="#n-2" class="headerlink" title="\n"></a>\n</h4><p>标识一个八进制转义码或反向引用。 如果 \n 前面至少有 n 个捕获子表达式，那么 n 是反向引用。<br>否则，如果 n 是八进制数 (0-7)，那么 n 是八进制转义码。</p>
<pre><code>(\d)\1 与两个连续的相同数字匹配。</code></pre><h4 id="nm"><a href="#nm" class="headerlink" title="\nm"></a>\nm</h4><p>标识一个八进制转义码或反向引用。 如果 \nm 前面至少有 nm 个捕获子表达式，那么 nm 是反向引用。<br>如果 \nm 前面至少有 n 个捕获子表达式，则 n 是反向引用，后面跟有文本 m。<br>如果上述情况都不存在，当 n 和 m 是八进制数字 (0-7) 时，\nm 匹配八进制转义码 nm。</p>
<pre><code>\11 与制表符匹配。</code></pre><h4 id="nml"><a href="#nml" class="headerlink" title="\nml"></a>\nml</h4><p>当 n 是八进制数字 (0-3)，m 和 l 是八进制数字 (0-7) 时，匹配八进制转义码 nml。</p>
<pre><code>\011 与制表符匹配。</code></pre><h4 id="un"><a href="#un" class="headerlink" title="\un"></a>\un</h4><p>匹配 n，其中 n 是以四位十六进制数表示的 Unicode 字符。</p>
<pre><code>\u00A9 与版权符号 (©) 匹配。</code></pre><h3 id="非打印字符"><a href="#非打印字符" class="headerlink" title="非打印字符"></a>非打印字符</h3><ul>
<li>\f 换页符。 \x0c 和 \cL</li>
<li>\n 换行符。 \x0a 和 \cJ</li>
<li>\r 回车符。 \x0d 和 \cM</li>
<li>\s 任何空白字符。 其中包括空格、制表符和换页符。 [ \f\n\r\t\v ]</li>
<li>\S 任何非空白字符。 [^ \f\n\r\t\v]</li>
<li>\t Tab 字符。 \x09 和 \cI</li>
<li>\v 垂直制表符。 \x0b 和 \cK</li>
</ul>
<ol>
<li><a href="http://blog.chinaunix.net/uid-26284412-id-3189214.html" target="_blank" rel="noopener">sscanf的高级用法</a></li>
<li><a href="http://www.cnblogs.com/lyq105/archive/2009/11/28/1612677.html" target="_blank" rel="noopener">C语言函数sscanf()的用法</a></li>
<li><a href="http://www.kryptosx.info/archives/60.html" target="_blank" rel="noopener">scanf的正则表达式总结</a></li>
<li><a href="http://blog.csdn.net/tujiaw/article/details/6139896" target="_blank" rel="noopener">scanf、sscanf中的正则表达式</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/17/vim-tips-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/17/vim-tips-1/" class="post-title-link" itemprop="url">vim中使用grep、sed删除匹配行</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-18 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-18T00:00:00+08:00">2015-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>159</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在调试过程中经常需要分析打印、数据等等，在大量文本中仅仅需要提取需要关心的部分，使用用例如下：</p>
<p><strong>删除匹配行：</strong></p>
<pre><code>%!grep -v &quot;cscope&quot;
%!sed &#39;/cscope/&#39;d</code></pre><p><strong>只保留匹配行：</strong></p>
<pre><code>%!grep &quot;cscope&quot;</code></pre><p>grep、sed可以使用正则表达式来完成复杂匹配。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/16/gdb-dump-memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/16/gdb-dump-memory/" class="post-title-link" itemprop="url">gdb dump内存数据</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-17 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-17T00:00:00+08:00">2015-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>gdb调试过程中从内存中dump出相关数据用于分析</strong></p>
<h2 id="help-dump"><a href="#help-dump" class="headerlink" title="help dump"></a><strong>help dump</strong></h2><p>在gdb中输入：</p>
<pre><code>(gdb) help dump
Dump target code/data to a local file.

List of dump subcommands:

dump binary -- Write target code/data to a raw binary file
dump ihex -- Write target code/data to an intel hex file
dump memory -- Write contents of memory to a raw binary file
dump srec -- Write target code/data to an srec file
dump tekhex -- Write target code/data to a tekhex file
dump value -- Write the value of an expression to a raw binary file

Type &quot;help dump&quot; followed by dump subcommand name for full documentation.
Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;.
Command name abbreviations are allowed if unambiguous.

dump [格式] memory 文件名 起始地址 结构地址 #   把指定内存段写到文件
dump [格式] value 文件名 表达式             #   把指定值写到文件</code></pre><p>格式包括:</p>
<ul>
<li>binary      原始二进制格式</li>
<li>ihex        intel 16进制格式</li>
<li>srec        S-recored格式</li>
<li>tekhex      tektronix 16进制格式</li>
</ul>
<p>命令具体参数格式：</p>
<pre><code>dump binary memory filename start_addr end_addr
    Dump contents of memory from start_addr to end_addr into raw binary format file filename.
dump binary value filename expression
    Dump value of expression into raw binary format file filename.
dump ihex memory filename start_addr end_addr
    Dump contents of memory from start_addr to end_addr into intel hex format file filename.
dump ihex value filename expression
    Dump value of expression into intel hex format file filename.
dump srec memory filename start_addr end_addr
    Dump contents of memory from start_addr to end_addr into srec format file filename.
dump srec value filename expression
    Dump value of expression into srec format file filename.
dump tekhex memory filename start_addr end_addr
    Dump contents of memory from start_addr to end_addr into tekhex format file filename.
dump tekhex value filename expression
    Dump value of expression into tekhex format file filename.</code></pre><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a><strong>用法</strong></h2><pre><code>(gdb) dump binary memory file $1 $2         //$1 $2为地址
(gdb) dump binary memory ./dump s1 s1+5     //s1为数组
(gdb) dump memory file 0x9000xxxx 0x9001xxxx     //s1为数组</code></pre><p>通过以上command来完成内存对比。</p>
<ol>
<li><a href="http://www.delorie.com/gnu/docs/gdb/gdb_69.html" target="_blank" rel="noopener">Copy between memory and a file</a></li>
<li><a href="http://blog.csdn.net/zhangmiaoping23/article/details/40892261" target="_blank" rel="noopener">gdb 内存复制到/从文件</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/10/vim-astyle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/10/vim-astyle/" class="post-title-link" itemprop="url">AStyle代码排版整理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-11T00:00:00+08:00">2015-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>两种安装方式：</p>
<ol>
<li><a href="http://sourceforge.net/projects/astyle/files/" target="_blank" rel="noopener">官网</a>下载源码编译安装</li>
<li>sudo apt-get install astyle</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>两种配置方式：</p>
<ol>
<li>配置文件~/.astylerc</li>
<li>执行命令携带参数</li>
</ol>
<p>配置文件例子如下：</p>
<pre><code>--style=linux                  # -A8
--indent=force-tab             # -T,  强制 TAB 缩进
--break-blocks                 # -f,  Pad empty lines around header blocks (e.g. &#39;if&#39;, &#39;for&#39;, &#39;while&#39;...)
--attach-namespaces            # -xn, Attach brackets to a namespace statement
--attach-classes               # -xc, Attach brackets to a class statement
--delete-empty-lines           # -xe, 删除函数内多余的空行
--align-pointer=name           # -k3, *号靠近变量名
--remove-brackets              # -xj, if,while,for 等代码是单行行时，去掉 {}
--close-templates              # -xy, 模板中无空格, 如：Stack&lt;int,List&lt;int&gt;&gt; stack1;
--pad-oper                     # -p,  运算符两边加空格
--indent-preproc-define        # -w,  宏定义缩进
--indent-col1-comments         # -y,  注释缩进
--unpad-paren                  # -U,  Remove extra space padding around parenthesis on the inside and outside
--pad-header                   # -H,  关键字后加空格
--break-after-logical          # -xL
--lineend=linux                # -z2
--indent=tab                   # -t</code></pre><p>执行参数例子如下：</p>
<pre><code>-A8xnxcxek3xyfTpEwyUHxLz3t</code></pre><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>自动排版命令：</p>
<pre><code>indent -npsl
astyle -A8xnxcxek3xyfTpEwyUHxLz3t
find -name &quot;*.[ch]*&quot; | xargs indent -npsl | xargs astyle -A8xnxcxek3xyfTpEwyUHxLz3t</code></pre><h2 id="与vim结合"><a href="#与vim结合" class="headerlink" title="与vim结合"></a>与vim结合</h2><p>最终成品如下：</p>
<pre><code>function! CodeFormat()
    ks
    &quot;let curfile = expand(&quot;%&quot;)
    &quot;let curfile = expand(&quot;%:t&quot;)
    &quot;echo curfile
    silent! %s/^M//g
    silent! exec &#39;%!astyle -A3LYfpjk3NSEUHwyW3xC100 --style=break&#39;
    silent! %g/^\s*$\n\s*$/d
    silent! %s/\s\+$//g
    &#39;s
endfunction

autocmd BufNewFile,BufRead *.c call CodeFormat()
autocmd BufNewFile,BufRead *.h call CodeFormat()
nmap &lt;leader&gt;&lt;leader&gt;q :call CodeFormat()&lt;CR&gt;</code></pre><p>解析如下：</p>
<ul>
<li>ks ‘s 保存当前行位置</li>
<li>expand(“%”) 取file变量</li>
<li>expand(“%:t”) 取文件名</li>
<li>silent! 静默执行命令</li>
<li>%s/^M//g 将<br>删除，相当于dos2unix</li>
<li>exec 执行命令</li>
<li>%!astyle -A3LYfpjk3NSEUHwyW3xC100 –style=break 携带参数执行外部命令</li>
<li>%g/^\s<em>$\n\s</em>$/d 删除多行空行为一行</li>
<li>%s/\s+$//g 删除行尾空格</li>
<li>autocmd BufNewFile,BufRead *.c 打开c文件时，自动调用函数CodeFormat()</li>
<li>nmap 映射快捷键</li>
</ul>
<p>astyle参数解析：</p>
<ul>
<li>-A3: Kernighan &amp; Ritchie style uses linux brackets</li>
<li>-L: 标签缩进</li>
<li>-Y: 注释缩进</li>
<li>-f: 空行分隔没有关系的块,类,标签(不包括函数块)</li>
<li>-p: 操作符两端插入一个空格 </li>
<li>-j: if,while,for 等代码是单行行时，加 {}</li>
<li>-k3: *号靠近变量名</li>
<li>-N: 缩进命名空间定义行</li>
<li>-S: switch 与case不同列,case缩进</li>
<li>-E: 块间空行的换行符前插入一个空格</li>
<li>-U: 移除括号两端多余空格</li>
<li>-H: 关键字后加空格</li>
<li>-w: 宏定义缩进</li>
<li>-y: else catch左边的大括号与else catch分隔</li>
<li>-W3: &amp;号靠近变量名</li>
<li>-xC100: 代码最大长度100,超过之后进行换行</li>
</ul>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol>
<li><a href="http://tonybai.com/2010/07/29/use-astyle-to-beautify-your-code/" target="_blank" rel="noopener">使用astyle美化代码</a></li>
<li><a href="http://blog.163.com/jiangmc@yeah/blog/static/126590885201031611844360/" target="_blank" rel="noopener">Vim整合AStyle进行代码美化</a></li>
<li><a href="http://blog.chinaunix.net/uid-20662363-id-1904145.html" target="_blank" rel="noopener"> Astyle编程语言格式化工具的中文说明 </a></li>
<li><a href="http://blog.csdn.net/memory_xj/article/details/2983093" target="_blank" rel="noopener">Astyle：代码格式化工具简明指南</a></li>
<li><a href="http://astyle.sourceforge.net/astyle.html" target="_blank" rel="noopener">Artistic Style 3.1</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/09/udp-packet-loss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/09/udp-packet-loss/" class="post-title-link" itemprop="url">网络性能调优（TCP/UDP）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-10 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-10T00:00:00+08:00">2015-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Socket/" itemprop="url" rel="index">
                    <span itemprop="name">Socket</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="检查协议栈buffer"><a href="#检查协议栈buffer" class="headerlink" title="检查协议栈buffer"></a><strong>检查协议栈buffer</strong></h2><p>检查buffer大小，修改之后重启网络服务：</p>
<pre><code>sysctl -a |grep net.core
net.core.rmem_default = 212992
net.core.rmem_max = 212992</code></pre><p>检查网卡收包情况：</p>
<pre><code>2015 git:(master)✗ &gt; netstat -su
IcmpMsg:
    InType3: 366
    OutType3: 325
Udp:
    88110 packets received
    325 packets to unknown port received.
    0 packet receive errors
    6219 packets sent
    IgnoredMulti: 2208
UdpLite:
IpExt:
    InMcastPkts: 1945
    OutMcastPkts: 35
    InBcastPkts: 42730
    OutBcastPkts: 261
    InOctets: 192296247659
    OutOctets: 192200794856
    InMcastOctets: 220327
    OutMcastOctets: 5370
    InBcastOctets: 4953400
    OutBcastOctets: 30722
    InNoECTPkts: 6131438
    InECT0Pkts: 127</code></pre><h2 id="检查socket收发缓冲区"><a href="#检查socket收发缓冲区" class="headerlink" title="检查socket收发缓冲区"></a><strong>检查socket收发缓冲区</strong></h2><p>TCP 的性能取决于几个方面的因素。两个最重要的因素是：</p>
<ol>
<li>链接带宽（link bandwidth）（报文在网络上传输的速率）</li>
<li>往返时间（round-trip time） 或 RTT（发送报文与接收到另一端的响应之间的延时）</li>
</ol>
<p><strong>这两个值确定了称为 Bandwidth Delay Product（BDP）的内容</strong>。<br>给定链接带宽和 RTT 之后，您就可以计算出 BDP 的值了，<br><strong>BDP 给出了一种简单的方法来计算理论上最优的 TCP socket 缓冲区大小</strong>（其中保存了排队等待传输和等待应用程序接收的数据）。</p>
<p>如果缓冲区太小，那么 TCP 窗口就不能完全打开，这会对性能造成限制。<br>如果缓冲区太大，那么宝贵的内存资源就会造成浪费。<br>如果您设置的缓冲区大小正好合适，那么就可以完全利用可用的带宽。下面我们来看一个例子：</p>
<p>如果应用程序是通过一个 100Mbps 的局域网进行通信，其 RRT 为 50 ms，那么 BDP 就是：</p>
<pre><code>BDP = link_bandwidth * RTT
100MBps * 0.050 sec / 8 = 0.625MB = 625KB</code></pre><p>注意：此处除以 8 是将位转换成通信使用的字节。</p>
<p>因此，我们可以将 TCP 窗口设置为 BDP 或 1.25MB。<br>但是在 <strong>Linux 2.6 上默认的 TCP 窗口大小是 110KB</strong>，这会将连接的带宽限制为 2.2MBps，计算方法如下：</p>
<pre><code>throughput = window_size / RTT
110KB / 0.050 = 2.2MBps</code></pre><p>如果使用上面计算的窗口大小，我们得到的带宽就是 12.5MBps，计算方法如下：</p>
<pre><code>625KB / 0.050 = 12.5MBps</code></pre><p>差别的确很大，并且可以为 socket 提供更大的吞吐量。<br>Sockets API 提供了几个 socket 选项，其中两个可以用于修改 socket 的发送和接收缓冲区的大小。<br><strong>使用 SO_SNDBUF 和 SO_RCVBUF 选项来调整发送和接收缓冲区的大小</strong>。<br>注意：尽管 socket 缓冲区的大小确定了通告 TCP 窗口的大小，但是 TCP 还在通告窗口内维护了一个拥塞窗口。<br>因此，由于这个拥塞窗口的存在，给定的 socket 可能永远都不会利用最大的通告窗口。</p>
<p>修改默认socket收发缓冲区大小：</p>
<pre><code>int ret, sock, sock_buf_size;
sock = socket( AF_INET, SOCK_STREAM, 0  );
sock_buf_size = 64*1024;
ret = setsockopt( sock, SOL_SOCKET, SO_SNDBUF,
        (char *)&amp;sock_buf_size, sizeof(sock_buf_size) );
ret = setsockopt( sock, SOL_SOCKET, SO_RCVBUF,
        (char *)&amp;sock_buf_size, sizeof(sock_buf_size) );</code></pre><h2 id="禁用-Nagle-算法"><a href="#禁用-Nagle-算法" class="headerlink" title="禁用 Nagle 算法"></a>禁用 Nagle 算法</h2><p>在通过 TCP socket 进行通信时，数据都拆分成了数据块，<br>这样它们就可以封装到给定连接的 TCP payload（指 TCP 数据包中的有效负荷）中了。<br>TCP payload 的大小取决于几个因素（例如最大报文长度和路径），<br>但是这些因素在连接发起时都是已知的。<br>为了达到最好的性能，我们的目标是使用尽可能多的可用数据来填充每个报文。<br><strong>当没有足够的数据来填充 payload 时（也称为最大报文段长度（maximum segment size） 或 MSS），<br>TCP 就会采用 Nagle 算法自动将一些小的缓冲区连接到一个报文段中。</strong><br>这样可以通过最小化所发送的报文的数量来提高应用程序的效率，并减轻整体的网络拥塞问题。</p>
<p>尽管 John Nagle 的算法可以通过将这些数据连接成更大的报文来最小化所发送的报文的数量，<br>但是有时您可能希望只发送一些较小的报文。<br>一个简单的例子是 telnet 程序，它让用户可以与远程系统进行交互，这通常都是通过一个 shell 来进行的。<br>如果用户被要求用发送报文之前输入的字符来填充某个报文段，那么这种方法就绝对不能满足我们的需要。<br>另外一个例子是 HTTP 协议。通常，客户机浏览器会产生一个小请求（一条 HTTP 请求消息），<br>然后 Web 服务器就会返回一个更大的响应（Web 页面）。</p>
<p>您应该考虑的第一件事情是 Nagle 算法满足一种需求。<br><strong>由于这种算法对数据进行合并，试图构成一个完整的 TCP 报文段，因此它会引入一些延时。</strong><br>但是这种算法可以最小化在线路上发送的报文的数量，因此可以最小化网络拥塞的问题。<br>但是在需要最小化传输延时的情况中，Sockets API 可以提供一种解决方案。<br>要<strong>禁用 Nagle 算法，您可以设置 TCP_NODELAY socket 选项。</strong></p>
<p>为TCP socket 禁用 Nagle 算法</p>
<pre><code>int sock, flag, ret;
/* Create new stream socket */
sock = socket( AF_INET, SOCK_STREAM, 0  );
/* Disable the Nagle (TCP No Delay) algorithm */
flag = 1;
ret = setsockopt( sock, IPPROTO_TCP, TCP_NODELAY, (char *)&amp;flag, sizeof(flag)  );
if (ret == -1) {
printf(&quot;Couldn&#39;t setsockopt(TCP_NODELAY)\n&quot;);
    exit(-1);
}</code></pre><p>使用 Samba 的实验表明，在从 Microsoft® Windows® 服务器上的 Samba 驱动器上读取数据时，禁用 Nagle 算法几乎可以加倍提高读性能。</p>
<h2 id="tcp"><a href="#tcp" class="headerlink" title="tcp"></a>tcp</h2><p>我们知道TCP链接是有很多开销的，<strong>一个是会占用文件描述符，另一个是会开缓存</strong>，<br>一般来说一个系统可以支持的TCP链接数是有限的，我们需要清楚地认识到<strong>TCP链接对系统的开销是很大的</strong>。<br>正是因为TCP是耗资源的，所以，很多攻击都是让你系统上出现大量的TCP链接，把你的系统资源耗尽。比如著名的SYNC Flood攻击。</p>
<p>所以，我们要<strong>注意配置KeepAlive参数</strong>，这个参数的意思是定义一个时间，<br>如果链接上没有数据传输，系统会在这个时间发一个包，如果没有收到回应，<br>那么TCP就认为链接断了，然后就会把链接关闭，这样可以回收系统资源开销。<br>（注：HTTP层上也有KeepAlive参数）对于像HTTP这样的短链接，设置一个1-2分钟的keepalive非常重要。<br>这可以在一定程度上防止DoS攻击。有下面几个参数（下面这些参数的值仅供参考）：</p>
<pre><code>net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 20
net.ipv4.tcp_fin_timeout = 30</code></pre><p>对于TCP的TIME_WAIT这个状态，主动关闭的一方进入TIME_WAIT状态，<br>TIME_WAIT状态将持续2个MSL(Max Segment Lifetime)，默认为4分钟，TIME_WAIT状态下的资源不能回收。<br>有大量的TIME_WAIT链接的情况一般是在HTTP服务器上。对此，有两个参数需要注意，</p>
<pre><code>net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_tw_recycle=1</code></pre><p>前者表示重用TIME_WAIT，后者表示回收TIME_WAIT的资源。</p>
<p><strong>TCP还有一个重要的概念叫RWIN（TCP Receive Window Size），<br>这个东西的意思是，我一个TCP链接在没有向Sender发出ack时可以接收到的最大的数据包。<br>为什么这个很重要？因为如果Sender没有收到Receiver发过来ack，<br>Sender就会停止发送数据并会等一段时间，如果超时，那么就会重传。<br>这就是为什么TCP链接是可靠链接的原因。<br>重传还不是最严重的，如果有丢包发生的话，TCP的带宽使用率会马上受到影响（会盲目减半），<br>再丢包，再减半，然后如果不丢包了，就逐步恢复。</strong>相关参数如下：</p>
<pre><code>net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216</code></pre><p>一般来说，<strong>理论上的RWIN应该设置成：吞吐量 * 回路时间</strong>。<br><strong>Sender端的buffer应该和RWIN有一样的大小</strong>，<br>因为Sender端发送完数据后要等Receiver端确认，如果网络延时很大，<br>buffer过小了，确认的次数就会多，于是性能就不高，对网络的利用率也就不高了。<br>也就是说，<strong>对于延迟大的网络，我们需要大的buffer，这样可以少一点ack，多一些数据，对于响应快一点的网络，可以少一些buffer</strong>。<br>因为，如果有丢包（没有收到ack），buffer过大可能会有问题，因为这会让TCP重传所有的数据，反而影响网络性能。<br>（当然，网络差的情况下，就别玩什么高性能了） 所以，<br>高性能的网络重要的是要让网络丢包率非常非常地小（基本上是用在LAN里），<br>如果网络基本是可信的，这样用大一点的buffer会有更好的网络传输性能（来来回回太多太影响性能了）。</p>
<h2 id="udp"><a href="#udp" class="headerlink" title="udp"></a>udp</h2><p>说到UDP的调优，有一些事我想重点说一样，那就是<strong>MTU——最大传输单元（其实这对TCP也一样，因为这是链路层上的东西）</strong>。<br>对于一个UDP的包，我们要尽量地让他大到MTU的最大尺寸再往网络上传，这样可以最大化带宽利用率。<br>对于这个MTU，以太网是1500字节，光纤是4352字节，802.11无线网是7981。<br>但是，当我们用TCP/UDP发包的时候，<br>我们的有效负载Payload要低于这个值，因为<strong>IP协议会加上20个字节，UDP会加上8个字节（TCP加的更多）</strong>，<br>所以，一般来说，你的一个UDP包的最大应该是1500-8-20=1472，这是你的数据的大小。<br>当然，如果你用光纤的话， 这个值就可以更大一些。</p>
<p>再多说一下，使用Socket编程的时候，你可以<strong>使用setsockopt() 设置 SO_SNDBUF/SO_RCVBUF 的大小，TTL和KeepAlive这些关键的设置</strong></p>
<h2 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h2><p>关于多路复用技术，也就是用一个线程来管理所有的TCP链接，有三个系统调用要重点注意：</p>
<ol>
<li>一个是select，这个系统调用只支持上限1024个链接</li>
<li>第二个是poll，其可以突破1024的限制，但是select和poll本质上是使用的轮询机制，<br>轮询机制在链接多的时候性能很差，因主是O(n)的算法</li>
<li>所以，epoll出现了，epoll是操作系统内核支持的，仅当在链接活跃时，操作系统才会callback，<br>这是由操作系统通知触发的，但其只有Linux Kernel 2.6以后才支持（准确说是2.5.44中引入的），<br>当然，如果所有的链接都是活跃的，过多的使用epoll_ctl可能会比轮询的方式还影响性能，不过影响的不大。</li>
</ol>
<p>另外，<strong>关于一些和DNS Lookup的系统调用要小心，比如：gethostbyaddr/gethostbyname，<br>这个函数可能会相当的费时，因为其要到网络上去找域名，因为DNS的递归查询，会导致严重超时，<br>而又不能通过设置什么参数来设置time out</strong>，<br>对此你可以通过配置hosts文件来加快速度，或是自己在内存中管理对应表，在程序启动时查好，<br>而不要在运行时每次都查。</p>
<p>另外，<strong>在多线程下面，gethostbyname会一个更严重的问题，<br>就是如果有一个线程的gethostbyname发生阻塞，<br>其它线程都会在gethostbyname处发生阻塞</strong>，这个比较变态，要小心。<br>（你可以试试GNU的gethostbyname_r()，这个的性能要好一些） 这种到网上找信息的东西很多，<br>比如，如果你的Linux使用了NIS，或是NFS，某些用户或文件相关的系统调用就很慢，所以要小心。</p>
<h2 id="检查防火墙"><a href="#检查防火墙" class="headerlink" title="检查防火墙"></a>检查防火墙</h2><pre><code>iptables -L</code></pre><p>如果iptables工作，需要关闭：</p>
<pre><code>service iptables stop</code></pre><h2 id="Linux内核参数优化"><a href="#Linux内核参数优化" class="headerlink" title="Linux内核参数优化"></a>Linux内核参数优化</h2><ol>
<li>/proc/sys/net/core/rmem_max — 最大的TCP数据接收缓冲。</li>
<li>/proc/sys/net/core/wmem_max — 最大的TCP数据发送缓冲。</li>
<li>/proc/sys/net/ipv4/tcp_timestamps — 时间戳在(请参考RFC 1323)TCP的包头增加12个字节。</li>
<li>/proc/sys/net/ipv4/tcp_sack — 有选择的应答。</li>
<li>/proc/sys/net/ipv4/tcp_window_scaling — 支持更大的TCP窗口. 如果TCP窗口最大超过65535(64KB), 必须设置该数值为1。</li>
<li>rmem_default — 默认的接收窗口大小。</li>
<li>rmem_max — 接收窗口的最大大小。</li>
<li>wmem_default — 默认的发送窗口大小。</li>
<li>wmem_max — 发送窗口的最大大小。</li>
</ol>
<p>/proc目录下的所有内容都是临时性的, 所以重启动系统后任何修改都会丢失。<br>建议在系统启动时自动修改TCP/IP参数，两种方式：</p>
<ol>
<li>修改/etc/rc.local</li>
<li>修改/etc/sysctl.conf </li>
</ol>
<h2 id="GUN-Linux网络工具"><a href="#GUN-Linux网络工具" class="headerlink" title="GUN/Linux网络工具"></a>GUN/Linux网络工具</h2><p>GNU/Linux 提供了几个工具 —— 有些是 GNU/Linux 自己提供的，<br>有些是开放源码软件 —— 用于调试网络应用程序，测量带宽/吞吐量，以及检查链接的使用情况。</p>
<p><strong>任何 GNU/Linux 发行版中都可以找到的工具：</strong></p>
<ol>
<li><strong>ping</strong>这是用于检查主机的可用性的最常用的工具，但是也可以用于识别带宽延时产品计算的 RTT。</li>
<li><strong>traceroute</strong>打印某个连接到网络主机所经过的包括一系列路由器和网关的路径（路由），从而确定每个 hop 之间的延时。</li>
<li><strong>netstat</strong>确定有关网络子系统、协议和连接的各种统计信息。</li>
<li><strong>tcpdump</strong>显示一个或多个连接的协议级的报文跟踪信息；其中还包括时间信息，您可以使用这些信息来研究不同协议服务的报文时间。</li>
</ol>
<p><strong>GNU/Linux 发行版中没有提供的有用性能工具：</strong></p>
<ol>
<li><strong>netlog</strong>为应用程序提供一些有关网络性能方面的信息。</li>
<li><strong>nettimer</strong>为瓶颈链接带宽生成一个度量标准；可以用于协议的自动优化。</li>
<li><strong>Ethereal</strong>以一个易于使用的图形化界面提供了 tcpump（报文跟踪）的特性。</li>
<li><strong>iperf</strong>测量 TCP 和 UDP 的网络性能；测量最大带宽，并汇报延时和数据报的丢失情况。</li>
</ol>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-hisock.html" target="_blank" rel="noopener">提高 Linux 上 socket 性能</a></li>
<li><a href="http://my.oschina.net/sharelinux/blog/146282" target="_blank" rel="noopener">浅谈linux性能调优之十四:调节socket缓冲区</a></li>
<li><a href="http://coolshell.cn/articles/7490.html" target="_blank" rel="noopener">性能调优攻略</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/08/tcp-udp-send-sendto/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/08/tcp-udp-send-sendto/" class="post-title-link" itemprop="url">tcp udp send流程分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-09 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-09T00:00:00+08:00">2015-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Socket/" itemprop="url" rel="index">
                    <span itemprop="name">Socket</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a><strong>tips</strong></h2><p>net/ipv4/af_inet.c 查看：inet_stream_ops 和 inet_dgram_ops</p>
<h2 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a><strong>TCP和UDP</strong></h2><p>TCP（传输控制协议）和UDP（用户数据报协议）是网络体系结构TCP/IP模型中传输层一层中的两个不同的通信协议。</p>
<ol>
<li>TCP：传输控制协议，一种面向连接的协议，给用户进程提供可靠的全双工的字节流，TCP套接口是字节流套接口(stream socket)的一种。</li>
<li>UDP：用户数据报协议。UDP是一种无连接协议。UDP套接口是数据报套接口(datagram socket)的一种。</li>
</ol>
<h3 id="TCP-Client-Server框架"><a href="#TCP-Client-Server框架" class="headerlink" title="TCP Client-Server框架"></a><strong>TCP Client-Server框架</strong></h3><p><img src="/images/socket/tcp-socket.jpg" alt="TCP" title="TCP"></p>
<p>服务器程序流程：</p>
<ol>
<li>程序初始化</li>
<li>填写本机地址信息</li>
<li>绑定并监听一个固定的端口</li>
<li>收到Client的连接后建立一个socket连接</li>
<li>产生一个新的进程与Client进行通信和信息处理</li>
<li>子通信结束后中断与Client的连接</li>
</ol>
<p>客户端程序流程：</p>
<ol>
<li>程序初始化</li>
<li>填写服务器地址信息</li>
<li>连接服务器</li>
<li>与服务器通信和信息处理</li>
<li>通信结束后断开连接</li>
</ol>
<h3 id="UDP-Client-Server框架"><a href="#UDP-Client-Server框架" class="headerlink" title="UDP Client-Server框架"></a><strong>UDP Client-Server框架</strong></h3><p><img src="/images/socket/udp-socket.jpg" alt="UDP" title="UDP"></p>
<p>服务器程序流程：</p>
<ol>
<li><p>程序初始化</p>
</li>
<li><p>填写本机地址信息</p>
</li>
<li><p>绑定一个固定的端口</p>
</li>
<li><p>收到Client的数据报后进行处理与通信</p>
</li>
<li><p>通信结束后断开连接</p>
<p>客户端程序流程：</p>
</li>
<li><p>程序初始化</p>
</li>
<li><p>填写服务器地址信息</p>
</li>
<li><p>与服务器通信和信息处理</p>
</li>
<li><p>通信结束后断开连接</p>
</li>
</ol>
<h3 id="Socket编程"><a href="#Socket编程" class="headerlink" title="Socket编程"></a><strong>Socket编程</strong></h3><p>Socket接口是TCP/IP网络的API，<br>网络的Socket数据传输是一种特殊的I/O，Socket也是一种文件描述符。<br>常用的Socket类型有两种：<strong>流式Socket（SOCK_STREAM）</strong>和<strong>数据报式Socket（SOCK_DGRAM）</strong>。</p>
<ol>
<li>流式是一种面向连接的Socket，针对于面向连接的TCP服务应用</li>
<li>数据报式Socket是一种无连接的Socket，对应于无连接的UDP服务应用</li>
</ol>
<p><strong>创建套接字</strong></p>
<pre><code>int socket(int domain, int type, int protocol);</code></pre><p><strong>建立地址和套接字的联系</strong></p>
<pre><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></pre><p><strong>服务器端侦听客户端的请求</strong></p>
<pre><code>int listen(int sockfd, int backlog);</code></pre><p><strong>建立服务器/客户端的连接 (面向连接TCP）</strong></p>
<pre><code>//客户端请求连接 
int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);

//服务器端从编号为Sockid的Socket上接收客户连接请求 
newsockid=accept(Sockid，Clientaddr, paddrlen)</code></pre><p><strong>发送/接收数据</strong></p>
<pre><code>//面向连接：
ssize_t send(int sockfd, const void *buf, size_t len, int flags);
ssize_t recv(int sockfd, void *buf, size_t len, int flags);

//面向无连接：
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags, const struct sockaddr *dest_addr, socklen_t addrlen);
ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags, struct sockaddr *src_addr, socklen_t *addrlen);</code></pre><p><strong>释放套接字</strong></p>
<pre><code>int close(int fd);</code></pre><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a><strong>区别</strong></h3><ol>
<li>socket()的参数不同</li>
<li>UDP Server不需要调用listen和accept</li>
<li>UDP收发数据用sendto/recvfrom函数</li>
<li>TCP：地址信息在connect/accept时确定</li>
<li>UDP：在sendto/recvfrom函数中每次均需指定地址信息(客户端调用connect之后，不需要每次指定)</li>
<li>UDP：shutdown函数无效</li>
</ol>
<h3 id="socket插入内核hash表"><a href="#socket插入内核hash表" class="headerlink" title="socket插入内核hash表"></a><strong>socket插入内核hash表</strong></h3><p>根据服务器和客户端的行为不同，bind()和sendto()都会调用到get_port()，<br>也就是说，在bind()或sendto()调用时，socket才被插入到内核表中。</p>
<p><strong>bind() 绑定地址</strong></p>
<pre><code>sys_bind -&gt; sock-&gt;ops-&gt;bind -&gt; inet_bind -&gt; sk-&gt;sk_prot-&gt;get_port</code></pre><p>sk-&gt;sk_prot是udp_prot，这里实际调用udp_v4_get_port()函数。</p>
<p><strong>sendto() 发送到指定地址</strong></p>
<pre><code>sys_sendto -&gt; sock_sendmsg -&gt; __sock_sendmsg -&gt; sock-&gt;ops-&gt;sendmsg</code></pre><p>由于<strong>创建的是udp socket，因此sock-&gt;ops指向inet_dgram_ops</strong>，sendmsg()实际调用inet_sendmsg()函数。该函数中的有如下语句：</p>
<pre><code>if (!inet_sk(sk)-&gt;inet_num &amp;&amp; inet_autobind(sk))  
    return -EAGAIN;  </code></pre><p>客户端在执行sendto()前仅仅执行了socket()操作，<br>此时inet_num=0，因此执行了inet_autobind()，<br>该函数会调用sk-&gt;sk_prot-&gt;get_port()。<br>从而回到了udp_v4_get_port()函数，它会将sk插入到内核表udp_table中。</p>
<h2 id="UDP调用connect"><a href="#UDP调用connect" class="headerlink" title="UDP调用connect"></a><strong>UDP调用connect</strong></h2><p>标准的udp客户端开了套接口后，一般使用sendto和recvfrom函数来发数据，<br>udp发送数据有两种方法供大家选用的：</p>
<ol>
<li>socket–&gt;sendto()或recvfrom() </li>
<li>socket–&gt;connect()–&gt;send()或recv()</li>
</ol>
<p>sendto和recvfrom在收发时指定地址，而send和recv则没有，地址是在connect指定的.</p>
<pre><code>int connect(int sockfd, const struct sockaddr *serv_addr, socklen_t addrlen);</code></pre><p>在udp编程中，如果你只往一个地址发送，那么你可以使用send和recv，<br>在使用它们之前用connect指定目的地址。connect函数在udp中就是这个作用，用它来检测udp端口的是否开放是没有用的。</p>
<p>udp中也有connect，只是它的connect不会进行三步握手，udp中调用connect时什么包也不发送。<br>调用connect是可选的，调用connect后就可以使用send、recv来进行UDP的收发包，而不必每次都要指定地址，<br>然后使用sendto、recvfrom进行操作，当然也可以调用sendto recvfrom。<br>没有调用connect那只能调用sendto、recvfrom，不可以调用send、recv。<br>调用sendto的时候第五个参数必须是NULL,第六个参数是0.<br>调用recvfrom,recv,read系统调用只能获取到先前connect的ip&amp;port发送的报文. </p>
<p>UDP中使用connect可以提高效率.原因如下:</p>
<ol>
<li>普通的UDP发送两个报文内核做了如下:#1:建立连结#2:发送报文#3:断开连结#4:建立连结#5:发送报文#6:断开连结</li>
<li>采用connect方式的UDP发送两个报文内核如下处理:#1:建立连结#2:发送报文#3:发送报文另外一点, 每次发送报文内核都由可能要做路由查询.</li>
</ol>
<p><strong>TCP中调用connect会引起三次握手,client与server建立连结.UDP中调用connect内核仅仅把对端ip&amp;port记录下来</strong>.<br><strong>UDP中可以多次调用connect,TCP只能调用一次connect</strong>.  UDP多次调用connect有两种用途:</p>
<ol>
<li><strong>指定一个新的ip&amp;port连结</strong>. 指定新连结,直接设置connect第二个参数即可.</li>
<li><strong>断开和之前的ip&amp;port的连结</strong>. 断开连结,需要将connect第二个参数中的sin_family设置成AF_UNSPEC即可. </li>
</ol>
<p>UDP中使用connect的好处:</p>
<ol>
<li>会提升效率</li>
<li>高并发服务中会增加系统稳定性</li>
</ol>
<p><strong>内核</strong>：发送时有两种调用方式：sys_send()和sys_sendto()，<br>两者的区别在于sys_sendto()需要给入目的地址的参数；<br>而sys_send()调用前需要调用sys_connect()来绑定目的地址信息；<br>两者的后续调用是相同的。如果调用sys_sendto()发送，<br>地址信息在sys_sendto()中从用户空间拷贝到内核空间，<br>而报文内容在udp_sendmsg()中从用户空间拷贝到内核空间。</p>
<h2 id="TCP使用sendto"><a href="#TCP使用sendto" class="headerlink" title="TCP使用sendto"></a><strong>TCP使用sendto</strong></h2><p>tcp_v4_connect函数代码片段：</p>
<pre><code>/* 记录目的端口和目的IP */
inet-&gt;dport = usin-&gt;sin_port;
inet-&gt;daddr = daddr;</code></pre><p><strong>将目标地址及端口记录在inet中</strong>！</p>
<p>同样的，TCP也可以调用sendto、recvfrom来完成数据的读写。<strong>Linux内核中send系统调用</strong>：</p>
<pre><code>SYSCALL_DEFINE4(send, int, fd, void __user *, buff, size_t, len,
    unsigned int, flags)
{
    return sys_sendto(fd, buff, len, flags, NULL, 0);
}</code></pre><p>可以看到，send直接调用sendto，后面两个参数直接填NULL，0，<br>因此对于TCP调用来将，使用sendto，并将后两个参数置0，一样可以工作。</p>
<h2 id="TCP-UDP-Send流程代码分析"><a href="#TCP-UDP-Send流程代码分析" class="headerlink" title="TCP/UDP Send流程代码分析"></a><strong>TCP/UDP Send流程代码分析</strong></h2><p>TCP调用sendto时没有给定地址，如何来完成TCP传输？sendto函数原型：</p>
<pre><code>SYSCALL_DEFINE6(sendto, int, fd, void __user *, buff, size_t, len,
    unsigned, flags, struct sockaddr __user *, addr,
    int, addr_len)
{
    struct socket *sock;
    struct sockaddr_storage address;
    int err;
    struct msghdr msg;
    struct iovec iov;
    int fput_needed;

    if (len &gt; INT_MAX)
        len = INT_MAX;
    sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);
    if (!sock)
        goto out;

    iov.iov_base = buff;
    iov.iov_len = len;
    msg.msg_name = NULL;
    msg.msg_iov = &amp;iov;
    msg.msg_iovlen = 1;
    msg.msg_control = NULL;
    msg.msg_controllen = 0;
    msg.msg_namelen = 0;

    if (addr) {
        err = move_addr_to_kernel(addr, addr_len, (struct sockaddr *)&amp;address);
        if (err &lt; 0)
            goto out_put;
        msg.msg_name = (struct sockaddr *)&amp;address;
        msg.msg_namelen = addr_len;
    }

    if (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)
        flags |= MSG_DONTWAIT;
    msg.msg_flags = flags;
    err = sock_sendmsg(sock, &amp;msg, len);

    out_put:
        fput_light(sock-&gt;file, fput_needed);
    out:
        return err;
}                          </code></pre><p><strong>tips</strong>: 使用sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK 来检查是否是nonblock的传送。</p>
<p>sendto中首先调用函数move_addr_to_kernel，将地址copy进内核空间：</p>
<pre><code>int move_addr_to_kernel(void __user *uaddr, int ulen, struct sockaddr *kaddr)                                                      
{
    if (ulen &lt; 0 || ulen &gt; sizeof(struct sockaddr_storage))
        return -EINVAL;
    if (ulen == 0)
        return 0;
    if (copy_from_user(kaddr, uaddr, ulen))
        return -EFAULT;
    return audit_sockaddr(ulen, kaddr);
}</code></pre><p>对于TCP来说，传入参数分别为NULL，0，这部分不会执行到。</p>
<pre><code>msg.msg_name = (struct sockaddr *)&amp;address;
msg.msg_namelen = addr_len;</code></pre><p><strong>地址存入msg中，用于UDP连接</strong>。</p>
<p>然后调用sock_sendmsg来完成数据发送，调用顺序：</p>
<pre><code>sys_send -&gt; sys_sendto -&gt; sock_sendmsg -&gt; __sock_sendmsg -&gt; sock-&gt;ops-&gt;sendmsg -&gt; inet_sendmsg -&gt; sk-&gt;sk_prot-&gt;sendmsg

static inline int __sock_sendmsg(struct kiocb *iocb, struct socket *sock,                                                          
        struct msghdr *msg, size_t size)
{
    struct sock_iocb *si = kiocb_to_siocb(iocb);
    int err;

    si-&gt;sock = sock;
    si-&gt;scm = NULL;
    si-&gt;msg = msg;
    si-&gt;size = size;

    err = security_socket_sendmsg(sock, msg, size);
    if (err)
        return err;

    return sock-&gt;ops-&gt;sendmsg(iocb, sock, msg, size);
}</code></pre><p><strong>根据socket不同具体对应于tcp_sendmsg、udp_sendmsg</strong></p>
<h3 id="udp-sendmsg"><a href="#udp-sendmsg" class="headerlink" title="udp sendmsg"></a><strong>udp sendmsg</strong></h3><p>udp_sendmsg代码分析：</p>
<pre><code>int udp_sendmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg, size_t len);

struct inet_sock *inet = inet_sk(sk);
if (msg-&gt;msg_name) {
    struct sockaddr_in * usin = (struct sockaddr_in*)msg-&gt;msg_name;
    if (msg-&gt;msg_namelen &lt; sizeof(*usin))
        return -EINVAL;
    if (usin-&gt;sin_family != AF_INET) {
        if (usin-&gt;sin_family != AF_UNSPEC)
            return -EAFNOSUPPORT;
    }

    daddr = usin-&gt;sin_addr.s_addr;
    dport = usin-&gt;sin_port;
    if (dport == 0)
        return -EINVAL;
} else {
    if (sk-&gt;sk_state != TCP_ESTABLISHED)
        return -EDESTADDRREQ;
    daddr = inet-&gt;daddr;
    dport = inet-&gt;dport;
    /* Open fast path for connected socket.
       Route will not be used, if at least one option is set.
     */
    connected = 1;
}
ipc.addr = inet-&gt;saddr;</code></pre><p>这段代码<strong>获取要发送数据的目的地址和端口号</strong>。<br>一种情况是<strong>调用sendto()发送数据</strong>，此时目的的信息以参数传入，存储在msg-&gt;msg_name中，因此从中取出daddr和dport；<br>另一种情况是<strong>调用connect(), send()发送数据</strong>，在<strong>connect()调用时绑定了目的的信息，存储在inet中</strong>，<br>并且由于是调用了connect()，sk-&gt;sk_state会设置为TCP_ESTABLISHED。<br>以后调用send()发送数据时，无需要再给入目的信息参数，因此从inet中取出dadr和dport。而connected表示了该socket是否已绑定目的。</p>
<h3 id="tcp-sendmsg"><a href="#tcp-sendmsg" class="headerlink" title="tcp sendmsg"></a><strong>tcp sendmsg</strong></h3><p>tcp_sendmsg代码分析，调用流程：</p>
<pre><code>tcp_sendmsg -&gt; tcp_push -&gt; __tcp_push_pending_frames -&gt; tcp_write_xmit -&gt; tcp_transmit_skb

static int tcp_transmit_skb(struct sock *sk, struct sk_buff *skb, int clone_it,
        gfp_t gfp_mask)
{
    struct inet_sock *inet;
    .
    .
    inet = inet_sk(sk);
    /* Build TCP header and checksum it. */
    th = tcp_hdr(skb);
    th-&gt;source      = inet-&gt;sport;
    th-&gt;dest        = inet-&gt;dport;
    th-&gt;seq         = htonl(tcb-&gt;seq);
    th-&gt;ack_seq     = htonl(tp-&gt;rcv_nxt);
    *(((__be16 *)th) + 6)   = htons(((tcp_header_size &gt;&gt; 2) &lt;&lt; 12) |
            tcb-&gt;flags);
    .
    .
}</code></pre><p><strong>tcp_sendmsg目标地址在函数tcp_transmit_skb中获取，获取的值是调用connect时存储在inet中！</strong></p>
<ol>
<li><a href="http://www.cnblogs.com/hubavyn/p/4322819.html" target="_blank" rel="noopener">udp调用connect有什么作用</a></li>
<li><a href="http://blog.csdn.net/vonkingdom/article/details/7057832" target="_blank" rel="noopener">UDP 的Connect函数的例子</a></li>
<li><a href="http://blog.csdn.net/qy532846454/article/details/6993695" target="_blank" rel="noopener">Linux内核分析 - 网络：UDP模块 - 收发</a></li>
<li><a href="http://blog.csdn.net/qy532846454/article/details/6942667" target="_blank" rel="noopener">Linux内核分析 - 网络：UDP模块 - socket</a></li>
<li><a href="http://blog.csdn.net/cz_hyf/article/details/602802" target="_blank" rel="noopener">linux-Tcp IP协议栈源码阅读笔记</a></li>
<li><a href="http://blog.chinaunix.net/uid-13746440-id-4825005.html" target="_blank" rel="noopener">Linux TCP/IP源码分析 Connect</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5063e4c80101fvj3.html" target="_blank" rel="noopener">Linux TCP/IP 协议栈源码分析</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/02/printf-formats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/02/printf-formats/" class="post-title-link" itemprop="url">printf格式化输出</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-03 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-03T00:00:00+08:00">2015-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-29 13:31:06" itemprop="dateModified" datetime="2021-01-29T13:31:06+08:00">2021-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="格式输出控制符"><a href="#格式输出控制符" class="headerlink" title="格式输出控制符"></a><strong>格式输出控制符</strong></h2><p>printf的格式控制的完整格式：<strong>%</strong>  <strong>-</strong>  <strong>0</strong>  <strong>m.n</strong>  <strong>l</strong>或<strong>h</strong>:</p>
<ol>
<li>%：格式说明的起始符号，不可缺少。</li>
<li>-： 有-表示左对齐输出，如省略表示右对齐输出。</li>
<li>0：有0表示指定空位填0,如省略表示指定空位不填。</li>
<li>m.n：m指域宽，即对应的输出项在输出设备上所占的字符数。n指精度，用于说明输出的实型数的小数位数。未指定n时，隐含的精度为n=6位。<br>针对字符输出，%m.ns：输出占m列，但只取字符串中左端n个字符。</li>
<li>l：l对整型指long型，对实型指double型。</li>
<li>h：用于将整型的格式字符修正为short型。</li>
</ol>
<h2 id="格式输出数据类型控制"><a href="#格式输出数据类型控制" class="headerlink" title="格式输出数据类型控制"></a><strong>格式输出数据类型控制</strong></h2><ol>
<li>d格式：用来输出十进制整数。%ld：输出长整型数据。%md：m为指定的输出字段的宽度。</li>
<li>o格式：以无符号八进制形式输出整数。对长整型可以用”%lo”格式输出。同样也可以指定字段宽度用“%mo”格式输出。</li>
<li>x格式：以无符号十六进制形式输出整数。对长整型可以用”%lx”格式输出。同样也可以指定字段宽度用”%mx”格式输出。</li>
<li>u格式：以无符号十进制形式输出整数。对长整型可以用”%lu”格式输出。同样也可以指定字段宽度用“%mu”格式输出。</li>
<li>c格式：输出一个字符。</li>
<li>s格式：用来输出一个字符串</li>
<li>f格式：用来输出实数（包括单、双精度），以小数形式输出。</li>
<li>e格式：以指数形式输出实数。</li>
<li>g格式：自动选f格式或e格式中较短的一种输出，且不输出无意义的零。</li>
</ol>
<h2 id="m-n格式另一种表述"><a href="#m-n格式另一种表述" class="headerlink" title="m.n格式另一种表述"></a><strong>m.n格式另一种表述</strong></h2><p>对于m.n的格式还可以用如下方法表示：</p>
<pre><code>printf(“%*.*s\n”,m,n,ch);</code></pre><p>前边的*定义的是总的宽度，后边的定义的是输出的个数。<br>分别对应外面的参数m和n 。<br>这种方法的好处是可以在语句之外对参数m和n赋值，从而控制输出格式。</p>
<p>例如：函数接口传给你一个没有“\0”结尾的字符串str和他的长度str_len，调试的时候你需要将其打印出来。</p>
<pre><code>printf(&quot;%.*s\n&quot;, str_len, str);</code></pre><h2 id="printf输出字符串长度"><a href="#printf输出字符串长度" class="headerlink" title="printf输出字符串长度"></a><strong>printf输出字符串长度</strong></h2><p>输出格式 <strong>%n</strong> 可以将所输出字符串的长度值赋绐一个变量:</p>
<pre><code>int slen;
printf(“hello world%n”, &amp;slen);</code></pre><p>执行后变量slen被赋值为11。</p>
<h2 id="输出颜色"><a href="#输出颜色" class="headerlink" title="输出颜色"></a><strong>输出颜色</strong></h2><pre><code>printf(&quot;\033[31m test print color \033[0m\n&quot;);</code></pre><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h2><pre><code>printf(&quot;%3s, \n%7.2s, \n%.4s, \n%-5.3s\n&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;);
gcc main.c
./a.out
PRINTF, 
     PR, 
PRIN, 
PRI  </code></pre><p>解析如下：</p>
<ol>
<li><strong>%s</strong>原样输出字符串: %s</li>
<li><strong>%ns</strong>输出指定长度n的字符串, 超长时不截断, 不足时右对齐: %3s</li>
<li><strong>%m.ns</strong>输出指定长度的字符串, 超长时截断, 不足时<strong>右对齐</strong>，m为最终的字符串输出长度，n为从参数字符串中取出的子串长度: %7.2s</li>
<li><strong>%.ns</strong>输出指定长度的字符串, 超长时截断，不足时右对齐: %.4s; 如果使用 %.8s 与%s %3s效果一样</li>
<li><strong>%-m.ns</strong>输出指定长度的字符串, 超长时截断, 不足时<strong>左对齐</strong>: %-5.3s</li>
</ol>
<p>通过上述用例，所谓超长时截断用到的n并不是只在超长时才起作用，而是不管你有没有超长，都必须截取这么长。<br>上述m,n是可以动态指定的，方法是用*代替m或者n，然后在参数列表里加上一个数字参数</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><span class="space">&hellip;</span><a class="page-number" href="/page/32/">32</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Breeze.Temple"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Breeze.Temple</p>
  <div class="site-description" itemprop="description">Breeze.Temple</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">468</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">63</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">506</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/breezetemple" title="GitHub &rarr; https://github.com/breezetemple" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org" title="BitBucket &rarr; https://bitbucket.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-bitbucket"></i>BitBucket</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://breezetemple.github.io/" title="http://breezetemple.github.io/" rel="noopener" target="_blank">Breeze.Temple's HomePage</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Breeze.Temple</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">18:42</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  


  <link rel="stylesheet" href="/js/highlight/styles/solarized-dark.css">
  <script src="/js/highlight/highlight.pack.js"></script>
  <script type="text/javascript">
      $(function() {
          hljs.initHighlighting();
      });
  </script>

</body>
</html>

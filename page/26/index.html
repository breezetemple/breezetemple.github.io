<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="Breeze.Temple">
<meta property="og:type" content="website">
<meta property="og:title" content="IT日记">
<meta property="og:url" content="http://yoursite.com/page/26/index.html">
<meta property="og:site_name" content="IT日记">
<meta property="og:description" content="Breeze.Temple">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Breeze.Temple">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/26/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>IT日记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IT日记</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Life is Now.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="Searching..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/10/vim-astyle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/10/vim-astyle/" class="post-title-link" itemprop="url">AStyle代码排版整理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-11 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-11T00:00:00+08:00">2015-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>两种安装方式：</p>
<ol>
<li><a href="http://sourceforge.net/projects/astyle/files/" target="_blank" rel="noopener">官网</a>下载源码编译安装</li>
<li>sudo apt-get install astyle</li>
</ol>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>两种配置方式：</p>
<ol>
<li>配置文件~/.astylerc</li>
<li>执行命令携带参数</li>
</ol>
<p>配置文件例子如下：</p>
<pre><code>--style=linux                  # -A8
--indent=force-tab             # -T,  强制 TAB 缩进
--break-blocks                 # -f,  Pad empty lines around header blocks (e.g. &#39;if&#39;, &#39;for&#39;, &#39;while&#39;...)
--attach-namespaces            # -xn, Attach brackets to a namespace statement
--attach-classes               # -xc, Attach brackets to a class statement
--delete-empty-lines           # -xe, 删除函数内多余的空行
--align-pointer=name           # -k3, *号靠近变量名
--remove-brackets              # -xj, if,while,for 等代码是单行行时，去掉 {}
--close-templates              # -xy, 模板中无空格, 如：Stack&lt;int,List&lt;int&gt;&gt; stack1;
--pad-oper                     # -p,  运算符两边加空格
--indent-preproc-define        # -w,  宏定义缩进
--indent-col1-comments         # -y,  注释缩进
--unpad-paren                  # -U,  Remove extra space padding around parenthesis on the inside and outside
--pad-header                   # -H,  关键字后加空格
--break-after-logical          # -xL
--lineend=linux                # -z2
--indent=tab                   # -t</code></pre><p>执行参数例子如下：</p>
<pre><code>-A8xnxcxek3xyfTpEwyUHxLz3t</code></pre><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>自动排版命令：</p>
<pre><code>indent -npsl
astyle -A8xnxcxek3xyfTpEwyUHxLz3t
find -name &quot;*.[ch]*&quot; | xargs indent -npsl | xargs astyle -A8xnxcxek3xyfTpEwyUHxLz3t</code></pre><h2 id="与vim结合"><a href="#与vim结合" class="headerlink" title="与vim结合"></a>与vim结合</h2><p>最终成品如下：</p>
<pre><code>function! CodeFormat()
    ks
    &quot;let curfile = expand(&quot;%&quot;)
    &quot;let curfile = expand(&quot;%:t&quot;)
    &quot;echo curfile
    silent! %s/^M//g
    silent! exec &#39;%!astyle -A3LYfpjk3NSEUHwyW3xC100 --style=break&#39;
    silent! %g/^\s*$\n\s*$/d
    silent! %s/\s\+$//g
    &#39;s
endfunction

autocmd BufNewFile,BufRead *.c call CodeFormat()
autocmd BufNewFile,BufRead *.h call CodeFormat()
nmap &lt;leader&gt;&lt;leader&gt;q :call CodeFormat()&lt;CR&gt;</code></pre><p>解析如下：</p>
<ul>
<li>ks ‘s 保存当前行位置</li>
<li>expand(“%”) 取file变量</li>
<li>expand(“%:t”) 取文件名</li>
<li>silent! 静默执行命令</li>
<li>%s/^M//g 将<br>删除，相当于dos2unix</li>
<li>exec 执行命令</li>
<li>%!astyle -A3LYfpjk3NSEUHwyW3xC100 –style=break 携带参数执行外部命令</li>
<li>%g/^\s<em>$\n\s</em>$/d 删除多行空行为一行</li>
<li>%s/\s+$//g 删除行尾空格</li>
<li>autocmd BufNewFile,BufRead *.c 打开c文件时，自动调用函数CodeFormat()</li>
<li>nmap 映射快捷键</li>
</ul>
<p>astyle参数解析：</p>
<ul>
<li>-A3: Kernighan &amp; Ritchie style uses linux brackets</li>
<li>-L: 标签缩进</li>
<li>-Y: 注释缩进</li>
<li>-f: 空行分隔没有关系的块,类,标签(不包括函数块)</li>
<li>-p: 操作符两端插入一个空格 </li>
<li>-j: if,while,for 等代码是单行行时，加 {}</li>
<li>-k3: *号靠近变量名</li>
<li>-N: 缩进命名空间定义行</li>
<li>-S: switch 与case不同列,case缩进</li>
<li>-E: 块间空行的换行符前插入一个空格</li>
<li>-U: 移除括号两端多余空格</li>
<li>-H: 关键字后加空格</li>
<li>-w: 宏定义缩进</li>
<li>-y: else catch左边的大括号与else catch分隔</li>
<li>-W3: &amp;号靠近变量名</li>
<li>-xC100: 代码最大长度100,超过之后进行换行</li>
</ul>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol>
<li><a href="http://tonybai.com/2010/07/29/use-astyle-to-beautify-your-code/" target="_blank" rel="noopener">使用astyle美化代码</a></li>
<li><a href="http://blog.163.com/jiangmc@yeah/blog/static/126590885201031611844360/" target="_blank" rel="noopener">Vim整合AStyle进行代码美化</a></li>
<li><a href="http://blog.chinaunix.net/uid-20662363-id-1904145.html" target="_blank" rel="noopener"> Astyle编程语言格式化工具的中文说明 </a></li>
<li><a href="http://blog.csdn.net/memory_xj/article/details/2983093" target="_blank" rel="noopener">Astyle：代码格式化工具简明指南</a></li>
<li><a href="http://astyle.sourceforge.net/astyle.html" target="_blank" rel="noopener">Artistic Style 3.1</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/09/udp-packet-loss/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/09/udp-packet-loss/" class="post-title-link" itemprop="url">网络性能调优（TCP/UDP）</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-10 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-10T00:00:00+08:00">2015-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Socket/" itemprop="url" rel="index">
                    <span itemprop="name">Socket</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="检查协议栈buffer"><a href="#检查协议栈buffer" class="headerlink" title="检查协议栈buffer"></a><strong>检查协议栈buffer</strong></h2><p>检查buffer大小，修改之后重启网络服务：</p>
<pre><code>sysctl -a |grep net.core
net.core.rmem_default = 212992
net.core.rmem_max = 212992</code></pre><p>检查网卡收包情况：</p>
<pre><code>2015 git:(master)✗ &gt; netstat -su
IcmpMsg:
    InType3: 366
    OutType3: 325
Udp:
    88110 packets received
    325 packets to unknown port received.
    0 packet receive errors
    6219 packets sent
    IgnoredMulti: 2208
UdpLite:
IpExt:
    InMcastPkts: 1945
    OutMcastPkts: 35
    InBcastPkts: 42730
    OutBcastPkts: 261
    InOctets: 192296247659
    OutOctets: 192200794856
    InMcastOctets: 220327
    OutMcastOctets: 5370
    InBcastOctets: 4953400
    OutBcastOctets: 30722
    InNoECTPkts: 6131438
    InECT0Pkts: 127</code></pre><h2 id="检查socket收发缓冲区"><a href="#检查socket收发缓冲区" class="headerlink" title="检查socket收发缓冲区"></a><strong>检查socket收发缓冲区</strong></h2><p>TCP 的性能取决于几个方面的因素。两个最重要的因素是：</p>
<ol>
<li>链接带宽（link bandwidth）（报文在网络上传输的速率）</li>
<li>往返时间（round-trip time） 或 RTT（发送报文与接收到另一端的响应之间的延时）</li>
</ol>
<p><strong>这两个值确定了称为 Bandwidth Delay Product（BDP）的内容</strong>。<br>给定链接带宽和 RTT 之后，您就可以计算出 BDP 的值了，<br><strong>BDP 给出了一种简单的方法来计算理论上最优的 TCP socket 缓冲区大小</strong>（其中保存了排队等待传输和等待应用程序接收的数据）。</p>
<p>如果缓冲区太小，那么 TCP 窗口就不能完全打开，这会对性能造成限制。<br>如果缓冲区太大，那么宝贵的内存资源就会造成浪费。<br>如果您设置的缓冲区大小正好合适，那么就可以完全利用可用的带宽。下面我们来看一个例子：</p>
<p>如果应用程序是通过一个 100Mbps 的局域网进行通信，其 RRT 为 50 ms，那么 BDP 就是：</p>
<pre><code>BDP = link_bandwidth * RTT
100MBps * 0.050 sec / 8 = 0.625MB = 625KB</code></pre><p>注意：此处除以 8 是将位转换成通信使用的字节。</p>
<p>因此，我们可以将 TCP 窗口设置为 BDP 或 1.25MB。<br>但是在 <strong>Linux 2.6 上默认的 TCP 窗口大小是 110KB</strong>，这会将连接的带宽限制为 2.2MBps，计算方法如下：</p>
<pre><code>throughput = window_size / RTT
110KB / 0.050 = 2.2MBps</code></pre><p>如果使用上面计算的窗口大小，我们得到的带宽就是 12.5MBps，计算方法如下：</p>
<pre><code>625KB / 0.050 = 12.5MBps</code></pre><p>差别的确很大，并且可以为 socket 提供更大的吞吐量。<br>Sockets API 提供了几个 socket 选项，其中两个可以用于修改 socket 的发送和接收缓冲区的大小。<br><strong>使用 SO_SNDBUF 和 SO_RCVBUF 选项来调整发送和接收缓冲区的大小</strong>。<br>注意：尽管 socket 缓冲区的大小确定了通告 TCP 窗口的大小，但是 TCP 还在通告窗口内维护了一个拥塞窗口。<br>因此，由于这个拥塞窗口的存在，给定的 socket 可能永远都不会利用最大的通告窗口。</p>
<p>修改默认socket收发缓冲区大小：</p>
<pre><code>int ret, sock, sock_buf_size;
sock = socket( AF_INET, SOCK_STREAM, 0  );
sock_buf_size = 64*1024;
ret = setsockopt( sock, SOL_SOCKET, SO_SNDBUF,
        (char *)&amp;sock_buf_size, sizeof(sock_buf_size) );
ret = setsockopt( sock, SOL_SOCKET, SO_RCVBUF,
        (char *)&amp;sock_buf_size, sizeof(sock_buf_size) );</code></pre><h2 id="禁用-Nagle-算法"><a href="#禁用-Nagle-算法" class="headerlink" title="禁用 Nagle 算法"></a>禁用 Nagle 算法</h2><p>在通过 TCP socket 进行通信时，数据都拆分成了数据块，<br>这样它们就可以封装到给定连接的 TCP payload（指 TCP 数据包中的有效负荷）中了。<br>TCP payload 的大小取决于几个因素（例如最大报文长度和路径），<br>但是这些因素在连接发起时都是已知的。<br>为了达到最好的性能，我们的目标是使用尽可能多的可用数据来填充每个报文。<br><strong>当没有足够的数据来填充 payload 时（也称为最大报文段长度（maximum segment size） 或 MSS），<br>TCP 就会采用 Nagle 算法自动将一些小的缓冲区连接到一个报文段中。</strong><br>这样可以通过最小化所发送的报文的数量来提高应用程序的效率，并减轻整体的网络拥塞问题。</p>
<p>尽管 John Nagle 的算法可以通过将这些数据连接成更大的报文来最小化所发送的报文的数量，<br>但是有时您可能希望只发送一些较小的报文。<br>一个简单的例子是 telnet 程序，它让用户可以与远程系统进行交互，这通常都是通过一个 shell 来进行的。<br>如果用户被要求用发送报文之前输入的字符来填充某个报文段，那么这种方法就绝对不能满足我们的需要。<br>另外一个例子是 HTTP 协议。通常，客户机浏览器会产生一个小请求（一条 HTTP 请求消息），<br>然后 Web 服务器就会返回一个更大的响应（Web 页面）。</p>
<p>您应该考虑的第一件事情是 Nagle 算法满足一种需求。<br><strong>由于这种算法对数据进行合并，试图构成一个完整的 TCP 报文段，因此它会引入一些延时。</strong><br>但是这种算法可以最小化在线路上发送的报文的数量，因此可以最小化网络拥塞的问题。<br>但是在需要最小化传输延时的情况中，Sockets API 可以提供一种解决方案。<br>要<strong>禁用 Nagle 算法，您可以设置 TCP_NODELAY socket 选项。</strong></p>
<p>为TCP socket 禁用 Nagle 算法</p>
<pre><code>int sock, flag, ret;
/* Create new stream socket */
sock = socket( AF_INET, SOCK_STREAM, 0  );
/* Disable the Nagle (TCP No Delay) algorithm */
flag = 1;
ret = setsockopt( sock, IPPROTO_TCP, TCP_NODELAY, (char *)&amp;flag, sizeof(flag)  );
if (ret == -1) {
printf(&quot;Couldn&#39;t setsockopt(TCP_NODELAY)\n&quot;);
    exit(-1);
}</code></pre><p>使用 Samba 的实验表明，在从 Microsoft® Windows® 服务器上的 Samba 驱动器上读取数据时，禁用 Nagle 算法几乎可以加倍提高读性能。</p>
<h2 id="tcp"><a href="#tcp" class="headerlink" title="tcp"></a>tcp</h2><p>我们知道TCP链接是有很多开销的，<strong>一个是会占用文件描述符，另一个是会开缓存</strong>，<br>一般来说一个系统可以支持的TCP链接数是有限的，我们需要清楚地认识到<strong>TCP链接对系统的开销是很大的</strong>。<br>正是因为TCP是耗资源的，所以，很多攻击都是让你系统上出现大量的TCP链接，把你的系统资源耗尽。比如著名的SYNC Flood攻击。</p>
<p>所以，我们要<strong>注意配置KeepAlive参数</strong>，这个参数的意思是定义一个时间，<br>如果链接上没有数据传输，系统会在这个时间发一个包，如果没有收到回应，<br>那么TCP就认为链接断了，然后就会把链接关闭，这样可以回收系统资源开销。<br>（注：HTTP层上也有KeepAlive参数）对于像HTTP这样的短链接，设置一个1-2分钟的keepalive非常重要。<br>这可以在一定程度上防止DoS攻击。有下面几个参数（下面这些参数的值仅供参考）：</p>
<pre><code>net.ipv4.tcp_keepalive_probes = 5
net.ipv4.tcp_keepalive_intvl = 20
net.ipv4.tcp_fin_timeout = 30</code></pre><p>对于TCP的TIME_WAIT这个状态，主动关闭的一方进入TIME_WAIT状态，<br>TIME_WAIT状态将持续2个MSL(Max Segment Lifetime)，默认为4分钟，TIME_WAIT状态下的资源不能回收。<br>有大量的TIME_WAIT链接的情况一般是在HTTP服务器上。对此，有两个参数需要注意，</p>
<pre><code>net.ipv4.tcp_tw_reuse=1
net.ipv4.tcp_tw_recycle=1</code></pre><p>前者表示重用TIME_WAIT，后者表示回收TIME_WAIT的资源。</p>
<p><strong>TCP还有一个重要的概念叫RWIN（TCP Receive Window Size），<br>这个东西的意思是，我一个TCP链接在没有向Sender发出ack时可以接收到的最大的数据包。<br>为什么这个很重要？因为如果Sender没有收到Receiver发过来ack，<br>Sender就会停止发送数据并会等一段时间，如果超时，那么就会重传。<br>这就是为什么TCP链接是可靠链接的原因。<br>重传还不是最严重的，如果有丢包发生的话，TCP的带宽使用率会马上受到影响（会盲目减半），<br>再丢包，再减半，然后如果不丢包了，就逐步恢复。</strong>相关参数如下：</p>
<pre><code>net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216</code></pre><p>一般来说，<strong>理论上的RWIN应该设置成：吞吐量 * 回路时间</strong>。<br><strong>Sender端的buffer应该和RWIN有一样的大小</strong>，<br>因为Sender端发送完数据后要等Receiver端确认，如果网络延时很大，<br>buffer过小了，确认的次数就会多，于是性能就不高，对网络的利用率也就不高了。<br>也就是说，<strong>对于延迟大的网络，我们需要大的buffer，这样可以少一点ack，多一些数据，对于响应快一点的网络，可以少一些buffer</strong>。<br>因为，如果有丢包（没有收到ack），buffer过大可能会有问题，因为这会让TCP重传所有的数据，反而影响网络性能。<br>（当然，网络差的情况下，就别玩什么高性能了） 所以，<br>高性能的网络重要的是要让网络丢包率非常非常地小（基本上是用在LAN里），<br>如果网络基本是可信的，这样用大一点的buffer会有更好的网络传输性能（来来回回太多太影响性能了）。</p>
<h2 id="udp"><a href="#udp" class="headerlink" title="udp"></a>udp</h2><p>说到UDP的调优，有一些事我想重点说一样，那就是<strong>MTU——最大传输单元（其实这对TCP也一样，因为这是链路层上的东西）</strong>。<br>对于一个UDP的包，我们要尽量地让他大到MTU的最大尺寸再往网络上传，这样可以最大化带宽利用率。<br>对于这个MTU，以太网是1500字节，光纤是4352字节，802.11无线网是7981。<br>但是，当我们用TCP/UDP发包的时候，<br>我们的有效负载Payload要低于这个值，因为<strong>IP协议会加上20个字节，UDP会加上8个字节（TCP加的更多）</strong>，<br>所以，一般来说，你的一个UDP包的最大应该是1500-8-20=1472，这是你的数据的大小。<br>当然，如果你用光纤的话， 这个值就可以更大一些。</p>
<p>再多说一下，使用Socket编程的时候，你可以<strong>使用setsockopt() 设置 SO_SNDBUF/SO_RCVBUF 的大小，TTL和KeepAlive这些关键的设置</strong></p>
<h2 id="多路复用"><a href="#多路复用" class="headerlink" title="多路复用"></a>多路复用</h2><p>关于多路复用技术，也就是用一个线程来管理所有的TCP链接，有三个系统调用要重点注意：</p>
<ol>
<li>一个是select，这个系统调用只支持上限1024个链接</li>
<li>第二个是poll，其可以突破1024的限制，但是select和poll本质上是使用的轮询机制，<br>轮询机制在链接多的时候性能很差，因主是O(n)的算法</li>
<li>所以，epoll出现了，epoll是操作系统内核支持的，仅当在链接活跃时，操作系统才会callback，<br>这是由操作系统通知触发的，但其只有Linux Kernel 2.6以后才支持（准确说是2.5.44中引入的），<br>当然，如果所有的链接都是活跃的，过多的使用epoll_ctl可能会比轮询的方式还影响性能，不过影响的不大。</li>
</ol>
<p>另外，<strong>关于一些和DNS Lookup的系统调用要小心，比如：gethostbyaddr/gethostbyname，<br>这个函数可能会相当的费时，因为其要到网络上去找域名，因为DNS的递归查询，会导致严重超时，<br>而又不能通过设置什么参数来设置time out</strong>，<br>对此你可以通过配置hosts文件来加快速度，或是自己在内存中管理对应表，在程序启动时查好，<br>而不要在运行时每次都查。</p>
<p>另外，<strong>在多线程下面，gethostbyname会一个更严重的问题，<br>就是如果有一个线程的gethostbyname发生阻塞，<br>其它线程都会在gethostbyname处发生阻塞</strong>，这个比较变态，要小心。<br>（你可以试试GNU的gethostbyname_r()，这个的性能要好一些） 这种到网上找信息的东西很多，<br>比如，如果你的Linux使用了NIS，或是NFS，某些用户或文件相关的系统调用就很慢，所以要小心。</p>
<h2 id="检查防火墙"><a href="#检查防火墙" class="headerlink" title="检查防火墙"></a>检查防火墙</h2><pre><code>iptables -L</code></pre><p>如果iptables工作，需要关闭：</p>
<pre><code>service iptables stop</code></pre><h2 id="Linux内核参数优化"><a href="#Linux内核参数优化" class="headerlink" title="Linux内核参数优化"></a>Linux内核参数优化</h2><ol>
<li>/proc/sys/net/core/rmem_max — 最大的TCP数据接收缓冲。</li>
<li>/proc/sys/net/core/wmem_max — 最大的TCP数据发送缓冲。</li>
<li>/proc/sys/net/ipv4/tcp_timestamps — 时间戳在(请参考RFC 1323)TCP的包头增加12个字节。</li>
<li>/proc/sys/net/ipv4/tcp_sack — 有选择的应答。</li>
<li>/proc/sys/net/ipv4/tcp_window_scaling — 支持更大的TCP窗口. 如果TCP窗口最大超过65535(64KB), 必须设置该数值为1。</li>
<li>rmem_default — 默认的接收窗口大小。</li>
<li>rmem_max — 接收窗口的最大大小。</li>
<li>wmem_default — 默认的发送窗口大小。</li>
<li>wmem_max — 发送窗口的最大大小。</li>
</ol>
<p>/proc目录下的所有内容都是临时性的, 所以重启动系统后任何修改都会丢失。<br>建议在系统启动时自动修改TCP/IP参数，两种方式：</p>
<ol>
<li>修改/etc/rc.local</li>
<li>修改/etc/sysctl.conf </li>
</ol>
<h2 id="GUN-Linux网络工具"><a href="#GUN-Linux网络工具" class="headerlink" title="GUN/Linux网络工具"></a>GUN/Linux网络工具</h2><p>GNU/Linux 提供了几个工具 —— 有些是 GNU/Linux 自己提供的，<br>有些是开放源码软件 —— 用于调试网络应用程序，测量带宽/吞吐量，以及检查链接的使用情况。</p>
<p><strong>任何 GNU/Linux 发行版中都可以找到的工具：</strong></p>
<ol>
<li><strong>ping</strong>这是用于检查主机的可用性的最常用的工具，但是也可以用于识别带宽延时产品计算的 RTT。</li>
<li><strong>traceroute</strong>打印某个连接到网络主机所经过的包括一系列路由器和网关的路径（路由），从而确定每个 hop 之间的延时。</li>
<li><strong>netstat</strong>确定有关网络子系统、协议和连接的各种统计信息。</li>
<li><strong>tcpdump</strong>显示一个或多个连接的协议级的报文跟踪信息；其中还包括时间信息，您可以使用这些信息来研究不同协议服务的报文时间。</li>
</ol>
<p><strong>GNU/Linux 发行版中没有提供的有用性能工具：</strong></p>
<ol>
<li><strong>netlog</strong>为应用程序提供一些有关网络性能方面的信息。</li>
<li><strong>nettimer</strong>为瓶颈链接带宽生成一个度量标准；可以用于协议的自动优化。</li>
<li><strong>Ethereal</strong>以一个易于使用的图形化界面提供了 tcpump（报文跟踪）的特性。</li>
<li><strong>iperf</strong>测量 TCP 和 UDP 的网络性能；测量最大带宽，并汇报延时和数据报的丢失情况。</li>
</ol>
<h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><ol>
<li><a href="http://www.ibm.com/developerworks/cn/linux/l-hisock.html" target="_blank" rel="noopener">提高 Linux 上 socket 性能</a></li>
<li><a href="http://my.oschina.net/sharelinux/blog/146282" target="_blank" rel="noopener">浅谈linux性能调优之十四:调节socket缓冲区</a></li>
<li><a href="http://coolshell.cn/articles/7490.html" target="_blank" rel="noopener">性能调优攻略</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/08/tcp-udp-send-sendto/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/08/tcp-udp-send-sendto/" class="post-title-link" itemprop="url">tcp udp send流程分析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-09 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-09T00:00:00+08:00">2015-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/Socket/" itemprop="url" rel="index">
                    <span itemprop="name">Socket</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/" itemprop="url" rel="index">
                    <span itemprop="name">Network</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network/TCP/" itemprop="url" rel="index">
                    <span itemprop="name">TCP</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a><strong>tips</strong></h2><p>net/ipv4/af_inet.c 查看：inet_stream_ops 和 inet_dgram_ops</p>
<h2 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a><strong>TCP和UDP</strong></h2><p>TCP（传输控制协议）和UDP（用户数据报协议）是网络体系结构TCP/IP模型中传输层一层中的两个不同的通信协议。</p>
<ol>
<li>TCP：传输控制协议，一种面向连接的协议，给用户进程提供可靠的全双工的字节流，TCP套接口是字节流套接口(stream socket)的一种。</li>
<li>UDP：用户数据报协议。UDP是一种无连接协议。UDP套接口是数据报套接口(datagram socket)的一种。</li>
</ol>
<h3 id="TCP-Client-Server框架"><a href="#TCP-Client-Server框架" class="headerlink" title="TCP Client-Server框架"></a><strong>TCP Client-Server框架</strong></h3><p><img src="/images/socket/tcp-socket.jpg" alt="TCP" title="TCP"></p>
<p>服务器程序流程：</p>
<ol>
<li>程序初始化</li>
<li>填写本机地址信息</li>
<li>绑定并监听一个固定的端口</li>
<li>收到Client的连接后建立一个socket连接</li>
<li>产生一个新的进程与Client进行通信和信息处理</li>
<li>子通信结束后中断与Client的连接</li>
</ol>
<p>客户端程序流程：</p>
<ol>
<li>程序初始化</li>
<li>填写服务器地址信息</li>
<li>连接服务器</li>
<li>与服务器通信和信息处理</li>
<li>通信结束后断开连接</li>
</ol>
<h3 id="UDP-Client-Server框架"><a href="#UDP-Client-Server框架" class="headerlink" title="UDP Client-Server框架"></a><strong>UDP Client-Server框架</strong></h3><p><img src="/images/socket/udp-socket.jpg" alt="UDP" title="UDP"></p>
<p>服务器程序流程：</p>
<ol>
<li><p>程序初始化</p>
</li>
<li><p>填写本机地址信息</p>
</li>
<li><p>绑定一个固定的端口</p>
</li>
<li><p>收到Client的数据报后进行处理与通信</p>
</li>
<li><p>通信结束后断开连接</p>
<p>客户端程序流程：</p>
</li>
<li><p>程序初始化</p>
</li>
<li><p>填写服务器地址信息</p>
</li>
<li><p>与服务器通信和信息处理</p>
</li>
<li><p>通信结束后断开连接</p>
</li>
</ol>
<h3 id="Socket编程"><a href="#Socket编程" class="headerlink" title="Socket编程"></a><strong>Socket编程</strong></h3><p>Socket接口是TCP/IP网络的API，<br>网络的Socket数据传输是一种特殊的I/O，Socket也是一种文件描述符。<br>常用的Socket类型有两种：<strong>流式Socket（SOCK_STREAM）</strong>和<strong>数据报式Socket（SOCK_DGRAM）</strong>。</p>
<ol>
<li>流式是一种面向连接的Socket，针对于面向连接的TCP服务应用</li>
<li>数据报式Socket是一种无连接的Socket，对应于无连接的UDP服务应用</li>
</ol>
<p><strong>创建套接字</strong></p>
<pre><code>int socket(int domain, int type, int protocol);</code></pre><p><strong>建立地址和套接字的联系</strong></p>
<pre><code>int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></pre><p><strong>服务器端侦听客户端的请求</strong></p>
<pre><code>int listen(int sockfd, int backlog);</code></pre><p><strong>建立服务器/客户端的连接 (面向连接TCP）</strong></p>
<pre><code>//客户端请求连接 
int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);

//服务器端从编号为Sockid的Socket上接收客户连接请求 
newsockid=accept(Sockid，Clientaddr, paddrlen)</code></pre><p><strong>发送/接收数据</strong></p>
<pre><code>//面向连接：
ssize_t send(int sockfd, const void *buf, size_t len, int flags);
ssize_t recv(int sockfd, void *buf, size_t len, int flags);

//面向无连接：
ssize_t sendto(int sockfd, const void *buf, size_t len, int flags, const struct sockaddr *dest_addr, socklen_t addrlen);
ssize_t recvfrom(int sockfd, void *buf, size_t len, int flags, struct sockaddr *src_addr, socklen_t *addrlen);</code></pre><p><strong>释放套接字</strong></p>
<pre><code>int close(int fd);</code></pre><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a><strong>区别</strong></h3><ol>
<li>socket()的参数不同</li>
<li>UDP Server不需要调用listen和accept</li>
<li>UDP收发数据用sendto/recvfrom函数</li>
<li>TCP：地址信息在connect/accept时确定</li>
<li>UDP：在sendto/recvfrom函数中每次均需指定地址信息(客户端调用connect之后，不需要每次指定)</li>
<li>UDP：shutdown函数无效</li>
</ol>
<h3 id="socket插入内核hash表"><a href="#socket插入内核hash表" class="headerlink" title="socket插入内核hash表"></a><strong>socket插入内核hash表</strong></h3><p>根据服务器和客户端的行为不同，bind()和sendto()都会调用到get_port()，<br>也就是说，在bind()或sendto()调用时，socket才被插入到内核表中。</p>
<p><strong>bind() 绑定地址</strong></p>
<pre><code>sys_bind -&gt; sock-&gt;ops-&gt;bind -&gt; inet_bind -&gt; sk-&gt;sk_prot-&gt;get_port</code></pre><p>sk-&gt;sk_prot是udp_prot，这里实际调用udp_v4_get_port()函数。</p>
<p><strong>sendto() 发送到指定地址</strong></p>
<pre><code>sys_sendto -&gt; sock_sendmsg -&gt; __sock_sendmsg -&gt; sock-&gt;ops-&gt;sendmsg</code></pre><p>由于<strong>创建的是udp socket，因此sock-&gt;ops指向inet_dgram_ops</strong>，sendmsg()实际调用inet_sendmsg()函数。该函数中的有如下语句：</p>
<pre><code>if (!inet_sk(sk)-&gt;inet_num &amp;&amp; inet_autobind(sk))  
    return -EAGAIN;  </code></pre><p>客户端在执行sendto()前仅仅执行了socket()操作，<br>此时inet_num=0，因此执行了inet_autobind()，<br>该函数会调用sk-&gt;sk_prot-&gt;get_port()。<br>从而回到了udp_v4_get_port()函数，它会将sk插入到内核表udp_table中。</p>
<h2 id="UDP调用connect"><a href="#UDP调用connect" class="headerlink" title="UDP调用connect"></a><strong>UDP调用connect</strong></h2><p>标准的udp客户端开了套接口后，一般使用sendto和recvfrom函数来发数据，<br>udp发送数据有两种方法供大家选用的：</p>
<ol>
<li>socket–&gt;sendto()或recvfrom() </li>
<li>socket–&gt;connect()–&gt;send()或recv()</li>
</ol>
<p>sendto和recvfrom在收发时指定地址，而send和recv则没有，地址是在connect指定的.</p>
<pre><code>int connect(int sockfd, const struct sockaddr *serv_addr, socklen_t addrlen);</code></pre><p>在udp编程中，如果你只往一个地址发送，那么你可以使用send和recv，<br>在使用它们之前用connect指定目的地址。connect函数在udp中就是这个作用，用它来检测udp端口的是否开放是没有用的。</p>
<p>udp中也有connect，只是它的connect不会进行三步握手，udp中调用connect时什么包也不发送。<br>调用connect是可选的，调用connect后就可以使用send、recv来进行UDP的收发包，而不必每次都要指定地址，<br>然后使用sendto、recvfrom进行操作，当然也可以调用sendto recvfrom。<br>没有调用connect那只能调用sendto、recvfrom，不可以调用send、recv。<br>调用sendto的时候第五个参数必须是NULL,第六个参数是0.<br>调用recvfrom,recv,read系统调用只能获取到先前connect的ip&amp;port发送的报文. </p>
<p>UDP中使用connect可以提高效率.原因如下:</p>
<ol>
<li>普通的UDP发送两个报文内核做了如下:#1:建立连结#2:发送报文#3:断开连结#4:建立连结#5:发送报文#6:断开连结</li>
<li>采用connect方式的UDP发送两个报文内核如下处理:#1:建立连结#2:发送报文#3:发送报文另外一点, 每次发送报文内核都由可能要做路由查询.</li>
</ol>
<p><strong>TCP中调用connect会引起三次握手,client与server建立连结.UDP中调用connect内核仅仅把对端ip&amp;port记录下来</strong>.<br><strong>UDP中可以多次调用connect,TCP只能调用一次connect</strong>.  UDP多次调用connect有两种用途:</p>
<ol>
<li><strong>指定一个新的ip&amp;port连结</strong>. 指定新连结,直接设置connect第二个参数即可.</li>
<li><strong>断开和之前的ip&amp;port的连结</strong>. 断开连结,需要将connect第二个参数中的sin_family设置成AF_UNSPEC即可. </li>
</ol>
<p>UDP中使用connect的好处:</p>
<ol>
<li>会提升效率</li>
<li>高并发服务中会增加系统稳定性</li>
</ol>
<p><strong>内核</strong>：发送时有两种调用方式：sys_send()和sys_sendto()，<br>两者的区别在于sys_sendto()需要给入目的地址的参数；<br>而sys_send()调用前需要调用sys_connect()来绑定目的地址信息；<br>两者的后续调用是相同的。如果调用sys_sendto()发送，<br>地址信息在sys_sendto()中从用户空间拷贝到内核空间，<br>而报文内容在udp_sendmsg()中从用户空间拷贝到内核空间。</p>
<h2 id="TCP使用sendto"><a href="#TCP使用sendto" class="headerlink" title="TCP使用sendto"></a><strong>TCP使用sendto</strong></h2><p>tcp_v4_connect函数代码片段：</p>
<pre><code>/* 记录目的端口和目的IP */
inet-&gt;dport = usin-&gt;sin_port;
inet-&gt;daddr = daddr;</code></pre><p><strong>将目标地址及端口记录在inet中</strong>！</p>
<p>同样的，TCP也可以调用sendto、recvfrom来完成数据的读写。<strong>Linux内核中send系统调用</strong>：</p>
<pre><code>SYSCALL_DEFINE4(send, int, fd, void __user *, buff, size_t, len,
    unsigned int, flags)
{
    return sys_sendto(fd, buff, len, flags, NULL, 0);
}</code></pre><p>可以看到，send直接调用sendto，后面两个参数直接填NULL，0，<br>因此对于TCP调用来将，使用sendto，并将后两个参数置0，一样可以工作。</p>
<h2 id="TCP-UDP-Send流程代码分析"><a href="#TCP-UDP-Send流程代码分析" class="headerlink" title="TCP/UDP Send流程代码分析"></a><strong>TCP/UDP Send流程代码分析</strong></h2><p>TCP调用sendto时没有给定地址，如何来完成TCP传输？sendto函数原型：</p>
<pre><code>SYSCALL_DEFINE6(sendto, int, fd, void __user *, buff, size_t, len,
    unsigned, flags, struct sockaddr __user *, addr,
    int, addr_len)
{
    struct socket *sock;
    struct sockaddr_storage address;
    int err;
    struct msghdr msg;
    struct iovec iov;
    int fput_needed;

    if (len &gt; INT_MAX)
        len = INT_MAX;
    sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed);
    if (!sock)
        goto out;

    iov.iov_base = buff;
    iov.iov_len = len;
    msg.msg_name = NULL;
    msg.msg_iov = &amp;iov;
    msg.msg_iovlen = 1;
    msg.msg_control = NULL;
    msg.msg_controllen = 0;
    msg.msg_namelen = 0;

    if (addr) {
        err = move_addr_to_kernel(addr, addr_len, (struct sockaddr *)&amp;address);
        if (err &lt; 0)
            goto out_put;
        msg.msg_name = (struct sockaddr *)&amp;address;
        msg.msg_namelen = addr_len;
    }

    if (sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK)
        flags |= MSG_DONTWAIT;
    msg.msg_flags = flags;
    err = sock_sendmsg(sock, &amp;msg, len);

    out_put:
        fput_light(sock-&gt;file, fput_needed);
    out:
        return err;
}                          </code></pre><p><strong>tips</strong>: 使用sock-&gt;file-&gt;f_flags &amp; O_NONBLOCK 来检查是否是nonblock的传送。</p>
<p>sendto中首先调用函数move_addr_to_kernel，将地址copy进内核空间：</p>
<pre><code>int move_addr_to_kernel(void __user *uaddr, int ulen, struct sockaddr *kaddr)                                                      
{
    if (ulen &lt; 0 || ulen &gt; sizeof(struct sockaddr_storage))
        return -EINVAL;
    if (ulen == 0)
        return 0;
    if (copy_from_user(kaddr, uaddr, ulen))
        return -EFAULT;
    return audit_sockaddr(ulen, kaddr);
}</code></pre><p>对于TCP来说，传入参数分别为NULL，0，这部分不会执行到。</p>
<pre><code>msg.msg_name = (struct sockaddr *)&amp;address;
msg.msg_namelen = addr_len;</code></pre><p><strong>地址存入msg中，用于UDP连接</strong>。</p>
<p>然后调用sock_sendmsg来完成数据发送，调用顺序：</p>
<pre><code>sys_send -&gt; sys_sendto -&gt; sock_sendmsg -&gt; __sock_sendmsg -&gt; sock-&gt;ops-&gt;sendmsg -&gt; inet_sendmsg -&gt; sk-&gt;sk_prot-&gt;sendmsg

static inline int __sock_sendmsg(struct kiocb *iocb, struct socket *sock,                                                          
        struct msghdr *msg, size_t size)
{
    struct sock_iocb *si = kiocb_to_siocb(iocb);
    int err;

    si-&gt;sock = sock;
    si-&gt;scm = NULL;
    si-&gt;msg = msg;
    si-&gt;size = size;

    err = security_socket_sendmsg(sock, msg, size);
    if (err)
        return err;

    return sock-&gt;ops-&gt;sendmsg(iocb, sock, msg, size);
}</code></pre><p><strong>根据socket不同具体对应于tcp_sendmsg、udp_sendmsg</strong></p>
<h3 id="udp-sendmsg"><a href="#udp-sendmsg" class="headerlink" title="udp sendmsg"></a><strong>udp sendmsg</strong></h3><p>udp_sendmsg代码分析：</p>
<pre><code>int udp_sendmsg(struct kiocb *iocb, struct sock *sk, struct msghdr *msg, size_t len);

struct inet_sock *inet = inet_sk(sk);
if (msg-&gt;msg_name) {
    struct sockaddr_in * usin = (struct sockaddr_in*)msg-&gt;msg_name;
    if (msg-&gt;msg_namelen &lt; sizeof(*usin))
        return -EINVAL;
    if (usin-&gt;sin_family != AF_INET) {
        if (usin-&gt;sin_family != AF_UNSPEC)
            return -EAFNOSUPPORT;
    }

    daddr = usin-&gt;sin_addr.s_addr;
    dport = usin-&gt;sin_port;
    if (dport == 0)
        return -EINVAL;
} else {
    if (sk-&gt;sk_state != TCP_ESTABLISHED)
        return -EDESTADDRREQ;
    daddr = inet-&gt;daddr;
    dport = inet-&gt;dport;
    /* Open fast path for connected socket.
       Route will not be used, if at least one option is set.
     */
    connected = 1;
}
ipc.addr = inet-&gt;saddr;</code></pre><p>这段代码<strong>获取要发送数据的目的地址和端口号</strong>。<br>一种情况是<strong>调用sendto()发送数据</strong>，此时目的的信息以参数传入，存储在msg-&gt;msg_name中，因此从中取出daddr和dport；<br>另一种情况是<strong>调用connect(), send()发送数据</strong>，在<strong>connect()调用时绑定了目的的信息，存储在inet中</strong>，<br>并且由于是调用了connect()，sk-&gt;sk_state会设置为TCP_ESTABLISHED。<br>以后调用send()发送数据时，无需要再给入目的信息参数，因此从inet中取出dadr和dport。而connected表示了该socket是否已绑定目的。</p>
<h3 id="tcp-sendmsg"><a href="#tcp-sendmsg" class="headerlink" title="tcp sendmsg"></a><strong>tcp sendmsg</strong></h3><p>tcp_sendmsg代码分析，调用流程：</p>
<pre><code>tcp_sendmsg -&gt; tcp_push -&gt; __tcp_push_pending_frames -&gt; tcp_write_xmit -&gt; tcp_transmit_skb

static int tcp_transmit_skb(struct sock *sk, struct sk_buff *skb, int clone_it,
        gfp_t gfp_mask)
{
    struct inet_sock *inet;
    .
    .
    inet = inet_sk(sk);
    /* Build TCP header and checksum it. */
    th = tcp_hdr(skb);
    th-&gt;source      = inet-&gt;sport;
    th-&gt;dest        = inet-&gt;dport;
    th-&gt;seq         = htonl(tcb-&gt;seq);
    th-&gt;ack_seq     = htonl(tp-&gt;rcv_nxt);
    *(((__be16 *)th) + 6)   = htons(((tcp_header_size &gt;&gt; 2) &lt;&lt; 12) |
            tcb-&gt;flags);
    .
    .
}</code></pre><p><strong>tcp_sendmsg目标地址在函数tcp_transmit_skb中获取，获取的值是调用connect时存储在inet中！</strong></p>
<ol>
<li><a href="http://www.cnblogs.com/hubavyn/p/4322819.html" target="_blank" rel="noopener">udp调用connect有什么作用</a></li>
<li><a href="http://blog.csdn.net/vonkingdom/article/details/7057832" target="_blank" rel="noopener">UDP 的Connect函数的例子</a></li>
<li><a href="http://blog.csdn.net/qy532846454/article/details/6993695" target="_blank" rel="noopener">Linux内核分析 - 网络：UDP模块 - 收发</a></li>
<li><a href="http://blog.csdn.net/qy532846454/article/details/6942667" target="_blank" rel="noopener">Linux内核分析 - 网络：UDP模块 - socket</a></li>
<li><a href="http://blog.csdn.net/cz_hyf/article/details/602802" target="_blank" rel="noopener">linux-Tcp IP协议栈源码阅读笔记</a></li>
<li><a href="http://blog.chinaunix.net/uid-13746440-id-4825005.html" target="_blank" rel="noopener">Linux TCP/IP源码分析 Connect</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5063e4c80101fvj3.html" target="_blank" rel="noopener">Linux TCP/IP 协议栈源码分析</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/11/02/printf-formats/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/02/printf-formats/" class="post-title-link" itemprop="url">printf格式化输出</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-03 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-03T00:00:00+08:00">2015-11-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="格式输出控制符"><a href="#格式输出控制符" class="headerlink" title="格式输出控制符"></a><strong>格式输出控制符</strong></h2><p>printf的格式控制的完整格式：<strong>%</strong>  <strong>-</strong>  <strong>0</strong>  <strong>m.n</strong>  <strong>l</strong>或<strong>h</strong>:</p>
<ol>
<li>%：格式说明的起始符号，不可缺少。</li>
<li>-： 有-表示左对齐输出，如省略表示右对齐输出。</li>
<li>0：有0表示指定空位填0,如省略表示指定空位不填。</li>
<li>m.n：m指域宽，即对应的输出项在输出设备上所占的字符数。n指精度，用于说明输出的实型数的小数位数。未指定n时，隐含的精度为n=6位。<br>针对字符输出，%m.ns：输出占m列，但只取字符串中左端n个字符。</li>
<li>l：l对整型指long型，对实型指double型。</li>
<li>h：用于将整型的格式字符修正为short型。</li>
</ol>
<h2 id="格式输出数据类型控制"><a href="#格式输出数据类型控制" class="headerlink" title="格式输出数据类型控制"></a><strong>格式输出数据类型控制</strong></h2><ol>
<li>d格式：用来输出十进制整数。%ld：输出长整型数据。%md：m为指定的输出字段的宽度。</li>
<li>o格式：以无符号八进制形式输出整数。对长整型可以用”%lo”格式输出。同样也可以指定字段宽度用“%mo”格式输出。</li>
<li>x格式：以无符号十六进制形式输出整数。对长整型可以用”%lx”格式输出。同样也可以指定字段宽度用”%mx”格式输出。</li>
<li>u格式：以无符号十进制形式输出整数。对长整型可以用”%lu”格式输出。同样也可以指定字段宽度用“%mu”格式输出。</li>
<li>c格式：输出一个字符。</li>
<li>s格式：用来输出一个字符串</li>
<li>f格式：用来输出实数（包括单、双精度），以小数形式输出。</li>
<li>e格式：以指数形式输出实数。</li>
<li>g格式：自动选f格式或e格式中较短的一种输出，且不输出无意义的零。</li>
</ol>
<h2 id="m-n格式另一种表述"><a href="#m-n格式另一种表述" class="headerlink" title="m.n格式另一种表述"></a><strong>m.n格式另一种表述</strong></h2><p>对于m.n的格式还可以用如下方法表示：</p>
<pre><code>printf(“%*.*s\n”,m,n,ch);</code></pre><p>前边的*定义的是总的宽度，后边的定义的是输出的个数。<br>分别对应外面的参数m和n 。<br>这种方法的好处是可以在语句之外对参数m和n赋值，从而控制输出格式。</p>
<p>例如：函数接口传给你一个没有“\0”结尾的字符串str和他的长度str_len，调试的时候你需要将其打印出来。</p>
<pre><code>printf(&quot;%.*s\n&quot;, str_len, str);</code></pre><h2 id="printf输出字符串长度"><a href="#printf输出字符串长度" class="headerlink" title="printf输出字符串长度"></a><strong>printf输出字符串长度</strong></h2><p>输出格式 <strong>%n</strong> 可以将所输出字符串的长度值赋绐一个变量:</p>
<pre><code>int slen;
printf(“hello world%n”, &amp;slen);</code></pre><p>执行后变量slen被赋值为11。</p>
<h2 id="输出颜色"><a href="#输出颜色" class="headerlink" title="输出颜色"></a><strong>输出颜色</strong></h2><pre><code>printf(&quot;\033[31m test print color \033[0m\n&quot;);</code></pre><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h2><pre><code>printf(&quot;%3s, \n%7.2s, \n%.4s, \n%-5.3s\n&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;, &quot;PRINTF&quot;);
gcc main.c
./a.out
PRINTF, 
     PR, 
PRIN, 
PRI  </code></pre><p>解析如下：</p>
<ol>
<li><strong>%s</strong>原样输出字符串: %s</li>
<li><strong>%ns</strong>输出指定长度n的字符串, 超长时不截断, 不足时右对齐: %3s</li>
<li><strong>%m.ns</strong>输出指定长度的字符串, 超长时截断, 不足时<strong>右对齐</strong>，m为最终的字符串输出长度，n为从参数字符串中取出的子串长度: %7.2s</li>
<li><strong>%.ns</strong>输出指定长度的字符串, 超长时截断，不足时右对齐: %.4s; 如果使用 %.8s 与%s %3s效果一样</li>
<li><strong>%-m.ns</strong>输出指定长度的字符串, 超长时截断, 不足时<strong>左对齐</strong>: %-5.3s</li>
</ol>
<p>通过上述用例，所谓超长时截断用到的n并不是只在超长时才起作用，而是不管你有没有超长，都必须截取这么长。<br>上述m,n是可以动态指定的，方法是用*代替m或者n，然后在参数列表里加上一个数字参数</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/31/python-Tkinter/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/31/python-Tkinter/" class="post-title-link" itemprop="url">python Tkinter编程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-01 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-01T00:00:00+08:00">2015-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>python提供了多个图形开发界面的库，几个常用Python GUI库如下：</p>
<ul>
<li>Tkinter： Tkinter模块(“Tk 接口”)是Python的标准Tk GUI工具包的接口.<br>Tk和Tkinter可以在大多数的Unix平台下使用,同样可以应用在Windows和Macintosh系统里.<br>Tk8.0的后续版本可以实现本地窗口风格,并良好地运行在绝大多数平台中。</li>
<li>wxPython：wxPython 是一款开源软件，是 Python 语言的一套优秀的 GUI 图形库，<br>允许 Python 程序员很方便的创建完整的、功能键全的 GUI 用户界面。</li>
<li>Jython：Jython程序可以和Java无缝集成。除了一些标准模块，Jython使用Java的模块。<br>Jython几乎拥有标准的Python中不依赖于C语言的全部模块。<br>比如，Jython的用户界面将使用Swing，AWT或者SWT。Jython可以被动态或静态地编译成Java字节码。</li>
</ul>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2015/10/31/python-Tkinter/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/31/python-pyinstaller/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/31/python-pyinstaller/" class="post-title-link" itemprop="url">使用pyinstaller打包python程序</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-01 00:00:00" itemprop="dateCreated datePublished" datetime="2015-11-01T00:00:00+08:00">2015-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>常用的Python打包为exe工具有：</p>
<ol>
<li>py2exe</li>
<li>pyinstaller</li>
<li>cxfreeze</li>
</ol>
<p>选择使用方便的pyinstaller作为打包工具。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>有两种方式：</p>
<ol>
<li>官网下载后解压缩到需要的文件夹就可以执行，不需要安装。</li>
<li>pip 方式安装升级： <strong>pip install pyinstaller</strong> 和 <strong>pip install –upgrade pyinstaller</strong></li>
</ol>
<p>使用第二种方式安装pyinstaller，安装过程中遇到一些环境问题，主要是pip，google解决之。</p>
<pre><code>python2.7 -m pip install -U setuptools
python3.4 -m pip install -U setuptools
python2.7 -m pip install pyinstaller
python3.4 -m pip install pyinstaller</code></pre><p>执行pyinstaller可能遇到如下问题：</p>
<pre><code>FileNotFoundError: Path or glob &quot;/usr/include/python3.4m/pyconfig.h&quot; not found or matches no files.</code></pre><p><a href="http://stackoverflow.com/questions/31767469/pyinstaller-path-or-glob-usr-include-python3-4m-pyconfig-h-not-found-or-matc" target="_blank" rel="noopener">文章</a><br>解决：</p>
<pre><code>sudo apt-get install libpython3.4-dev</code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>测试代码：</p>
<pre><code>#!/usr/bin/env python3.4
# -*- coding: utf-8 -*-

from tkinter import *

root = Tk()
root.title(&#39;测试界面&#39;)
root.config(height=480,pady=10)

title = Label(root,text=&#39;测试控件&#39;,font=&#39;微软雅黑 -23 bold&#39;,fg=&#39;#fa8723&#39;)
title.pack()

root.mainloop()                         </code></pre><p>执行打包命令：</p>
<pre><code>✘ /data/OpenSourceCode/python/tkinter/test  &gt; pyinstaller -F tk-1030.py
28 INFO: PyInstaller: 3.0
28 INFO: Python: 3.4.3
28 INFO: Platform: Linux-3.19.0-32-generic-x86_64-with-Ubuntu-15.04-vivid
28 INFO: wrote /data/OpenSourceCode/python/tkinter/test/tk-1030.spec
29 INFO: UPX is not available.
30 INFO: Extending PYTHONPATH with /data/OpenSourceCode/python/tkinter/test
31 INFO: checking Analysis
31 INFO: Building Analysis because out00-Analysis.toc is non existent
31 INFO: Initializing module dependency graph...
96 INFO: Initializing module graph hooks...
110 INFO: Analyzing base_library.zip ...
1864 INFO: Processing pre-find module path hook   distutils
3560 INFO: running Analysis out00-Analysis.toc
3647 INFO: Analyzing /data/OpenSourceCode/python/tkinter/test/tk-1030.py
3834 INFO: Looking for import hooks ...
3839 INFO: Processing hook   hook-sysconfig.py
3859 INFO: Processing hook   hook-pydoc.py
3860 INFO: Processing hook   hook-_tkinter.py
3934 INFO: checking Tree
3934 INFO: Building Tree because out00-Tree.toc is non existent
3934 INFO: Building Tree out00-Tree.toc
3954 INFO: checking Tree
3954 INFO: Building Tree because out01-Tree.toc is non existent
3954 INFO: Building Tree out01-Tree.toc
3963 INFO: Processing hook   hook-encodings.py
3983 INFO: Processing hook   hook-distutils.py
3984 INFO: Processing hook   hook-xml.py
4272 INFO: Processing hook   hook-xml.sax.py
4281 INFO: Looking for ctypes DLLs
4628 INFO: Analyzing run-time hooks ...
4631 INFO: Including run-time hook &#39;pyi_rth__tkinter.py&#39;
4643 INFO: Looking for dynamic libraries
5008 INFO: Looking for eggs
5008 INFO: Python library not in binary depedencies. Doing additional searching...
5197 INFO: Using Python library /usr/lib/x86_64-linux-gnu/libpython3.4m.so.1.0
5204 INFO: Warnings written to /data/OpenSourceCode/python/tkinter/test/build/tk-1030/warntk-1030.txt
5218 INFO: checking PYZ
5218 INFO: Building PYZ because out00-PYZ.toc is non existent
5218 INFO: Building PYZ (ZlibArchive) /data/OpenSourceCode/python/tkinter/test/build/tk-1030/out00-PYZ.pyz
5430 INFO: checking PKG
5430 INFO: Building PKG because out00-PKG.toc is non existent
5430 INFO: Building PKG (CArchive) out00-PKG.pkg
10161 INFO: Bootloader /usr/local/lib/python3.4/dist-packages/PyInstaller/bootloader/Linux-64bit/run
10161 INFO: checking EXE
10161 INFO: Building EXE because out00-EXE.toc is non existent
10161 INFO: Building EXE from out00-EXE.toc
10167 INFO: Appending archive to EXE /data/OpenSourceCode/python/tkinter/test/dist/tk-1030</code></pre><p>exe文件生成在dist文件夹中，执行命令验证正常：</p>
<pre><code>✔ /data/OpenSourceCode/python/tkinter/test  &gt; ./dist/tk-1030</code></pre><ol>
<li><a href="http://www.cnblogs.com/chjbbs/p/3533187.html" target="_blank" rel="noopener">关于python打包成exe的一点经验之谈</a></li>
<li><a href="http://www.biubiu.net/blog/pyinstaller-install-use/" target="_blank" rel="noopener">PYINSTALLER 安装和使用</a></li>
<li><a href="http://www.py2exe.org/index.cgi/Tutorial" target="_blank" rel="noopener">py2exe Tutorial</a></li>
<li><a href="http://pythonhosted.org/PyInstaller/" target="_blank" rel="noopener">PyInstaller Manual</a></li>
<li><a href="https://github.com/pyinstaller/pyinstaller/wiki/Supported-Packages" target="_blank" rel="noopener">PYInstaller Supported Packages</a></li>
<li><a href="http://cx-freeze.readthedocs.org/en/latest/index.html" target="_blank" rel="noopener">cx_Freeze’s documentation</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/29/python-pip/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/29/python-pip/" class="post-title-link" itemprop="url">python pip执行错误</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-30T00:00:00+08:00">2015-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ImportError-cannot-import-name-IncompleteRead"><a href="#ImportError-cannot-import-name-IncompleteRead" class="headerlink" title="ImportError: cannot import name IncompleteRead"></a>ImportError: cannot import name IncompleteRead</h2><pre><code>pip -h
ImportError: cannot import name IncompleteRead</code></pre><p>pip出现问题，执行修复：</p>
<pre><code>sudo apt-get remove python-pip
sudo apt-get install python-pip</code></pre><p>没有解决问题，尝试另一种：</p>
<pre><code>sudo easy_install pip</code></pre><p>解决此问题</p>
<h2 id="ImportError-No-module-named-‘pip’"><a href="#ImportError-No-module-named-‘pip’" class="headerlink" title="ImportError: No module named ‘pip’"></a>ImportError: No module named ‘pip’</h2><p>Pip则是一种更为高级的安装工具，它依赖于Setuptools</p>
<pre><code>pip list
Traceback (most recent call last):
File &quot;/usr/local/bin/pip&quot;, line 9, in &lt;module&gt;
load_entry_point(&#39;pip==1.4.1&#39;, &#39;console_scripts&#39;, &#39;pip&#39;)()
File &quot;/usr/local/lib/python3.4/dist-packages/setuptools-1.1.5-py3.4.egg /pkg_resources.py&quot;, line 357, in load_entry_point
def get_entry_info(dist, group, name):
File &quot;/usr/local/lib/python3.4/dist-packages/setuptools-1.1.5-py3.4.egg/pkg_resources.py&quot;, line 2394, in load_entry_point
break
File &quot;/usr/local/lib/python3.4/dist-packages/setuptools-1.1.5-py3.4.egg/pkg_resources.py&quot;, line 2108, in load
name = some.module:some.attr [extra1,extra2]
ImportError: No module named &#39;pip&#39;

$ which pip
/usr/local/bin/pip

$ python2.7 -m pip //here can be just python, btw
Usage:   
/usr/bin/python2.7 -m pip &lt;command&gt; [options]
//and so on...

$ python3.4 -m pip
/usr/bin/python3.4: No module named pip</code></pre><p>需要安装python3.4下的pip</p>
<pre><code>$ curl https://bootstrap.pypa.io/get-pip.py | python3.4
$ python{2.7,3.4} -m pip install -U setuptools</code></pre><p>然后执行</p>
<pre><code>pip list
pip install pyinstaller</code></pre><p>均正确，解决此问题</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/29/python-ImageTK/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/29/python-ImageTK/" class="post-title-link" itemprop="url">python ImageTk加载错误</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-30T00:00:00+08:00">2015-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>510</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>python中使用PIL ImageTK出现以下问题：</p>
<pre><code>Traceback (most recent call last):
    File &quot;./ExportXiamiList.py&quot;, line 4, in &lt;module&gt;
        from tkinter import *
ImportError: No module named tkinter</code></pre><p>Ubuntu下环境：</p>
<pre><code>ExportXiamiList-master &gt; python
python            python2.7         python2-config    python3.3         python3.4         python3m                          
python2           python2.7-config  python3           python3.3m        python3.4m        python-config            </code></pre><p>安装如下包，不起作用：</p>
<pre><code>sudo apt-get install python-pil python-pil.imagetk --reinstall</code></pre><p>继续安装如下包解决问题：</p>
<pre><code>sudo apt-get install python3-pil python3-pil.imagetk</code></pre><p>python中ImageTK用法如下：</p>
<pre><code>from PIL import Image
from PIL import ImageTk</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/27/shell-getopts/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/27/shell-getopts/" class="post-title-link" itemprop="url">shell脚本的命令行选项解析</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-28 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-28T00:00:00+08:00">2015-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>标准UNIX命一般都提供大量的选项和参数，例如：</p>
<pre><code>ps --help
Usage:
ps [options]

Try &#39;ps --help &lt;simple|list|output|threads|misc|all&gt;&#39;
or &#39;ps --help &lt;s|l|o|t|m|a&gt;&#39;
for additional help text.</code></pre><p>在这些工具的命令行处理中使用了C函数<strong>getopt</strong>；<br>shell脚本可以通过使用<strong>getopts</strong>来保持与UNIX一致的风格。</p>
<h2 id="常用shell参数变量"><a href="#常用shell参数变量" class="headerlink" title="常用shell参数变量"></a>常用shell参数变量</h2><ul>
<li>$0 ：即命令本身，相当于C/C++中的argv[0]</li>
<li>$1 ：第一个参数.</li>
<li>$2, $3, $4 … ：第2、3、4个参数，依次类推。</li>
<li>$#  参数的个数，不包括命令本身</li>
<li>$@ ：参数本身的列表，也不包括命令本身</li>
<li>$* ：和$@相同，但”$*“ 和 “$@”(加引号)并不同，”$*“将所有的参数解释成一个字符串，而”$@”是一个参数数组。</li>
</ul>
<h2 id="getopts"><a href="#getopts" class="headerlink" title="getopts"></a>getopts</h2><p>getopts有两个参数，<br>第一个参数是一个字符串，包括字符和“：”，每一个字符都是一个有效的选项，<br>如果字符后面带有“：”，表示这个字符有自己的参数。<br>如果字符串最前面带有“：”，表示开启静默模式，屏蔽系统提示错误。<br>getopts从命令中获取这些参数，并且删去了“-”，<br>并将其赋值在第二个参数中，如果带有自己参数，这个参数赋值在“OPTARG”中。</p>
<p>在使用getopts命令的时候，shell会自动产生两个变量OPTIND和OPTARG。<br>OPTIND初始值为1，其含义是下一个待处理的参数的索引。<br>只要存在，getopts命令返回true，所以一般getopts命令使用while循环；<br>OPTARG是当getopts获取到其期望的参数后存入的位置。</p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre><code>[ $# -eq 0   ] &amp;&amp; usage

# option_string以冒号开头表示屏蔽脚本的系统提示错误，自己处理错误提示。
# 后面接合法的单字母选项，选项后若有冒号，则表示该选项必须接具体的参数

while getopts :s:t:i:oh OPTION
do
    case $OPTION in
        s)
            STRING=$OPTARG
            ;;

        t)
            STRING=`cat $OPTARG`
            ;;

        i)
            IN=$OPTARG        #$OPTARG为特殊变量，表示选项的具体参数
            ;;

        o)
            OUT=$OPTARG        #$OPTARG为特殊变量，表示选项的具体参数
            ;;

        h)
            echo &quot;\033[31mHelp Info:\033[0m&quot;
            java -jar sfntly-builds/java-openjdk-8/sfnttool/sfnttool.jar -h
            exit 1
        ;;

        \?)                       #如果出现错误，则解析为?
            usage
            ;;
    esac
done

#$OPTIND表示第几个选项，初始值为1
#shift $(($OPTIND - 1))
#if [ $# -eq 0  ]; then
#    usage
#fi</code></pre><h2 id="shift"><a href="#shift" class="headerlink" title="shift"></a>shift</h2><p>使用shift $(($OPTIND-1))的作用是:<br>通过shift $(($OPTIND - 1))的处理，$*中就只保留了除去选项内容的参数，可以在其后进行正常的shell编程处理，例如：</p>
<pre><code>./xx -i in -o out para1 para2 ...</code></pre><p>经过处理之后，$*为 <strong>para1 para2</strong>，方便后续脚本处理</p>
<pre><code>while getopts s:h OPTION
do
    case $OPTION in
        s)
            STRING=$OPTARG
            ;;

        h)
            echo &quot;\033[31mHelp Info:\033[0m&quot;
            exit 1
        ;;

        \?)                       #如果出现错误，则解析为?
            usage
            ;;
    esac
done

echo &quot;OPTIND:&quot;$OPTIND
shift $(($OPTIND - 1))      #除了选项之外，该脚本必须接至少一个参数

echo $0
echo $*
echo $@

if [ $# -eq 0  ]; then
    usage
fi

for file in $@          #依次处理剩余的参数
do
    echo $file
done</code></pre><p>执行结果如下：</p>
<pre><code>➜  /data/OpenSourceCode/subset-ttf  &gt; ./test.sh -s &quot;123&quot; test1 test2 test3
OPTIND:3
./test.sh               $0
test1 test2 test3       $*
test1 test2 test3       $@
test1                   file
test2
test3</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/27/shell-name-suffix/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/27/shell-name-suffix/" class="post-title-link" itemprop="url">shell提取文件扩展名或文件名</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-28 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-28T00:00:00+08:00">2015-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<hr>
<p>在shell中用于提取文件名或后缀，需要用到以下几个操作符： <strong>%、%%、#、##</strong></p>
<h2 id="和-操作符"><a href="#和-操作符" class="headerlink" title="% 和 %% 操作符"></a><strong>% 和 %% 操作符</strong></h2><p>用法：</p>
<pre><code>${VAR%.*}
${VAR%%.*}</code></pre><p><strong>${VAR%.*}</strong>含义：从<strong>$VAR</strong>中<strong>删除</strong>位于 <strong>%</strong> 右侧的通配符左右匹配的字符串，<strong>通配符从右向左进行匹配</strong>。</p>
<ul>
<li><strong>% 属于非贪婪操作符</strong>，从右向左匹配最短结果</li>
<li><strong>%% 属于贪婪操作符</strong>，从右向左匹配符合条件的最长字符串</li>
</ul>
<p>示例如下：</p>
<pre><code>file=&quot;abc.c&quot;
name=${file%.*}
echo file name is: $name

输出结果：
file name is: abc</code></pre><p>变量 name 赋值abc.c，那么通配符从右向左就会匹配到 .c，所有从 $VAR 中删除匹配结果。</p>
<pre><code>file=&quot;text.gif.bak.2012&quot;
name=${file%.*}
name2=${file%%.*}
echo file name is: $name
echo file name is: $name2

输出结果：
file name is: text.gif.bak    //使用 %
file name is: text            //使用 %%</code></pre><p>操作符 %% 使用 .* 从右向左贪婪匹配到 .gif.bak.2012</p>
<h2 id="和-操作符-1"><a href="#和-操作符-1" class="headerlink" title="# 和 ## 操作符"></a><strong># 和 ## 操作符</strong></h2><p>用法：</p>
<pre><code>${VAR#*.}
${VAR##*.}</code></pre><p><strong>${VAR#*.}</strong> 含义：从 <strong>$VAR</strong> 中<strong>删除</strong>位于 <strong>#</strong> 右侧的通配符所匹配的字符串，<strong>通配符是左向右进行匹配</strong>。</p>
<ul>
<li><strong># 属于非贪婪操作符</strong>，从左向右匹配最短结果</li>
<li><strong>## 属于贪婪操作符</strong>，从左向右匹配符合条件的最长字符串</li>
</ul>
<p>符示例：</p>
<pre><code>file=&quot;text.gif&quot;
suffix=${file#*.}
echo suffix is: $suffix

输出结果：
suffix is: gif


file=&quot;text.gif.bak.2012.txt&quot;
suffix=${file#*.}
suffix2=${file##*.}
echo suffix is: $suffix
echo suffix is: $suffix2

输出结果：
suffix is: text.gif.bak.2012     //使用 #
suffix2 is: txt                  //使用 ##</code></pre><p>操作符 ## 使用 *. 从左向右贪婪匹配到 text.gif.bak.2012</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><pre><code>url=&quot;www.baidu.com&quot;

echo ${url%.*}      #移除 .* 所匹配的最右边的内容。
www.baidu

echo ${url%%.*}     #将从右边开始一直匹配到最左边的 *. 移除，贪婪操作符。
www

echo ${url#*.}      #移除 *. 所有匹配的最左边的内容。
baidu.com

echo ${url##*.}     #将从左边开始一直匹配到最右边的 *. 移除，贪婪操作符。
com</code></pre>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/25/makefile-and-shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/25/makefile-and-shell/" class="post-title-link" itemprop="url">Makefile中嵌入一段shell脚本及函数列表</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-26T00:00:00+08:00">2015-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shell/" itemprop="url" rel="index">
                    <span itemprop="name">Shell</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Make/" itemprop="url" rel="index">
                    <span itemprop="name">Make</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>


<p>Makefile中需要在编译前进行一些处理，shell可以方便完成。以下为在Makefile中使用shell需要注意的一些事项：</p>
<h2 id="makefile和shell区别"><a href="#makefile和shell区别" class="headerlink" title="makefile和shell区别"></a>makefile和shell区别</h2><h3 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h3><p>shell中所有引用<strong>以$打头的变量其后要加{}</strong>,而在Makefile中的变量是<strong>以$打头的后加()</strong>。如下：</p>
<pre><code>Makefile
PATH=&quot;/data/&quot;
SUBPATH=$(PATH)

Shell
PATH=&quot;/data/&quot;
SUBPATH=${PATH}</code></pre><h3 id="引用shell变量"><a href="#引用shell变量" class="headerlink" title="引用shell变量"></a>引用shell变量</h3><p>Makefile中所有以$打头的单词都会被解释成Makefile中的变量。<br>如果<strong>需要调用shell中的变量（或者正则表达式中锚定句位$），都需要加两个$符号（$$）</strong>。如下：</p>
<pre><code>PATH=&quot;/data/&quot;
all:
    echo $(PATH)
    echo $$PATH</code></pre><p>第一个$(PATH)引用的是Makefile中的变量，而不是shell中的PATH环境变量，后者引用的是Shell中的PATH环境变量。</p>
<h3 id="通配符区别"><a href="#通配符区别" class="headerlink" title="通配符区别"></a>通配符区别</h3><p>shell 中通配符*表示所有的字符；Makefile 中通配符%表示所有的字符</p>
<h3 id="打印输出"><a href="#打印输出" class="headerlink" title="打印输出"></a>打印输出</h3><p>在Makefile中只能在target中调用Shell脚本，其他地方是不能输出的。比如如下代码就是没有任何输出：</p>
<pre><code>VAR=&quot;Hello&quot;
echo &quot;$VAR&quot;
all:</code></pre><p>以上代码任何时候都不会输出，没有在target内，如果上述代码改为如下：</p>
<pre><code>VAR=&quot;Hello&quot;
all:
    echo &quot;$VAR&quot;</code></pre><p>以上代码，在make all的时候将会执行echo命令。</p>
<h3 id="代码片段"><a href="#代码片段" class="headerlink" title="代码片段"></a>代码片段</h3><p>Makefile中的shell，每一行是一个进程，不同行之间变量值不能传递。所以，Makefile中的shell不管多长也要写在一行<br>在Makefile中执行shell命令，一行创建一个进程来执行。<br>不同行之间变量值不能传递。<br>这也是为什么很多Makefile中有很多行的末尾都是“;\”，<br>以此来保证代码是一行而不是多行，这样Makefile可以在一个进程中执行，例如：</p>
<pre><code>SUBDIR=src example
all:
    @for subdir in $(SUBDIR); \     #shell代码开始
    do\
        echo &quot;building &quot;; \
    done</code></pre><p>上述可以看出for循环中每行都是以”; \”结尾的。</p>
<h3 id="shell代码范围"><a href="#shell代码范围" class="headerlink" title="shell代码范围"></a>shell代码范围</h3><p>在Makefile文件的目标项冒号后的另起一行的代码才是shell代码。</p>
<pre><code>xx = xx1       #这里时makefile代码
yy：xx = xx2   #这是是makefile代码，makefile允许变量赋值时，&#39;=&#39;号两边留空格
yy：
    xx=xx3     #只有这里是shell代码 ，shell不允许‘=’号两边有空格哦。

有一个例外：
xx=$(shell 这里的代码也是shell代码)</code></pre><h3 id="makefile总的反引号"><a href="#makefile总的反引号" class="headerlink" title="makefile总的反引号`"></a>makefile总的反引号<strong>`</strong></h3><p>反引号括起来的字符串被shell解释为命令行，<br>在执行时，shell首先执行该命令行，并以它的标准输出结果取代整个反引号（包括两个反引号）部分</p>
<pre><code>PATH=`pwd`
TODAY=`date`

#等同于
PATH=$(shell pwd)
TODAY=$(shell date)</code></pre><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>获取当前目录</strong></p>
<pre><code>TOPDIR:=$(shell pwd)</code></pre><p><strong>获取日期</strong></p>
<pre><code>DATE:=$(shell date +%Y%m%d)</code></pre><p><strong>获取源文件列表</strong></p>
<pre><code>SRC += $(shell find . -iname &quot;*.c&quot;  | grep -v &quot;./opensource/*&quot;)
SRC += $(shell find . -iname &quot;*.cpp&quot;)

PRE_SRC=$(shell find -name &quot;*.c&quot; | xargs grep &quot;HANDLER&quot; | awk -F &#39;:&#39; &#39;{print $$1}&#39; | sort -u) #注意awk中使用的是 $$1</code></pre><p><strong>Makefile打印输出</strong></p>
<pre><code>print_version:
    @echo $(BR2_VERSION_FULL)</code></pre><p><strong>Makefile嵌入脚本</strong></p>
<pre><code>env:                                                                                                                                
    sh $(SRC_PATH)/scripts/connect.sh
    find $(SRC_PATH) -name &quot;sysinfo.o&quot; | xargs rm -f

signalpre:                                                                                                                          
    sed -i &#39;s/HANDLER/HANDLER HANDLERX/g&#39; $(LIB_PATH)/include/core.h
    @mkdir -p $(SRC_PATH)/output/signalpres
    @echo &quot;\033[031msignale handler processor...\033[0m&quot;
    @for f in $(PRE_SRC); do \
        OBJ=$(SRC_PATH)/output/signalpres/`basename $$f|sed -e &#39;s/\.c/\.i/&#39;`; \
        $(CC) $(CFLAGS) -E $$f -o $$OBJ;\
        echo -n &quot;.&quot;;\
    done
    sed -i &#39;s/HANDLER HANDLERX/HANDLER/g&#39; $(LIB_PATH)/include/core.h
    echo &quot;\n&quot;

prepare_config:
    @chmod +x scripts/proj.sh
    @scripts/proj.sh
    @chmod +x scripts/theme.sh
    @scripts/theme.sh</code></pre><p><strong>Makefile中的exec执行脚本</strong></p>
<pre><code>format:
    @echo &quot;Makeing format...&quot;;
    @find -name &quot;*.c&quot; -exec dos2unix -qU 2&gt;d2utmp1 {} \;
    @find -name &quot;*.h&quot; -exec dos2unix -qU 2&gt;d2utmp1 {} \; 
#   @find -name &quot;*.c&quot; -exec indent -npro -kr -i8 -sob -l120 -ss -ncs  {} \;
    @find -name &quot;*~&quot; -exec rm {} \;
    @find -name &quot;d2utmp*&quot; -exec rm {} \;
    @find -name &quot;deps*&quot; -exec rm {} \;</code></pre><p><strong>循环处理文件行</strong></p>
<pre><code>cat config_tmp | while read line
do
    echo &quot;${line}&quot;

    MACRO=$(echo ${line} | awk -F &#39; &#39; &#39;{print $2}&#39;)
    VALUE=$(echo ${line} | awk -F &#39; &#39; &#39;{print $3}&#39;)
    echo &quot;Macro: $MACRO Value: $VALUE\n&quot;

    #cat &quot;$SIGNALE_HANDLER_FILE&quot; | sed -e &quot;s/$MACRO/$VALUE/g&quot; &gt; signal_tmp
    sed -i &quot;s/$MACRO/$VALUE/g&quot; ${SIGNALE_HANDLER_FILE}
done</code></pre><p><strong>grep反选</strong></p>
<pre><code>cat $CONFIG_FILE | sed -s &#39;/^$/d&#39; | grep -v -e &quot;LangName&quot; -e &quot;__CONFIG_H__&quot; -e &quot;#endif&quot; -e &quot;//&quot; &gt; config_tmp</code></pre><p><strong>Makefile依赖规则</strong></p>
<pre><code>OBJS=$(addprefix $(SRC_PATH)/objects/, $(addsuffix .o, $(basename $(notdir $(SRC)))))

deps: $(SRC)
    @-rm -f deps;
    @for f in $(SRC); do \
        OBJ=$(SRC_PATH)/objects/`basename $$f|sed -e &#39;s/\.c/\.o/&#39;`; \
        echo $$OBJ: $$f&gt;&gt; deps; \
        echo &#39;  @echo -e &quot;compiling \033[032m[$(CC)]\033[0m&quot;: &#39; $$f &gt;&gt; deps; \
        echo &#39;  $(CC) $$(CFLAGS) -c -o $$@ $$^&#39;&gt;&gt; deps; \
    done</code></pre><p><strong>Makefile模式规则</strong></p>
<pre><code>%.d: %.c
    @set -e; rm -f $@; \
    $(CC) -M $(CPPFLAGS) $&lt; &gt; $@.$$$$; \
    sed &#39;s,\($*\)\.o[ : ]*,\1.o $@ : ,g&#39; &lt; $@.$$$$ &gt; $@; \
    rm -f $@.$$$$</code></pre><p>这个规则的意思是，所有的[.d]文件依赖于[.c]文件，“rm -f $@”的意思是删除所有的目标，也就是[.d]文件，<br>第二行的意思是，为每个依赖文件“$&lt;”，也就是[.c]文件生成依赖文件，“$@”表示模式“%.d”文件，<br>如果有一个C文件是name.c，那么“%”就是 “name”，“$$$$”意为一个随机编号，<br>第二行生成的文件有可能是“name.d.12345”，<br>第三行使用sed命令做了一个替换，关于sed命令的用法请参看相关的使用文档。<br>第四行就是删除临时文件。</p>
<p><strong>变量值的替换</strong></p>
<pre><code>foo := a.o b.o c.o
bar := $(foo:.o=.c)

foo := a.o b.o c.o
bar := $(foo:%.o=%.c)</code></pre><p>变量<em>.o替换为</em>.c</p>
<h2 id="makefile函数列表"><a href="#makefile函数列表" class="headerlink" title="makefile函数列表"></a>makefile函数列表</h2><p>函数调用，很像变量的使用，也是以“$”来标识的，其語法如下：</p>
<pre><code>$(&lt;function&gt; &lt;arguments&gt;)</code></pre><p>或是</p>
<pre><code>${&lt;function&gt; &lt;arguments&gt;}</code></pre><p>这里，&lt;function&gt;就是函数名，make支持的函数不多。<br>&lt;arguments&gt;为函数的参数，参数间以逗号“,”分隔，而函数名和参数之间以“空格”分隔。<br>函数调用以“$”开头，以圆括号或花括号把函数名和参数括起。<br>感觉很像一个变量，是不是？函数中的参数可以使用变量，为了风格的统一，函数和变量的括号最好一样，<br>如使用“$(subst a,b,$(x))”这样的形式，而不是“$(subst a,b, ${x})”的形式。<br>因为统一会更清楚，也会减少一些不必要的麻烦。</p>
<h3 id="字符串处理函数"><a href="#字符串处理函数" class="headerlink" title="字符串处理函数"></a>字符串处理函数</h3><ul>
<li>$(subst &lt;from&gt;,&lt;to&gt;,&lt;text&gt;), 字符串替换函数</li>
<li>$(patsubst &lt;pattern&gt;,&lt;replacement&gt;,&lt;text&gt;), 模式字符串替换函数</li>
<li>$(strip &lt;string&gt;), 去空格函数,字串中开头和结尾的空字符</li>
<li>$(findstring &lt;find&gt;,&lt;in&gt;), 查找字符串函数</li>
<li>$(filter &lt;pattern…&gt;,&lt;text&gt;), 以&lt;pattern&gt;模式过滤&lt;text&gt;字符串中的单词，保留符合模式&lt;pattern&gt;的单词。可以有多个模式</li>
<li>$(filter-out &lt;pattern…&gt;,&lt;text&gt;), 以&lt;pattern&gt;模式过滤&lt;text&gt;字符串中的单词，去除符合模式&lt;pattern&gt;的单词。可以有多个模式</li>
<li>$(sort &lt;list&gt;), 给字符串&lt;list&gt;中的单词排序（升序）。</li>
<li>$(word &lt;n&gt;,&lt;text&gt;), 取字符串&lt;text&gt;中第&lt;n&gt;个单词。（从一开始）</li>
<li>$(wordlist &lt;ss&gt;,&lt;e&gt;,&lt;text&gt;), 从字符串&lt;text&gt;中取从&lt;ss&gt;开始到&lt;e&gt;的单词串。&lt;ss&gt;和&lt;e&gt;是一个数字</li>
<li>$(words &lt;text&gt;), 统计&lt;text&gt;中字符串中的单词个数</li>
<li>$(firstword &lt;text&gt;), 取字符串&lt;text&gt;中的第一个单词</li>
</ul>
<p>搭配使用：</p>
<pre><code>override CFLAGS += $(patsubst %,-I%,$(subst :, ,$(VPATH)))</code></pre><p>如果我们的“$(VPATH)”值是“src:../headers”，<br>那么“$(patsubst %,-I%,$(subst :, ,$(VPATH)))”将返回“-Isrc -I../headers”，这正是cc或gcc搜索头文件路径的参数</p>
<h3 id="文件名操作函数"><a href="#文件名操作函数" class="headerlink" title="文件名操作函数"></a>文件名操作函数</h3><ul>
<li><p>$(dir &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出目录部分。目录部分是指最后一个反斜杠（“/”）之前的部分。如果没有反斜杠，那么返回“./”</p>
</li>
<li><p>$(notdir &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出非目录部分。非目录部分是指最後一个反斜杠（“/”）之后的部分</p>
</li>
<li><p>$(suffix &lt;names…&gt;) , 从文件名序列&lt;names&gt;中取出各个文件名的后缀</p>
</li>
<li><p>$(basename &lt;names…&gt;), 从文件名序列&lt;names&gt;中取出各个文件名的前缀部分</p>
</li>
<li><p>$(addsuffix &lt;suffix&gt;,&lt;names…&gt;), 把后缀&lt;suffix&gt;加到&lt;names&gt;中的每个单词后面</p>
</li>
<li><p>$(addprefix &lt;prefix&gt;,&lt;names…&gt;), 把前缀&lt;prefix&gt;加到&lt;names&gt;中的每个单词后面</p>
</li>
<li><p>$(join &lt;list1&gt;,&lt;list2&gt;), 把&lt;list2&gt;中的单词对应地加到&lt;list1&gt;的单词后面。<br>如果&lt;list1&gt;的单词个数要比&lt;list2&gt;的多，那么，&lt;list1&gt;中的多出来的单词将保持原样。<br>如果&lt;list2&gt;的单词个数要比&lt;list1&gt;多，那么，&lt;list2&gt;多出来的单词将被复制到&lt;list1&gt;中</p>
<p>  $(join aaa bbb , 111 222 333)返回值是“aaa111 bbb222 333”</p>
</li>
</ul>
<h3 id="foreach-函数"><a href="#foreach-函数" class="headerlink" title="foreach 函数"></a>foreach 函数</h3><p>foreach函数和别的函数非常的不一样。<br>因为这个函数是用来做循环用的，<br>Makefile中的foreach函数几乎是仿照于Unix标准 Shell（/bin/sh）中的for语句，<br>或是C-Shell（/bin/csh）中的foreach语句而构建的。它的语法是：</p>
<pre><code>$(foreach   &lt;var&gt;,&lt;list&gt;,&lt;text&gt;)</code></pre><p>这个函数的意思是，把参数&lt;list&gt;中的单词逐一取出放到参数&lt;var&gt;所指定的变量中，<br>然后再执行&lt; text&gt;所包含的表达式。<br>每一次&lt;text&gt;会返回一个字符串，循环过程中，&lt;text&gt;的所返回的每个字符串会以空格分隔，<br>最后当整个循环结束时，<br>&lt;text&gt;所返回的每个字符串所组成的整个字符串（以空格分隔）将会是foreach函数的返回值。</p>
<p>所以，&lt;var&gt;最好是一个变量名，&lt;list&gt;可以是一个表达式，而&lt;text&gt;中一般会使用&lt;var&gt;这个参数来依次枚举&lt;list&gt;中的单词。举个例子：</p>
<pre><code>names := a b c d
files := $(foreach n,$(names),$(n).o)</code></pre><p>上面的例子中，$(name)中的单词会被挨个取出，并存到变量“n”中，“$(n).o”每次根据“$(n)”计算出一个值，<br>这些值以空格分隔，最后作为foreach函数的返回，所以，$(files)的值是“a.o b.o c.o d.o”。</p>
<p>注意，foreach中的&lt;var&gt;参数是一个临时的局部变量，foreach函数执行完后，参数&lt;var&gt;的变量将不在作用，其作用域只在foreach函数当中。</p>
<h3 id="if-函数"><a href="#if-函数" class="headerlink" title="if 函数"></a>if 函数</h3><p>if函数很像GNU的make所支持的条件语句——ifeq，if函数的语法是：</p>
<pre><code>$(if &lt;condition&gt;,&lt;then-part&gt;) </code></pre><p>或是</p>
<pre><code>$(if &lt;condition&gt;,&lt;then-part&gt;,&lt;else-part&gt;)</code></pre><h3 id="call函数"><a href="#call函数" class="headerlink" title="call函数"></a>call函数</h3><p>call函数是唯一一个可以用来创建新的参数化的函数。<br>你可以写一个非常复杂的表达式，这个表达式中，你可以定义许多参数，然后你可以用call函数来向这个表达式传递参数。其语法是：</p>
<pre><code>$(call &lt;expression&gt;;,&lt;parm1&gt;;,&lt;parm2&gt;;,&lt;parm3&gt;;...)</code></pre><p>当make执行这个函数时，&lt;expression&gt;;参数中的变量，<br>如$(1)，$(2)，$(3)等，会被参数&lt; parm1&gt;;，&lt;parm2&gt;;，&lt;parm3&gt;;依次取代。<br>而&lt;expression&gt;;的返回值就是 call函数的返回值。例如：</p>
<pre><code>reverse =  $(1) $(2)
foo = $(call reverse,a,b)</code></pre><p>那么，foo的值就是“a b”。当然，参数的次序是可以自定义的，不一定是顺序的，如：</p>
<pre><code>reverse =  $(2) $(1)
foo = $(call reverse,a,b)</code></pre><p>此时的foo的值就是“b a”。</p>
<h3 id="origin函数"><a href="#origin函数" class="headerlink" title="origin函数"></a>origin函数</h3><p>origin函数不像其它的函数，他并不操作变量的值，他只是告诉你你的这个变量是哪里来的？其语法是：</p>
<pre><code>$(origin &lt;variable&gt;;)</code></pre><p>注意，&lt;variable&gt;;是变量的名字，不应该是引用。<br>所以你最好不要在&lt;variable&gt;;中使用“$”字符。<br>Origin函数会以其返回值来告诉你这个变量的“出生情况”，下面，是origin函数的返回值:</p>
<ul>
<li>“undefined” 如果&lt;variable&gt;;从来没有定义过，origin函数返回这个值“undefined”。</li>
<li>“default” 如果&lt;variable&gt;;是一个默认的定义，比如“CC”这个变量，这种变量我们将在后面讲述。</li>
<li>“environment” 如果&lt;variable&gt;;是一个环境变量，并且当Makefile被执行时，“-e”参数没有被打开。</li>
<li>“file” 如果&lt;variable&gt;;这个变量被定义在Makefile中。</li>
<li>“command line” 如果&lt;variable&gt;;这个变量是被命令行定义的。</li>
<li>“override” 如果&lt;variable&gt;;是被override指示符重新定义的。</li>
<li>“automatic” 如果&lt;variable&gt;;是一个命令运行中的自动化变量。关于自动化变量将在后面讲述。</li>
</ul>
<p>这些信息对于我们编写Makefile是非常有用的，<br>例如，假设我们有一个Makefile其包了一个定义文件Make.def，<br>在 Make.def中定义了一个变量“bletch”，而我们的环境中也有一个环境变量“bletch”，<br>此时，我们想判断一下，如果变量来源于环境，那么我们就把之重定义了，<br>如果来源于Make.def或是命令行等非环境的，那么我们就不重新定义它。于是，在我们的Makefile中，我们可以这样写：</p>
<pre><code>ifdef bletch
    ifeq &quot;$(origin bletch)&quot; &quot;environment&quot;
        bletch = barf, gag, etc.
    endif
endif</code></pre><h3 id="shell函数"><a href="#shell函数" class="headerlink" title="shell函数"></a>shell函数</h3><p>它的参数应该就是操作系统Shell的命令。它和反引号<strong>`</strong>是相同的功能。<br>这就是说，shell函数把执行操作系统命令后的输出作为函数返回。<br>于是，我们可以用操作系统命令以及字符串处理命令awk，sed等等命令来生成一个变量，如：</p>
<pre><code>contents := $(shell cat foo)
files := $(shell echo *.c)</code></pre><p>注意，这个函数会新生成一个Shell程序来执行命令，所以你要注意其运行性能，<br>如果你的Makefile中有一些比较复杂的规则，并大量使用了这个函数，那么对于你的系统性能是有害的。<br>特别是Makefile的隐晦的规则可能会让你的shell函数执行的次数比你想像的多得多。</p>
<h2 id="自动化变量"><a href="#自动化变量" class="headerlink" title="自动化变量"></a>自动化变量</h2><ul>
<li><p>$@ 表示规则中的目标文件集。在模式规则中，如果有多个目标，那么，”$@”就是匹配于目标中模式定义的集合。</p>
</li>
<li><p>$% 仅当目标是函数库文件中，表示规则中的目标成员名。<br>例如，如果一个目标是”foo.a(bar.o)”，那么，”$%”就是 “bar.o”，”$@”就是”foo.a”。<br>如果目标不是函数库文件（Unix下是[.a]，Windows下是[.lib]），那么，其值为空。</p>
</li>
<li><p>$&lt; 依赖目标中的第一个目标名字。如果依赖目标是以模式（即”%”）定义的，那么”$&lt;”将是符合模式的一系列的文件集。<br>注意，其是一个一个取出来的。</p>
</li>
<li><p>$? 所有比目标新的依赖目标的集合。以空格分隔。</p>
</li>
<li><p>$^ 所有的依赖目标的集合。以空格分隔。如果在依赖目标中有多个重复的，那个这个变量会去除重复的依赖目标，只保留一份。</p>
</li>
<li><p>$+ 这个变量很像”$^”，也是所有依赖目标的集合。只是它不去除重复的依赖目标。</p>
</li>
<li><p>$* 这个变量表示目标模式中”%”及其之前的部分。如果目标是”dir/a.foo.b”，并且目标的模式是”a.%.b”，<br>那么，”$*“的值就是”dir/a.foo”。这个变量对于构造有关联的文件名是比较有较。如果目标中没有模式的定义，<br>那么”$*“也就不能被推导出，但是，如果目标文件的后缀是make所识别的，那么”$*“就是除了后缀的那一部分。<br>例如：如果目标是”foo.c”，因为”.c”是make所能识别的后缀名，<br>所以，” $*“的值就是”foo”。这个特性是GNU make的，很有可能不兼容于其它版本的make，<br>所以，你应该尽量避免使用”$*“，除非是在隐含规则或是静态模式中。如果目标中的后缀是make所不能识别的，那么”$*“就是空值。<br>当你希望只对更新过的依赖文件进行操作时，”$?”在显式规则中很有用，<br>例如，假设有一个函数库文件叫”lib”，其由其它几个object文件更新。那么把object文件打包的比较有效率的Makefile规则是：</p>
<p>  lib : foo.o bar.o lose.o win.o</p>
<pre><code>  ar r lib $?</code></pre></li>
</ul>
<p>在上述所列出来的自动量变量中。四个变量（$@、$&lt;、$%、$*）在扩展时只会有一个文件，<br>而另三个的值是一个文件列表。</p>
<p>对于”$&lt;”，为了避免产生不必要的麻烦，我们最好给$后面的那个特定字符都加上圆括号，比如，”$(&lt;)”就要比”$&lt;”要好一些。</p>
<ol>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:%E4%BD%BF%E7%94%A8%E5%87%BD%E6%95%B0#shell.E5.87.BD.E6.95.B0" target="_blank" rel="noopener">makefile:使用函数</a></li>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile" target="_blank" rel="noopener">跟我一起写Makefile</a></li>
<li><a href="http://wiki.ubuntu.org.cn/%E8%B7%9F%E6%88%91%E4%B8%80%E8%B5%B7%E5%86%99Makefile:%E9%9A%90%E5%90%AB%E8%A7%84%E5%88%99#.E4.BD.BF.E7.94.A8.E9.9A.90.E5.90.AB.E8.A7.84.E5.88.99" target="_blank" rel="noopener">makefile:隐含规则</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/21/compile-warning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/21/compile-warning/" class="post-title-link" itemprop="url">解决C编译警告</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-22 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-22T00:00:00+08:00">2015-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="implicit-declaration-of-function"><a href="#implicit-declaration-of-function" class="headerlink" title="implicit declaration of function"></a>implicit declaration of function</h2><pre><code>warning: implicit declaration of function &#39;app_create_dialog&#39;</code></pre><p>包含函数’app_create_dialog’定义的头文件解决警告。<br>如果没有声明头文件，可以将函数extern声明一下。</p>
<h2 id="unused-variable"><a href="#unused-variable" class="headerlink" title="unused variable"></a>unused variable</h2><pre><code>warning: unused variable &#39;buf&#39;</code></pre><p>删除不使用的变量</p>
<h2 id="initialization-discards-qualifiers-from-pointer-target-type"><a href="#initialization-discards-qualifiers-from-pointer-target-type" class="headerlink" title="initialization discards qualifiers from pointer target type"></a>initialization discards qualifiers from pointer target type</h2><pre><code>xx.c: In function &#39;cmm_cascam_create_dialog1&#39;:
xx.c:95:26: warning: initialization discards qualifiers from pointer target type</code></pre><p>添加类型强制转换</p>
<h2 id="pointer-targets-in-return-differ-in-signedness"><a href="#pointer-targets-in-return-differ-in-signedness" class="headerlink" title="pointer targets in return differ in signedness"></a>pointer targets in return differ in signedness</h2><pre><code>xx.c: In function &#39;cmm_ca_get_notice_str&#39;:
xx.c:58:5: warning: pointer targets in return differ in signedness</code></pre><p>数据类型不匹配，强制转换</p>
<h2 id="assignment-discards-qualifiers-from-pointer-target-type"><a href="#assignment-discards-qualifiers-from-pointer-target-type" class="headerlink" title="assignment discards qualifiers from pointer target type"></a>assignment discards qualifiers from pointer target type</h2><pre><code>ca/common_menu/cmm_cascam_dialog3.c: In function &#39;_create_dialog_check&#39;:
ca/common_menu/cmm_cascam_dialog3.c:150:17: warning: assignment discards qualifiers from pointer target type</code></pre><p>强制转换解决</p>
<h2 id="defined-but-not-used"><a href="#defined-but-not-used" class="headerlink" title="defined but not used"></a>defined but not used</h2><pre><code>x.c:59:12: warning: &#39;_mutex_delete&#39; defined but not used</code></pre><p>删除无用代码</p>
<h2 id="control-reaches-end-of-non-void-function"><a href="#control-reaches-end-of-non-void-function" class="headerlink" title="control reaches end of non-void function"></a>control reaches end of non-void function</h2><pre><code>module/cascam/cas/thinew/adapter/tnt_demux.c: In function &#39;_nit_set_equal_filter&#39;:
module/cascam/cas/thinew/adapter/tnt_demux.c:600:1: warning: control reaches end of non-void function</code></pre><p>添加</p>
<pre><code>return ret;</code></pre><h2 id="pointer-targets-in-passing-argument-1-of-‘cascam-strlen’-differ-in-signedness"><a href="#pointer-targets-in-passing-argument-1-of-‘cascam-strlen’-differ-in-signedness" class="headerlink" title="pointer targets in passing argument 1 of ‘cascam_strlen’ differ in signedness"></a>pointer targets in passing argument 1 of ‘cascam_strlen’ differ in signedness</h2><pre><code>module/cascam/cas/thinew/adapter/tnt_baseinfo.c: In function &#39;_get_basic_information&#39;:
module/cascam/cas/thinew/adapter/tnt_baseinfo.c:45:9: warning: pointer targets in passing argument 1 of &#39;cascam_strlen&#39; differ in signedness
module/cascam/cas/thinew/adapter/../../../include/cascam_os.h:61:14: note: expected &#39;char *&#39; but argument is of type &#39;unsigned char *&#39;</code></pre><p>形参与实参类型不匹配，强制转换</p>
<h2 id="warning-missing-braces-around-initializer"><a href="#warning-missing-braces-around-initializer" class="headerlink" title="warning: missing braces around initializer"></a>warning: missing braces around initializer</h2><pre><code>module/cascam/adapter/cascam_osd_adapter.c: In function &#39;cascam_osd_pop_dialog5&#39;:
module/cascam/adapter/cascam_osd_adapter.c:295:5: warning: missing braces around initializer
module/cascam/adapter/cascam_osd_adapter.c:295:5: warning: (near initialization for &#39;para.title&#39;)</code></pre><p>初始化大括号不明确，内部加上一个大括号，二维数组初始化。</p>
<h2 id="may-be-used-uninitialized-in-this-function"><a href="#may-be-used-uninitialized-in-this-function" class="headerlink" title="may be used uninitialized in this function"></a>may be used uninitialized in this function</h2><p>初始化变量</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/20/gdb-disassemble-debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/20/gdb-disassemble-debug/" class="post-title-link" itemprop="url">使用反汇编定位未开源库问题</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-21 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-21T00:00:00+08:00">2015-10-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index">
                    <span itemprop="name">C</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h2><p>整合版本时，遇到一个必现死机问题，每次出现问题都是调用库中的一个函数。<br>经过排查，初步怀疑是库存在一些问题，或者与外部使用配合出现问题。</p>
<h2 id="定位问题"><a href="#定位问题" class="headerlink" title="定位问题"></a>定位问题</h2><pre><code>(gdb) set $pc=$epc
(gdb) i r r10
r10            0x970038656
(gdb) info registers 
r0             0x90972c100x90972c10
r1             0x90486564-1874303644
r2             0x970038656
r3             0xff255
r4             0x904895de-1874291234
r5             0xae174
r6             0x00
r7             0x00
r8             0x904d03a0-1874000992
r9             0x11110009286326793
r10            0x970038656
r11            0x6096
r12            0x11
r13            0x904d03a0-1874000992
r14            0x904d02a0-1874001248
r15            0x90142750-1877727408
pc             0x9000060a0x9000060a &lt;__default_14&gt;
epc            0x902abd300x902abd30 &lt;inflate_fast+708&gt;
psr            0x8f0e0010-1894907888
epsr           0x800e0150-2146565808
(gdb) pc
#0  0x9014279cin xxx_xxm()at xx.c:574
#1  0x90142750in xxx_xxm()at xx.c:568
#2  0x9014144ein xxx_xx()at xx.c:2659
#3  0x90141446in xxx_xx()at xx.c:2658
#4  0x9014143ein xxx_xx()at xx.c:2657
#5  0x901413f2in xxx_xx()at xx.c:2657
#6  0x901413dein xxx_xx()at xx.c:2652
#7  0x901413d2in xxx_xx()at xx.c:2652
(gdb) disassemble $pc-10,$pc+10
Dump of assembler code from 0x90000600 to 0x90000614:
0x90000600 &lt;__hardware_accelerator+2&gt;:br0x90000600
0x90000602 &lt;__trap0+0&gt;:bkpt
0x90000604 &lt;__trap0+2&gt;:br0x90000604
0x90000606 &lt;__default_13+0&gt;:bkpt
0x90000608 &lt;__default_13+2&gt;:br0x90000608
=&gt; 0x9000060a &lt;__default_14+0&gt;:bkpt
0x9000060c &lt;__default_14+2&gt;:br0x9000060c
0x9000060e &lt;__default_15+0&gt;:bkpt
0x90000610 &lt;__default_15+2&gt;:br0x90000610
0x90000612 &lt;__default_17+0&gt;:bkpt
End of assembler dump.
(gdb) bt
#0  0x9000060a in __default_14 ()
#1  0x90142750 in xxx_xxm () at xx.c:568
#2  0x9013cfb8 in func () at c1.c:167
#3  0x9013f394 in main_entry (args=&lt;value optimized out&gt;) at init.c:14
#4  0x9008724c in default_thread_function (arg=0x907f32b8) at os/ecos/osapi.c:371
#5  0x901232f2 in pthread_entry(unsigned int) ()
#6  0x90127030 in Cyg_HardwareThread::thread_entry(Cyg_Thread*) ()
#7  0x9012701c in Cyg_Thread::exit() ()
#8  0xb0b6ccd0 in ?? ()</code></pre><p>可以判断出r10中值出现问题，并且问题出现在文件xx.c的函数xxx_xxm()中，重启跟踪代码：</p>
<pre><code>(gdb) b xxx_xxm 
Breakpoint 3 at 0x901425f4: file xx.c, line 524.
(gdb) c
Continuing.

Breakpoint 3, xxx_xxm () at xx.c:524
524xx.c: 没有那个文件或目录.
in xx.c
(gdb) display /i $r10
1: x/i $r10
0x1111000a:ldm r3-r15, (r0)
(gdb) display /i $pc
2: x/i $pc
=&gt; 0x901425f4 &lt;xxx_xxm+20&gt;:lrw r7, 0x903BA9CC
(gdb) n
526in xx.c
(gdb) 
574in xx.c
2: x/i $pc
=&gt; 0x9014279c &lt;xxx_xxm+444&gt;:mov r7, r2
1: x/i $r10
0x1111000a:movi r4, 86
(gdb) 
575in xx.c
2: x/i $pc
=&gt; 0x901427a6 &lt;xxx_xxm+454&gt;:mov r2, r10
1: x/i $r10
0x9700:movi r4, 86</code></pre><p><strong>问题很可能出现在源文件xx.c的574行</strong>，执行过这一行之后，r10的值修改为0x9700，最后请客户检查代码，确认为野指针。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/18/vim-map-nmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/18/vim-map-nmap/" class="post-title-link" itemprop="url">VIM键值映射规则</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-19 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-19T00:00:00+08:00">2015-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="map模式"><a href="#map模式" class="headerlink" title="map模式"></a>map模式</h2><p>有五种映射存在： </p>
<ol>
<li>Normal mode: 普通模式, 输入命令时</li>
<li>Visual mode: 可视模式: 可视区域高亮并输入命令时</li>
<li>Select mode: 选择模式: 与可视模式区别是会替换选择文本</li>
<li>Operator-pending mode: 操作符等待模式: 操作符等待中 (“d”，”y”，”c” 等等之后)。 见下: |omap-info|。 </li>
<li>Insert mode: 插入模式: 也用于替换模式。 </li>
<li>Command-line mode: 命令行模式: 输入 “:” 或 “/“ 命令时。 </li>
</ol>
<h2 id="快捷键映射"><a href="#快捷键映射" class="headerlink" title="快捷键映射"></a>快捷键映射</h2><p>快捷键映射分两种: map 和 noremap</p>
<h3 id="递归映射-map"><a href="#递归映射-map" class="headerlink" title="递归映射 (map)"></a>递归映射 (map)</h3><p>如果键 b 映射为键 a，然后键 c 映射为键 b，那么当按键 c 时会产生按键 a 的效果。</p>
<pre><code>:map b a
:map c b</code></pre><p>相当于</p>
<pre><code>:map c a</code></pre><h3 id="非递归映射-noremap"><a href="#非递归映射-noremap" class="headerlink" title="非递归映射 (noremap)"></a>非递归映射 (noremap)</h3><pre><code>:noremap b a
:noremap c b</code></pre><p>非递归映射则不会产生递归映射一样的效果。</p>
<h2 id="不同模式下的快捷键映射"><a href="#不同模式下的快捷键映射" class="headerlink" title="不同模式下的快捷键映射"></a>不同模式下的快捷键映射</h2><h3 id="映射模式"><a href="#映射模式" class="headerlink" title="映射模式"></a>映射模式</h3><p>在 map 与 noremap 前分别可以加 ‘n’, ‘v’, ‘x’, ‘s’, ‘o’, ‘i’, ‘l’, ‘c’ 以及 ‘map!’ 和 ‘noremap!’：</p>
<ul>
<li><Space>    Normal, Visual, Select and Operator-pending</li>
<li>n    Normal</li>
<li>v    Visual and Select</li>
<li>s    Select (在可视模式下Ctrl+G进入)</li>
<li>x    Visual</li>
<li>o    Operator-pending</li>
<li>!    Insert and Command-line</li>
<li>i    Insert</li>
<li>l    “:lmap” mappings for Insert, Command-line and Lang-Arg</li>
<li>c    Command-line</li>
</ul>
<p>常用参数：</p>
<ul>
<li>{lhs} 表示左手边 *{lhs}*</li>
<li>{rhs} 表示右手边 *{rhs}*</li>
</ul>
<h3 id="普通模式的映射命令"><a href="#普通模式的映射命令" class="headerlink" title="普通模式的映射命令"></a>普通模式的映射命令</h3><p>可以随时<strong><em>:help map</em></strong>一下，查看相关命令具体信息。</p>
<h4 id="map"><a href="#map" class="headerlink" title="map"></a>map</h4><pre><code>:map {lhs} {rhs} 
:map {lhs} {rhs} |mapmode-nvo| *:map* </code></pre><p>作用模式： n、v、o （普通、可视和选择、操作符等待）。<br>在:map作用的模式中把键系列 {lhs} 映射为 {rhs}，{rhs}可进行映射扫描，也就是可递归映射。 </p>
<p>举例： </p>
<pre><code>:map td :tabnew .&lt;cr&gt; </code></pre><p>在其作用模式（普通、可视、操作符）下，输入td等价于输入 :tabnew . <cr>。<br>而普通模式下输入:tabnew . <cr>就是打开当前目录，<br>如果再定义绑定：</p>
<pre><code>:map ts td</code></pre><p>就是指在其作用模式下输入ts等价于td，也就是打开当前目录。不过如果没有特殊需要，一般不建议递归映射。 </p>
<h4 id="noremap"><a href="#noremap" class="headerlink" title="noremap"></a>noremap</h4><p>:moremap和:map命令相对，作用模式和命令格式都相同，<br>只不过不允许再对{rhs}进行映射扫描，也就是{lhs}定义后的映射就是{rhs}的键序列，不会再对{rhs}键序列重新解释扫描。<br>它一般用于重定义一个命令，当然如果:map不需要递归映射的话，建议使用:noremap，比如： </p>
<pre><code>:noremap ts td </code></pre><p>它的意思是在其作用模式下，输入ts就是输入td，但是和:map不同的是，此时td再不会做进一步扫描解释。<br>虽然之前已经定义了td，但是不会对td再做扫描 </p>
<h4 id="unmap"><a href="#unmap" class="headerlink" title="unmap"></a>unmap</h4><p>:unmap是对应取消:map绑定的{lhs}，作用模式相同，命令格式</p>
<pre><code>:unmap {lhs}</code></pre><p>例如： </p>
<pre><code>:unmap td </code></pre><p>就是取消在其作用模式中td的绑定，比如之前td被绑定为:tabnew .<cr>，此时此绑定消失。 </p>
<h4 id="mapclear"><a href="#mapclear" class="headerlink" title="mapclear"></a>mapclear</h4><p>:mapclear时对应取消所有:map绑定的，慎用！ </p>
<h4 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h4><p>:nmap是:map的普通模式板，也就是说其绑定的键只作用于普通模式。例如： </p>
<pre><code>:nmap td :tabnew .&lt;cr&gt; </code></pre><p>在普通模式下等效 </p>
<pre><code>:map td :tabnew .&lt;cr&gt; </code></pre><h4 id="nnoremap"><a href="#nnoremap" class="headerlink" title="nnoremap"></a>nnoremap</h4><p>:nnorempa和:nmap的关系和:noremap和:map的关系一样，只是:nmap的非递归版 </p>
<h4 id="nunmap"><a href="#nunmap" class="headerlink" title="nunmap"></a>nunmap</h4><p>:nunmap和:nmap的关系和:unmap和:map的关系一样，取消:nmap的绑定。 </p>
<h4 id="nmapclear"><a href="#nmapclear" class="headerlink" title="nmapclear"></a>nmapclear</h4><p>:nmapclear是对应取消所有:map绑定的，慎用！ </p>
<p><strong>可以发现一个规律，前4个是一组，后4个时一组，后一组比前一组多一个n就是指只作用于普通模式。<br>其中每组内*nore*是其对应的非递归版、*un*是取消绑定某个&lt;lhs&gt;绑定、clear后缀是取消所有绑定。<br>发现了这个规律，再翻到前面的模式代号表，<br>大体可以猜到vmap、xmap、smap、omap是什么意思，以及相对应的nore版本、un版本、clear版本。</strong></p>
<p>另外，{rhs} 之前可能显示一个特殊字符: </p>
<ul>
<li>* 表示它不可重映射 </li>
<li>&amp; 表示仅脚本的局部映射可以被重映射 </li>
<li>@ 表示缓冲区的局部映射 </li>
</ul>
<h3 id="键表-key-notation"><a href="#键表-key-notation" class="headerlink" title="键表|key-notation|"></a>键表|key-notation|</h3><ul>
<li>&lt;k0&gt; - &lt;k9&gt; 小键盘 0 到 9 *keypad-0* *keypad-9* </li>
<li>&lt;S-…&gt; Shift＋键 *shift* *&lt;S-* </li>
<li>&lt;C-…&gt; Control＋键 *control* *ctrl* *&lt;C-* </li>
<li>&lt;M-…&gt; Alt＋键 或 meta＋键 *meta* *alt* *&lt;M-* </li>
<li>&lt;A-…&gt; 同 &lt;m-…&gt; *&lt;A-* </li>
<li>&lt;t_xx&gt; termcap 里的 “xx” 入口键 </li>
</ul>
<h3 id="特殊参数"><a href="#特殊参数" class="headerlink" title="特殊参数"></a>特殊参数</h3><ul>
<li>&lt;buffer&gt; </li>
<li>&lt;nowait&gt; </li>
<li>&lt;silent&gt; </li>
<li>&lt;special&gt; </li>
<li>&lt;script&gt; </li>
<li>&lt;expr&gt; </li>
<li>&lt;unique&gt; </li>
</ul>
<p>可以按任意顺序使用。它们必须紧跟在命令的后边，而在其它任何参数的前边。</p>
<h4 id="lt-buffer-gt"><a href="#lt-buffer-gt" class="headerlink" title="&lt;buffer&gt;"></a>&lt;buffer&gt;</h4><p>如果这些映射命令的第一个参数是&lt;buffer&gt;，映射将只局限于当前缓冲区（也就是你此时正编辑的文件）内。比如： </p>
<pre><code>:map &lt;buffer&gt; ,w /a&lt;CR&gt; </code></pre><p>它的意思时在当前缓冲区里定义键绑定，“,w”将在当前缓冲区里查找字符a。同样你可以在其他缓冲区里定义： </p>
<pre><code>:map &lt;buffer&gt; ,w /b&lt;CR&gt; </code></pre><p>其作用域也只在各自的标签里。同样要清除这些缓冲区的键绑定也要加上&lt;buffer&gt;参数，比如： </p>
<pre><code>:unmap &lt;buffer&gt; ,w 
:mapclear &lt;buffer&gt; </code></pre><h4 id="lt-nowait-gt"><a href="#lt-nowait-gt" class="headerlink" title="&lt;nowait&gt;"></a>&lt;nowait&gt;</h4><p>定义局部于缓冲区的映射 “,” 时，可能有另一个全局映射也以 “,” 开始。<br>这时你需要键入另一个字符，Vim 才能知道是用 “,” 映射还是更长的那个。<br>要避免这个问题，加入 <nowait> 参数。<br>这样映射一旦匹配就会被使用，Vim 不会等待更多字符的输入。但如果那些字符已经输入了，还是会使用的。</p>
<h4 id="lt-silent-gt"><a href="#lt-silent-gt" class="headerlink" title="&lt;silent&gt;"></a>&lt;silent&gt;</h4><p>执行键绑定时不在命令行上回显，比如： </p>
<pre><code>:map &lt;silent&gt; ,w /abcd&lt;CR&gt; </code></pre><p>输入,w查找abcd时，命令行上不会显示/abcd，如果没有&lt;silent&gt;参数就会显示出来 </p>
<h4 id="lt-special-gt"><a href="#lt-special-gt" class="headerlink" title="&lt;special&gt;"></a>&lt;special&gt;</h4><p>一般用于定义特殊键怕有副作用的场合。比如： </p>
<pre><code>:map &lt;special&gt; &lt;F12&gt; /Header&lt;CR&gt; </code></pre><h4 id="lt-unique-gt"><a href="#lt-unique-gt" class="headerlink" title="&lt;unique&gt;"></a>&lt;unique&gt;</h4><p>一般用于定义新的键映射或者缩写命令的同时检查是否该键已经被映射，如果该映射或者缩写已经存在，则该命令会失败 </p>
<pre><code>:map &lt;unique&gt; ,w  /[#&amp;!]&lt;CR&gt;</code></pre><p>这个例子将失败:</p>
<pre><code>:map ,w  /[#&amp;!]&lt;CR&gt;
:map &lt;buffer&gt; &lt;unique&gt; ,w  /[.,;]&lt;CR&gt;</code></pre><h4 id="lt-expr-gt"><a href="#lt-expr-gt" class="headerlink" title="&lt;expr&gt;"></a>&lt;expr&gt;</h4><p>如果定义新映射的第一个参数是&lt;expr&gt;，那么参数会作为表达式来进行计算，结果使用实际使用的&lt;rhs&gt;，例如： </p>
<pre><code>:inoremap &lt;expr\&gt; . InsertDot() </code></pre><p>这可以用来检查光标之前的文本并在一定条件下启动全能 (omni) 补全。 </p>
<p>这里是插入递增的列表编号的例子:</p>
<pre><code>let counter = 0 
inoremap &lt;expr&gt; &lt;C-L&gt; ListItem() 
inoremap &lt;expr&gt; &lt;C-R&gt; ListReset() 

func ListItem() 
    let g:counter += 1 
    return g:counter . &#39;. &#39; 
endfunc 

func ListReset() 
    let g:counter = 0 
    return &#39;&#39; 
endfunc </code></pre><p>CTRL-L 插入下一个数值，CTRL-R 复位计数且返回空字符串，这样就不会插入任何内容。</p>
<h3 id="lt-Leader-gt-mapleader"><a href="#lt-Leader-gt-mapleader" class="headerlink" title="&lt;Leader&gt;mapleader"></a>&lt;Leader&gt;mapleader</h3><p>要定义一个使用 “mapleader” 变量的映射，可以使用特殊字串 “<Leader>“。<br>它会被 “mapleader” 的字串值所替换。如果 “mapleader” 未设置或为空，则用反斜杠代替，例如:</p>
<pre><code>:map &lt;Leader&gt;A  oanother line&lt;Esc&gt;</code></pre><p>和下面一样:</p>
<pre><code>:map \A  oanother line&lt;Esc&gt;</code></pre><p>但是当:</p>
<pre><code>:let mapleader = &quot;,&quot;</code></pre><p>又相当于:</p>
<pre><code>:map ,A  oanother line&lt;Esc&gt;</code></pre><p>注意 “mapleader” 的值仅当定义映射时被使用。后来改变的 “mapleader” 不会影响已定义的映射。</p>
<ol>
<li><a href="http://vimcdoc.sourceforge.net/doc/map.html#:map-commands" target="_blank" rel="noopener">VIM 参考手册-MAP</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/10/15/go-with-vim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Breeze.Temple">
      <meta itemprop="description" content="Breeze.Temple">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IT日记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/15/go-with-vim/" class="post-title-link" itemprop="url">vim配置golang开发环境</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-16 00:00:00" itemprop="dateCreated datePublished" datetime="2015-10-16T00:00:00+08:00">2015-10-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-07 09:52:13" itemprop="dateModified" datetime="2020-05-07T09:52:13+08:00">2020-05-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Tools/Editor/" itemprop="url" rel="index">
                    <span itemprop="name">Editor</span>
                  </a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>2.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <script type="text/javascript">
$(document).ready(function(){
        $("h2,h3,h4,h5,h6").each(function(i,item){
            var tag = $(item).get(0).localName;
            $(item).attr("id","wow"+i);
            $("#category").append('<a class="new'+tag+'" href="#wow'+i+'">'+$(this).text()+'</a></br>');
            $(".newh2").css("margin-left",0);
            $(".newh3").css("margin-left",20);
            $(".newh4").css("margin-left",40);
            $(".newh5").css("margin-left",60);
            $(".newh6").css("margin-left",80);
            });
        });
</script>
<div id="category"></div>

<h2 id="vim配置"><a href="#vim配置" class="headerlink" title="vim配置"></a>vim配置</h2><p>Vim-go是当前使用最为广泛的用于搭建Golang开发环境的vim插件：</p>
<pre><code>Bundle &#39;fatih/vim-go&#39;
:BundleInstall</code></pre><p>Tagbar配合gotags配置：</p>
<pre><code>let g:tagbar_type_go = {
    \ &#39;ctagstype&#39; : &#39;go&#39;,
    \ &#39;kinds&#39;     : [
        \ &#39;p:package&#39;,
    \ &#39;i:imports:1&#39;,
    \ &#39;c:constants&#39;,
    \ &#39;v:variables&#39;,
    \ &#39;t:types&#39;,
    \ &#39;n:interfaces&#39;,
    \ &#39;w:fields&#39;,
    \ &#39;e:embedded&#39;,
    \ &#39;m:methods&#39;,
    \ &#39;r:constructor&#39;,
    \ &#39;f:functions&#39;
        \ 
    ],
    \ &#39;sro&#39; : &#39;.&#39;,
    \ &#39;kind2scope&#39; : {
        \ &#39;t&#39; : &#39;ctype&#39;,
        \ &#39;n&#39; : &#39;ntype&#39;
            \ 
    },
    \ &#39;scope2kind&#39; : {
        \ &#39;ctype&#39; : &#39;t&#39;,
        \ &#39;ntype&#39; : &#39;n&#39;
            \ 
    },
    \ &#39;ctagsbin&#39;  : &#39;gotags&#39;,
    \ &#39;ctagsargs&#39; : &#39;-sort -silent&#39;
    \ }</code></pre><h2 id="安装Binaries"><a href="#安装Binaries" class="headerlink" title="安装Binaries"></a>安装Binaries</h2><p>还需要安装其他tools，vim-go安装说明中提到所有必要的binary需要先安装好，比如gocode、godef、goimports等。通过：</p>
<pre><code>:GoInstallBinaries</code></pre><p>查看文件.vim/bundle/vim-go/plugin/go.vim：</p>
<pre><code>let s:packages = [
    \ &quot;github.com/nsf/gocode&quot;,
    \ &quot;golang.org/x/tools/cmd/goimports&quot;,
    \ &quot;github.com/rogpeppe/godef&quot;,
    \ &quot;golang.org/x/tools/cmd/oracle&quot;,
    \ &quot;golang.org/x/tools/cmd/gorename&quot;,
    \ &quot;github.com/golang/lint/golint&quot;,
    \ &quot;github.com/kisielk/errcheck&quot;,
    \ &quot;github.com/jstemmer/gotags&quot;,
    \ ]</code></pre><p>这些vim-go依赖的二进制工具将会自动被下载，并被安装到$GOBIN下，但是自动安装很可能部分tools安装不成功，此时需要手动安装：</p>
<pre><code>go get -u github.com/nsf/gocode

//或者
git clone https://go.googlesource.com/tools $GOPATH/src/golang.org/x/tools
go build golang.org/x/tools/cmd/goimports</code></pre><p>安装golint：</p>
<pre><code>./3rdpkg/src/github.com/golang
git clone git@github.com:golang/lint.git
cd ../../../../go/bin
pwd
./go/bin
go build -x github.com/golang/lint/golint
cp $WORK/github.com/golang/lint/golint/_obj/exe/a.out golint</code></pre><h2 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h2><p>安装完毕$GOBIN目录如下：</p>
<pre><code>.
├── errcheck
├── go
├── gocode
├── godef
├── godoc
├── gofmt
├── goimports
├── gorename
├── gotags
└── oracle</code></pre><ul>
<li><a href="https://github.com/jstemmer/gotags" target="_blank" rel="noopener">gotags</a> 这个用来配合vim的tagbar，查看方便的生成和查看文件中的各种方法，并进行跳转</li>
<li><a href="https://godoc.org/golang.org/x/tools/cmd/goimports" target="_blank" rel="noopener">goimport</a> 根据你所使用的方法，自动调整import中引用的内容，比较方便。<br>可以随时用vim命令 :Fmt 来格式化你的代码，也可以每次保存代码的时候，让vim自动为你格式化代码</li>
<li><a href="https://github.com/dgryski/vim-godef" target="_blank" rel="noopener">godef</a> 实现在代码中的跳转，从函数调用的地方，直接跳转到函数的定义。默认的命令是：gd</li>
<li><a href="https://github.com/nsf/gocode" target="_blank" rel="noopener">gocode</a>实现Golang的代码自动补全</li>
</ul>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><ul>
<li>新起一行输入fmt.，然后ctrl+x, ctrl+o，Vim 会弹出补齐提示下拉框，不过并非实时跟随的那种补齐，这个补齐是由gocode提供的。</li>
<li>输入一行代码：time.Sleep(time.Second)，执行:GoImports，Vim会自动导入time包。</li>
<li>将光标移到Sleep函数上，执行:GoDef或命令模式下敲入gd，Vim会打开$GOROOT/src/time/sleep.go中 的Sleep函数的定义。执行:b 1返回到hellogolang.go。</li>
<li>执行:GoLint，运行golint在当前Go源文件上。</li>
<li>执行:GoDoc，打开当前光标对应符号的Go文档。</li>
<li>执行:GoVet，在当前目录下运行go vet在当前Go源文件上。</li>
<li>执行:GoRun，编译运行当前main package。</li>
<li>执行:GoBuild，编译当前包，这取决于你的源文件，GoBuild不产生结果文件。</li>
<li>执行:GoInstall，安装当前包。</li>
<li>执行:GoTest，测试你当前路径下地_test.go文件。</li>
<li>执行:GoCoverage，创建一个测试覆盖结果文件，并打开浏览器展示当前包的情况。</li>
<li>执行:GoErrCheck，检查当前包种可能的未捕获的errors。</li>
<li>执行:GoFiles，显示当前包对应的源文件列表。</li>
<li>执行:GoDeps，显示当前包的依赖包列表。</li>
<li>执行:GoImplements，显示当前类型实现的interface列表。</li>
<li>执行:GoRename [to]，将当前光标下的符号替换为[to]。</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="http://studygolang.com/articles/1785" target="_blank" rel="noopener">Golang开发环境搭建</a></li>
<li><a href="https://github.com/nsf/gocode" target="_blank" rel="noopener">gocode</a></li>
<li><a href="https://github.com/golang" target="_blank" rel="noopener">Go</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/25/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><span class="page-number current">26</span><a class="page-number" href="/page/27/">27</a><span class="space">&hellip;</span><a class="page-number" href="/page/30/">30</a><a class="extend next" rel="next" href="/page/27/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Breeze.Temple"
    src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Breeze.Temple</p>
  <div class="site-description" itemprop="description">Breeze.Temple</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">442</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">474</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/breezetemple" title="GitHub &rarr; https://github.com/breezetemple" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://bitbucket.org" title="BitBucket &rarr; https://bitbucket.org" rel="noopener" target="_blank"><i class="fa fa-fw fa-bitbucket"></i>BitBucket</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://breezetemple.github.io/" title="http://breezetemple.github.io/" rel="noopener" target="_blank">Breeze.Temple's HomePage</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Breeze.Temple</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">18:07</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  


  <link rel="stylesheet" href="/js/highlight/styles/solarized-dark.css">
  <script src="/js/highlight/highlight.pack.js"></script>
  <script type="text/javascript">
      $(function() {
          hljs.initHighlighting();
      });
  </script>

</body>
</html>
